# FMS BBP - Global Tax Management

## **1. MODULE IDENTIFICATION**

**Module Name:** Global Tax Management
**Module Number:** 1.6.1
**Module Type:** Master
**Target File:** FMS/01.Finance Setup & Configuration/1.6.Tax Categories/1.6.1 Global Tax Management.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Global Tax Management module serves as the centralized configuration system for managing tax jurisdictions, tax rates, and tax calculation rules across multiple countries and regions, providing standardized tax compliance and automated tax calculation capabilities for global financial operations.

### **2.2 Business Scope**
**In Scope:**
- Tax jurisdiction configuration and management
- Tax rate setup and maintenance
- Tax rule engine configuration
- Multi-country tax compliance management
- Tax calculation method definitions
- Tax exemption and deduction rules
- Tax reporting period configuration
- Integration with financial transactions

**Out of Scope:**
- Actual tax transaction processing (handled by transaction modules)
- Tax return filing (handled by Tax Returns module)
- Tax payment processing (handled by Payment modules)
- Tax audit and compliance reporting (handled by Tax Compliance module)

### **2.3 Key Stakeholders**
- **Tax Managers:** Global tax configuration and compliance management
- **Finance Directors:** Tax strategy and oversight
- **Compliance Officers:** Tax regulatory compliance monitoring
- **System Administrators:** Technical tax system maintenance
- **External Auditors:** Tax configuration validation and audit support

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: TaxJurisdiction**

```python
class TaxJurisdiction(models.Model):
    """
    Master tax jurisdiction configuration for global tax management
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    jurisdiction_code = models.CharField(max_length=10)
    jurisdiction_name = models.CharField(max_length=200)
    jurisdiction_type = models.CharField(
        max_length=20,
        choices=[
            ('COUNTRY', 'Country'),
            ('STATE', 'State/Province'),
            ('CITY', 'City/Municipality'),
            ('REGION', 'Region'),
            ('DISTRICT', 'District'),
        ]
    )
    country_code = models.CharField(max_length=3)  # ISO 3166-1 alpha-3
    parent_jurisdiction_id = models.UUIDField(null=True, blank=True)
    tax_authority = models.CharField(max_length=200)
    tax_registration_number = models.CharField(max_length=50, blank=True)
    is_active = models.BooleanField(default=True)
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    
    # Tax Configuration
    default_tax_rate = models.DecimalField(max_digits=10, decimal_places=4, null=True, blank=True)
    tax_calculation_method = models.CharField(
        max_length=20,
        choices=[
            ('PERCENTAGE', 'Percentage'),
            ('FIXED', 'Fixed Amount'),
            ('TIERED', 'Tiered Rates'),
            ('COMPOUND', 'Compound Tax'),
        ],
        default='PERCENTAGE'
    )
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_tax_jurisdictions'
        verbose_name = 'Tax Jurisdiction'
        verbose_name_plural = 'Tax Jurisdictions'
        indexes = [
            models.Index(fields=['company_id', 'jurisdiction_code'], name='idx_tj_company_code'),
            models.Index(fields=['country_code'], name='idx_tj_country'),
            models.Index(fields=['is_active'], name='idx_tj_active'),
            models.Index(fields=['parent_jurisdiction_id'], name='idx_tj_parent'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'jurisdiction_code'], name='uk_tj_company_code'),
        ]

class TaxRate(models.Model):
    """
    Tax rate configuration for different tax types and jurisdictions
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    jurisdiction_id = models.UUIDField()
    tax_type = models.CharField(
        max_length=30,
        choices=[
            ('SALES_TAX', 'Sales Tax'),
            ('VAT', 'Value Added Tax'),
            ('GST', 'Goods and Services Tax'),
            ('SERVICE_TAX', 'Service Tax'),
            ('EXCISE', 'Excise Tax'),
            ('CUSTOMS', 'Customs Duty'),
            ('INCOME_TAX', 'Income Tax'),
            ('WITHHOLDING_TAX', 'Withholding Tax'),
        ]
    )
    tax_code = models.CharField(max_length=20)
    tax_name = models.CharField(max_length=200)
    rate_percentage = models.DecimalField(max_digits=10, decimal_places=4)
    is_compound = models.BooleanField(default=False)
    is_recoverable = models.BooleanField(default=True)
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_tax_rates'
        verbose_name = 'Tax Rate'
        verbose_name_plural = 'Tax Rates'
        indexes = [
            models.Index(fields=['company_id', 'jurisdiction_id', 'tax_type'], name='idx_tr_company_jur_type'),
            models.Index(fields=['tax_code'], name='idx_tr_code'),
            models.Index(fields=['is_active'], name='idx_tr_active'),
        ]
        constraints = [
            models.UniqueConstraint(
                fields=['company_id', 'jurisdiction_id', 'tax_code'], 
                name='uk_tr_company_jur_code'
            ),
        ]

class TaxRule(models.Model):
    """
    Tax calculation rules and conditions
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    jurisdiction_id = models.UUIDField()
    tax_rate_id = models.UUIDField()
    rule_name = models.CharField(max_length=200)
    rule_condition = models.TextField()  # JSON condition logic
    rule_action = models.TextField()     # JSON action logic
    priority = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_tax_rules'
        verbose_name = 'Tax Rule'
        verbose_name_plural = 'Tax Rules'
        indexes = [
            models.Index(fields=['company_id', 'jurisdiction_id'], name='idx_trule_company_jur'),
            models.Index(fields=['tax_rate_id'], name='idx_trule_rate'),
            models.Index(fields=['priority'], name='idx_trule_priority'),
            models.Index(fields=['is_active'], name='idx_trule_active'),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 Company**

```python
class Company(models.Model):
    """
    Reference to company for multi-tenant support
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_name = models.CharField(max_length=200)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'fms_companies'
        verbose_name = 'Company'
        verbose_name_plural = 'Companies'
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPS**

### **5.1 Primary Relationships**
- **TaxJurisdiction** → **Company**: Multi-tenant support through company_id
- **TaxRate** → **TaxJurisdiction**: Many-to-one relationship for jurisdiction-based rates
- **TaxRule** → **TaxJurisdiction**: Many-to-one relationship for jurisdiction-based rules
- **TaxRule** → **TaxRate**: Many-to-one relationship for rate-based rules

### **5.2 Many-to-Many Relationships**
- **TaxJurisdiction** ↔ **TaxRate**: Through tax rules for conditional application
- **TaxJurisdiction** ↔ **Parent Jurisdiction**: Self-referencing for hierarchical tax structures

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**
- Tax jurisdiction codes must be unique within each company
- Tax rates cannot overlap for the same jurisdiction and tax type
- Tax rules must have valid JSON condition and action logic
- Parent jurisdiction relationships cannot create circular dependencies
- Tax registration numbers must follow country-specific formats

### **6.2 Validation Logic**

```python
def clean_jurisdiction_code(self):
    """
    Validate tax jurisdiction code format and uniqueness
    """
    if not re.match(r'^[A-Z0-9]{2,10}$', self.jurisdiction_code):
        raise ValidationError("Jurisdiction code must be 2-10 uppercase alphanumeric characters")
    
    # Check uniqueness within company
    if TaxJurisdiction.objects.filter(
        company_id=self.company_id,
        jurisdiction_code=self.jurisdiction_code
    ).exclude(id=self.id).exists():
        raise ValidationError("Jurisdiction code must be unique within company")

def clean_tax_rate_percentage(self):
    """
    Validate tax rate percentage is within valid range
    """
    if self.rate_percentage < 0 or self.rate_percentage > 100:
        raise ValidationError("Tax rate percentage must be between 0 and 100")

def clean_effective_dates(self):
    """
    Validate effective and expiry dates
    """
    if self.effective_date and self.expiry_date:
        if self.effective_date >= self.expiry_date:
            raise ValidationError("Effective date must be before expiry date")

def clean_parent_jurisdiction(self):
    """
    Validate parent jurisdiction to prevent circular dependencies
    """
    if self.parent_jurisdiction_id:
        # Check for circular reference
        current = self.parent_jurisdiction_id
        while current:
            if current == self.id:
                raise ValidationError("Circular jurisdiction reference detected")
            try:
                parent = TaxJurisdiction.objects.get(id=current)
                current = parent.parent_jurisdiction_id
            except TaxJurisdiction.DoesNotExist:
                break
```

### **6.3 Business Constraints**
- Cannot delete tax jurisdictions with active tax rates
- Cannot modify tax rates if they are used in active transactions
- Cannot deactivate tax jurisdictions used in current fiscal period
- Tax rules must be compatible with jurisdiction tax calculation methods
- Tax registration numbers must be validated against tax authority databases

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**
- **Layout:** Master-detail layout with jurisdiction hierarchy tree and configuration panels
- **Navigation:** Tabbed interface for different tax configuration sections (Jurisdictions, Rates, Rules)
- **Responsiveness:** Full desktop experience with tablet support for tax configuration tasks

### **7.2 User Experience Design**
- **User Flow:** Browse jurisdictions → Select jurisdiction → Configure rates → Set rules → Test calculations → Save
- **Error Handling:** Inline validation with clear error messages for tax configuration conflicts
- **Loading States:** Progress indicators for tax calculation testing and validation

### **7.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility for all tax configuration controls
- **Screen Reader Support:** Comprehensive ARIA labels for complex tax form relationships

### **7.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **7.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **7.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **7.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **7.8 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **7.9 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, jurisdiction type filter, country filter, status filter
- **Filter Actions:** Apply, Clear, Reset buttons

### **7.10 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

## **8.1 External Systems**
- **Tax Authority APIs:** Integration with government tax databases for rate validation
- **Currency Exchange APIs:** Real-time currency conversion for multi-jurisdiction tax calculations
- **Compliance Services:** External tax compliance monitoring and reporting services
- **Geolocation Services:** Automatic tax jurisdiction detection based on location data

## **8.2 Internal APIs**
- **Financial Transaction API:** Tax calculation integration for transaction processing
- **User Management API:** Role-based access control for tax configuration
- **Audit Trail API:** Complete audit logging for all tax configuration operations
- **Reporting API:** Tax data export and integration with financial reports

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

## **9.1 REST Endpoints**

#### **GET /api/tax-jurisdictions/**
- **Purpose:** Retrieve all tax jurisdictions for a company
- **Authentication:** JWT token required
- **Parameters:** company_id, country_code, jurisdiction_type, is_active
- **Response:** List of tax jurisdiction objects with hierarchical structure

#### **POST /api/tax-jurisdictions/**
- **Purpose:** Create new tax jurisdiction
- **Authentication:** JWT token required
- **Request Body:** Tax jurisdiction configuration with validation rules
- **Response:** Created tax jurisdiction object with validation results

#### **PUT /api/tax-jurisdictions/{id}/**
- **Purpose:** Update existing tax jurisdiction
- **Authentication:** JWT token required
- **Request Body:** Updated tax jurisdiction configuration
- **Response:** Updated tax jurisdiction object with change tracking

#### **GET /api/tax-rates/**
- **Purpose:** Retrieve tax rates for jurisdictions
- **Authentication:** JWT token required
- **Parameters:** company_id, jurisdiction_id, tax_type, effective_date
- **Response:** List of tax rate objects with applicability dates

#### **POST /api/tax-rates/**
- **Purpose:** Create new tax rate
- **Authentication:** JWT token required
- **Request Body:** Tax rate configuration with jurisdiction reference
- **Response:** Created tax rate object with validation results

#### **POST /api/tax-calculate/**
- **Purpose:** Calculate tax for transaction
- **Authentication:** JWT token required
- **Request Body:** Transaction amount, jurisdiction, tax type, date
- **Response:** Tax calculation results with applied rates and rules

#### **GET /api/tax-rules/**
- **Purpose:** Retrieve tax calculation rules
- **Authentication:** JWT token required
- **Parameters:** company_id, jurisdiction_id, tax_rate_id, is_active
- **Response:** List of tax rule objects with condition logic

## **9.2 Data Formats**
- **Request Format:** JSON with proper tax rate and jurisdiction validation
- **Response Format:** JSON with standardized tax calculation data
- **Error Format:** JSON with tax-specific error details and validation messages

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

## **10.1 Authentication**
- **Method:** JWT-based authentication with role-based access control
- **Authorization:** Tax configuration permissions (view, create, edit, delete, admin)
- **Session Management:** Secure session handling with automatic timeout

## **10.2 Data Protection**
- **Encryption:** AES-256 encryption for sensitive tax data
- **Data Masking:** Partial masking of tax registration numbers in logs
- **Audit Trail:** Complete audit logging for all tax configuration operations

## **10.3 Access Control**
- **Permissions:**
  - tax_jurisdictions_view: View tax jurisdiction configurations
  - tax_jurisdictions_create: Create new tax jurisdictions
  - tax_jurisdictions_edit: Modify existing tax jurisdictions
  - tax_jurisdictions_delete: Deactivate tax jurisdictions
  - tax_rates_manage: Full tax rate management access
  - tax_admin: Full administrative access
- **Roles:** Tax Manager, Finance Director, Compliance Officer, System Administrator
- **Audit Trail:** Complete audit logging for all tax operations

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

## **11.1 Database Optimization**
- **Indexing Strategy:** Optimized indexes for tax jurisdiction and rate queries
- **Query Optimization:** Efficient queries for tax calculation and rate lookups
- **Connection Pooling:** Database connection management for concurrent tax calculations

## **11.2 Caching Strategy**
- **Cache Layers:** Redis caching for frequently accessed tax rates and rules
- **Cache Invalidation:** Time-based and event-driven cache invalidation for tax updates
- **Performance Metrics:** Tax calculation performance and accuracy rates

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

## **12.1 Unit Tests**
- **Coverage Target:** 95% code coverage for tax models and business logic
- **Test Framework:** pytest with Django test framework
- **Test Data:** Comprehensive test data for various tax scenarios and jurisdictions

## **12.2 Integration Tests**
- **API Testing:** Complete API endpoint testing for tax operations
- **Tax Calculation Testing:** Tax rule accuracy and performance validation
- **Jurisdiction Testing:** Hierarchical tax structure validation

## **12.3 User Acceptance Tests**
- **UAT Scenarios:** End-to-end tax configuration workflows
- **User Stories:** Jurisdiction setup, rate configuration, rule testing, calculation validation
- **Acceptance Criteria:** Accurate tax calculation with proper jurisdiction handling

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

## **13.1 Environment Requirements**
- **Development:** Local development with sample tax configurations
- **Staging:** Pre-production environment with full tax calculation testing
- **Production:** High-availability setup with scalable tax calculation capabilities

## **13.2 Configuration Management**
- **Settings:** Tax configuration parameters and calculation rules
- **Environment Variables:** API keys for tax authority services
- **Secrets Management:** Secure storage of sensitive tax configuration data

## **13.3 Monitoring & Logging**
- **Application Logs:** Tax operation logs with detailed audit trails
- **Performance Metrics:** Tax calculation performance and accuracy rates
- **Error Tracking:** Real-time error monitoring and alerting

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

## **14.1 Regular Maintenance**
- **Database Maintenance:** Monthly tax rate updates and archiving
- **Performance Tuning:** Quarterly performance optimization for tax calculations
- **Compliance Updates:** Regular updates to tax rules and jurisdiction data

## **14.2 Support Procedures**
- **Issue Tracking:** Ticket system integration for tax configuration issues
- **Knowledge Base:** Documentation for tax configuration procedures
- **User Training:** Training programs for tax managers and finance staff

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

## **15.1 Version History**
- **v1.0.0:** Initial release with basic tax jurisdiction management
- **v1.1.0:** Added advanced tax rules and conditional logic
- **v1.2.0:** Enhanced multi-jurisdiction tax calculation capabilities

## **15.2 Change Management**
- **Release Process:** Structured release process with backward compatibility
- **Rollback Procedures:** Emergency rollback capabilities for critical tax issues
- **Migration Scripts:** Data migration scripts for tax schema updates

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

## **16.1 Regulatory Compliance**
- **Tax Regulations:** Compliance with international tax standards and regulations
- **Data Protection:** GDPR and data protection compliance for tax data
- **Financial Standards:** Compliance with financial reporting standards
- **Audit Requirements:** Professional audit standards for tax configuration management

## **16.2 Audit Requirements**
- **Audit Trail:** Complete audit trail for all tax configuration operations and changes
- **Tax Reports:** Automated generation of tax compliance reports
- **Change Documentation:** Comprehensive documentation of all tax configuration changes
- **Security Controls:** Proper segregation of duties and access controls for tax data

--- END OF SECTION 16 ---

**END OF GLOBAL TAX MANAGEMENT BBP**
