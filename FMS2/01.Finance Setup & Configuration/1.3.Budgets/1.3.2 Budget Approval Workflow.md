# FMS BBP - Budget Approval Workflow

## **1. MODULE IDENTIFICATION**

**Module Name:** Budget Approval Workflow
**Module Number:** 1.8.2
**Module Type:** Workflow
**Target File:** FMS/01.Finance Setup & Configuration/1.8.Budgets/1.8.2 Budget Approval Workflow.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Budget Approval Workflow module provides comprehensive configuration and management of budget approval processes, enabling multi-level approval hierarchies, automated routing, and audit trails for budget submissions, ensuring proper financial governance and control over budget allocations and expenditures.

### **2.2 Business Scope**
**In Scope:**
- Budget approval workflow configuration and management
- Multi-level approval hierarchy setup
- Approval routing and escalation rules
- Budget submission and approval tracking
- Approval condition and threshold management
- Workflow automation and notifications
- Approval audit trail and documentation
- Integration with budget templates and financial modules

**Out of Scope:**
- Actual budget template creation (handled by Budget Templates module)
- Budget execution and monitoring (handled by Budget vs Actual module)
- Financial transaction processing (handled by transaction modules)
- Budget reporting and analytics (handled by Analytics module)

### **2.3 Key Stakeholders**
- **Finance Managers:** Workflow configuration and approval oversight
- **Department Heads:** Budget submission and approval participation
- **Budget Owners:** Budget preparation and workflow initiation
- **Compliance Officers:** Approval process audit and governance
- **System Administrators:** Workflow system maintenance and configuration

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: BudgetApprovalWorkflow**

```python
class BudgetApprovalWorkflow(models.Model):
    """
    Master budget approval workflow configuration for multi-level approval processes
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    workflow_name = models.CharField(max_length=200)
    workflow_code = models.CharField(max_length=50)
    workflow_description = models.TextField(blank=True)
    workflow_type = models.CharField(
        max_length=30,
        choices=[
            ('DEPARTMENTAL', 'Departmental Budget'),
            ('PROJECT', 'Project Budget'),
            ('COST_CENTER', 'Cost Center Budget'),
            ('CAPITAL', 'Capital Budget'),
            ('OPERATING', 'Operating Budget'),
            ('CONTINGENCY', 'Contingency Budget'),
        ]
    )
    budget_template_id = models.UUIDField()
    is_active = models.BooleanField(default=True)
    is_default = models.BooleanField(default=False)
    
    # Workflow Configuration
    max_approval_levels = models.IntegerField(default=3)
    auto_approve_threshold = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    escalation_enabled = models.BooleanField(default=True)
    parallel_approval_enabled = models.BooleanField(default=False)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_budget_approval_workflows'
        verbose_name = 'Budget Approval Workflow'
        verbose_name_plural = 'Budget Approval Workflows'
        indexes = [
            models.Index(fields=['company_id', 'workflow_code'], name='idx_baw_company_code'),
            models.Index(fields=['workflow_type'], name='idx_baw_type'),
            models.Index(fields=['budget_template_id'], name='idx_baw_template'),
            models.Index(fields=['is_active'], name='idx_baw_active'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'workflow_code'], name='uk_baw_company_code'),
        ]

class BudgetApprovalStep(models.Model):
    """
    Individual approval steps within a budget approval workflow
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    budget_approval_workflow_id = models.UUIDField()
    step_number = models.IntegerField()
    step_name = models.CharField(max_length=200)
    step_description = models.TextField(blank=True)
    
    # Approval Configuration
    approval_type = models.CharField(
        max_length=30,
        choices=[
            ('SINGLE', 'Single Approver'),
            ('MAJORITY', 'Majority Approval'),
            ('UNANIMOUS', 'Unanimous Approval'),
            ('PARALLEL', 'Parallel Approval'),
            ('SEQUENTIAL', 'Sequential Approval'),
        ],
        default='SINGLE'
    )
    required_approvers = models.IntegerField(default=1)
    timeout_hours = models.IntegerField(default=72)
    
    # Step Conditions
    amount_threshold_min = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    amount_threshold_max = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    department_filter = models.TextField(blank=True)  # JSON filter conditions
    cost_center_filter = models.TextField(blank=True)  # JSON filter conditions
    
    # Configuration
    is_mandatory = models.BooleanField(default=True)
    is_active = models.BooleanField(default=True)
    escalation_step_id = models.UUIDField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_budget_approval_steps'
        verbose_name = 'Budget Approval Step'
        verbose_name_plural = 'Budget Approval Steps'
        indexes = [
            models.Index(fields=['company_id', 'budget_approval_workflow_id'], name='idx_bas_company_workflow'),
            models.Index(fields=['step_number'], name='idx_bas_step_number'),
            models.Index(fields=['approval_type'], name='idx_bas_type'),
            models.Index(fields=['is_active'], name='idx_bas_active'),
        ]
        constraints = [
            models.UniqueConstraint(
                fields=['company_id', 'budget_approval_workflow_id', 'step_number'], 
                name='uk_bas_company_workflow_step'
            ),
        ]

class BudgetApprovalStepApprover(models.Model):
    """
    Approvers assigned to specific budget approval steps
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    budget_approval_step_id = models.UUIDField()
    approver_type = models.CharField(
        max_length=30,
        choices=[
            ('USER', 'Specific User'),
            ('ROLE', 'Role-based'),
            ('DEPARTMENT_HEAD', 'Department Head'),
            ('COST_CENTER_MANAGER', 'Cost Center Manager'),
            ('FINANCE_MANAGER', 'Finance Manager'),
            ('EXECUTIVE', 'Executive Level'),
        ]
    )
    approver_id = models.UUIDField(null=True, blank=True)  # User ID or Role ID
    approver_name = models.CharField(max_length=200)
    approver_email = models.EmailField(blank=True)
    is_backup_approver = models.BooleanField(default=False)
    is_active = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_budget_approval_step_approvers'
        verbose_name = 'Budget Approval Step Approver'
        verbose_name_plural = 'Budget Approval Step Approvers'
        indexes = [
            models.Index(fields=['company_id', 'budget_approval_step_id'], name='idx_basa_company_step'),
            models.Index(fields=['approver_type'], name='idx_basa_type'),
            models.Index(fields=['approver_id'], name='idx_basa_approver'),
            models.Index(fields=['is_active'], name='idx_basa_active'),
        ]
```

--- END OF SECTION 3 ---
