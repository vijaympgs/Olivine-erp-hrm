# FMS BBP - Budget Templates

## **1. MODULE IDENTIFICATION**

**Module Name:** Budget Templates
**Module Number:** 1.8.1
**Module Type:** Master
**Target File:** FMS/01.Finance Setup & Configuration/1.8.Budgets/1.8.1 Budget Templates.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Budget Templates module provides comprehensive configuration and management of standardized budget templates, enabling consistent budget creation, allocation, and tracking across departments, cost centers, and projects with predefined structures, formulas, and approval workflows for financial planning and control.

### **2.2 Business Scope**
**In Scope:**
- Budget template creation and configuration
- Template structure and hierarchy management
- Budget period and frequency setup
- Cost center and department mapping
- Budget calculation formulas and rules
- Template versioning and change management
- Budget allocation and distribution rules
- Integration with financial planning modules

**Out of Scope:**
- Actual budget execution and monitoring (handled by Budget vs Actual module)
- Budget approval workflows (handled by Budget Approval Workflow module)
- Financial transaction processing (handled by transaction modules)
- Budget reporting and analytics (handled by Analytics module)

### **2.3 Key Stakeholders**
- **Finance Managers:** Budget template configuration and management
- **Department Heads:** Budget allocation and planning oversight
- **Cost Center Managers:** Budget structure and formula setup
- **Financial Planners:** Budget template design and implementation
- **Compliance Officers:** Budget policy and regulatory compliance

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: BudgetTemplate**

```python
class BudgetTemplate(models.Model):
    """
    Master budget template configuration for standardized budget creation
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    template_name = models.CharField(max_length=200)
    template_code = models.CharField(max_length=50)
    template_description = models.TextField(blank=True)
    template_type = models.CharField(
        max_length=30,
        choices=[
            ('DEPARTMENTAL', 'Departmental Budget'),
            ('PROJECT', 'Project Budget'),
            ('COST_CENTER', 'Cost Center Budget'),
            ('CAPITAL', 'Capital Budget'),
            ('OPERATING', 'Operating Budget'),
            ('CASH_FLOW', 'Cash Flow Budget'),
            ('REVENUE', 'Revenue Budget'),
            ('EXPENSE', 'Expense Budget'),
        ]
    )
    budget_period = models.CharField(
        max_length=20,
        choices=[
            ('MONTHLY', 'Monthly'),
            ('QUARTERLY', 'Quarterly'),
            ('HALF_YEARLY', 'Half-Yearly'),
            ('ANNUAL', 'Annual'),
            ('BI_ANNUAL', 'Bi-Annual'),
            ('CUSTOM', 'Custom Period'),
        ]
    )
    currency_id = models.UUIDField()
    default_version = models.CharField(max_length=20, default='1.0')
    is_active = models.BooleanField(default=True)
    is_system_defined = models.BooleanField(default=False)
    
    # Template Configuration
    template_structure = models.TextField()  # JSON structure definition
    calculation_rules = models.TextField()   # JSON calculation formulas
    allocation_rules = models.TextField()    # JSON allocation logic
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_budget_templates'
        verbose_name = 'Budget Template'
        verbose_name_plural = 'Budget Templates'
        indexes = [
            models.Index(fields=['company_id', 'template_code'], name='idx_bt_company_code'),
            models.Index(fields=['template_type'], name='idx_bt_type'),
            models.Index(fields=['budget_period'], name='idx_bt_period'),
            models.Index(fields=['is_active'], name='idx_bt_active'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'template_code'], name='uk_bt_company_code'),
        ]

class BudgetTemplateLine(models.Model):
    """
    Budget template line items with detailed structure and formulas
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    budget_template_id = models.UUIDField()
    line_number = models.IntegerField()
    line_name = models.CharField(max_length=200)
    line_description = models.TextField(blank=True)
    line_type = models.CharField(
        max_length=30,
        choices=[
            ('REVENUE', 'Revenue Line'),
            ('EXPENSE', 'Expense Line'),
            ('ASSET', 'Asset Line'),
            ('LIABILITY', 'Liability Line'),
            ('EQUITY', 'Equity Line'),
            ('CALCULATION', 'Calculation Line'),
            ('HEADER', 'Header Line'),
            ('TOTAL', 'Total Line'),
        ]
    )
    account_id = models.UUIDField(null=True, blank=True)
    cost_center_id = models.UUIDField(null=True, blank=True)
    department_id = models.UUIDField(null=True, blank=True)
    
    # Calculation Fields
    calculation_method = models.CharField(
        max_length=30,
        choices=[
            ('FIXED_AMOUNT', 'Fixed Amount'),
            ('PERCENTAGE', 'Percentage Based'),
            ('FORMULA', 'Formula Based'),
            ('HISTORICAL', 'Historical Based'),
            ('MANUAL', 'Manual Entry'),
        ],
        default='MANUAL'
    )
    calculation_formula = models.TextField(blank=True)  # JSON formula definition
    default_amount = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    percentage_base = models.CharField(max_length=200, blank=True)
    
    # Configuration
    is_mandatory = models.BooleanField(default=False)
    is_editable = models.BooleanField(default=True)
    display_order = models.IntegerField(default=0)
    parent_line_id = models.UUIDField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_budget_template_lines'
        verbose_name = 'Budget Template Line'
        verbose_name_plural = 'Budget Template Lines'
        indexes = [
            models.Index(fields=['company_id', 'budget_template_id'], name='idx_btl_company_template'),
            models.Index(fields=['line_type'], name='idx_btl_type'),
            models.Index(fields=['display_order'], name='idx_btl_order'),
            models.Index(fields=['parent_line_id'], name='idx_btl_parent'),
        ]
        constraints = [
            models.UniqueConstraint(
                fields=['company_id', 'budget_template_id', 'line_number'], 
                name='uk_btl_company_template_line'
            ),
        ]

class BudgetTemplateVersion(models.Model):
    """
    Budget template version control and change management
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    budget_template_id = models.UUIDField()
    version_number = models.CharField(max_length=20)
    version_description = models.TextField(blank=True)
    change_summary = models.TextField(blank=True)
    
    # Version Control
    is_active = models.BooleanField(default=False)
    is_current = models.BooleanField(default=False)
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    
    # Change Tracking
    created_by_user_id = models.UUIDField()
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    approval_date = models.DateTimeField(null=True, blank=True)
    approval_status = models.CharField(
        max_length=20,
        choices=[
            ('DRAFT', 'Draft'),
            ('PENDING_APPROVAL', 'Pending Approval'),
            ('APPROVED', 'Approved'),
            ('REJECTED', 'Rejected'),
            ('ARCHIVED', 'Archived'),
        ],
        default='DRAFT'
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_budget_template_versions'
        verbose_name = 'Budget Template Version'
        verbose_name_plural = 'Budget Template Versions'
        indexes = [
            models.Index(fields=['company_id', 'budget_template_id'], name='idx_btv_company_template'),
            models.Index(fields=['version_number'], name='idx_btv_version'),
            models.Index(fields=['is_current'], name='idx_btv_current'),
            models.Index(fields=['approval_status'], name='idx_btv_status'),
        ]
        constraints = [
            models.UniqueConstraint(
                fields=['company_id', 'budget_template_id', 'version_number'], 
                name='uk_btv_company_template_version'
            ),
        ]
```

--- END OF SECTION 3 ---
