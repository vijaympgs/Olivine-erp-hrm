# FMS BBP - Account Groups

## **1. MODULE IDENTIFICATION**

**Module Name:** Account Groups
**Module Number:** 1.2
**Module Type:** Master
**Target File:** FMS/01.Finance Setup & Configuration/1.2 Account Groups.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Account Groups module provides a hierarchical structure for organizing and categorizing chart of accounts into logical groups, enabling better financial reporting, analysis, and management oversight through systematic account classification and grouping.

### **2.2 Business Scope**
**In Scope:**
- Account group hierarchy management
- Group classification and categorization
- Parent-child group relationships
- Group-level reporting and analysis
- Multi-level group structures
- Group-based access controls

**Out of Scope:**
- Individual account management (handled by Chart of Accounts)
- Transaction processing (handled by Journal Entries)
- Financial reporting generation (handled by Analytics module)

### **2.3 Key Stakeholders**
- **Chief Financial Officer:** Strategic group structure oversight
- **Finance Managers:** Group hierarchy management and reporting
- **Accountants:** Account assignment to groups
- **Auditors:** Group structure validation and compliance
- **System Administrators:** Group configuration and maintenance

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: AccountGroup**

```python
class AccountGroup(models.Model):
    """
    Account groups for organizing chart of accounts into hierarchical structures
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    parent_group_id = models.UUIDField(null=True, blank=True)
    
    # Core Fields
    group_code = models.CharField(max_length=20)
    group_name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    group_type = models.CharField(
        max_length=20,
        choices=[
            ('ASSET', 'Asset Groups'),
            ('LIABILITY', 'Liability Groups'),
            ('EQUITY', 'Equity Groups'),
            ('REVENUE', 'Revenue Groups'),
            ('EXPENSE', 'Expense Groups'),
            ('CONTRA_ASSET', 'Contra Asset Groups'),
            ('CONTRA_REVENUE', 'Contra Revenue Groups'),
        ]
    )
    group_category = models.CharField(
        max_length=50,
        choices=[
            ('BALANCE_SHEET', 'Balance Sheet Groups'),
            ('INCOME_STATEMENT', 'Income Statement Groups'),
            ('CASH_FLOW', 'Cash Flow Groups'),
            ('MANAGEMENT', 'Management Reporting Groups'),
            ('REGULATORY', 'Regulatory Reporting Groups'),
        ]
    )
    level = models.IntegerField(default=1)
    sort_order = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)
    is_consolidated = models.BooleanField(default=False)
    is_reporting_group = models.BooleanField(default=True)
    minimum_level = models.IntegerField(default=1)
    maximum_level = models.IntegerField(default=10)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_account_groups'
        verbose_name = 'Account Group'
        verbose_name_plural = 'Account Groups'
        indexes = [
            models.Index(fields=['company_id', 'group_code'], name='idx_ag_company_code'),
            models.Index(fields=['company_id', 'group_type'], name='idx_ag_company_type'),
            models.Index(fields=['parent_group_id'], name='idx_ag_parent'),
            models.Index(fields=['level'], name='idx_ag_level'),
            models.Index(fields=['is_active'], name='idx_ag_active'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'group_code'], name='uk_ag_company_code'),
            models.CheckConstraint(check=models.Q(level__gte=1), name='ck_ag_level_positive'),
            models.CheckConstraint(
                check=models.Q(minimum_level__lte=models.F('maximum_level')),
                name='ck_ag_level_range'
            ),
        ]

class AccountGroupMapping(models.Model):
    """
    Mapping between accounts and groups for many-to-many relationships
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    account_id = models.UUIDField()
    group_id = models.UUIDField()
    is_primary_group = models.BooleanField(default=False)
    assignment_date = models.DateField(auto_now_add=True)
    assigned_by_user_id = models.UUIDField()
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_account_group_mappings'
        verbose_name = 'Account Group Mapping'
        verbose_name_plural = 'Account Group Mappings'
        indexes = [
            models.Index(fields=['account_id', 'group_id'], name='idx_agm_account_group'),
            models.Index(fields=['group_id'], name='idx_agm_group'),
            models.Index(fields=['is_primary_group'], name='idx_agm_primary'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['account_id', 'group_id'], name='uk_agm_account_group'),
        ]

class AccountGroupTemplate(models.Model):
    """
    Predefined account group templates for quick setup
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    created_by_user_id = models.UUIDField()
    
    template_name = models.CharField(max_length=100)
    template_code = models.CharField(max_length=20, unique=True)
    description = models.TextField(blank=True)
    template_type = models.CharField(
        max_length=20,
        choices=[
            ('STANDARD', 'Standard Chart'),
            ('MANUFACTURING', 'Manufacturing'),
            ('SERVICE', 'Service Industry'),
            ('RETAIL', 'Retail'),
            ('NON_PROFIT', 'Non-Profit'),
            ('FINANCIAL', 'Financial Services'),
        ]
    )
    industry_type = models.CharField(max_length=50, blank=True)
    country_code = models.CharField(max_length=3, blank=True)
    is_active = models.BooleanField(default=True)
    template_data = models.JSONField(default=dict)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_account_group_templates'
        verbose_name = 'Account Group Template'
        verbose_name_plural = 'Account Group Templates'
        indexes = [
            models.Index(fields=['template_code'], name='idx_agt_template_code'),
            models.Index(fields=['template_type'], name='idx_agt_template_type'),
            models.Index(fields=['is_active'], name='idx_agt_active'),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 GroupType**

```python
class GroupType(models.Model):
    """
    Reference data for account group types
    """
    
    group_type_code = models.CharField(max_length=20, primary_key=True)
    group_type_name = models.CharField(max_length=50)
    description = models.TextField(blank=True)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'ref_group_types'
        verbose_name = 'Group Type'
        verbose_name_plural = 'Group Types'
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPS**

### **5.1 Primary Relationships**
- **AccountGroup** → **AccountGroup**: Self-referencing relationship for parent-child hierarchy
- **AccountGroupMapping** → **AccountGroup**: Many-to-one relationship for group assignment
- **AccountGroupMapping** → **ChartOfAccount**: Many-to-one relationship for account mapping

### **5.2 Many-to-Many Relationships**
- **AccountGroup** ↔ **ChartOfAccount**: Through AccountGroupMapping model
- **AccountGroup** ↔ **Company**: Multi-tenant support through company_id

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**
- Group codes must be unique within each company
- Parent groups must exist and be at higher level than child groups
- Group hierarchy cannot exceed maximum defined depth
- Group types must be consistent within hierarchy levels
- Primary group assignments must be unique per account

### **6.2 Validation Logic**

```python
def clean_group_code(self):
    """
    Validate group code format and uniqueness
    """
    if not re.match(r'^[A-Z0-9\-]+$', self.group_code):
        raise ValidationError("Group code can only contain uppercase letters, numbers, and hyphens")
    
    # Check uniqueness within company
    if AccountGroup.objects.filter(
        company_id=self.company_id,
        group_code=self.group_code
    ).exclude(id=self.id).exists():
        raise ValidationError("Group code must be unique within company")

def clean_group_hierarchy(self):
    """
    Validate parent-child relationship and hierarchy consistency
    """
    if self.parent_group_id:
        parent = AccountGroup.objects.get(id=self.parent_group_id)
        if parent.level >= self.level:
            raise ValidationError("Parent group must be at higher level than child group")
        if parent.company_id != self.company_id:
            raise ValidationError("Parent group must belong to same company")
        if parent.group_type != self.group_type:
            raise ValidationError("Parent and child groups must be of same type")

def clean_level_consistency(self):
    """
    Validate level consistency with hierarchy
    """
    if self.parent_group_id:
        parent = AccountGroup.objects.get(id=self.parent_group_id)
        expected_level = parent.level + 1
        if self.level != expected_level:
            raise ValidationError(f"Group level must be {expected_level} based on parent level")
```

### **6.3 Business Constraints**
- Cannot delete parent groups with active child groups
- Cannot deactivate groups with assigned accounts
- Cannot modify group type if accounts are assigned
- Group templates cannot be modified if in use
- Maximum hierarchy depth is 10 levels

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**
- **Layout:** Tree view with expand/collapse functionality
- **Navigation:** Hierarchical navigation with breadcrumb trail
- **Responsiveness:** Full desktop experience with tablet support

### **7.2 User Experience Design**
- **User Flow:** Browse tree → Select group → View/Edit details → Manage assignments
- **Error Handling:** Inline validation with clear error messages
- **Loading States:** Progress indicators for bulk operations

### **7.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility
- **Screen Reader Support:** Comprehensive ARIA labels

### **7.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **7.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **7.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **7.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **7.8 Border & Shadow System**
- **Border Radius:**
  - **None:** 0px
  - **SM:** 4px
  - **MD:** 8px
  - **LG:** 12px
  - **XL:** 16px
- **Box Shadows:**
  - **SM:** 0 1px 2px 0 rgba(0, 0, 0, 0.05)
  - **MD:** 0 4px 6px -1px rgba(0, 0, 0, 0.1)
  - **LG:** 0 10px 15px -3px rgba(0, 0, 0, 0.1)

### **7.9 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **7.10 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, group type filter, status filter, level filter
- **Filter Actions:** Apply, Clear, Reset buttons

### **7.11 Data Display Standards**
- **Tree View:**
  - **Node Height:** 48px
  - **Indent:** 24px per level
  - **Hover State:** Background #f5f5f5
  - **Selected State:** Background #e3f2fd

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

### **8.1 External Systems**
- **ERP Systems:** Group structure synchronization
- **Reporting Systems:** Group-based reporting data
- **Compliance Systems:** Regulatory group mappings

### **8.2 Internal APIs**
- **Chart of Accounts API:** Account assignment and validation
- **Financial Reports API:** Group-based report generation
- **Budget Management API:** Group budget allocation

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

### **9.1 REST Endpoints**

#### **GET /api/fms/account-groups/**
- **Purpose:** Retrieve account groups list
- **Authentication:** JWT token required
- **Parameters:** company_id, group_type, is_active, parent_group_id
- **Response:** Paginated group list with hierarchy

#### **POST /api/fms/account-groups/**
- **Purpose:** Create new account group
- **Authentication:** JWT token required
- **Request Body:** Group details
- **Response:** Created group object

#### **PUT /api/fms/account-groups/{id}/**
- **Purpose:** Update existing account group
- **Authentication:** JWT token required
- **Request Body:** Updated group details
- **Response:** Updated group object

#### **POST /api/fms/account-groups/{id}/assign-accounts/**
- **Purpose:** Assign accounts to group
- **Authentication:** JWT token required
- **Request Body:** Account IDs and assignment details
- **Response:** Assignment confirmation

### **9.2 Data Formats**
- **Request Format:** JSON
- **Response Format:** JSON
- **Error Format:** {"error": "message", "code": "ERROR_CODE"}

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

### **10.1 Authentication**
- **Method:** JWT-based authentication
- **Authorization:** Role-based access control
- **Session Management:** Token refresh mechanism

### **10.2 Data Protection**
- **Encryption:** AES-256 encryption for sensitive data
- **Masking:** Group code masking in logs
- **Backup:** Daily encrypted backups

### **10.3 Access Control**
- **Permissions:** Create, Read, Update, Delete permissions by role
- **Roles:** Finance Manager, Accountant, Auditor, Viewer
- **Audit Trail:** Complete audit logging for all changes

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

### **11.1 Database Optimization**
- **Indexing Strategy:** Composite indexes on company_id + group_code
- **Query Optimization:** Optimized hierarchical queries using CTE
- **Connection Pooling:** pgbouncer connection pooling

### **11.2 Caching Strategy**
- **Cache Layers:** Redis for group hierarchy caching
- **Cache Invalidation:** Cache invalidation on group changes
- **Performance Metrics:** Query response time < 200ms

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

### **12.1 Unit Tests**
- **Coverage Target:** 90% code coverage
- **Test Framework:** pytest with Django test extensions
- **Test Data:** Factory Boy for test data generation

### **12.2 Integration Tests**
- **API Testing:** DRF test client for endpoint testing
- **Database Testing:** PostgreSQL integration testing
- **Third-party Testing:** Mock external system calls

### **12.3 User Acceptance Tests**
- **UAT Scenarios:** Complete group management workflows
- **User Stories:** All user story acceptance criteria
- **Acceptance Criteria:** Functional and non-functional requirements

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

### **13.1 Environment Requirements**
- **Development:** Docker Compose with PostgreSQL
- **Staging:** Kubernetes cluster with staging database
- **Production:** Kubernetes cluster with HA PostgreSQL

### **13.2 Configuration Management**
- **Settings:** Django settings with environment variables
- **Environment Variables:** Database URLs, secret keys, API keys
- **Secrets Management:** Kubernetes secrets for sensitive data

### **13.3 Monitoring & Logging**
- **Application Logs:** Structured JSON logging with ELK stack
- **Performance Metrics:** Prometheus metrics collection
- **Error Tracking:** Sentry integration for error monitoring

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

### **14.1 Regular Maintenance**
- **Database Maintenance:** Weekly vacuum and analyze
- **Performance Tuning:** Monthly query performance review
- **Security Updates:** Patch Tuesday security updates

### **14.2 Support Procedures**
- **Issue Tracking:** Jira integration for bug tracking
- **Knowledge Base:** Confluence documentation
- **User Training:** Quarterly user training sessions

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

### **15.1 Version History**
- **v1.0.0:** Initial release with core group management
- **v1.1.0:** Template-based group setup enhancement
- **v1.2.0:** Advanced reporting group features

### **15.2 Change Management**
- **Release Process:** GitFlow with feature branches
- **Rollback Procedures:** Database migration rollback capability
- **Migration Scripts:** Django migration management

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

### **16.1 Regulatory Compliance**
- **IFRS Compliance:** IFRS reporting group standards
- **SOX Compliance:** Sarbanes-Oxley internal controls
- **GDPR:** Data protection and privacy compliance

### **16.2 Audit Requirements**
- **Audit Trail:** Complete change history with user attribution
- **Compliance Reporting:** Automated compliance report generation
- **Documentation:** Comprehensive technical and user documentation

--- END OF SECTION 16 ---
