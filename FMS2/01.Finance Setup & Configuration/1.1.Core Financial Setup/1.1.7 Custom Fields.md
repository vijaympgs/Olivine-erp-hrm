# FMS BBP - Custom Fields

## **1. MODULE IDENTIFICATION**

**Module Name:** Custom Fields
**Module Number:** 1.9
**Module Type:** Config
**Target File:** FMS/01.Finance Setup & Configuration/1.9 Custom Fields.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Custom Fields module provides a dynamic configuration system enabling users to create and manage user-defined data fields for financial entities, allowing flexible data capture beyond standard voucher types with customizable field types, validation rules, and display preferences.

### **2.2 Business Scope**
**In Scope:**
- Custom field definition and configuration
- Field type management (text, number, date, dropdown, checkbox, etc.)
- Validation rule configuration for custom fields
- Field assignment to financial entities and modules
- Display preference and layout configuration
- Multi-company custom field management
- Field dependency and conditional logic setup

**Out of Scope:**
- Actual data entry using custom fields (handled by respective modules)
- Financial transaction processing (handled by transaction modules)
- Reporting and analytics (handled by Analytics module)

### **2.3 Key Stakeholders**
- **System Administrators:** Custom field configuration and management
- **Finance Managers:** Field definition for business requirements
- **Business Analysts:** Field requirement gathering and validation
- **End Users:** Utilization of custom fields in data entry
- **Developers:** Integration and technical implementation

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: CustomField**

```python
class CustomField(models.Model):
    """
    Master custom field configuration for dynamic data capture
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    field_name = models.CharField(max_length=100)
    field_label = models.CharField(max_length=200)
    field_description = models.TextField(blank=True)
    field_type = models.CharField(
        max_length=30,
        choices=[
            ('TEXT', 'Text Field'),
            ('NUMBER', 'Number Field'),
            ('DECIMAL', 'Decimal Field'),
            ('DATE', 'Date Field'),
            ('DATETIME', 'Date Time Field'),
            ('EMAIL', 'Email Field'),
            ('PHONE', 'Phone Field'),
            ('URL', 'URL Field'),
            ('TEXTAREA', 'Text Area'),
            ('DROPDOWN', 'Dropdown'),
            ('MULTI_SELECT', 'Multi Select'),
            ('RADIO', 'Radio Button'),
            ('CHECKBOX', 'Checkbox'),
            ('BOOLEAN', 'Boolean'),
            ('FILE', 'File Upload'),
            ('IMAGE', 'Image Upload'),
        ]
    )
    target_module = models.CharField(
        max_length=50,
        choices=[
            ('VOUCHER_TYPES', 'Voucher Types'),
            ('CHART_OF_ACCOUNTS', 'Chart of Accounts'),
            ('COST_CENTERS', 'Cost Centers'),
            ('JOURNAL_ENTRIES', 'Journal Entries'),
            ('INVOICES', 'Invoices'),
            ('EXPENSES', 'Expenses'),
        ]
    )
    is_required = models.BooleanField(default=False)
    is_unique = models.BooleanField(default=False)
    is_readonly = models.BooleanField(default=False)
    is_active = models.BooleanField(default=True)
    sort_order = models.IntegerField(default=0)
    default_value = models.TextField(blank=True)
    placeholder_text = models.CharField(max_length=200, blank=True)
    help_text = models.TextField(blank=True)
    
    # Field Configuration
    max_length = models.IntegerField(null=True, blank=True)
    min_value = models.DecimalField(max_digits=20, decimal_places=8, null=True, blank=True)
    max_value = models.DecimalField(max_digits=20, decimal_places=8, null=True, blank=True)
    decimal_places = models.IntegerField(null=True, blank=True)
    
    # Display Configuration
    display_width = models.IntegerField(default=100)
    display_height = models.IntegerField(default=1)
    css_class = models.CharField(max_length=100, blank=True)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_custom_fields'
        verbose_name = 'Custom Field'
        verbose_name_plural = 'Custom Fields'
        indexes = [
            models.Index(fields=['company_id', 'target_module'], name='idx_cf_company_module'),
            models.Index(fields=['field_type'], name='idx_cf_field_type'),
            models.Index(fields=['is_active'], name='idx_cf_active'),
            models.Index(fields=['sort_order'], name='idx_cf_sort_order'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'target_module', 'field_name'], name='uk_cf_company_module_field'),
        ]

class CustomFieldOption(models.Model):
    """
    Options for dropdown and multi-select custom fields
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    custom_field_id = models.UUIDField()
    option_value = models.CharField(max_length=200)
    option_label = models.CharField(max_length=200)
    option_order = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'fms_custom_field_options'
        verbose_name = 'Custom Field Option'
        verbose_name_plural = 'Custom Field Options'
        indexes = [
            models.Index(fields=['custom_field_id', 'option_order'], name='idx_cfo_field_order'),
            models.Index(fields=['is_active'], name='idx_cfo_active'),
        ]
        constraints = [
            models.UniqueConstraint(
                fields=['custom_field_id', 'option_value'], 
                name='uk_cfo_field_value'
            ),
        ]

class CustomFieldValidation(models.Model):
    """
    Validation rules for custom fields
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    custom_field_id = models.UUIDField()
    validation_type = models.CharField(
        max_length=30,
        choices=[
            ('REGEX', 'Regular Expression'),
            ('MIN_LENGTH', 'Minimum Length'),
            ('MAX_LENGTH', 'Maximum Length'),
            ('RANGE', 'Value Range'),
            ('EMAIL_FORMAT', 'Email Format'),
            ('PHONE_FORMAT', 'Phone Format'),
            ('URL_FORMAT', 'URL Format'),
            ('CUSTOM_FUNCTION', 'Custom Function'),
        ]
    )
    validation_rule = models.TextField()
    error_message = models.CharField(max_length=500)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'fms_custom_field_validations'
        verbose_name = 'Custom Field Validation'
        verbose_name_plural = 'Custom Field Validations'
        indexes = [
            models.Index(fields=['custom_field_id', 'validation_type'], name='idx_cfv_field_type'),
            models.Index(fields=['is_active'], name='idx_cfv_active'),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 Company**

```python
class Company(models.Model):
    """
    Reference to company for multi-tenant support
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_name = models.CharField(max_length=200)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'fms_companies'
        verbose_name = 'Company'
        verbose_name_plural = 'Companies'
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPS**

### **5.1 Primary Relationships**
- **CustomField** → **Company**: Multi-tenant support through company_id
- **CustomFieldOption** → **CustomField**: Many-to-one relationship for field options
- **CustomFieldValidation** → **CustomField**: Many-to-one relationship for validation rules

### **5.2 Many-to-Many Relationships**
- **CustomField** ↔ **Target Modules**: Through target_module field for module assignment

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**
- Custom field names must be unique within each company and target module
- Field names must follow consistent naming conventions (alphanumeric, underscores)
- System-defined custom fields cannot be deleted or modified
- Validation rules must be compatible with field types
- Field options must have unique values within each field

### **6.2 Validation Logic**

```python
def clean_field_name(self):
    """
    Validate custom field name format and uniqueness
    """
    if not re.match(r'^[a-zA-Z][a-zA-Z0-9_]*$', self.field_name):
        raise ValidationError("Field name must start with a letter and contain only letters, numbers, and underscores")
    
    # Check uniqueness within company and module
    if CustomField.objects.filter(
        company_id=self.company_id,
        target_module=self.target_module,
        field_name=self.field_name
    ).exclude(id=self.id).exists():
        raise ValidationError("Field name must be unique within company and target module")

def clean_field_configuration(self):
    """
    Validate field configuration based on field type
    """
    if self.field_type in ['TEXT', 'TEXTAREA'] and self.max_length and self.max_length <= 0:
        raise ValidationError("Max length must be greater than 0 for text fields")
    
    if self.field_type in ['NUMBER', 'DECIMAL'] and self.min_value and self.max_value:
        if self.min_value >= self.max_value:
            raise ValidationError("Min value must be less than max value")
    
    if self.field_type == 'DECIMAL' and self.decimal_places and (self.decimal_places < 0 or self.decimal_places > 10):
        raise ValidationError("Decimal places must be between 0 and 10")

def clean_validation_rules(self):
    """
    Validate validation rule compatibility
    """
    if self.field_type == 'EMAIL' and self.validation_type not in ['EMAIL_FORMAT', 'REGEX', 'CUSTOM_FUNCTION']:
        raise ValidationError("Email fields can only use email format, regex, or custom function validation")
    
    if self.field_type == 'NUMBER' and self.validation_type == 'EMAIL_FORMAT':
        raise ValidationError("Number fields cannot use email format validation")
```

### **6.3 Business Constraints**
- Cannot delete custom fields with existing data
- Cannot modify field types if data exists
- Cannot deactivate fields used in active forms
- Required fields must have default values or be mandatory in data entry
- File upload fields must have size and type restrictions

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**
- **Layout:** Master-detail layout with custom field list on left, configuration details on right
- **Navigation:** Tabbed interface for different configuration sections (Basic, Validation, Options, Display)
- **Responsiveness:** Full desktop experience with tablet support for configuration tasks

### **7.2 User Experience Design**
- **User Flow:** Browse custom fields → Select field → Configure details → Test validation → Save
- **Error Handling:** Inline validation with clear error messages for field configuration conflicts
- **Loading States:** Progress indicators for field validation testing

### **7.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility for all form controls
- **Screen Reader Support:** Comprehensive ARIA labels for complex form relationships

### **7.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **7.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **7.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **7.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **7.8 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **7.9 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, field type filter, target module filter, status filter
- **Filter Actions:** Apply, Clear, Reset buttons

### **7.10 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

## **8.1 External Systems**
- **Form Builder APIs:** Integration with dynamic form generation systems
- **Validation Services:** External validation service integration for complex rules
- **Notification Services:** Email/SMS alerts for custom field configuration changes
- **Data Analytics Platforms:** Custom field usage analytics and reporting

## **8.2 Internal APIs**
- **Module Configuration API:** Dynamic field assignment to financial modules
- **User Management API:** Permission-based field access control
- **Audit Trail API:** Complete audit logging for custom field operations
- **Data Export API:** Custom field data export and import capabilities

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

## **9.1 REST Endpoints**

#### **GET /api/custom-fields/**
- **Purpose:** Retrieve all custom fields for a company
- **Authentication:** JWT token required
- **Parameters:** company_id, target_module, field_type, is_active
- **Response:** List of custom field objects with configurations

#### **POST /api/custom-fields/**
- **Purpose:** Create new custom field
- **Authentication:** JWT token required
- **Request Body:** Custom field configuration with validation rules
- **Response:** Created custom field object with validation results

#### **PUT /api/custom-fields/{id}/**
- **Purpose:** Update existing custom field
- **Authentication:** JWT token required
- **Request Body:** Updated custom field configuration
- **Response:** Updated custom field object with change tracking

#### **DELETE /api/custom-fields/{id}/**
- **Purpose:** Deactivate custom field
- **Authentication:** JWT token required
- **Response:** Deactivation confirmation with impact analysis

#### **POST /api/custom-fields/{id}/test-validation/**
- **Purpose:** Test validation rules for custom field
- **Authentication:** JWT token required
- **Request Body:** Test data values for validation
- **Response:** Validation results with error messages

#### **GET /api/custom-fields/{id}/options/**
- **Purpose:** Retrieve options for dropdown/multi-select fields
- **Authentication:** JWT token required
- **Response:** List of field options with ordering

#### **POST /api/custom-fields/{id}/options/**
- **Purpose:** Add option to dropdown/multi-select field
- **Authentication:** JWT token required
- **Request Body:** Option value and label
- **Response:** Created option object

## **9.2 Data Formats**
- **Request Format:** JSON with proper field type validation
- **Response Format:** JSON with standardized custom field data
- **Error Format:** JSON with validation error details and field-specific messages

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

## **10.1 Authentication**
- **Method:** JWT-based authentication with role-based access control
- **Authorization:** Custom field permissions (view, create, edit, delete, admin)
- **Session Management:** Secure session handling with automatic timeout

## **10.2 Data Protection**
- **Encryption:** AES-256 encryption for sensitive custom field data
- **Data Masking:** Partial masking of confidential field values in logs
- **Audit Trail:** Complete audit logging for all custom field operations

## **10.3 Access Control**
- **Permissions:**
  - custom_fields_view: View custom field configurations
  - custom_fields_create: Create new custom fields
  - custom_fields_edit: Modify existing custom fields
  - custom_fields_delete: Deactivate custom fields
  - custom_fields_admin: Full administrative access
- **Roles:** System Administrator, Finance Manager, Business Analyst
- **Audit Trail:** Complete audit logging for all custom field operations

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

## **11.1 Database Optimization**
- **Indexing Strategy:** Optimized indexes for custom field queries and lookups
- **Query Optimization:** Efficient queries for field configuration retrieval
- **Connection Pooling:** Database connection management for concurrent field operations

## **11.2 Caching Strategy**
- **Cache Layers:** Redis caching for frequently accessed custom field configurations
- **Cache Invalidation:** Time-based and event-driven cache invalidation
- **Performance Metrics:** Custom field configuration retrieval and validation performance

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

## **12.1 Unit Tests**
- **Coverage Target:** 95% code coverage for custom field models and business logic
- **Test Framework:** pytest with Django test framework
- **Test Data:** Comprehensive test data for various field types and validation scenarios

## **12.2 Integration Tests**
- **API Testing:** Complete API endpoint testing for custom field operations
- **Validation Testing:** Field validation rule accuracy and performance testing
- **Module Integration:** Custom field integration with target financial modules

## **12.3 User Acceptance Tests**
- **UAT Scenarios:** End-to-end custom field configuration workflows
- **User Stories:** Field creation, configuration, validation, and assignment
- **Acceptance Criteria:** Accurate field configuration with proper validation

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

## **13.1 Environment Requirements**
- **Development:** Local development with sample custom field configurations
- **Staging:** Pre-production environment with full validation testing
- **Production:** High-availability setup with scalable configuration management

## **13.2 Configuration Management**
- **Settings:** Custom field configuration parameters and validation rules
- **Environment Variables:** API keys for external validation services
- **Secrets Management:** Secure storage of sensitive configuration data

## **13.3 Monitoring & Logging**
- **Application Logs:** Custom field operation logs with detailed audit trails
- **Performance Metrics:** Field configuration and validation performance rates
- **Error Tracking:** Real-time error monitoring and alerting

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

## **14.1 Regular Maintenance**
- **Database Maintenance:** Monthly custom field usage cleanup and archiving
- **Performance Tuning:** Quarterly performance optimization for field validation
- **Configuration Updates:** Regular updates to field type options and validation rules

## **14.2 Support Procedures**
- **Issue Tracking:** Ticket system integration for custom field issues
- **Knowledge Base:** Documentation for custom field configuration procedures
- **User Training:** Training programs for system administrators and finance managers

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

## **15.1 Version History**
- **v1.0.0:** Initial release with basic custom field configuration
- **v1.1.0:** Added advanced validation rules and field dependencies
- **v1.2.0:** Enhanced field types and conditional logic support

## **15.2 Change Management**
- **Release Process:** Structured release process with backward compatibility
- **Rollback Procedures:** Emergency rollback capabilities for critical issues
- **Migration Scripts:** Data migration scripts for schema updates

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

## **16.1 Regulatory Compliance**
- **Data Protection:** GDPR and data protection compliance for custom field data
- **Financial Standards:** Compliance with financial data management standards
- **Audit Requirements:** Professional audit standards for configuration management

## **16.2 Audit Requirements**
- **Audit Trail:** Complete audit trail for all custom field operations and changes
- **Configuration Reports:** Automated generation of custom field compliance reports
- **Change Documentation:** Comprehensive documentation of all configuration changes
- **Security Controls:** Proper segregation of duties and access controls

--- END OF SECTION 16 ---

**END OF CUSTOM FIELDS BBP**
