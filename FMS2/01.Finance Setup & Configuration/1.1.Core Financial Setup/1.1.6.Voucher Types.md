# FMS BBP - Voucher Types

## **1. MODULE IDENTIFICATION**

**Module Name:** Voucher Types
**Module Number:** 1.7
**Module Type:** Master
**Target File:** FMS/01.Finance Setup & Configuration/1.7 Voucher Types.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Voucher Types module serves as the foundational configuration system for defining and managing different types of financial vouchers used in accounting transactions, providing standardized classification and validation rules for all financial document types within the organization.

### **2.2 Business Scope**
**In Scope:**
- Voucher type definition and configuration
- Voucher numbering series management
- Account mapping and validation rules
- Authorization and approval workflow configuration
- Voucher template and format definition
- Multi-company voucher type management
- Voucher type hierarchy and relationships

**Out of Scope:**
- Actual voucher transaction processing (handled by Journal Entries module)
- Voucher posting and ledger updates (handled by transaction modules)
- Financial reporting and analytics (handled by Analytics module)

### **2.3 Key Stakeholders**
- **Chief Financial Officer:** Strategic voucher type standardization
- **Finance Managers:** Voucher type configuration and management
- **Accountants:** Daily voucher type usage and compliance
- **Auditors:** Voucher type validation and audit trail verification
- **System Administrators:** Technical configuration and maintenance

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: VoucherType**

```python
class VoucherType(models.Model):
    """
    Master voucher type configuration for financial document classification
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    default_debit_account_id = models.UUIDField(null=True, blank=True)
    default_credit_account_id = models.UUIDField(null=True, blank=True)
    
    # Core Fields
    voucher_code = models.CharField(max_length=20)
    voucher_name = models.CharField(max_length=100)
    voucher_description = models.TextField(blank=True)
    voucher_category = models.CharField(
        max_length=30,
        choices=[
            ('PAYMENT', 'Payment Vouchers'),
            ('RECEIPT', 'Receipt Vouchers'),
            ('JOURNAL', 'Journal Vouchers'),
            ('CONTRA', 'Contra Vouchers'),
            ('SALES', 'Sales Vouchers'),
            ('PURCHASE', 'Purchase Vouchers'),
            ('CREDIT_NOTE', 'Credit Notes'),
            ('DEBIT_NOTE', 'Debit Notes'),
        ]
    )
    voucher_class = models.CharField(
        max_length=20,
        choices=[
            ('ASSET', 'Asset Vouchers'),
            ('LIABILITY', 'Liability Vouchers'),
            ('EQUITY', 'Equity Vouchers'),
            ('REVENUE', 'Revenue Vouchers'),
            ('EXPENSE', 'Expense Vouchers'),
        ]
    )
    numbering_method = models.CharField(
        max_length=20,
        choices=[
            ('AUTO', 'Automatic Numbering'),
            ('MANUAL', 'Manual Numbering'),
            ('DATE_BASED', 'Date-based Numbering'),
            ('PERIOD_BASED', 'Period-based Numbering'),
        ],
        default='AUTO'
    )
    prefix_format = models.CharField(max_length=20, blank=True)
    number_length = models.IntegerField(default=6)
    restart_frequency = models.CharField(
        max_length=20,
        choices=[
            ('NEVER', 'Never Restart'),
            ('DAILY', 'Daily Restart'),
            ('MONTHLY', 'Monthly Restart'),
            ('YEARLY', 'Yearly Restart'),
        ],
        default='YEARLY'
    )
    current_number = models.BigIntegerField(default=1)
    is_active = models.BooleanField(default=True)
    is_system_defined = models.BooleanField(default=False)
    requires_approval = models.BooleanField(default=False)
    approval_limit = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    auto_post = models.BooleanField(default=False)
    allow_editing = models.BooleanField(default=True)
    allow_deleting = models.BooleanField(default=True)
    sort_order = models.IntegerField(default=0)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_voucher_types'
        verbose_name = 'Voucher Type'
        verbose_name_plural = 'Voucher Types'
        indexes = [
            models.Index(fields=['company_id', 'voucher_code'], name='idx_vt_company_code'),
            models.Index(fields=['company_id', 'voucher_category'], name='idx_vt_company_category'),
            models.Index(fields=['is_active'], name='idx_vt_active'),
            models.Index(fields=['voucher_class'], name='idx_vt_class'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'voucher_code'], name='uk_vt_company_code'),
            models.CheckConstraint(check=models.Q(current_number__gte=1), name='ck_vt_current_number_positive'),
        ]

class VoucherTypeAccountMapping(models.Model):
    """
    Account mapping rules for voucher types
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    voucher_type_id = models.UUIDField()
    account_id = models.UUIDField()
    mapping_type = models.CharField(
        max_length=20,
        choices=[
            ('DEFAULT_DEBIT', 'Default Debit Account'),
            ('DEFAULT_CREDIT', 'Default Credit Account'),
            ('ALLOWED_DEBIT', 'Allowed Debit Account'),
            ('ALLOWED_CREDIT', 'Allowed Credit Account'),
            ('RESTRICTED_DEBIT', 'Restricted Debit Account'),
            ('RESTRICTED_CREDIT', 'Restricted Credit Account'),
        ]
    )
    is_mandatory = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'fms_voucher_type_account_mappings'
        verbose_name = 'Voucher Type Account Mapping'
        verbose_name_plural = 'Voucher Type Account Mappings'
        indexes = [
            models.Index(fields=['voucher_type_id', 'mapping_type'], name='idx_vtam_voucher_type'),
            models.Index(fields=['account_id'], name='idx_vtam_account'),
        ]
        constraints = [
            models.UniqueConstraint(
                fields=['voucher_type_id', 'account_id', 'mapping_type'], 
                name='uk_vtam_voucher_account_type'
            ),
        ]

class VoucherNumberSeries(models.Model):
    """
    Number series management for voucher types
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    voucher_type_id = models.UUIDField()
    series_name = models.CharField(max_length=50)
    prefix = models.CharField(max_length=20, blank=True)
    start_number = models.BigIntegerField(default=1)
    current_number = models.BigIntegerField(default=1)
    end_number = models.BigIntegerField(null=True, blank=True)
    financial_year = models.CharField(max_length=10, blank=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_voucher_number_series'
        verbose_name = 'Voucher Number Series'
        verbose_name_plural = 'Voucher Number Series'
        indexes = [
            models.Index(fields=['voucher_type_id', 'financial_year'], name='idx_vns_voucher_fy'),
            models.Index(fields=['company_id', 'series_name'], name='idx_vns_company_series'),
        ]
        constraints = [
            models.UniqueConstraint(
                fields=['voucher_type_id', 'series_name', 'financial_year'], 
                name='uk_vns_voucher_series_fy'
            ),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 ChartOfAccount**

```python
class ChartOfAccount(models.Model):
    """
    Reference to chart of accounts for voucher type account mappings
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    account_code = models.CharField(max_length=50)
    account_name = models.CharField(max_length=200)
    account_type = models.CharField(max_length=20)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'fms_chart_of_accounts'
        verbose_name = 'Chart of Account'
        verbose_name_plural = 'Chart of Accounts'
```

### **4.2 FinancialYear**

```python
class FinancialYear(models.Model):
    """
    Reference to financial year for voucher number series
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    year_code = models.CharField(max_length=10)
    year_name = models.CharField(max_length=50)
    start_date = models.DateField()
    end_date = models.DateField()
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'fms_financial_years'
        verbose_name = 'Financial Year'
        verbose_name_plural = 'Financial Years'
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPS**

### **5.1 Primary Relationships**
- **VoucherType** → **ChartOfAccount**: Many-to-one relationship for default debit/credit accounts
- **VoucherType** → **Company**: Multi-tenant support through company_id
- **VoucherTypeAccountMapping** → **VoucherType**: Many-to-one relationship for account mapping rules
- **VoucherTypeAccountMapping** → **ChartOfAccount**: Many-to-one relationship for mapped accounts
- **VoucherNumberSeries** → **VoucherType**: Many-to-one relationship for number series management
- **VoucherNumberSeries** → **FinancialYear**: Many-to-one relationship for financial year association

### **5.2 Many-to-Many Relationships**
- **VoucherType** ↔ **ChartOfAccount**: Through VoucherTypeAccountMapping model for complex account mapping rules

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**
- Voucher codes must be unique within each company
- Voucher codes must follow consistent naming conventions
- System-defined voucher types cannot be deleted or modified
- Number series must not overlap within the same financial year
- Account mappings must respect account types and categories
- Approval limits must be positive values

### **6.2 Validation Logic**

```python
def clean_voucher_code(self):
    """
    Validate voucher code format and uniqueness
    """
    if not re.match(r'^[A-Z0-9\-_]+$', self.voucher_code):
        raise ValidationError("Voucher code can only contain uppercase letters, numbers, hyphens, and underscores")
    
    # Check uniqueness within company
    if VoucherType.objects.filter(
        company_id=self.company_id,
        voucher_code=self.voucher_code
    ).exclude(id=self.id).exists():
        raise ValidationError("Voucher code must be unique within company")

def clean_numbering_configuration(self):
    """
    Validate numbering method and configuration consistency
    """
    if self.numbering_method == 'AUTO' and not self.prefix_format:
        raise ValidationError("Prefix format is required for automatic numbering")
    
    if self.number_length < 3 or self.number_length > 15:
        raise ValidationError("Number length must be between 3 and 15 digits")
    
    if self.current_number < 1:
        raise ValidationError("Current number must be greater than 0")

def clean_approval_configuration(self):
    """
    Validate approval workflow configuration
    """
    if self.requires_approval and not self.approval_limit:
        raise ValidationError("Approval limit is required when approval is required")
    
    if self.approval_limit and self.approval_limit <= 0:
        raise ValidationError("Approval limit must be greater than 0")

def clean_account_mappings(self):
    """
    Validate account mapping consistency
    """
    if self.default_debit_account_id and self.default_credit_account_id:
        if self.default_debit_account_id == self.default_credit_account_id:
            raise ValidationError("Default debit and credit accounts cannot be the same")
```

### **6.3 Business Constraints**
- Cannot delete voucher types with existing transactions
- Cannot deactivate voucher types used in active number series
- Cannot modify voucher codes if transactions exist
- System voucher types cannot have their category changed
- Number series end numbers must be greater than start numbers
- Financial year must be active for number series assignment

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**
- **Layout:** Master-detail layout with voucher type list on left, configuration details on right
- **Navigation:** Tabbed interface for different configuration sections (Basic, Numbering, Accounts, Approval)
- **Responsiveness:** Full desktop experience with tablet support for configuration tasks

### **7.2 User Experience Design**
- **User Flow:** Browse voucher types → Select type → Configure details → Test numbering → Save
- **Error Handling:** Inline validation with clear error messages for numbering conflicts
- **Loading States:** Progress indicators for number series generation and validation

### **7.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility for all form controls
- **Screen Reader Support:** Comprehensive ARIA labels for complex form relationships

### **7.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **7.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **7.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **7.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **7.8 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **7.9 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, voucher category filter, status filter, numbering method filter
- **Filter Actions:** Apply, Clear, Reset buttons

### **7.10 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

### **8.1 External Systems**
- **ERP Systems:** Voucher type synchronization for financial document classification
- **Accounting Software:** Export/import of voucher type configurations
- **Audit Systems:** Voucher type validation and compliance reporting

### **8.2 Internal APIs**
- **Journal Entries API:** Voucher type validation and account mapping enforcement
- **Chart of Accounts API:** Account validation and mapping rules
- **Financial Year API:** Number series management and financial year association
- **Approval Workflow API:** Voucher approval limit enforcement and routing

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

### **9.1 REST Endpoints**

#### **GET /api/fms/voucher-types/**
- **Purpose:** Retrieve voucher types list
- **Authentication:** JWT token required
- **Parameters:** company_id, voucher_category, is_active
- **Response:** Paginated voucher type list with account mappings

#### **POST /api/fms/voucher-types/**
- **Purpose:** Create new voucher type
- **Authentication:** JWT token required
- **Request Body:** Voucher type details
- **Response:** Created voucher type object

#### **PUT /api/fms/voucher-types/{id}/**
- **Purpose:** Update existing voucher type
- **Authentication:** JWT token required
- **Request Body:** Updated voucher type details
- **Response:** Updated voucher type object

#### **GET /api/fms/voucher-types/{id}/account-mappings/**
- **Purpose:** Retrieve account mappings for voucher type
- **Authentication:** JWT token required
- **Parameters:** mapping_type
- **Response:** Account mappings list

#### **POST /api/fms/voucher-types/{id}/account-mappings/**
- **Purpose:** Create account mapping for voucher type
- **Authentication:** JWT token required
- **Request Body:** Account mapping details
- **Response:** Created account mapping object

#### **GET /api/fms/voucher-types/{id}/number-series/**
- **Purpose:** Retrieve number series for voucher type
- **Authentication:** JWT token required
- **Parameters:** financial_year
- **Response:** Number series list

#### **POST /api/fms/voucher-types/{id}/test-numbering/**
- **Purpose:** Test voucher numbering configuration
- **Authentication:** JWT token required
- **Request Body:** Test parameters
- **Response:** Generated voucher number preview

### **9.2 Data Formats**
- **Request Format:** JSON
- **Response Format:** JSON
- **Error Format:** {"error": "message", "code": "ERROR_CODE"}

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

### **10.1 Authentication**
- **Method:** JWT-based authentication
- **Authorization:** Role-based access control
- **Session Management:** Token refresh mechanism

### **10.2 Data Protection**
- **Encryption:** AES-256 encryption for sensitive voucher configuration data
- **Masking:** Voucher number masking in logs and exports
- **Backup:** Daily encrypted backups of voucher type configurations

### **10.3 Access Control**
- **Permissions:** Create, Read, Update, Delete permissions by role
- **Roles:** Finance Manager, Accountant, Auditor, Viewer
- **Audit Trail:** Complete audit logging for all voucher type changes

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

### **11.1 Database Optimization**
- **Indexing Strategy:** Composite indexes on company_id + voucher_code, company_id + voucher_category
- **Query Optimization:** Optimized queries for voucher type lookups and account mapping validation
- **Connection Pooling:** pgbouncer connection pooling for high-volume voucher processing

### **11.2 Caching Strategy**
- **Cache Layers:** Redis for voucher type configurations and account mappings
- **Cache Invalidation:** Cache invalidation on voucher type changes
- **Performance Metrics:** Query response time < 200ms for voucher type operations

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

### **12.1 Unit Tests**
- **Coverage Target:** 90% code coverage
- **Test Framework:** pytest with Django test extensions
- **Test Data:** Factory Boy for test data generation

### **12.2 Integration Tests**
- **API Testing:** DRF test client for endpoint testing
- **Database Testing:** PostgreSQL integration testing
- **Third-party Testing:** Mock external system calls

### **12.3 User Acceptance Tests**
- **UAT Scenarios:** Complete voucher type configuration workflows
- **User Stories:** All user story acceptance criteria
- **Acceptance Criteria:** Functional and non-functional requirements

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

### **13.1 Environment Requirements**
- **Development:** Docker Compose with PostgreSQL 14, Redis 6
- **Staging:** Kubernetes cluster with 2 replicas, PostgreSQL 14
- **Production:** Kubernetes cluster with 3 replicas, PostgreSQL 14 with read replicas

### **13.2 Configuration Management**
- **Settings:** Django settings with environment-specific configurations
- **Environment Variables:** Database URLs, Redis URLs, JWT secrets
- **Secrets Management:** Kubernetes secrets for sensitive data

### **13.3 Monitoring & Logging**
- **Application Logs:** Structured JSON logging with ELK stack
- **Performance Metrics:** Prometheus metrics for API response times
- **Error Tracking:** Sentry integration for error monitoring

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

### **14.1 Regular Maintenance**
- **Database Maintenance:** Weekly index rebuilds and statistics updates
- **Performance Tuning:** Monthly query performance analysis and optimization
- **Security Updates:** Quarterly security patching and vulnerability scanning

### **14.2 Support Procedures**
- **Issue Tracking:** Jira integration for bug tracking and feature requests
- **Knowledge Base:** Comprehensive documentation for troubleshooting
- **User Training:** Quarterly training sessions for finance teams

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

### **15.1 Version History**
- **v1.0.0:** Initial release with core voucher type management
- **v1.1.0:** Added account mapping rules and validation
- **v1.2.0:** Enhanced numbering series management
- **v1.3.0:** Current version with approval workflow integration

### **15.2 Change Management**
- **Release Process:** Git flow with feature branches and pull requests
- **Rollback Procedures:** Database migration rollback capabilities
- **Migration Scripts:** Django migrations for schema changes

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

### **16.1 Regulatory Compliance**
- **GAAP Compliance:** Generally Accepted Accounting Principles adherence
- **SOX Compliance:** Sarbanes-Oxley Act requirements for financial controls
- **IFRS Support:** International Financial Reporting Standards compatibility

### **16.2 Audit Requirements**
- **Audit Trail:** Complete audit logging for all voucher type changes
- **Compliance Reporting:** Automated compliance report generation
- **Documentation:** Comprehensive audit documentation maintenance

---

**END OF BBP TEMPLATE**

--- END OF SECTION 16 ---
