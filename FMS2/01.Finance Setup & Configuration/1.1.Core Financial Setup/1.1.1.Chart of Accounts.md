# FMS BBP - Chart of Accounts

## **1. MODULE IDENTIFICATION**

**Module Name:** Chart of Accounts
**Module Number:** 1.1
**Module Type:** Master
**Target File:** FMS/01.Finance Setup & Configuration/1.1 Chart of Accounts.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Chart of Accounts module serves as the foundational structure for financial accounting, providing a systematic framework for organizing, categorizing, and tracking all financial transactions according to standard accounting principles and regulatory requirements.

### **2.2 Business Scope**
**In Scope:**
- Account structure and hierarchy management
- Account classification and categorization
- Opening balance management
- Account status and lifecycle management
- Multi-company account structures
- Account group and subgroup management

**Out of Scope:**
- Transaction processing (handled by Journal Entries module)
- Financial reporting (handled by Analytics module)
- Tax-specific account configurations (handled by Global Tax Management)

### **2.3 Key Stakeholders**
- **Chief Financial Officer:** Strategic financial structure oversight
- **Finance Managers:** Account structure management and maintenance
- **Accountants:** Daily account operations and transaction coding
- **Auditors:** Compliance and validation of account structures
- **System Administrators:** Technical configuration and maintenance

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: ChartOfAccount**

```python
class ChartOfAccount(models.Model):
    """
    Master chart of accounts structure for financial accounting
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    account_group_id = models.UUIDField()
    parent_account_id = models.UUIDField(null=True, blank=True)
    
    # Core Fields
    account_code = models.CharField(max_length=50, unique=True)
    account_name = models.CharField(max_length=200)
    account_type = models.CharField(
        max_length=20,
        choices=[
            ('ASSET', 'Asset'),
            ('LIABILITY', 'Liability'),
            ('EQUITY', 'Equity'),
            ('REVENUE', 'Revenue'),
            ('EXPENSE', 'Expense'),
            ('CONTRA_ASSET', 'Contra Asset'),
            ('CONTRA_REVENUE', 'Contra Revenue'),
        ]
    )
    account_category = models.CharField(
        max_length=50,
        choices=[
            ('CURRENT_ASSET', 'Current Asset'),
            ('NON_CURRENT_ASSET', 'Non-Current Asset'),
            ('CURRENT_LIABILITY', 'Current Liability'),
            ('NON_CURRENT_LIABILITY', 'Non-Current Liability'),
            ('OWNERS_EQUITY', "Owner's Equity"),
            ('OPERATING_REVENUE', 'Operating Revenue'),
            ('NON_OPERATING_REVENUE', 'Non-Operating Revenue'),
            ('OPERATING_EXPENSE', 'Operating Expense'),
            ('NON_OPERATING_EXPENSE', 'Non-Operating Expense'),
        ]
    )
    description = models.TextField(blank=True)
    opening_balance = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    opening_balance_date = models.DateField()
    currency_code = models.CharField(max_length=3, default='USD')
    is_active = models.BooleanField(default=True)
    is_consolidated = models.BooleanField(default=False)
    is_cash_account = models.BooleanField(default=False)
    is_bank_account = models.BooleanField(default=False)
    is_tax_account = models.BooleanField(default=False)
    is_revaluation_account = models.BooleanField(default=False)
    level = models.IntegerField(default=1)
    sort_order = models.IntegerField(default=0)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_chart_of_accounts'
        verbose_name = 'Chart of Account'
        verbose_name_plural = 'Chart of Accounts'
        indexes = [
            models.Index(fields=['company_id', 'account_code'], name='idx_coa_company_code'),
            models.Index(fields=['company_id', 'account_type'], name='idx_coa_company_type'),
            models.Index(fields=['account_group_id'], name='idx_coa_account_group'),
            models.Index(fields=['parent_account_id'], name='idx_coa_parent'),
            models.Index(fields=['is_active'], name='idx_coa_active'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'account_code'], name='uk_coa_company_code'),
            models.CheckConstraint(
                check=models.Q(opening_balance__gte=0) | models.Q(account_type__in=['LIABILITY', 'EQUITY', 'REVENUE']),
                name='ck_coa_opening_balance_logic'
            ),
        ]
```

### **3.2 Supporting Models**

```python
class AccountGroup(models.Model):
    """
    Account groups for organizing chart of accounts
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    group_code = models.CharField(max_length=20)
    group_name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    parent_group_id = models.UUIDField(null=True, blank=True)
    level = models.IntegerField(default=1)
    sort_order = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_account_groups'
        verbose_name = 'Account Group'
        verbose_name_plural = 'Account Groups'
        indexes = [
            models.Index(fields=['company_id', 'group_code'], name='idx_ag_company_code'),
            models.Index(fields=['parent_group_id'], name='idx_ag_parent'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'group_code'], name='uk_ag_company_code'),
        ]

class AccountBalance(models.Model):
    """
    Historical account balances tracking
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    account_id = models.UUIDField()
    company_id = models.UUIDField()
    
    balance_date = models.DateField()
    opening_balance = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    debit_amount = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    credit_amount = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    closing_balance = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    currency_code = models.CharField(max_length=3, default='USD')
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'fms_account_balances'
        verbose_name = 'Account Balance'
        verbose_name_plural = 'Account Balances'
        indexes = [
            models.Index(fields=['account_id', 'balance_date'], name='idx_ab_account_date'),
            models.Index(fields=['company_id', 'balance_date'], name='idx_ab_company_date'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['account_id', 'balance_date'], name='uk_ab_account_date'),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 Currency**

```python
class Currency(models.Model):
    """
    Currency reference for multi-currency support
    """
    
    currency_code = models.CharField(max_length=3, primary_key=True)
    currency_name = models.CharField(max_length=100)
    symbol = models.CharField(max_length=5)
    decimal_places = models.IntegerField(default=2)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'ref_currencies'
        verbose_name = 'Currency'
        verbose_name_plural = 'Currencies'
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPS**

### **5.1 Primary Relationships**
- **ChartOfAccount** → **AccountGroup**: Many-to-one relationship for account grouping
- **ChartOfAccount** → **ChartOfAccount**: Self-referencing relationship for parent-child hierarchy
- **AccountBalance** → **ChartOfAccount**: Many-to-one relationship for balance tracking

### **5.2 Many-to-Many Relationships**
- **ChartOfAccount** ↔ **Company**: Multi-tenant support through company_id

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**
- Account codes must be unique within each company
- Account codes must follow consistent numbering pattern
- Parent accounts must exist and be at higher level than child accounts
- Opening balances must respect account type logic (assets have debit balances, liabilities have credit balances)
- Account groups must form valid hierarchical structure

### **6.2 Validation Logic**

```python
def clean_account_code(self):
    """
    Validate account code format and uniqueness
    """
    if not re.match(r'^[A-Z0-9\-\.]+$', self.account_code):
        raise ValidationError("Account code can only contain uppercase letters, numbers, hyphens, and dots")
    
    # Check uniqueness within company
    if ChartOfAccount.objects.filter(
        company_id=self.company_id,
        account_code=self.account_code
    ).exclude(id=self.id).exists():
        raise ValidationError("Account code must be unique within company")

def clean_account_hierarchy(self):
    """
    Validate parent-child relationship
    """
    if self.parent_account_id:
        parent = ChartOfAccount.objects.get(id=self.parent_account_id)
        if parent.level >= self.level:
            raise ValidationError("Parent account must be at higher level than child account")
        if parent.company_id != self.company_id:
            raise ValidationError("Parent account must belong to same company")

def clean_opening_balance(self):
    """
    Validate opening balance logic based on account type
    """
    if self.account_type in ['ASSET', 'EXPENSE', 'CONTRA_REVENUE'] and self.opening_balance < 0:
        raise ValidationError("Asset and expense accounts cannot have negative opening balances")
    if self.account_type in ['LIABILITY', 'EQUITY', 'REVENUE', 'CONTRA_ASSET'] and self.opening_balance > 0:
        raise ValidationError("Liability, equity, and revenue accounts cannot have positive opening balances")
```

### **6.3 Business Constraints**
- Cannot delete accounts with transaction history
- Cannot deactivate parent accounts with active child accounts
- Cannot modify account codes if transactions exist
- Opening balance date must be within current financial year
- Account level cannot exceed maximum defined hierarchy depth

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**
- **Layout:** Master-detail layout with account tree on left, details on right
- **Navigation:** Hierarchical tree view with expand/collapse functionality
- **Responsiveness:** Full desktop experience with tablet support

### **7.2 User Experience Design**
- **User Flow:** Browse tree → Select account → View/Edit details → Save
- **Error Handling:** Inline validation with clear error messages
- **Loading States:** Progress indicators for bulk operations

### **7.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility
- **Screen Reader Support:** Comprehensive ARIA labels

### **7.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **7.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **7.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **7.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **7.8 Border & Shadow System**
- **Border Radius:**
  - **None:** 0px
  - **SM:** 4px
  - **MD:** 8px
  - **LG:** 12px
  - **XL:** 16px
- **Box Shadows:**
  - **SM:** 0 1px 2px 0 rgba(0, 0, 0, 0.05)
  - **MD:** 0 4px 6px -1px rgba(0, 0, 0, 0.1)
  - **LG:** 0 10px 15px -3px rgba(0, 0, 0, 0.1)

### **7.9 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **7.10 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, account type filter, status filter, date range
- **Filter Actions:** Apply, Clear, Reset buttons

### **7.11 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

### **8.1 External Systems**
- **ERP Systems:** Account structure synchronization
- **Tax Systems:** Tax account mapping
- **Banking Systems:** Bank account reconciliation

### **8.2 Internal APIs**
- **Journal Entries API:** Account validation and posting
- **Financial Reports API:** Account data for reporting
- **Budget Management API:** Account budget allocation

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

### **9.1 REST Endpoints**

#### **GET /api/fms/chart-of-accounts/**
- **Purpose:** Retrieve chart of accounts list
- **Authentication:** JWT token required
- **Parameters:** company_id, account_type, is_active
- **Response:** Paginated account list with hierarchy

#### **POST /api/fms/chart-of-accounts/**
- **Purpose:** Create new account
- **Authentication:** JWT token required
- **Request Body:** Account details
- **Response:** Created account object

#### **PUT /api/fms/chart-of-accounts/{id}/**
- **Purpose:** Update existing account
- **Authentication:** JWT token required
- **Request Body:** Updated account details
- **Response:** Updated account object

### **9.2 Data Formats**
- **Request Format:** JSON
- **Response Format:** JSON
- **Error Format:** {"error": "message", "code": "ERROR_CODE"}

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

### **10.1 Authentication**
- **Method:** JWT-based authentication
- **Authorization:** Role-based access control
- **Session Management:** Token refresh mechanism

### **10.2 Data Protection**
- **Encryption:** AES-256 encryption for sensitive data
- **Masking:** Account number masking in logs
- **Backup:** Daily encrypted backups

### **10.3 Access Control**
- **Permissions:** Create, Read, Update, Delete permissions by role
- **Roles:** Finance Manager, Accountant, Auditor, Viewer
- **Audit Trail:** Complete audit logging for all changes

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

### **11.1 Database Optimization**
- **Indexing Strategy:** Composite indexes on company_id + account_code
- **Query Optimization:** Optimized hierarchical queries
- **Connection Pooling:** pgbouncer connection pooling

### **11.2 Caching Strategy**
- **Cache Layers:** Redis for account hierarchy caching
- **Cache Invalidation:** Cache invalidation on account changes
- **Performance Metrics:** Query response time < 200ms

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

### **12.1 Unit Tests**
- **Coverage Target:** 90% code coverage
- **Test Framework:** pytest with Django test extensions
- **Test Data:** Factory Boy for test data generation

### **12.2 Integration Tests**
- **API Testing:** DRF test client for endpoint testing
- **Database Testing:** PostgreSQL integration testing
- **Third-party Testing:** Mock external system calls

### **12.3 User Acceptance Tests**
- **UAT Scenarios:** Complete account management workflows
- **User Stories:** All user story acceptance criteria
- **Acceptance Criteria:** Functional and non-functional requirements

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

### **13.1 Environment Requirements**
- **Development:** Docker Compose with PostgreSQL
- **Staging:** Kubernetes cluster with staging database
- **Production:** Kubernetes cluster with HA PostgreSQL

### **13.2 Configuration Management**
- **Settings:** Django settings with environment variables
- **Environment Variables:** Database URLs, secret keys, API keys
- **Secrets Management:** Kubernetes secrets for sensitive data

### **13.3 Monitoring & Logging**
- **Application Logs:** Structured JSON logging with ELK stack
- **Performance Metrics:** Prometheus metrics collection
- **Error Tracking:** Sentry integration for error monitoring

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

### **14.1 Regular Maintenance**
- **Database Maintenance:** Weekly vacuum and analyze
- **Performance Tuning:** Monthly query performance review
- **Security Updates:** Patch Tuesday security updates

### **14.2 Support Procedures**
- **Issue Tracking:** Jira integration for bug tracking
- **Knowledge Base:** Confluence documentation
- **User Training:** Quarterly user training sessions

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

### **15.1 Version History**
- **v1.0.0:** Initial release with core account management
- **v1.1.0:** Multi-currency support enhancement
- **v1.2.0:** Advanced reporting features

### **15.2 Change Management**
- **Release Process:** GitFlow with feature branches
- **Rollback Procedures:** Database migration rollback capability
- **Migration Scripts:** Django migration management

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

### **16.1 Regulatory Compliance**
- **IFRS Compliance:** IFRS accounting standards support
- **SOX Compliance:** Sarbanes-Oxley internal controls
- **GDPR:** Data protection and privacy compliance

### **16.2 Audit Requirements**
- **Audit Trail:** Complete change history with user attribution
- **Compliance Reporting:** Automated compliance report generation
- **Documentation:** Comprehensive technical and user documentation

--- END OF SECTION 16 ---
