# FMS BBP - Currencies

## **1. MODULE IDENTIFICATION**

**Module Name:** Currencies
**Module Number:** 1.5
**Module Type:** Master
**Target File:** FMS/01.Finance Setup & Configuration/1.5 Currencies.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Currencies module provides comprehensive multi-currency support for financial operations, enabling accurate foreign exchange management, multi-currency accounting, and global financial reporting following Tally, NetSuite, and Dynamics 365 finance principles.

### **2.2 Business Scope**
**In Scope:**
- Currency definition and configuration
- Exchange rate management and updates
- Multi-currency transaction processing
- Currency revaluation and gain/loss calculation
- Foreign exchange gain/loss reporting
- Currency conversion and validation rules

**Out of Scope:**
- Transaction posting (handled by Journal Entries module)
- Exchange rate provider integration (handled by external systems)
- Regulatory reporting (handled by Analytics module)

### **2.3 Key Stakeholders**
- **Chief Financial Officer:** Multi-currency strategy oversight
- **Finance Managers:** Exchange rate monitoring and reporting
- **Treasury Managers:** Foreign exchange operations
- **Accountants:** Multi-currency transaction processing
- **System Administrators:** Currency configuration and maintenance

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: Currency**

```python
class Currency(models.Model):
    """
    Currency configuration for multi-currency support
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Core Fields
    currency_code = models.CharField(max_length=3, primary_key=True)
    currency_name = models.CharField(max_length=100)
    currency_symbol = models.CharField(max_length=10)
    decimal_places = models.IntegerField(default=2)
    is_active = models.BooleanField(default=True)
    is_base_currency = models.BooleanField(default=False)
    
    # Currency Classification
    currency_type = models.CharField(
        max_length=20,
        choices=[
            ('FIAT', 'Fiat Currency'),
            ('CRYPTO', 'Cryptocurrency'),
            ('DIGITAL', 'Digital Currency'),
        ],
        default='FIAT'
    )
    
    # Regional Information
    country_code = models.CharField(max_length=3, blank=True)
    region = models.CharField(max_length=50, blank=True)
    
    # Display Configuration
    symbol_position = models.CharField(
        max_length=10,
        choices=[
            ('PREFIX', 'Prefix'),
            ('SUFFIX', 'Suffix'),
        ],
        default='PREFIX'
    )
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_currencies'
        verbose_name = 'Currency'
        verbose_name_plural = 'Currencies'
        indexes = [
            models.Index(fields=['is_active'], name='idx_currency_active'),
            models.Index(fields=['is_base_currency'], name='idx_currency_base'),
            models.Index(fields=['currency_type'], name='idx_currency_type'),
        ]
        constraints = [
            models.CheckConstraint(check=models.Q(decimal_places__gte=0) & models.Q(decimal_places__lte=10), name='ck_currency_decimal_places'),
        ]

class ExchangeRate(models.Model):
    """
    Exchange rate configuration for currency conversion
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Exchange Rate Details
    from_currency_code = models.CharField(max_length=3)
    to_currency_code = models.CharField(max_length=3)
    exchange_rate = models.DecimalField(max_digits=20, decimal_places=10)
    inverse_rate = models.DecimalField(max_digits=20, decimal_places=10)
    
    # Rate Information
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    rate_type = models.CharField(
        max_length=20,
        choices=[
            ('SPOT', 'Spot Rate'),
            ('FORWARD', 'Forward Rate'),
            ('AVERAGE', 'Average Rate'),
            ('HISTORICAL', 'Historical Rate'),
            ('BUDGET', 'Budget Rate'),
        ],
        default='SPOT'
    )
    
    # Source Information
    rate_source = models.CharField(
        max_length=50,
        choices=[
            ('MANUAL', 'Manual Entry'),
            ('API', 'API Feed'),
            ('BANK', 'Bank Feed'),
            ('THIRD_PARTY', 'Third Party Service'),
        ],
        default='MANUAL'
    )
    source_reference = models.CharField(max_length=100, blank=True)
    
    # Status
    is_active = models.BooleanField(default=True)
    is_default_rate = models.BooleanField(default=False)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_exchange_rates'
        verbose_name = 'Exchange Rate'
        verbose_name_plural = 'Exchange Rates'
        indexes = [
            models.Index(fields=['from_currency_code', 'to_currency_code', 'effective_date'], name='idx_er_from_to_date'),
            models.Index(fields=['effective_date', 'expiry_date'], name='idx_er_dates'),
            models.Index(fields=['is_active'], name='idx_er_active'),
            models.Index(fields=['is_default_rate'], name='idx_er_default'),
        ]
        constraints = [
            models.CheckConstraint(check=models.Q(exchange_rate__gt=0) & models.Q(inverse_rate__gt=0), name='ck_exchange_rates_positive'),
            models.CheckConstraint(check=models.Q(effective_date__lte=models.F('expiry_date') | models.Q(expiry_date__isnull=True)), name='ck_er_date_range'),
        ]

class CurrencyRevaluation(models.Model):
    """
    Currency revaluation and gain/loss tracking
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Revaluation Details
    currency_code = models.CharField(max_length=3)
    revaluation_date = models.DateField()
    closing_rate = models.DecimalField(max_digits=20, decimal_places=10)
    opening_rate = models.DecimalField(max_digits=20, decimal_places=10)
    
    # Financial Impact
    revaluation_amount = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    gain_loss_amount = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    base_currency_amount = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    
    # Reference Information
    reference_document = models.CharField(max_length=50, blank=True)
    reference_number = models.CharField(max_length=50, blank=True)
    
    # Status
    is_posted = models.BooleanField(default=False)
    posted_date = models.DateTimeField(null=True, blank=True)
    posted_by_user_id = models.UUIDField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_currency_revaluations'
        verbose_name = 'Currency Revaluation'
        verbose_name_plural = 'Currency Revaluations'
        indexes = [
            models.Index(fields=['currency_code', 'revaluation_date'], name='idx_cr_currency_date'),
            models.Index(fields=['revaluation_date'], name='idx_cr_date'),
            models.Index(fields=['is_posted'], name='idx_cr_posted'),
        ]
        constraints = [
            models.CheckConstraint(check=models.Q(closing_rate__gt=0) & models.Q(opening_rate__gt=0), name='ck_cr_rates_positive'),
        ]

class CurrencyTransaction(models.Model):
    """
    Multi-currency transaction tracking and conversion
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    cost_center_id = models.UUIDField(null=True, blank=True)
    
    # Transaction Reference
    transaction_id = models.UUIDField()
    transaction_date = models.DateField()
    
    # Currency Information
    transaction_currency_code = models.CharField(max_length=3)
    base_currency_code = models.CharField(max_length=3)
    exchange_rate = models.DecimalField(max_digits=20, decimal_places=10)
    exchange_rate_date = models.DateField()
    
    # Financial Amounts
    transaction_amount = models.DecimalField(max_digits=20, decimal_places=2)
    base_currency_amount = models.DecimalField(max_digits=20, decimal_places=2)
    exchange_gain_loss = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    
    # Additional Information
    description = models.TextField(blank=True)
    reference_document = models.CharField(max_length=50, blank=True)
    reference_number = models.CharField(max_length=50, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_currency_transactions'
        verbose_name = 'Currency Transaction'
        verbose_name_plural = 'Currency Transactions'
        indexes = [
            models.Index(fields=['transaction_id', 'transaction_date'], name='idx_ct_transaction_date'),
            models.Index(fields=['transaction_currency_code', 'base_currency_code'], name='idx_ct_currencies'),
            models.Index(fields=['transaction_date'], name='idx_ct_date'),
            models.Index(fields=['cost_center_id'], name='idx_ct_cost_center'),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 CurrencyType**

```python
class CurrencyType(models.Model):
    """
    Reference data for currency types
    """
    
    currency_type_code = models.CharField(max_length=20, primary_key=True)
    currency_type_name = models.CharField(max_length=50)
    description = models.TextField(blank=True)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'ref_currency_types'
        verbose_name = 'Currency Type'
        verbose_name_plural = 'Currency Types'
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPSHIPS**

### **5.1 Primary Relationships**
- **ExchangeRate** → **Currency**: Many-to-one relationship for from/to currency
- **CurrencyRevaluation** → **Currency**: Many-to-one relationship for currency revaluation
- **CurrencyTransaction** → **Currency**: Many-to-one relationship for transaction currency

### **5.2 Many-to-Many Relationships**
- **Currency** ↔ **Company**: Multi-tenant support through company_id in related models

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**
- Currency codes must follow ISO 4217 standard (3-letter codes)
- Only one base currency allowed per company
- Exchange rates must be positive values
- Revaluation dates must be within fiscal year boundaries
- Transaction amounts must be positive

### **6.2 Validation Logic**

```python
def clean_currency_code(self):
    """
    Validate currency code format and ISO 4217 compliance
    """
    if not re.match(r'^[A-Z]{3}$', self.currency_code):
        raise ValidationError("Currency code must be 3 uppercase letters per ISO 4217")
    
    # Check if currency exists in reference data
    if not CurrencyType.objects.filter(currency_type_code=self.currency_type).exists():
        raise ValidationError("Invalid currency type")

def clean_exchange_rate(self):
    """
    Validate exchange rate configuration
    """
    if self.exchange_rate <= 0:
        raise ValidationError("Exchange rate must be positive")
    
    # Calculate inverse rate
    self.inverse_rate = 1 / self.exchange_rate
    
    # Validate inverse rate calculation
    if self.inverse_rate <= 0:
        raise ValidationError("Invalid exchange rate calculation")

def clean_base_currency_uniqueness(self):
    """
    Validate base currency uniqueness per company
    """
    if self.is_base_currency:
        existing_base = Currency.objects.filter(
            is_base_currency=True
        ).exclude(id=self.id)
        if existing_base.exists():
            raise ValidationError("Only one base currency is allowed")

def clean_date_consistency(self):
    """
    Validate date consistency for exchange rates
    """
    if self.expiry_date and self.effective_date >= self.expiry_date:
        raise ValidationError("Expiry date must be after effective date")
```

### **6.3 Business Constraints**
- Cannot delete base currency if transactions exist
- Cannot deactivate currency with open exchange rates
- Cannot modify currency codes if transactions exist
- Revaluation periods must align with fiscal periods
- Exchange rate sources must be validated and authorized

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**
- **Layout:** Tabbed interface with currency details, exchange rates, and revaluation
- **Navigation:** Sidebar navigation with currency list and details
- **Responsiveness:** Full desktop experience with tablet support

### **7.2 User Experience Design**
- **User Flow:** Select currency → View details → Manage exchange rates → Process revaluations
- **Error Handling:** Inline validation with clear error messages
- **Loading States:** Progress indicators for rate calculations

### **7.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility
- **Screen Reader Support:** Comprehensive ARIA labels

### **7.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **7.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **7.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **7.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **7.8 Border & Shadow System**
- **Border Radius:**
  - **None:** 0px
  - **SM:** 4px
  - **MD:** 8px
  - **LG:** 12px
  - **XL:** 16px
- **Box Shadows:**
  - **SM:** 0 1px 2px 0 rgba(0, 0, 0, 0.05)
  - **MD:** 0 4px 6px -1px rgba(0, 0, 0, 0.1)
  - **LG:** 0 10px 15px -3px rgba(0, 0, 0, 0.1)

### **7.9 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **7.10 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, currency type filter, status filter, base currency filter
- **Filter Actions:** Apply, Clear, Reset buttons

### **7.11 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

### **8.1 External Systems**
- **Banking Systems:** Exchange rate feeds and synchronization
- **Financial Data Providers:** Real-time rate updates
- **Regulatory Systems:** Currency compliance validation

### **8.2 Internal APIs**
- **Chart of Accounts API:** Currency assignment and validation
- **Journal Entries API:** Multi-currency transaction posting
- **Financial Reports API:** Currency conversion and reporting
- **Budget Management API:** Multi-currency budget tracking

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

### **9.1 REST Endpoints**

#### **GET /api/fms/currencies/**
- **Purpose:** Retrieve currencies list
- **Authentication:** JWT token required
- **Parameters:** company_id, is_active, is_base_currency, currency_type
- **Response:** Paginated currency list with configuration

#### **POST /api/fms/currencies/**
- **Purpose:** Create new currency
- **Authentication:** JWT token required
- **Request Body:** Currency details
- **Response:** Created currency object

#### **PUT /api/fms/currencies/{id}/**
- **Purpose:** Update existing currency
- **Authentication:** JWT token required
- **Request Body:** Updated currency details
- **Response:** Updated currency object

#### **POST /api/fms/exchange-rates/**
- **Purpose:** Create exchange rate
- **Authentication:** JWT token required
- **Request Body:** Exchange rate details
- **Response:** Created exchange rate object

#### **POST /api/fms/currencies/{id}/revalue/**
- **Purpose:** Process currency revaluation
- **Authentication:** JWT token required
- **Request Body:** Revaluation details
- **Response:** Revaluation confirmation

### **9.2 Data Formats**
- **Request Format:** JSON
- **Response Format:** JSON
- **Error Format:** {"error": "message", "code": "ERROR_CODE"}

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

### **10.1 Authentication**
- **Method:** JWT-based authentication
- **Authorization:** Role-based access control
- **Session Management:** Token refresh mechanism

### **10.2 Data Protection**
- **Encryption:** AES-256 encryption for sensitive financial data
- **Masking:** Exchange rate masking in logs and reports
- **Backup:** Daily encrypted backups with point-in-time recovery

### **10.3 Access Control**
- **Permissions:** Create, Read, Update, Delete permissions by role
- **Roles:** Finance Manager, Treasury Manager, Accountant, Viewer
- **Audit Trail:** Complete audit logging for all currency changes

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

### **11.1 Database Optimization**
- **Indexing Strategy:** Composite indexes on currency_code and effective dates
- **Query Optimization:** Optimized exchange rate calculation queries
- **Connection Pooling:** pgbouncer connection pooling

### **11.2 Caching Strategy**
- **Cache Layers:** Redis for exchange rate and currency caching
- **Cache Invalidation:** Cache invalidation on rate changes
- **Performance Metrics:** Query response time < 200ms

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

### **12.1 Unit Tests**
- **Coverage Target:** 90% code coverage
- **Test Framework:** pytest with Django test extensions
- **Test Data:** Factory Boy for test data generation

### **12.2 Integration Tests**
- **API Testing:** DRF test client for endpoint testing
- **Database Testing:** PostgreSQL integration testing
- **Third-party Testing:** Mock external system calls

### **12.3 User Acceptance Tests**
- **UAT Scenarios:** Complete currency management workflows
- **User Stories:** All user story acceptance criteria
- **Acceptance Criteria:** Functional and non-functional requirements

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

### **13.1 Environment Requirements**
- **Development:** Docker Compose with PostgreSQL
- **Staging:** Kubernetes cluster with staging database
- **Production:** Kubernetes cluster with HA PostgreSQL

### **13.2 Configuration Management**
- **Settings:** Django settings with environment variables
- **Environment Variables:** Database URLs, secret keys, API keys
- **Secrets Management:** Kubernetes secrets for sensitive data

### **13.3 Monitoring & Logging**
- **Application Logs:** Structured JSON logging with ELK stack
- **Performance Metrics:** Prometheus metrics collection
- **Error Tracking:** Sentry integration for error monitoring

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

### **14.1 Regular Maintenance**
- **Database Maintenance:** Weekly vacuum and analyze
- **Performance Tuning:** Monthly query performance review
- **Security Updates:** Patch Tuesday security updates

### **14.2 Support Procedures**
- **Issue Tracking:** Jira integration for bug tracking
- **Knowledge Base:** Confluence documentation
- **User Training:** Quarterly user training sessions

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

### **15.1 Version History**
- **v1.0.0:** Initial release with core currency management
- **v1.1.0:** Advanced exchange rate management enhancement
- **v1.2.0:** Automated revaluation features

### **15.2 Change Management**
- **Release Process:** GitFlow with feature branches
- **Rollback Procedures:** Database migration rollback capability
- **Migration Scripts:** Django migration management

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

### **16.1 Regulatory Compliance**
- **IFRS Compliance:** IFRS multi-currency accounting standards
- **SOX Compliance:** Sarbanes-Oxley internal controls
- **GDPR:** Data protection and privacy compliance
- **Local GAAP:** Support for country-specific accounting standards

### **16.2 Audit Requirements**
- **Audit Trail:** Complete change history with user attribution
- **Compliance Reporting:** Automated compliance report generation
- **Documentation:** Comprehensive technical and user documentation

--- END OF SECTION 16 ---
