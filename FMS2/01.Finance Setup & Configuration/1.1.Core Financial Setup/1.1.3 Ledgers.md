# FMS BBP - Ledgers

## **1. MODULE IDENTIFICATION**

**Module Name:** Ledgers
**Module Number:** 1.3
**Module Type:** Master
**Target File:** FMS/01.Finance Setup & Configuration/1.3 Ledgers.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Ledgers module provides the foundational accounting book structure for recording, classifying, and summarizing financial transactions, enabling accurate financial reporting, audit trails, and compliance with accounting standards following Tally, NetSuite, and Dynamics 365 finance principles.

### **2.2 Business Scope**
**In Scope:**
- General ledger setup and configuration
- Sub-ledger management (accounts receivable, payable, fixed assets)
- Ledger opening balance management
- Ledger period and fiscal year configuration
- Multi-currency ledger support
- Ledger hierarchy and consolidation rules

**Out of Scope:**
- Transaction posting (handled by Journal Entries module)
- Financial report generation (handled by Analytics module)
- Bank reconciliation (handled by Bank Reconciliation module)

### **2.3 Key Stakeholders**
- **Chief Financial Officer:** Strategic ledger structure oversight
- **Finance Managers:** Ledger configuration and period management
- **Accountants:** Daily ledger operations and transaction posting
- **Auditors:** Ledger audit trail and compliance validation
- **System Administrators:** Ledger technical configuration and maintenance

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: Ledger**

```python
class Ledger(models.Model):
    """
    Master ledger configuration for financial accounting
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    ledger_code = models.CharField(max_length=20)
    ledger_name = models.CharField(max_length=100)
    ledger_type = models.CharField(
        max_length=20,
        choices=[
            ('GENERAL', 'General Ledger'),
            ('ACCOUNTS_RECEIVABLE', 'Accounts Receivable Ledger'),
            ('ACCOUNTS_PAYABLE', 'Accounts Payable Ledger'),
            ('FIXED_ASSETS', 'Fixed Assets Ledger'),
            ('CASH_MANAGEMENT', 'Cash Management Ledger'),
            ('INVENTORY', 'Inventory Ledger'),
            ('PAYROLL', 'Payroll Ledger'),
            ('PROJECT_COSTING', 'Project Costing Ledger'),
            ('TAX', 'Tax Ledger'),
        ]
    )
    description = models.TextField(blank=True)
    currency_code = models.CharField(max_length=3, default='USD')
    is_active = models.BooleanField(default=True)
    is_primary_ledger = models.BooleanField(default=False)
    is_consolidation_ledger = models.BooleanField(default=False)
    
    # Fiscal Year Configuration
    fiscal_year_start = models.DateField()
    fiscal_year_end = models.DateField()
    current_period = models.IntegerField(default=1)
    total_periods = models.IntegerField(default=12)
    period_locking_enabled = models.BooleanField(default=True)
    
    # Ledger Configuration
    auto_posting_enabled = models.BooleanField(default=True)
    multi_currency_enabled = models.BooleanField(default=False)
    inter_company_enabled = models.BooleanField(default=False)
    budget_control_enabled = models.BooleanField(default=False)
    
    # Opening Balances
    opening_balance_date = models.DateField()
    opening_balance_locked = models.BooleanField(default=False)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_ledgers'
        verbose_name = 'Ledger'
        verbose_name_plural = 'Ledgers'
        indexes = [
            models.Index(fields=['company_id', 'ledger_code'], name='idx_ledger_company_code'),
            models.Index(fields=['company_id', 'ledger_type'], name='idx_ledger_company_type'),
            models.Index(fields=['is_active'], name='idx_ledger_active'),
            models.Index(fields=['is_primary_ledger'], name='idx_ledger_primary'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'ledger_code'], name='uk_ledger_company_code'),
            models.UniqueConstraint(fields=['company_id', 'is_primary_ledger'], condition=models.Q(is_primary_ledger=True), name='uk_ledger_primary'),
            models.CheckConstraint(check=models.Q(current_period__gte=1) & models.Q(current_period__lte=models.F('total_periods')), name='ck_ledger_period_range'),
        ]

class LedgerPeriod(models.Model):
    """
    Ledger period configuration for financial year management
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    ledger_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    period_number = models.IntegerField()
    period_name = models.CharField(max_length=50)
    start_date = models.DateField()
    end_date = models.DateField()
    is_current_period = models.BooleanField(default=False)
    is_locked = models.BooleanField(default=False)
    is_posting_allowed = models.BooleanField(default=True)
    
    # Period Status
    opening_balance_locked = models.BooleanField(default=False)
    closing_balance_locked = models.BooleanField(default=False)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_ledger_periods'
        verbose_name = 'Ledger Period'
        verbose_name_plural = 'Ledger Periods'
        indexes = [
            models.Index(fields=['ledger_id', 'period_number'], name='idx_lp_ledger_period'),
            models.Index(fields=['start_date', 'end_date'], name='idx_lp_dates'),
            models.Index(fields=['is_current_period'], name='idx_lp_current'),
            models.Index(fields=['is_locked'], name='idx_lp_locked'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['ledger_id', 'period_number'], name='uk_lp_ledger_period'),
            models.CheckConstraint(check=models.Q(period_number__gte=1), name='ck_lp_period_positive'),
            models.CheckConstraint(check=models.Q(start_date__lte=models.F('end_date')), name='ck_lp_date_range'),
        ]

class LedgerAccountMapping(models.Model):
    """
    Mapping between chart of accounts and ledgers
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    ledger_id = models.UUIDField()
    account_id = models.UUIDField()
    is_active = models.BooleanField(default=True)
    posting_allowed = models.BooleanField(default=True)
    
    # Account Configuration in Ledger
    opening_balance = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    opening_balance_date = models.DateField()
    cost_center_required = models.BooleanField(default=False)
    budget_control_enabled = models.BooleanField(default=False)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_ledger_account_mappings'
        verbose_name = 'Ledger Account Mapping'
        verbose_name_plural = 'Ledger Account Mappings'
        indexes = [
            models.Index(fields=['ledger_id', 'account_id'], name='idx_lam_ledger_account'),
            models.Index(fields=['account_id'], name='idx_lam_account'),
            models.Index(fields=['is_active'], name='idx_lam_active'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['ledger_id', 'account_id'], name='uk_lam_ledger_account'),
        ]

class LedgerBalance(models.Model):
    """
    Ledger account balances by period
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    ledger_id = models.UUIDField()
    account_id = models.UUIDField()
    period_id = models.UUIDField()
    
    opening_balance = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    debit_amount = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    credit_amount = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    closing_balance = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    currency_code = models.CharField(max_length=3, default='USD')
    
    balance_date = models.DateField()
    last_transaction_date = models.DateField(null=True, blank=True)
    transaction_count = models.IntegerField(default=0)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_ledger_balances'
        verbose_name = 'Ledger Balance'
        verbose_name_plural = 'Ledger Balances'
        indexes = [
            models.Index(fields=['ledger_id', 'account_id', 'period_id'], name='idx_lb_ledger_account_period'),
            models.Index(fields=['account_id', 'balance_date'], name='idx_lb_account_date'),
            models.Index(fields=['period_id'], name='idx_lb_period'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['ledger_id', 'account_id', 'period_id'], name='uk_lb_ledger_account_period'),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 LedgerType**

```python
class LedgerType(models.Model):
    """
    Reference data for ledger types
    """
    
    ledger_type_code = models.CharField(max_length=20, primary_key=True)
    ledger_type_name = models.CharField(max_length=50)
    description = models.TextField(blank=True)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        db_table = 'ref_ledger_types'
        verbose_name = 'Ledger Type'
        verbose_name_plural = 'Ledger Types'
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPS**

### **5.1 Primary Relationships**
- **LedgerPeriod** → **Ledger**: Many-to-one relationship for period management
- **LedgerAccountMapping** → **Ledger**: Many-to-one relationship for account assignment
- **LedgerAccountMapping** → **ChartOfAccount**: Many-to-one relationship for account mapping
- **LedgerBalance** → **Ledger**: Many-to-one relationship for balance tracking
- **LedgerBalance** → **ChartOfAccount**: Many-to-one relationship for account balances
- **LedgerBalance** → **LedgerPeriod**: Many-to-one relationship for period balances

### **5.2 Many-to-Many Relationships**
- **Ledger** ↔ **ChartOfAccount**: Through LedgerAccountMapping model
- **Ledger** ↔ **Company**: Multi-tenant support through company_id

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**
- Ledger codes must be unique within each company
- Only one primary ledger allowed per company
- Fiscal year dates must be valid and non-overlapping
- Period dates must be within fiscal year boundaries
- Opening balances must respect account type logic

### **6.2 Validation Logic**

```python
def clean_ledger_code(self):
    """
    Validate ledger code format and uniqueness
    """
    if not re.match(r'^[A-Z0-9\-]+$', self.ledger_code):
        raise ValidationError("Ledger code can only contain uppercase letters, numbers, and hyphens")
    
    # Check uniqueness within company
    if Ledger.objects.filter(
        company_id=self.company_id,
        ledger_code=self.ledger_code
    ).exclude(id=self.id).exists():
        raise ValidationError("Ledger code must be unique within company")

def clean_fiscal_year(self):
    """
    Validate fiscal year configuration
    """
    if self.fiscal_year_start >= self.fiscal_year_end:
        raise ValidationError("Fiscal year start date must be before end date")
    
    # Check fiscal year duration (should be approximately 1 year)
    year_duration = self.fiscal_year_end - self.fiscal_year_start
    if year_duration.days < 350 or year_duration.days > 380:
        raise ValidationError("Fiscal year duration should be approximately 365 days")

def clean_primary_ledger(self):
    """
    Validate primary ledger uniqueness
    """
    if self.is_primary_ledger:
        existing_primary = Ledger.objects.filter(
            company_id=self.company_id,
            is_primary_ledger=True
        ).exclude(id=self.id)
        if existing_primary.exists():
            raise ValidationError("Only one primary ledger is allowed per company")

def clean_period_configuration(self):
    """
    Validate period configuration
    """
    if self.current_period < 1 or self.current_period > self.total_periods:
        raise ValidationError("Current period must be between 1 and total periods")
```

### **6.3 Business Constraints**
- Cannot delete primary ledger
- Cannot modify fiscal year if transactions exist
- Cannot lock current period if posting is required
- Cannot deactivate ledger with active transactions
- Opening balances cannot be modified after locking

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**
- **Layout:** Tabbed interface with ledger details, periods, and account mappings
- **Navigation:** Sidebar navigation with ledger list and details
- **Responsiveness:** Full desktop experience with tablet support

### **7.2 User Experience Design**
- **User Flow:** Select ledger → View details → Configure periods → Map accounts → Save
- **Error Handling:** Inline validation with clear error messages
- **Loading States:** Progress indicators for period generation

### **7.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility
- **Screen Reader Support:** Comprehensive ARIA labels

### **7.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **7.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **7.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **7.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **7.8 Border & Shadow System**
- **Border Radius:**
  - **None:** 0px
  - **SM:** 4px
  - **MD:** 8px
  - **LG:** 12px
  - **XL:** 16px
- **Box Shadows:**
  - **SM:** 0 1px 2px 0 rgba(0, 0, 0, 0.05)
  - **MD:** 0 4px 6px -1px rgba(0, 0, 0, 0.1)
  - **LG:** 0 10px 15px -3px rgba(0, 0, 0, 0.1)

### **7.9 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **7.10 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, ledger type filter, status filter, currency filter
- **Filter Actions:** Apply, Clear, Reset buttons

### **7.11 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

### **8.1 External Systems**
- **Banking Systems:** Ledger reconciliation and balance synchronization
- **Tax Systems:** Tax ledger integration and reporting
- **ERP Systems:** Master ledger data synchronization

### **8.2 Internal APIs**
- **Chart of Accounts API:** Account mapping and validation
- **Journal Entries API:** Transaction posting and validation
- **Financial Reports API:** Ledger-based report generation
- **Budget Management API:** Budget control and monitoring

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

### **9.1 REST Endpoints**

#### **GET /api/fms/ledgers/**
- **Purpose:** Retrieve ledgers list
- **Authentication:** JWT token required
- **Parameters:** company_id, ledger_type, is_active, is_primary_ledger
- **Response:** Paginated ledger list with configuration

#### **POST /api/fms/ledgers/**
- **Purpose:** Create new ledger
- **Authentication:** JWT token required
- **Request Body:** Ledger details
- **Response:** Created ledger object

#### **PUT /api/fms/ledgers/{id}/**
- **Purpose:** Update existing ledger
- **Authentication:** JWT token required
- **Request Body:** Updated ledger details
- **Response:** Updated ledger object

#### **POST /api/fms/ledgers/{id}/generate-periods/**
- **Purpose:** Generate fiscal year periods
- **Authentication:** JWT token required
- **Request Body:** Period configuration
- **Response:** Generated periods list

#### **POST /api/fms/ledgers/{id}/map-accounts/**
- **Purpose:** Map accounts to ledger
- **Authentication:** JWT token required
- **Request Body:** Account mappings and opening balances
- **Response:** Mapping confirmation

### **9.2 Data Formats**
- **Request Format:** JSON
- **Response Format:** JSON
- **Error Format:** {"error": "message", "code": "ERROR_CODE"}

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

### **10.1 Authentication**
- **Method:** JWT-based authentication
- **Authorization:** Role-based access control
- **Session Management:** Token refresh mechanism

### **10.2 Data Protection**
- **Encryption:** AES-256 encryption for sensitive financial data
- **Masking:** Balance masking in logs and reports
- **Backup:** Daily encrypted backups with point-in-time recovery

### **10.3 Access Control**
- **Permissions:** Create, Read, Update, Delete permissions by role
- **Roles:** Finance Manager, Accountant, Auditor, Viewer
- **Audit Trail:** Complete audit logging for all ledger changes

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

### **11.1 Database Optimization**
- **Indexing Strategy:** Composite indexes on company_id + ledger_code
- **Query Optimization:** Optimized balance calculation queries
- **Connection Pooling:** pgbouncer connection pooling

### **11.2 Caching Strategy**
- **Cache Layers:** Redis for ledger configuration and balance caching
- **Cache Invalidation:** Cache invalidation on ledger changes
- **Performance Metrics:** Query response time < 200ms

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

### **12.1 Unit Tests**
- **Coverage Target:** 90% code coverage
- **Test Framework:** pytest with Django test extensions
- **Test Data:** Factory Boy for test data generation

### **12.2 Integration Tests**
- **API Testing:** DRF test client for endpoint testing
- **Database Testing:** PostgreSQL integration testing
- **Third-party Testing:** Mock external system calls

### **12.3 User Acceptance Tests**
- **UAT Scenarios:** Complete ledger management workflows
- **User Stories:** All user story acceptance criteria
- **Acceptance Criteria:** Functional and non-functional requirements

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

### **13.1 Environment Requirements**
- **Development:** Docker Compose with PostgreSQL
- **Staging:** Kubernetes cluster with staging database
- **Production:** Kubernetes cluster with HA PostgreSQL

### **13.2 Configuration Management**
- **Settings:** Django settings with environment variables
- **Environment Variables:** Database URLs, secret keys, API keys
- **Secrets Management:** Kubernetes secrets for sensitive data

### **13.3 Monitoring & Logging**
- **Application Logs:** Structured JSON logging with ELK stack
- **Performance Metrics:** Prometheus metrics collection
- **Error Tracking:** Sentry integration for error monitoring

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

### **14.1 Regular Maintenance**
- **Database Maintenance:** Weekly vacuum and analyze
- **Performance Tuning:** Monthly query performance review
- **Security Updates:** Patch Tuesday security updates

### **14.2 Support Procedures**
- **Issue Tracking:** Jira integration for bug tracking
- **Knowledge Base:** Confluence documentation
- **User Training:** Quarterly user training sessions

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

### **15.1 Version History**
- **v1.0.0:** Initial release with core ledger management
- **v1.1.0:** Multi-currency ledger enhancement
- **v1.2.0:** Advanced period management features

### **15.2 Change Management**
- **Release Process:** GitFlow with feature branches
- **Rollback Procedures:** Database migration rollback capability
- **Migration Scripts:** Django migration management

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

### **16.1 Regulatory Compliance**
- **IFRS Compliance:** IFRS accounting standards support
- **SOX Compliance:** Sarbanes-Oxley internal controls
- **GDPR:** Data protection and privacy compliance
- **Local GAAP:** Support for country-specific accounting standards

### **16.2 Audit Requirements**
- **Audit Trail:** Complete change history with user attribution
- **Compliance Reporting:** Automated compliance report generation
- **Documentation:** Comprehensive technical and user documentation

--- END OF SECTION 16 ---
