# 1. MODULE IDENTIFICATION

**Module Name:** Multi-currency
**Module Number:** 2.2
**Module Type:** Transaction
**Target File:** FMS/02.Finance Operations & Entries/2.2.Multi-currency.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** FMS Development Team

---

# 2. PURPOSE

## 2.1 Business Purpose
Multi-currency module enables organizations to conduct financial transactions across multiple currencies, manage exchange rate fluctuations, and handle foreign exchange gains and losses. This module is essential for businesses operating internationally, dealing with foreign suppliers/customers, or managing multi-entity operations across different countries.

## 2.2 Business Scope
- Currency management and exchange rate maintenance
- Multi-currency transaction processing and conversion
- Foreign exchange gain/loss calculation and posting
- Currency revaluation and unrealized gain/loss management
- Multi-currency reporting and consolidation
- Exchange rate variance analysis and tracking
- Currency hedging and forward contract management
- Realized and unrealized gain/loss reporting

## 2.3 Key Stakeholders
- Finance Managers: Monitor currency exposure and FX impacts
- Accountants: Process multi-currency transactions and reconciliations
- Treasury Teams: Manage exchange rate risks and hedging strategies
- Management: Review multi-currency financial reports and analytics
- External Auditors: Verify currency compliance and reporting accuracy

---

# 3. CORE MODELS (DJANGO)

## 3.1 Primary Model: Currency

```python
class Currency(models.Model):
    """
    Master model for managing currency definitions and properties
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    currency_code = models.CharField(max_length=3, unique=True)  # ISO 4217 code
    currency_name = models.CharField(max_length=100)
    currency_symbol = models.CharField(max_length=10)
    decimal_places = models.IntegerField(default=2)
    is_base_currency = models.BooleanField(default=False)
    is_active = models.BooleanField(default=True)
    exchange_rate_precision = models.IntegerField(default=6)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_currencies'
        verbose_name = 'Currency'
        verbose_name_plural = 'Currencies'
        indexes = [
            models.Index(fields=['company_id', 'currency_code'], name='idx_currency_company_code'),
            models.Index(fields=['is_base_currency'], name='idx_currency_base'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'currency_code'], name='uk_currency_company_code'),
        ]
```

## 3.2 Primary Model: ExchangeRate

```python
class ExchangeRate(models.Model):
    """
    Exchange rate management for currency conversion
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    from_currency_id = models.UUIDField()
    to_currency_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    exchange_rate = models.DecimalField(max_digits=20, decimal_places=10)
    effective_date = models.DateField()
    rate_type = models.CharField(max_length=20, choices=[
        ('SPOT', 'Spot Rate'),
        ('FORWARD', 'Forward Rate'),
        ('AVERAGE', 'Average Rate'),
        ('CLOSING', 'Closing Rate'),
    ], default='SPOT')
    is_active = models.BooleanField(default=True)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_exchange_rates'
        verbose_name = 'Exchange Rate'
        verbose_name_plural = 'Exchange Rates'
        indexes = [
            models.Index(fields=['company_id', 'from_currency_id', 'to_currency_id', 'effective_date'], 
                      name='idx_exchange_rate_lookup'),
            models.Index(fields=['effective_date'], name='idx_exchange_rate_date'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'from_currency_id', 'to_currency_id', 
                                       'effective_date', 'rate_type'], name='uk_exchange_rate_unique'),
        ]
```

## 3.3 Primary Model: CurrencyTransaction

```python
class CurrencyTransaction(models.Model):
    """
    Multi-currency transaction details and conversion tracking
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    transaction_id = models.UUIDField()  # Reference to main transaction
    currency_id = models.UUIDField()
    base_currency_id = models.UUIDField()
    exchange_rate_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    transaction_amount = models.DecimalField(max_digits=20, decimal_places=2)
    base_currency_amount = models.DecimalField(max_digits=20, decimal_places=2)
    exchange_rate = models.DecimalField(max_digits=20, decimal_places=10)
    exchange_rate_date = models.DateField()
    realized_gain_loss = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    unrealized_gain_loss = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_currency_transactions'
        verbose_name = 'Currency Transaction'
        verbose_name_plural = 'Currency Transactions'
        indexes = [
            models.Index(fields=['company_id', 'transaction_id'], name='idx_currency_transaction'),
            models.Index(fields=['currency_id', 'exchange_rate_date'], name='idx_currency_rate_date'),
        ]
```

---

# 4. REFERENCE MODELS (DJANGO)

## 4.1 CurrencyRevaluation

```python
class CurrencyRevaluation(models.Model):
    """
    Currency revaluation process tracking
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    currency_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    
    # Core Fields
    revaluation_date = models.DateField()
    old_exchange_rate = models.DecimalField(max_digits=20, decimal_places=10)
    new_exchange_rate = models.DecimalField(max_digits=20, decimal_places=10)
    revaluation_amount = models.DecimalField(max_digits=20, decimal_places=2)
    status = models.CharField(max_length=20, choices=[
        ('PENDING', 'Pending'),
        ('PROCESSING', 'Processing'),
        ('COMPLETED', 'Completed'),
        ('FAILED', 'Failed'),
    ], default='PENDING')
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_currency_revaluations'
        verbose_name = 'Currency Revaluation'
        verbose_name_plural = 'Currency Revaluations'
        indexes = [
            models.Index(fields=['company_id', 'revaluation_date'], name='idx_revaluation_date'),
        ]
```

---

# 5. FOREIGN KEY RELATIONSHIPS

## 5.1 Primary Relationships
- **Currency** → **ExchangeRate**: Currency can have multiple exchange rates as from_currency or to_currency
- **CurrencyTransaction** → **Currency**: Each transaction belongs to a specific currency
- **CurrencyTransaction** → **ExchangeRate**: Transaction uses specific exchange rate for conversion
- **CurrencyRevaluation** → **Currency**: Revaluation is performed for specific currency

## 5.2 Many-to-Many Relationships
- **Currency** ↔ **Currency**: Through ExchangeRate model for bidirectional rate management

---

# 6. BUSINESS RULES & VALIDATIONS

## 6.1 Data Integrity Rules
- Each company must have exactly one base currency
- Exchange rates cannot be zero or negative
- Currency codes must follow ISO 4217 standard (3 characters)
- Exchange rate effective dates cannot be in the future for spot rates
- Base currency exchange rate is always 1.0

## 6.2 Validation Logic
```python
def clean_exchange_rate(self):
    """
    Custom validation for exchange rate
    """
    if self.exchange_rate <= 0:
        raise ValidationError("Exchange rate must be greater than zero")
    
    if self.from_currency_id == self.to_currency_id:
        raise ValidationError("From and to currencies cannot be the same")

def clean_currency_code(self):
    """
    Validate currency code format
    """
    if not re.match(r'^[A-Z]{3}$', self.currency_code):
        raise ValidationError("Currency code must be 3 uppercase letters (ISO 4217)")
```

## 6.3 Business Constraints
- Only one active exchange rate per currency pair per day
- Historical exchange rates cannot be modified once transactions are posted
- Currency revaluation can only be performed for inactive periods
- Base currency cannot be deactivated if transactions exist

---

# 7. UI/UX SPECIFICATIONS

## 7.1 User Interface Requirements
- **Layout:** Master-detail layout with currency list and exchange rate management
- **Navigation:** Tab-based interface for currencies, exchange rates, and revaluation
- **Responsiveness:** Fully responsive design for mobile, tablet, and desktop access

## 7.2 User Experience Design
- **User Flow:** Currency setup → Exchange rate management → Transaction processing → Revaluation
- **Error Handling:** Clear validation messages with actionable guidance
- **Loading States:** Progress indicators for exchange rate imports and revaluation processes

## 7.3 Accessibility Standards
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard support for all currency operations
- **Screen Reader Support:** Comprehensive ARIA labels and descriptions

## 7.4 Visual Design System
- **Color Scheme:** Professional financial system color palette
- **Typography:** Clean, readable fonts for numerical data
- **Iconography:** Currency symbols and financial icons for intuitive navigation

## 7.5 Design Language Standards
- **Design System:** Material Design 3.0 with financial system adaptations
- **Component Library:** Custom financial components for currency display
- **Design Tokens:** Consistent spacing and sizing for financial data

## 7.6 Typography Standards
- **Primary Font Family:** Inter, system-ui, -apple-system, sans-serif
- **Secondary Font Family:** Roboto Mono for numerical data
- **Font Sizes:**
  - **H1:** 32px / 700 / 1.2
  - **H2:** 24px / 600 / 1.3
  - **H3:** 20px / 600 / 1.4
  - **H4:** 18px / 600 / 1.4
  - **H5:** 16px / 500 / 1.5
  - **H6:** 14px / 500 / 1.5
  - **Body Large:** 16px / 400 / 1.5
  - **Body Medium:** 14px / 400 / 1.5
  - **Body Small:** 12px / 400 / 1.4
  - **Caption:** 11px / 400 / 1.4
- **Font Weights:** 300, 400, 500, 600, 700
- **Text Colors:** Primary #1a1a1a, Secondary #666666, Tertiary #999999, Disabled #cccccc, Error #d32f2f, Success #2e7d32, Warning #ed6c02

## 7.7 Color Palette
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Secondary Colors:** #5c6bc0 palette
- **Neutral Colors:** Gray scale from #fafafa to #212121
- **Semantic Colors:**
  - **Success:** #4caf50 palette
  - **Warning:** #ff9800 palette
  - **Error:** #f44336 palette
  - **Info:** #2196f3 palette

## 7.8 Spacing System
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

## 7.9 Border & Shadow System
- **Border Radius:**
  - **None:** 0px
  - **SM:** 2px
  - **MD:** 4px
  - **LG:** 8px
  - **XL:** 12px
  - **Full:** 50%
- **Border Width:** 0px, 1px, 2px
- **Box Shadows:**
  - **SM:** 0 1px 3px rgba(0,0,0,0.12)
  - **MD:** 0 4px 6px rgba(0,0,0,0.12)
  - **LG:** 0 10px 20px rgba(0,0,0,0.12)
  - **XL:** 0 14px 28px rgba(0,0,0,0.12)

## 7.10 Component Standards
- **Buttons:**
  - **Primary Button:** 40px height, 16px padding, 4px border-radius, Primary 500 background
  - **Secondary Button:** 40px height, 16px padding, 4px border-radius, transparent background
  - **Outline Button:** 40px height, 16px padding, 4px border-radius, Primary 500 border
  - **Text Button:** 32px height, 8px padding, transparent background
  - **Icon Button:** 40px height, 8px padding, circular shape
- **Form Controls:**
  - **Text Input:** 56px height, 16px padding, 1px border, Primary 500 focus
  - **Select Dropdown:** 56px height, 16px padding, 1px border, dropdown arrow
  - **Date Picker:** 56px height, calendar icon, date format display
  - **Number Input:** 56px height, step validation, currency symbol prefix
- **Cards:**
  - **Default Card:** 24px padding, MD shadow, 4px border-radius
  - **Elevated Card:** 24px padding, LG shadow, 4px border-radius
- **Tables:**
  - **Header Row:** 56px height, #f5f5f5 background, 600 weight text
  - **Data Row:** 48px height, bottom border, hover #fafafa background
  - **Pagination:** 40px height, Primary 500 active state

## 7.11 Filter System Standards
- **Filter Layout:** Sidebar layout with collapsible sections
- **Filter Components:**
  - **Search Input:** 300px width, search icon, placeholder text
  - **Date Range Picker:** Date format display, preset options (Today, This Week, This Month)
  - **Multi-select Dropdown:** Chip display, max 5 visible items
  - **Single Select Dropdown:** 200px width, search capability
  - **Checkbox Group:** Vertical layout, max 8 visible items
- **Filter Actions:**
  - **Apply Button:** Bottom right position, Primary style
  - **Clear Button:** Bottom left position, Text style
  - **Save Filter:** Top right position, bookmark icon
- **Filter States:**
  - **Active Filters:** Blue chip display with remove icon
  - **Filter Count:** Badge display on filter button

## 7.12 Data Display Standards
- **Tables:**
  - **Column Headers:** Left alignment, sorting icons, resizable columns
  - **Row Height:** 48px standard, 40px compact
  - **Cell Padding:** 16px horizontal, 12px vertical
  - **Alternating Rows:** #fafafa background for odd rows
  - **Hover State:** #f0f0f0 background, 0.2s transition
  - **Selection State:** #e3f2fd background, checkbox in first column
- **Lists:**
  - **List Item Height:** 56px standard
  - **List Item Padding:** 16px horizontal, 8px vertical
  - **Divider Lines:** 1px height, #e0e0e0 color
  - **Avatar Size:** 32px small, 40px medium, 48px large
- **Cards/Grid:**
  - **Card Spacing:** 16px gap between cards
  - **Card Aspect Ratio:** 16:9 standard
  - **Image Placeholder:** 200px height, #f5f5f5 background

## 7.13 Interactive Elements
- **Hover States:** 0.2s color transitions, opacity changes
- **Focus States:** 2px Primary 500 outline, 2px offset
- **Active States:** Primary 700 background, scale transform
- **Disabled States:** 0.6 opacity, not-allowed cursor, gray colors
- **Loading States:** 20px spinner, skeleton screens with 0.8s animation
- **Empty States:** 200px illustration, centered message, primary action button

## 7.14 Responsive Design Standards
- **Breakpoints:**
  - **Mobile:** <768px
  - **Tablet:** 768px - 1024px
  - **Desktop:** >1024px
  - **Large Desktop:** >1440px
- **Container Max Widths:** 100% mobile, 750px tablet, 1200px desktop
- **Grid Systems:** 1 column mobile, 2 columns tablet, 3-4 columns desktop
- **Typography Scaling:** 0.875x mobile, 1x tablet, 1.125x desktop
- **Component Adaptations:** Stack layout on mobile, side-by-side on desktop

## 7.15 Animation & Transitions
- **Transition Duration:** 0.15s fast, 0.3s medium, 0.5s slow
- **Easing Functions:** ease-in-out for most transitions
- **Micro-interactions:** Button scale (1.02), form field focus glow
- **Page Transitions:** 0.3s fade effect
- **Loading Animations:** 1s rotating spinner, 1.5s skeleton pulse

# 8. INTEGRATION POINTS

## 8.1 External Systems
- **Bank APIs:** Real-time exchange rate feeds from central banks and financial institutions
- **Currency Exchange Services:** Integration with services like XE, OANDA, or Reuters for live rates
- **ERP Systems:** Synchronization with external ERP systems for multi-entity currency management
- **Payment Gateways:** Currency conversion integration for international payment processing

## 8.2 Internal APIs
- **Transaction API:** Currency conversion for all financial transactions
- **Reporting API:** Multi-currency financial reporting and consolidation
- **General Ledger API:** Currency-aware GL posting and balance tracking
- **Treasury API:** Exchange rate management and FX exposure tracking

---

# 9. API SPECIFICATIONS

## 9.1 REST Endpoints

#### **GET /api/currencies/**
- **Purpose:** Retrieve all active currencies for the company
- **Authentication:** JWT token required
- **Parameters:** company_id, is_active
- **Response:** List of currency objects with current exchange rates

#### **POST /api/currencies/**
- **Purpose:** Create new currency
- **Authentication:** JWT token required
- **Request Body:** Currency details (code, name, symbol, decimal_places)
- **Response:** Created currency object with ID

#### **GET /api/exchange-rates/**
- **Purpose:** Get exchange rates for currency pairs
- **Authentication:** JWT token required
- **Parameters:** from_currency, to_currency, effective_date, rate_type
- **Response:** Exchange rate object with rate and metadata

#### **POST /api/exchange-rates/**
- **Purpose:** Create or update exchange rate
- **Authentication:** JWT token required
- **Request Body:** Exchange rate details (from_currency, to_currency, rate, effective_date)
- **Response:** Created/updated exchange rate object

#### **POST /api/currency-conversion/**
- **Purpose:** Convert amount between currencies
- **Authentication:** JWT token required
- **Request Body:** Amount, from_currency, to_currency, conversion_date
- **Response:** Converted amount with exchange rate details

#### **POST /api/currency-revaluation/**
- **Purpose:** Trigger currency revaluation process
- **Authentication:** JWT token required
- **Request Body:** Revaluation date, currency_list, revaluation_type
- **Response:** Revaluation job ID with status tracking

## 9.2 Data Formats
- **Request Format:** JSON with proper decimal precision for financial amounts
- **Response Format:** JSON with standardized currency codes and exchange rates
- **Error Format:** JSON with error code, message, and validation details

---

# 10. SECURITY REQUIREMENTS

## 10.1 Authentication
- **Method:** JWT-based authentication with role-based access control
- **Authorization:** Currency management permissions (view, edit, admin)
- **Session Management:** Secure session handling with automatic timeout

## 10.2 Data Protection
- **Encryption:** AES-256 encryption for sensitive exchange rate data
- **Masking:** Partial masking of confidential financial information
- **Backup:** Daily encrypted backups of currency and exchange rate data

## 10.3 Access Control
- **Permissions:** 
  - currency_view: View currency information and exchange rates
  - currency_edit: Create and update currencies and exchange rates
  - currency_admin: Full administrative access including revaluation
- **Roles:** Finance Manager, Accountant, Treasury Manager, Auditor
- **Audit Trail:** Complete audit logging for all currency operations

---

# 11. PERFORMANCE CONSIDERATIONS

## 11.1 Database Optimization
- **Indexing Strategy:** Optimized indexes for currency lookups and exchange rate queries
- **Query Optimization:** Efficient queries for high-volume transaction processing
- **Connection Pooling:** Database connection management for concurrent access

## 11.2 Caching Strategy
- **Cache Layers:** Redis caching for frequently accessed exchange rates
- **Cache Invalidation:** Time-based cache invalidation for exchange rate updates
- **Performance Metrics:** Exchange rate lookup time, conversion processing time

---

# 12. TESTING REQUIREMENTS

## 12.1 Unit Tests
- **Coverage Target:** 95% code coverage for currency models and business logic
- **Test Framework:** pytest with Django test framework
- **Test Data:** Comprehensive test data for various currency scenarios

## 12.2 Integration Tests
- **API Testing:** Complete API endpoint testing for currency operations
- **Database Testing:** Currency model relationship and constraint testing
- **Third-party Testing:** External exchange rate service integration testing

## 12.3 User Acceptance Tests
- **UAT Scenarios:** Multi-currency transaction processing workflows
- **User Stories:** Currency setup, exchange rate management, revaluation processes
- **Acceptance Criteria:** Accurate currency conversion and proper gain/loss calculation

---

# 13. DEPLOYMENT SPECIFICATIONS

## 13.1 Environment Requirements
- **Development:** Local development with sample currency data
- **Staging:** Pre-production environment with real exchange rate feeds
- **Production:** High-availability setup with load balancing

## 13.2 Configuration Management
- **Settings:** Currency configuration parameters and exchange rate sources
- **Environment Variables:** API keys for external exchange rate services
- **Secrets Management:** Secure storage of sensitive configuration data

## 13.3 Monitoring & Logging
- **Application Logs:** Currency operation logs with detailed audit trails
- **Performance Metrics:** Exchange rate update performance and conversion accuracy
- **Error Tracking:** Real-time error monitoring and alerting

---

# 14. MAINTENANCE & SUPPORT

## 14.1 Regular Maintenance
- **Database Maintenance:** Monthly exchange rate history cleanup and archiving
- **Performance Tuning:** Quarterly performance optimization for currency operations
- **Security Updates:** Regular security patches for currency data protection

## 14.2 Support Procedures
- **Issue Tracking:** Ticket system integration for currency-related issues
- **Knowledge Base:** Documentation for currency management procedures
- **User Training:** Training programs for multi-currency transaction processing

---

# 15. VERSION CONTROL

## 15.1 Version History
- **v1.0.0:** Initial release with basic currency management and exchange rate functionality
- **v1.1.0:** Added currency revaluation and unrealized gain/loss calculation
- **v1.2.0:** Enhanced reporting and multi-entity consolidation support

## 15.2 Change Management
- **Release Process:** Structured release process with backward compatibility
- **Rollback Procedures:** Emergency rollback capabilities for critical issues
- **Migration Scripts:** Data migration scripts for currency schema updates

---

# 16. COMPLIANCE & AUDIT

## 16.1 Regulatory Compliance
- **IFRS Compliance:** IFRS 9 and IAS 21 compliance for foreign currency transactions
- **SOX Compliance:** Sarbanes-Oxley compliance for financial reporting accuracy
- **GDPR:** Data protection compliance for currency transaction data

## 16.2 Audit Requirements
- **Audit Trail:** Complete audit trail for all currency operations and changes
- **Compliance Reporting:** Automated generation of currency compliance reports
- **Documentation:** Comprehensive documentation for audit purposes

---

***END OF SECTION 16***

**END OF MULTI-CURRENCY BBP**
