# FMS BBP - Multi-entity Consolidation

## **1. MODULE IDENTIFICATION**

**Module Name:** Multi-entity Consolidation
**Module Number:** 6.7
**Module Type:** Transaction
**Target File:** FMS/06.Finance Closing & Compliance/6.7 Multi-entity Consolidation.md
**Created Date:** December 31, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Multi-entity Consolidation module provides comprehensive financial consolidation capabilities for organizations with multiple legal entities, subsidiaries, or business units. It enables automated consolidation of financial statements, elimination of inter-company transactions, currency translation, and compliance with international financial reporting standards (IFRS) and generally accepted accounting principles (GAAP) for accurate group-level financial reporting.

### **2.2 Business Scope**
**In Scope:**
- Multi-entity financial statement consolidation and reporting
- Inter-company transaction elimination and reconciliation
- Currency translation and foreign exchange gain/loss calculation
- Consolidation rules and mapping configuration
- Minority interest and non-controlling interest calculations
- Acquisition and disposal accounting for business combinations
- Segment reporting and dimensional analysis
- Consolidated trial balance and working papers
- Regulatory compliance and statutory reporting
- Consolidation workflow approval and audit trail

**Out of Scope:**
- Individual entity accounting operations (handled by entity-specific modules)
- Tax consolidation and filing (handled by tax modules)
- Budget consolidation (handled by budgeting modules)
- Operational reporting (handled by analytics modules)

### **2.3 Key Stakeholders**
- **Group CFO:** Consolidated financial reporting oversight and final approval
- **Financial Controllers:** Consolidation process management and validation
- **Tax Directors:** Tax-efficient consolidation structures and compliance
- **External Auditors:** Consolidated financial statement audit and verification
- **Regulatory Authorities:** Statutory filing compliance and reporting validation
- **Investment Analysts:** Consolidated financial performance analysis

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: Consolidation**

```python
class Consolidation(models.Model):
    """
    Master consolidation process configuration and tracking
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    group_entity_id = models.UUIDField()
    initiated_by_user_id = models.UUIDField()
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    
    # Consolidation Information
    consolidation_name = models.CharField(max_length=200)
    consolidation_description = models.TextField(blank=True)
    consolidation_type = models.CharField(
        max_length=30,
        choices=[
            ('MONTHLY', 'Monthly Consolidation'),
            ('QUARTERLY', 'Quarterly Consolidation'),
            ('YEARLY', 'Yearly Consolidation'),
            ('ADHOC', 'Ad-hoc Consolidation'),
            ('PROVISIONAL', 'Provisional Consolidation'),
            ('FINAL', 'Final Consolidation'),
        ],
        default='MONTHLY'
    )
    
    # Period Information
    consolidation_period = models.CharField(max_length=20)  # YYYY-MM format
    start_date = models.DateField()
    end_date = models.DateField()
    reporting_date = models.DateField()
    
    # Entity Structure
    consolidation_hierarchy = models.TextField()  # JSON hierarchy structure
    included_entities = models.TextField()  # JSON array of entity IDs
    excluded_entities = models.TextField(blank=True)  # JSON array of excluded entity IDs
    consolidation_rules = models.TextField()  # JSON consolidation rules
    
    # Currency Configuration
    consolidation_currency = models.CharField(max_length=3)  # ISO 4217 currency code
    translation_method = models.CharField(
        max_length=20,
        choices=[
            ('CLOSING_RATE', 'Closing Rate Method'),
            ('AVERAGE_RATE', 'Average Rate Method'),
            ('TEMPORAL', 'Temporal Method'),
            ('CURRENT_RATE', 'Current Rate Method'),
        ],
        default='CLOSING_RATE'
    )
    exchange_rate_date = models.DateField(null=True, blank=True)
    
    # Status and Workflow
    status = models.CharField(
        max_length=20,
        choices=[
            ('DRAFT', 'Draft'),
            ('DATA_COLLECTION', 'Data Collection'),
            ('ELIMINATION', 'Inter-company Elimination'),
            ('TRANSLATION', 'Currency Translation'),
            ('CALCULATION', 'Consolidation Calculation'),
            ('REVIEW', 'Under Review'),
            ('PENDING_APPROVAL', 'Pending Approval'),
            ('APPROVED', 'Approved'),
            ('PUBLISHED', 'Published'),
            ('CANCELLED', 'Cancelled'),
        ],
        default='DRAFT'
    )
    
    # Progress Tracking
    total_entities = models.IntegerField(default=0)
    completed_entities = models.IntegerField(default=0)
    progress_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=0)
    
    # Financial Results Summary
    consolidated_revenue = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_expenses = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_profit = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_assets = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_liabilities = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_equity = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    
    # Minority Interest
    minority_interest = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    non_controlling_interest = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    
    # Audit and Compliance
    requires_audit = models.BooleanField(default=True)
    audit_completed = models.BooleanField(default=False)
    audit_notes = models.TextField(blank=True)
    compliance_status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', 'Pending'),
            ('COMPLIANT', 'Compliant'),
            ('NON_COMPLIANT', 'Non-Compliant'),
            ('REQUIRES_ACTION', 'Requires Action'),
        ],
        default='PENDING'
    )
    
    # Execution Details
    initiated_at = models.DateTimeField(auto_now_add=True)
    started_at = models.DateTimeField(null=True, blank=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    approved_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        db_table = 'fms_consolidation'
        verbose_name = 'Consolidation'
        verbose_name_plural = 'Consolidations'
        indexes = [
            models.Index(fields=['company_id', 'group_entity_id'], name='idx_consolidation_company_group'),
            models.Index(fields=['consolidation_period', 'status'], name='idx_consolidation_period_status'),
            models.Index(fields=['consolidation_type'], name='idx_consolidation_type'),
            models.Index(fields=['start_date', 'end_date'], name='idx_consolidation_dates'),
            models.Index(fields=['status'], name='idx_consolidation_status'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'consolidation_period', 'consolidation_type'], name='uk_consolidation_period_type'),
        ]

class ConsolidationEntity(models.Model):
    """
    Individual entity data within consolidation process
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    consolidation_id = models.UUIDField()
    entity_id = models.UUIDField()
    
    # Entity Information
    entity_name = models.CharField(max_length=200)
    entity_code = models.CharField(max_length=50)
    entity_type = models.CharField(
        max_length=20,
        choices=[
            ('SUBSIDIARY', 'Subsidiary'),
            ('ASSOCIATE', 'Associate'),
            ('JOINT_VENTURE', 'Joint Venture'),
            ('BRANCH', 'Branch'),
            ('DIVISION', 'Division'),
        ],
        default='SUBSIDIARY'
    )
    
    # Ownership Structure
    ownership_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=100.00)
    voting_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=100.00)
    control_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=100.00)
    acquisition_date = models.DateField(null=True, blank=True)
    
    # Financial Data
    entity_currency = models.CharField(max_length=3)
    functional_currency = models.CharField(max_length=3)
    reporting_currency = models.CharField(max_length=3)
    
    # Exchange Rates
    average_exchange_rate = models.DecimalField(max_digits=15, decimal_places=8, null=True, blank=True)
    closing_exchange_rate = models.DecimalField(max_digits=15, decimal_places=8, null=True, blank=True)
    translation_adjustment = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    
    # Status
    inclusion_status = models.CharField(
        max_length=20,
        choices=[
            ('INCLUDED', 'Included'),
            ('EXCLUDED', 'Excluded'),
            ('PARTIAL', 'Partial'),
            ('PENDING', 'Pending'),
        ],
        default='INCLUDED'
    )
    
    data_status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', 'Pending'),
            ('RECEIVED', 'Data Received'),
            ('VALIDATED', 'Data Validated'),
            ('ERRORS', 'Data Errors'),
            ('COMPLETED', 'Processing Completed'),
        ],
        default='PENDING'
    )
    
    # Financial Results (Local Currency)
    local_revenue = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    local_expenses = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    local_profit = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    local_assets = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    local_liabilities = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    local_equity = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    
    # Financial Results (Consolidation Currency)
    consolidated_revenue = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_expenses = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_profit = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_assets = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_liabilities = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    consolidated_equity = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    
    # Elimination Adjustments
    elimination_revenue = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    elimination_expenses = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    elimination_assets = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    elimination_liabilities = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_consolidation_entity'
        verbose_name = 'Consolidation Entity'
        verbose_name_plural = 'Consolidation Entities'
        indexes = [
            models.Index(fields=['company_id', 'consolidation_id'], name='idx_ce_company_consolidation'),
            models.Index(fields=['entity_id', 'consolidation_period'], name='idx_ce_entity_period'),
            models.Index(fields=['entity_type'], name='idx_ce_entity_type'),
            models.Index(fields=['inclusion_status', 'data_status'], name='idx_ce_statuses'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['consolidation_id', 'entity_id'], name='uk_ce_consolidation_entity'),
        ]

class IntercompanyTransaction(models.Model):
    """
    Inter-company transactions for elimination processing
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    consolidation_id = models.UUIDField()
    
    # Transaction Information
    transaction_id = models.CharField(max_length=100)
    transaction_date = models.DateField()
    transaction_type = models.CharField(
        max_length=30,
        choices=[
            ('SALES', 'Inter-company Sales'),
            ('PURCHASES', 'Inter-company Purchases'),
            ('LOANS', 'Inter-company Loans'),
            ('INTEREST', 'Interest Income/Expense'),
            ('DIVIDENDS', 'Dividends Received/Paid'),
            ('MANAGEMENT_FEES', 'Management Fees'),
            ('ROYALTIES', 'Royalties'),
            ('RENT', 'Rent Income/Expense'),
            ('OTHER', 'Other Inter-company Transactions'),
        ],
        default='SALES'
    )
    
    # Entity Information
    source_entity_id = models.UUIDField()
    source_entity_name = models.CharField(max_length=200)
    target_entity_id = models.UUIDField()
    target_entity_name = models.CharField(max_length=200)
    
    # Financial Details
    transaction_amount = models.DecimalField(max_digits=20, decimal_places=2)
    transaction_currency = models.CharField(max_length=3)
    exchange_rate = models.DecimalField(max_digits=15, decimal_places=8, null=True, blank=True)
    consolidation_amount = models.DecimalField(max_digits=20, decimal_places=2)
    
    # Account Mapping
    source_account_code = models.CharField(max_length=50)
    source_account_name = models.CharField(max_length=200)
    target_account_code = models.CharField(max_length=50)
    target_account_name = models.CharField(max_length=200)
    
    # Elimination Status
    elimination_status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', 'Pending'),
            ('MATCHED', 'Matched'),
            ('UNMATCHED', 'Unmatched'),
            ('PARTIAL', 'Partial Match'),
            ('ELIMINATED', 'Eliminated'),
            ('ERROR', 'Error'),
        ],
        default='PENDING'
    )
    
    # Matching Information
    matching_transaction_id = models.UUIDField(null=True, blank=True)
    matching_amount = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    variance_amount = models.DecimalField(max_digits=20, decimal_places=2, default=0)
    variance_reason = models.TextField(blank=True)
    
    # Elimination Details
    elimination_journal_id = models.UUIDField(null=True, blank=True)
    elimination_date = models.DateTimeField(null=True, blank=True)
    elimination_user_id = models.UUIDField(null=True, blank=True)
    
    # Documentation
    description = models.TextField(blank=True)
    reference_number = models.CharField(max_length=100, blank=True)
    supporting_documents = models.TextField(blank=True)  # JSON array of document references
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_intercompany_transaction'
        verbose_name = 'Inter-company Transaction'
        verbose_name_plural = 'Inter-company Transactions'
        indexes = [
            models.Index(fields=['company_id', 'consolidation_id'], name='idx_ict_company_consolidation'),
            models.Index(fields=['source_entity_id', 'target_entity_id'], name='idx_ict_entities'),
            models.Index(fields=['transaction_date', 'transaction_type'], name='idx_ict_date_type'),
            models.Index(fields=['elimination_status'], name='idx_ict_elimination_status'),
        ]
        ordering = ['-transaction_date']

class ConsolidationRule(models.Model):
    """
    Consolidation rules and mapping configurations
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    
    # Rule Information
    rule_name = models.CharField(max_length=200)
    rule_description = models.TextField(blank=True)
    rule_category = models.CharField(
        max_length=30,
        choices=[
            ('ACCOUNT_MAPPING', 'Account Mapping'),
            ('ELIMINATION', 'Elimination Rules'),
            ('TRANSLATION', 'Translation Rules'),
            ('CALCULATION', 'Calculation Rules'),
            ('VALIDATION', 'Validation Rules'),
            ('REPORTING', 'Reporting Rules'),
        ],
        default='ACCOUNT_MAPPING'
    )
    
    # Rule Configuration
    rule_type = models.CharField(
        max_length=20,
        choices=[
            ('MAPPING', 'Mapping Rule'),
            ('CALCULATION', 'Calculation Rule'),
            ('CONDITION', 'Condition Rule'),
            ('EXCLUSION', 'Exclusion Rule'),
            ('ADJUSTMENT', 'Adjustment Rule'),
        ],
        default='MAPPING'
    )
    
    # Rule Logic
    rule_conditions = models.TextField()  # JSON rule conditions
    rule_actions = models.TextField()  # JSON rule actions
    rule_priority = models.IntegerField(default=0)
    
    # Applicability
    entity_types = models.TextField(blank=True)  # JSON array of applicable entity types
    consolidation_types = models.TextField(blank=True)  # JSON array of applicable consolidation types
    
    # Status
    is_active = models.BooleanField(default=True)
    effective_date = models.DateTimeField(null=True, blank=True)
    expiry_date = models.DateTimeField(null=True, blank=True)
    
    # Metadata
    created_by_user_id = models.UUIDField()
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    version = models.IntegerField(default=1)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_consolidation_rule'
        verbose_name = 'Consolidation Rule'
        verbose_name_plural = 'Consolidation Rules'
        indexes = [
            models.Index(fields=['company_id', 'rule_category', 'is_active'], name='idx_cr_company_category_active'),
            models.Index(fields=['rule_type', 'rule_priority'], name='idx_cr_type_priority'),
            models.Index(fields=['effective_date', 'expiry_date'], name='idx_cr_dates'),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 ExchangeRate**

```python
class ExchangeRate(models.Model):
    """
    Exchange rate definitions for currency translation
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    
    # Rate Information
    from_currency = models.CharField(max_length=3)
    to_currency = models.CharField(max_length=3)
    rate_date = models.DateField()
    exchange_rate = models.DecimalField(max_digits=15, decimal_places=8)
    
    # Rate Type
    rate_type = models.CharField(
        max_length=20,
        choices=[
            ('SPOT', 'Spot Rate'),
            ('AVERAGE', 'Average Rate'),
            ('CLOSING', 'Closing Rate'),
            ('HISTORICAL', 'Historical Rate'),
            ('BUDGET', 'Budget Rate'),
        ],
        default='SPOT'
    )
    
    # Source and Validation
    rate_source = models.CharField(max_length=100)  # ECB, Federal Reserve, etc.
    is_validated = models.BooleanField(default=False)
    validated_by_user_id = models.UUIDField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_exchange_rate'
        verbose_name = 'Exchange Rate'
        verbose_name_plural = 'Exchange Rates'
        indexes = [
            models.Index(fields=['company_id', 'from_currency', 'to_currency', 'rate_date'], name='idx_er_currency_date'),
            models.Index(fields=['rate_type', 'rate_date'], name='idx_er_type_date'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'from_currency', 'to_currency', 'rate_date', 'rate_type'], name='uk_er_unique_rate'),
        ]
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPS**

### **5.1 Primary Relationships**
- **Consolidation** → **Company**: Group-level company configuration
- **Consolidation** → **Group Entity**: Parent entity for consolidation
- **Consolidation** → **User**: Initiated by and approved by users
- **ConsolidationEntity** → **Consolidation**: Belongs to consolidation process
- **ConsolidationEntity** → **Entity**: Individual legal entity
- **IntercompanyTransaction** → **Consolidation**: Processed within consolidation
- **IntercompanyTransaction** → **Source/Target Entity**: Transaction entities

### **5.2 Many-to-Many Relationships**
- **Consolidation** ↔ **Entity**: Multiple entities per consolidation
- **ConsolidationRule** ↔ **EntityType**: Rules applicable to entity types
- **ConsolidationRule** ↔ **ConsolidationType**: Rules for consolidation types

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**
- Consolidation periods must not overlap for the same consolidation type
- Entity ownership percentages must sum to 100% for complete ownership
- Inter-company transactions must have matching reciprocal entries
- Exchange rates must be available for all entity currencies
- Minority interest calculations must follow IFRS/GAAP standards

### **6.2 Validation Logic**

```python
def validate_consolidation_period(self, consolidation):
    """
    Validate consolidation period and prevent overlaps
    """
    # Check for existing consolidation in same period
    existing_consolidation = Consolidation.objects.filter(
        company_id=consolidation.company_id,
        consolidation_period=consolidation.consolidation_period,
        consolidation_type=consolidation.consolidation_type,
        status__in=['DRAFT', 'DATA_COLLECTION', 'ELIMINATION', 'TRANSLATION', 'CALCULATION', 'REVIEW']
    ).exclude(id=consolidation.id)
    
    if existing_consolidation.exists():
        raise ValidationError("Consolidation already exists for this period and type")

def validate_entity_ownership(self, consolidation_entity):
    """
    Validate entity ownership structure and percentages
    """
    if consolidation_entity.ownership_percentage < 0 or consolidation_entity.ownership_percentage > 100:
        raise ValidationError("Ownership percentage must be between 0 and 100")
    
    if consolidation_entity.voting_percentage < 0 or consolidation_entity.voting_percentage > 100:
        raise ValidationError("Voting percentage must be between 0 and 100")
    
    # Validate control requirements
    if consolidation_entity.entity_type == 'SUBSIDIARY' and consolidation_entity.control_percentage < 50:
        raise ValidationError("Subsidiary must have control percentage >= 50%")

def validate_intercompany_matching(self, transaction):
    """
    Validate inter-company transaction matching requirements
    """
    # Look for matching reciprocal transaction
    matching_transaction = IntercompanyTransaction.objects.filter(
        company_id=transaction.company_id,
        source_entity_id=transaction.target_entity_id,
        target_entity_id=transaction.source_entity_id,
        transaction_date=transaction.transaction_date,
        transaction_type__in=get_reciprocal_transaction_types(transaction.transaction_type)
    ).first()
    
    if not matching_transaction:
        transaction.elimination_status = 'UNMATCHED'
        transaction.variance_reason = 'No matching reciprocal transaction found'
    else:
        # Calculate variance
        variance = abs(transaction.consolidation_amount - matching_transaction.consolidation_amount)
        transaction.matching_transaction_id = matching_transaction.id
        transaction.matching_amount = matching_transaction.consolidation_amount
        transaction.variance_amount = variance
        
        if variance == 0:
            transaction.elimination_status = 'MATCHED'
        else:
            transaction.elimination_status = 'PARTIAL'
            transaction.variance_reason = f'Amount variance: {variance:.2f}'

def validate_currency_translation(self, consolidation_entity):
    """
    Validate currency translation requirements and calculations
    """
    if consolidation_entity.entity_currency != consolidation_entity.functional_currency:
        if not consolidation_entity.average_exchange_rate:
            raise ValidationError("Average exchange rate required for translation")
    
    if consolidation_entity.functional_currency != consolidation_entity.reporting_currency:
        if not consolidation_entity.closing_exchange_rate:
            raise ValidationError("Closing exchange rate required for translation")

def validate_consolidation_rules(self, consolidation):
    """
    Validate consolidation rule applicability and execution
    """
    rules = ConsolidationRule.objects.filter(
        company_id=consolidation.company_id,
        is_active=True
    ).filter(
        models.Q(effective_date__lte=timezone.now()) | models.Q(effective_date__isnull=True)
    ).filter(
        models.Q(expiry_date__gte=timezone.now()) | models.Q(expiry_date__isnull=True)
    )
    
    for rule in rules:
        if not validate_rule_applicability(rule, consolidation):
            raise ValidationError(f"Consolidation rule '{rule.rule_name}' is not applicable")

def validate_minority_interest_calculation(self, consolidation):
    """
    Validate minority interest calculations and compliance
    """
    total_minority_interest = 0
    
    for entity in consolidation.consolidationentity_set.all():
        if entity.entity_type == 'SUBSIDIARY' and entity.ownership_percentage < 100:
            # Calculate minority interest
            minority_percentage = (100 - entity.ownership_percentage) / 100
            entity_minority_interest = entity.consolidated_equity * Decimal(minority_percentage)
            total_minority_interest += entity_minority_interest
    
    consolidation.minority_interest = total_minority_interest

def validate_consolidation_hierarchy(self, consolidation):
    """
    Validate consolidation hierarchy and prevent circular references
    """
    hierarchy = json.loads(consolidation.consolidation_hierarchy)
    
    if has_circular_reference(hierarchy):
        raise ValidationError("Circular reference detected in consolidation hierarchy")
    
    # Validate all entities in hierarchy are included
    hierarchy_entities = extract_entities_from_hierarchy(hierarchy)
    included_entities = json.loads(consolidation.included_entities)
    
    for entity_id in hierarchy_entities:
        if entity_id not in included_entities:
            raise ValidationError(f"Entity {entity_id} in hierarchy but not included in consolidation")
```

### **6.3 Business Constraints**
- Consolidation cannot be approved if entities have data validation errors
- Inter-company eliminations must be completed before consolidation calculation
- Currency translation must use valid exchange rates for the consolidation period
- Minority interest must be calculated for subsidiaries with less than 100% ownership
- Consolidation rules must be applied in priority order during processing

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**
- **Layout:** Comprehensive dashboard with consolidation status, entity progress, and elimination tracking
- **Navigation:** Tabbed interface with consolidation setup, data collection, eliminations, and reporting
- **Responsiveness:** Full desktop experience with tablet support for mobile review

### **7.2 User Experience Design**
- **User Flow:** Setup consolidation → Collect data → Eliminate inter-company → Translate currencies → Calculate → Review → Approve
- **Error Handling:** Real-time validation with clear error messages for data mismatches and validation failures
- **Loading States:** Progress indicators for long-running consolidation calculations and eliminations

### **7.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility for all consolidation management controls
- **Screen Reader Support:** Comprehensive ARIA labels for complex consolidation data displays

### **7.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **7.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **7.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **7.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **7.8 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **7.9 Filter System Standards**
- **Filter Layout:** Sidebar filter panel with advanced search options
- **Filter Components:** Period filter, status filter, entity filter, consolidation type filter
- **Filter Actions:** Apply, Clear, Reset, Save Filter buttons

### **7.10 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical
- **Consolidation Hierarchy:** Visual tree structure with ownership percentages
- **Inter-company Matching:** Side-by-side comparison with variance highlighting
- **Progress Dashboard:** Real-time consolidation progress with entity status indicators

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

### **8.1 External Systems**
- **ERP Systems:** SAP, Oracle Financials for entity financial data extraction
- **Tax Systems:** Tax preparation software for tax-efficient consolidation structures
- **Banking Systems:** Treasury management systems for inter-company loan data
- **Regulatory Systems:** XBRL filing systems for statutory reporting

### **8.2 Internal APIs**
- **Entity Management API:** Entity master data and ownership structure
- **General Ledger API:** Trial balance and financial statement data
- **Currency Management API:** Exchange rates and translation methods
- **User Management API:** User roles and approval workflows

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

### **9.1 REST Endpoints**

#### **GET /api/consolidations/**
- **Purpose:** Retrieve list of consolidations
- **Authentication:** JWT token required
- **Parameters:** period, status, entity_type
- **Response:** Paginated consolidation list with summary data

#### **POST /api/consolidations/**
- **Purpose:** Create new consolidation process
- **Authentication:** JWT token required
- **Request Body:** Consolidation configuration and entity selection
- **Response:** Created consolidation with ID and initial status

#### **GET /api/consolidations/{id}/entities/**
- **Purpose:** Retrieve entities within consolidation
- **Authentication:** JWT token required
- **Parameters:** status, entity_type
- **Response:** Entity list with financial data and progress

#### **POST /api/consolidations/{id}/eliminate/**
- **Purpose:** Process inter-company eliminations
- **Authentication:** JWT token required
- **Request Body:** Elimination rules and matching criteria
- **Response:** Elimination results with variance analysis

#### **POST /api/consolidations/{id}/calculate/**
- **Purpose:** Execute consolidation calculations
- **Authentication:** JWT token required
- **Request Body:** Calculation rules and currency translation settings
- **Response:** Consolidated financial statements and calculations

### **9.2 Data Formats**
- **Request Format:** JSON with detailed consolidation parameters
- **Response Format:** JSON with comprehensive consolidation results
- **Error Format:** Structured error responses with validation details

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

### **10.1 Authentication**
- **Method:** JWT-based authentication with role-based access control
- **Authorization:** Multi-level approval for consolidation finalization
- **Session Management:** Secure session handling with timeout controls

### **10.2 Data Protection**
- **Encryption:** AES-256 encryption for sensitive financial data
- **Masking:** Data masking for non-production environments
- **Audit Trail:** Complete audit trail for all consolidation activities

### **10.3 Access Control**
- **Permissions:** Role-based permissions for consolidation functions
- **Roles:** Consolidation Manager, Reviewer, Approver, Viewer
- **Audit Trail:** Comprehensive logging of all data access and modifications

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

### **11.1 Database Optimization**
- **Indexing Strategy:** Optimized indexes for consolidation queries and reporting
- **Query Optimization:** Efficient queries for large-scale consolidation calculations
- **Connection Pooling:** Database connection management for concurrent processing

### **11.2 Caching Strategy**
- **Cache Layers:** Redis caching for exchange rates and consolidation rules
- **Cache Invalidation:** Intelligent cache refresh for changing data
- **Performance Metrics:** Query performance monitoring and optimization

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

### **12.1 Unit Tests**
- **Coverage Target:** 90% code coverage for consolidation logic
- **Test Framework:** pytest with Django test extensions
- **Test Data:** Comprehensive test data for various consolidation scenarios

### **12.2 Integration Tests**
- **API Testing:** Complete API endpoint testing with various scenarios
- **Database Testing:** Multi-entity consolidation database integration
- **External System Testing:** Integration with ERP and financial systems

### **12.3 User Acceptance Tests**
- **UAT Scenarios:** Real-world consolidation scenarios with test entities
- **User Stories:** Complete consolidation workflow testing
- **Acceptance Criteria:** IFRS/GAAP compliance validation

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

### **13.1 Environment Requirements**
- **Development:** Local development with test entities and consolidation scenarios
- **Staging:** Full consolidation testing with production-like data volumes
- **Production:** High-availability deployment with load balancing

### **13.2 Configuration Management**
- **Settings:** Environment-specific consolidation configurations
- **Environment Variables:** Secure storage for sensitive consolidation data
- **Secrets Management:** Encrypted storage for exchange rate APIs and credentials

### **13.3 Monitoring & Logging**
- **Application Logs:** Detailed consolidation processing logs with performance metrics
- **Performance Metrics:** Consolidation calculation time and resource usage monitoring
- **Error Tracking:** Comprehensive error capture and alerting for consolidation failures

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

### **14.1 Regular Maintenance**
- **Database Maintenance:** Regular optimization of consolidation data and indexes
- **Performance Tuning:** Ongoing optimization of consolidation calculation performance
- **Security Updates:** Regular updates for consolidation security controls

### **14.2 Support Procedures**
- **Issue Tracking:** Consolidation-specific issue tracking and resolution
- **Knowledge Base:** Documentation for consolidation rules and troubleshooting
- **User Training:** Training programs for consolidation managers and reviewers

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

### **15.1 Version History**
- **v1.0.0:** Initial release with basic consolidation functionality
- **v1.1.0:** Enhanced inter-company elimination and currency translation
- **v1.2.0:** Advanced consolidation rules and minority interest calculations

### **15.2 Change Management**
- **Release Process:** Structured release process with consolidation testing
- **Rollback Procedures:** Consolidation data rollback and recovery procedures
- **Migration Scripts:** Data migration scripts for consolidation schema changes

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

### **16.1 Regulatory Compliance**
- **IFRS Compliance:** IFRS 10, IFRS 12 compliance for consolidation accounting
- **GAAP Compliance:** US GAAP ASC 810 compliance for business combinations
- **SOX Compliance:** Sarbanes-Oxley compliance for internal controls

### **16.2 Audit Requirements**
- **Audit Trail:** Complete audit trail for all consolidation adjustments and eliminations
- **Compliance Reporting:** Automated generation of compliance reports
- **Documentation:** Comprehensive documentation of consolidation methodologies and rules

--- END OF SECTION 16 ---

**END OF MULTI-ENTITY CONSOLIDATION BBP**
