# FMS BBP - Year-End Closing

## **1. MODULE IDENTIFICATION**

**Module Name:** Year-End Closing
**Module Number:** 6.2
**Module Type:** Workflow
**Target File:** FMS/06.Finance Closing & Compliance/6.2 Year-End Closing.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Year-End Closing module provides comprehensive workflow management for annual financial closing processes, enabling systematic execution of year-end closing tasks, automated tax calculations and compliance validations, preparation of statutory financial statements, and generation of annual tax returns to ensure regulatory compliance and accurate annual financial reporting across the organization.

### **2.2 Business Scope**
**In Scope:**
- Year-end closing checklist management and task automation
- Annual tax calculations and compliance validations
- Fixed asset depreciation and impairment assessments
- Inventory valuation and provision calculations
- Bad debt provisioning and write-off processing
- Statutory financial statement preparation and filing
- Annual tax return generation and submission workflows
- Multi-level approval hierarchies for year-end entries
- Integration with all financial modules for annual data consolidation

**Out of Scope:**
- Month-end closing procedures (handled by Month-End Closing module)
- Audit trail management (handled by Audit Trail module)
- Data backup and restore operations (handled by separate modules)
- Multi-entity consolidation (handled by Consolidation module)
- Ongoing compliance monitoring (handled by Compliance modules)

### **2.3 Key Stakeholders**
- **CFO/Finance Directors:** Year-end closing oversight and final approval authority
- **Finance Controllers:** Year-end closing management and compliance validation
- **Tax Managers:** Annual tax calculations and return filing coordination
- **External Auditors:** Year-end closing audit and financial statement verification
- **Regulatory Authorities:** Statutory filing compliance and reporting validation

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: YearEndClosing**

```python
class YearEndClosing(models.Model):
    """
    Master year-end closing workflow configuration and tracking
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    financial_year_id = models.UUIDField()
    initiated_by_user_id = models.UUIDField()
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    auditor_approval_user_id = models.UUIDField(null=True, blank=True)
    
    # Core Fields
    closing_number = models.CharField(max_length=50, unique=True)
    closing_name = models.CharField(max_length=200)
    financial_year = models.IntegerField()
    closing_description = models.TextField(blank=True)
    
    # Closing Schedule
    start_date = models.DateField()
    end_date = models.DateField()
    target_completion_date = models.DateField()
    actual_completion_date = models.DateField(null=True, blank=True)
    audit_completion_date = models.DateField(null=True, blank=True)
    
    # Closing Status
    status = models.CharField(
        max_length=20,
        choices=[
            ('DRAFT', 'Draft'),
            ('IN_PROGRESS', 'In Progress'),
            ('UNDER_REVIEW', 'Under Review'),
            ('PENDING_APPROVAL', 'Pending Approval'),
            ('PENDING_AUDIT', 'Pending Audit'),
            ('AUDIT_COMPLETE', 'Audit Complete'),
            ('COMPLETED', 'Completed'),
            ('CANCELLED', 'Cancelled'),
            ('FAILED', 'Failed'),
        ],
        default='DRAFT'
    )
    
    # Progress Tracking
    total_tasks = models.IntegerField(default=0)
    completed_tasks = models.IntegerField(default=0)
    failed_tasks = models.IntegerField(default=0)
    progress_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=0)
    
    # Tax and Compliance
    tax_year = models.IntegerField()
    tax_jurisdiction = models.CharField(max_length=100)
    is_tax_compliant = models.BooleanField(default=False)
    tax_filing_date = models.DateField(null=True, blank=True)
    
    # Configuration
    auto_post_entries = models.BooleanField(default=False)
    require_dual_approval = models.BooleanField(default=True)
    require_auditor_approval = models.BooleanField(default=True)
    allow_reopening = models.BooleanField(default=False)
    
    # Financial Results
    total_revenue = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    total_expenses = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    net_profit = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    total_assets = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    total_liabilities = models.DecimalField(max_digits=20, decimal_places=2, null=True, blank=True)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        db_table = 'fms_year_end_closing'
        verbose_name = 'Year-End Closing'
        verbose_name_plural = 'Year-End Closing Records'
        indexes = [
            models.Index(fields=['company_id', 'closing_number'], name='idx_yec_company_number'),
            models.Index(fields=['financial_year'], name='idx_yec_financial_year'),
            models.Index(fields=['status'], name='idx_yec_status'),
            models.Index(fields=['target_completion_date'], name='idx_yec_target_date'),
            models.Index(fields=['tax_year'], name='idx_yec_tax_year'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'financial_year'], name='uk_yec_company_year'),
        ]

class YearEndClosingTask(models.Model):
    """
    Individual year-end closing tasks within the workflow
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    year_end_closing_id = models.UUIDField()
    
    # Task Information
    task_code = models.CharField(max_length=50)
    task_name = models.CharField(max_length=200)
    task_description = models.TextField(blank=True)
    task_group = models.CharField(max_length=100)  # Tax, Assets, Inventory, etc.
    
    # Task Configuration
    task_type = models.CharField(
        max_length=30,
        choices=[
            ('AUTOMATED', 'Automated'),
            ('MANUAL', 'Manual'),
            ('VALIDATION', 'Validation'),
            ('CALCULATION', 'Calculation'),
            ('APPROVAL', 'Approval'),
            ('REPORTING', 'Reporting'),
            ('TAX_FILING', 'Tax Filing'),
        ]
    )
    execution_order = models.IntegerField()
    is_mandatory = models.BooleanField(default=True)
    depends_on_tasks = models.TextField(blank=True)  # JSON array of task IDs
    
    # Assignment and Scheduling
    assigned_to_user_id = models.UUIDField(null=True, blank=True)
    assigned_to_role_id = models.UUIDField(null=True, blank=True)
    estimated_duration_hours = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    
    # Task Status
    status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', 'Pending'),
            ('IN_PROGRESS', 'In Progress'),
            ('COMPLETED', 'Completed'),
            ('FAILED', 'Failed'),
            ('SKIPPED', 'Skipped'),
            ('ON_HOLD', 'On Hold'),
            ('REQUIRES_REVIEW', 'Requires Review'),
        ],
        default='PENDING'
    )
    
    # Execution Details
    start_time = models.DateTimeField(null=True, blank=True)
    end_time = models.DateTimeField(null=True, blank=True)
    actual_duration_hours = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    
    # Results and Output
    result_data = models.TextField(blank=True)  # JSON result data
    calculated_amounts = models.TextField(blank=True)  # JSON calculated financial amounts
    error_message = models.TextField(blank=True)
    output_files = models.TextField(blank=True)  # JSON array of generated files
    
    # Approval
    requires_approval = models.BooleanField(default=False)
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    approval_notes = models.TextField(blank=True)
    approved_at = models.DateTimeField(null=True, blank=True)
    
    # Compliance
    is_compliance_related = models.BooleanField(default=False)
    compliance_status = models.CharField(
        max_length=20,
        choices=[
            ('NOT_APPLICABLE', 'Not Applicable'),
            ('COMPLIANT', 'Compliant'),
            ('NON_COMPLIANT', 'Non-Compliant'),
            ('REQUIRES_ACTION', 'Requires Action'),
        ],
        default='NOT_APPLICABLE'
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_year_end_closing_tasks'
        verbose_name = 'Year-End Closing Task'
        verbose_name_plural = 'Year-End Closing Tasks'
        indexes = [
            models.Index(fields=['company_id', 'year_end_closing_id'], name='idx_yect_company_closing'),
            models.Index(fields=['task_group', 'execution_order'], name='idx_yect_group_order'),
            models.Index(fields=['status'], name='idx_yect_status'),
            models.Index(fields=['assigned_to_user_id'], name='idx_yect_assigned_user'),
            models.Index(fields=['is_compliance_related'], name='idx_yect_compliance'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['year_end_closing_id', 'task_code'], name='uk_yect_closing_task'),
        ]

class YearEndClosingChecklist(models.Model):
    """
    Year-end closing checklist templates and configurations
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    
    # Checklist Information
    checklist_name = models.CharField(max_length=200)
    checklist_description = models.TextField(blank=True)
    checklist_type = models.CharField(
        max_length=30,
        choices=[
            ('STANDARD', 'Standard'),
            ('COMPREHENSIVE', 'Comprehensive'),
            ('TAX_FOCUSED', 'Tax Focused'),
            ('REGULATED', 'Regulated'),
            ('PUBLIC_COMPANY', 'Public Company'),
            ('PRIVATE_COMPANY', 'Private Company'),
            ('CUSTOM', 'Custom'),
        ],
        default='STANDARD'
    )
    
    # Configuration
    is_active = models.BooleanField(default=True)
    is_default = models.BooleanField(default=False)
    applicable_entity_types = models.TextField(blank=True)  # JSON array of entity types
    applicable_industries = models.TextField(blank=True)  # JSON array of industries
    
    # Task Templates
    task_templates = models.TextField()  # JSON array of task template configurations
    
    # Tax Configuration
    tax_requirements = models.TextField(blank=True)  # JSON tax requirements configuration
    compliance_checklists = models.TextField(blank=True)  # JSON compliance requirements
    
    # Approval Configuration
    approval_levels = models.IntegerField(default=2)
    approval_roles = models.TextField(blank=True)  # JSON array of role IDs
    requires_auditor_approval = models.BooleanField(default=True)
    
    # Reporting Configuration
    required_reports = models.TextField(blank=True)  # JSON array of required reports
    filing_deadlines = models.TextField(blank=True)  # JSON filing deadline configurations
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_year_end_closing_checklists'
        verbose_name = 'Year-End Closing Checklist'
        verbose_name_plural = 'Year-End Closing Checklists'
        indexes = [
            models.Index(fields=['company_id', 'checklist_type'], name='idx_yecc_company_type'),
            models.Index(fields=['is_active', 'is_default'], name='idx_yecc_active_default'),
            models.Index(fields=['requires_auditor_approval'], name='idx_yecc_auditor_required'),
        ]
```

--- END OF SECTION 3 ---

## **4. BUSINESS RULES & VALIDATIONS**

### **4.1 Data Integrity Rules**
- Year-end closing numbers must be unique within each company
- Only one year-end closing can be active per financial year
- Financial years must be sequential without gaps
- Mandatory tasks must be completed before closing approval
- Tax compliance must be validated before final closing approval
- Auditor approval required for regulated entities

### **4.2 Validation Logic**

```python
def clean_financial_year(self):
    """
    Validate financial year and prevent duplicates
    """
    # Check if closing already exists for this financial year
    if YearEndClosing.objects.filter(
        company_id=self.company_id,
        financial_year=self.financial_year,
        status__in=['DRAFT', 'IN_PROGRESS', 'UNDER_REVIEW', 'PENDING_APPROVAL', 'PENDING_AUDIT']
    ).exclude(id=self.id).exists():
        raise ValidationError("Year-end closing already exists for this financial year")

def validate_tax_compliance(self, closing_id):
    """
    Validate tax compliance requirements
    """
    closing = YearEndClosing.objects.get(id=closing_id)
    
    # Check tax-related tasks are completed
    tax_tasks = YearEndClosingTask.objects.filter(
        year_end_closing_id=closing_id,
        is_compliance_related=True
    )
    
    for task in tax_tasks:
        if task.status != 'COMPLETED':
            raise ValidationError(f"Tax compliance task '{task.task_name}' is not completed")
    
    # Validate tax calculations
    if not closing.is_tax_compliant:
        raise ValidationError("Tax compliance validation failed. Please review tax calculations.")

def validate_financial_statements(self, closing_id):
    """
    Validate financial statement balances
    """
    closing = YearEndClosing.objects.get(id=closing_id)
    
    # Basic balance sheet validation
    if closing.total_assets and closing.total_liabilities:
        equity = closing.total_assets - closing.total_liabilities
        # Additional validation logic for balance sheet equity
        if equity < 0:
            raise ValidationError("Balance sheet does not balance. Negative equity detected.")
    
    # Profit and loss validation
    if closing.total_revenue and closing.total_expenses:
        calculated_profit = closing.total_revenue - closing.total_expenses
        if abs(calculated_profit - (closing.net_profit or 0)) > 0.01:  # Allow for rounding
            raise ValidationError("Profit and loss statement does not balance.")

def validate_closing_completion(self, closing_id):
    """
    Validate that all requirements are met for year-end closing completion
    """
    closing = YearEndClosing.objects.get(id=closing_id)
    
    # Check all mandatory tasks are completed
    mandatory_tasks = YearEndClosingTask.objects.filter(
        year_end_closing_id=closing_id,
        is_mandatory=True
    )
    
    for task in mandatory_tasks:
        if task.status != 'COMPLETED':
            raise ValidationError(f"Mandatory task '{task.task_name}' is not completed")
    
    # Check no tasks have failed
    failed_tasks = YearEndClosingTask.objects.filter(
        year_end_closing_id=closing_id,
        status='FAILED'
    )
    
    if failed_tasks.exists():
        raise ValidationError("Some tasks have failed. Please resolve failed tasks before completing closing")
    
    # Validate tax compliance
    self.validate_tax_compliance(closing_id)
    
    # Validate financial statements
    self.validate_financial_statements(closing_id)

def validate_approval_hierarchy(self, closing_id, user_id, approval_type='standard'):
    """
    Validate user approval authority based on hierarchy and approval type
    """
    closing = YearEndClosing.objects.get(id=closing_id)
    user_role = get_user_role(user_id)
    
    # Check if user has approval authority
    if not has_year_end_approval_permission(user_role, closing.company_id, approval_type):
        raise ValidationError(f"User does not have {approval_type} approval authority for this year-end closing")
    
    # For auditor approval, validate auditor credentials
    if approval_type == 'auditor':
        if not is_authorized_auditor(user_id, closing.company_id):
            raise ValidationError("User is not an authorized auditor for this company")
```

### **4.3 Business Constraints**
- Cannot reopen completed year-end closing without board approval
- Cannot modify year-end entries after auditor approval
- Year-end tasks must be executed in defined dependency order
- Tax filing deadlines must be met for regulatory compliance
- Auditor approval required for public companies and regulated entities

--- END OF SECTION 4 ---

## **5. UI/UX SPECIFICATIONS**

### **5.1 User Interface Requirements**
- **Layout:** Comprehensive dashboard with closing progress, tax compliance status, and approval workflows
- **Navigation:** Tabbed interface with closing setup, task management, tax compliance, and reporting
- **Responsiveness:** Full desktop experience with tablet support for mobile approvals

### **5.2 User Experience Design**
- **User Flow:** Create closing → Load comprehensive checklist → Execute tasks → Validate compliance → Auditor review → Final approval
- **Error Handling:** Real-time validation with clear error messages for compliance failures
- **Loading States:** Progress indicators for long-running calculations and tax validations

### **5.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility for all closing management controls
- **Screen Reader Support:** Comprehensive ARIA labels for complex year-end workflows

### **5.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **5.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **5.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **5.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **5.8 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **5.9 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, status filter, financial year filter, compliance status filter
- **Filter Actions:** Apply, Clear, Reset buttons

### **5.10 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical

--- END OF SECTION 5 ---

## **6. SECTIONS 8-16: NOT APPLICABLE**

### **6.1 Simplified Technical Sections**
For Workflow modules, sections 8-16 are marked as not applicable as this is a configuration-focused module with emphasis on workflow management, business rules, and user experience rather than complex technical implementations.

### **6.2 Not Applicable Sections**
- **Section 8 - Integration Points:** Handled by underlying financial modules
- **Section 9 - API Specifications:** Standard workflow APIs are sufficient
- **Section 10 - Security Requirements:** Standard FMS security applies
- **Section 11 - Performance Considerations:** Standard workflow performance
- **Section 12 - Testing Requirements:** Standard workflow testing
- **Section 13 - Deployment Specifications:** Standard FMS deployment
- **Section 14 - Maintenance & Support:** Standard FMS maintenance
- **Section 15 - Version Control:** Standard FMS version control
- **Section 16 - Compliance & Audit:** Handled by dedicated compliance modules

--- END OF SECTION 6 ---

**END OF YEAR-END CLOSING BBP**
