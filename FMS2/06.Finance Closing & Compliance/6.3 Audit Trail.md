# FMS BBP - Audit Trail

## **1. MODULE IDENTIFICATION**

**Module Name:** Audit Trail
**Module Number:** 6.3
**Module Type:** Configuration
**Target File:** FMS/06.Finance Closing & Compliance/6.3 Audit Trail.md
**Created Date:** December 31, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Audit Trail module provides comprehensive tracking and logging of all financial system activities, ensuring complete auditability of data changes, user actions, and system events across the FMS. It enables regulatory compliance, forensic analysis, and internal control validation by maintaining immutable records of all financial transactions, configuration changes, and user access patterns.

### **2.2 Business Scope**
**In Scope:**
- Comprehensive logging of all financial transactions and data modifications
- User activity tracking including login, logout, and session management
- Configuration change auditing for system settings and master data
- Data export and download activity logging
- Exception and error event tracking
- Report generation and access logging
- Integration and API call auditing
- Data retention and archival policies for audit records
- Compliance reporting for SOX, GDPR, and other regulatory requirements
- Real-time monitoring and alerting for suspicious activities

**Out of Scope:**
- System performance monitoring (handled by separate monitoring modules)
- Security incident response (handled by security modules)
- Data backup operations (handled by backup modules)
- User authentication and authorization (handled by security modules)

### **2.3 Key Stakeholders**
- **Internal Auditors:** Review and validate audit trail completeness and accuracy
- **Compliance Officers:** Ensure regulatory compliance and reporting requirements
- **Finance Controllers:** Monitor financial data integrity and control effectiveness
- **IT Security Teams:** Investigate security incidents and unauthorized access
- **External Auditors:** Perform independent audits and regulatory examinations
- **Regulatory Authorities:** Conduct compliance inspections and investigations

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: AuditTrail**

```python
class AuditTrail(models.Model):
    """
    Master audit trail record for all system activities
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    user_id = models.UUIDField(null=True, blank=True)
    session_id = models.CharField(max_length=255, null=True, blank=True)
    
    # Event Information
    event_timestamp = models.DateTimeField(auto_now_add=True)
    event_type = models.CharField(
        max_length=50,
        choices=[
            ('CREATE', 'Create'),
            ('UPDATE', 'Update'),
            ('DELETE', 'Delete'),
            ('VIEW', 'View'),
            ('LOGIN', 'Login'),
            ('LOGOUT', 'Logout'),
            ('EXPORT', 'Export'),
            ('PRINT', 'Print'),
            ('APPROVE', 'Approve'),
            ('REJECT', 'Reject'),
            ('CONFIG_CHANGE', 'Configuration Change'),
            ('SYSTEM_EVENT', 'System Event'),
            ('ERROR', 'Error'),
            ('SECURITY_VIOLATION', 'Security Violation'),
        ]
    )
    event_category = models.CharField(
        max_length=50,
        choices=[
            ('FINANCIAL_TRANSACTION', 'Financial Transaction'),
            ('MASTER_DATA', 'Master Data'),
            ('USER_MANAGEMENT', 'User Management'),
            ('SYSTEM_CONFIG', 'System Configuration'),
            ('REPORT_ACCESS', 'Report Access'),
            ('DATA_EXPORT', 'Data Export'),
            ('SECURITY', 'Security'),
            ('COMPLIANCE', 'Compliance'),
        ]
    )
    
    # Action Details
    action_description = models.TextField()
    module_name = models.CharField(max_length=100)
    object_type = models.CharField(max_length=100)
    object_id = models.CharField(max_length=100, null=True, blank=True)
    object_name = models.CharField(max_length=500, null=True, blank=True)
    
    # User Information
    user_name = models.CharField(max_length=255, null=True, blank=True)
    user_email = models.CharField(max_length=255, null=True, blank=True)
    user_role = models.CharField(max_length=100, null=True, blank=True)
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    user_agent = models.TextField(null=True, blank=True)
    
    # Change Details
    old_values = models.TextField(null=True, blank=True)  # JSON format
    new_values = models.TextField(null=True, blank=True)  # JSON format
    changed_fields = models.TextField(null=True, blank=True)  # JSON array of field names
    
    # Request Information
    request_method = models.CharField(max_length=10, null=True, blank=True)
    request_url = models.TextField(null=True, blank=True)
    request_parameters = models.TextField(null=True, blank=True)  # JSON format
    response_status = models.IntegerField(null=True, blank=True)
    
    # System Information
    application_name = models.CharField(max_length=100, default='FMS')
    server_name = models.CharField(max_length=255, null=True, blank=True)
    database_name = models.CharField(max_length=100, null=True, blank=True)
    
    # Compliance and Security
    is_sensitive = models.BooleanField(default=False)
    is_compliance_related = models.BooleanField(default=False)
    retention_period_days = models.IntegerField(default=2555)  # 7 years default
    archival_date = models.DateTimeField(null=True, blank=True)
    
    # Additional Metadata
    reference_number = models.CharField(max_length=100, null=True, blank=True)
    batch_id = models.CharField(max_length=100, null=True, blank=True)
    correlation_id = models.CharField(max_length=100, null=True, blank=True)
    
    class Meta:
        db_table = 'fms_audit_trail'
        verbose_name = 'Audit Trail'
        verbose_name_plural = 'Audit Trail Records'
        indexes = [
            models.Index(fields=['company_id', 'event_timestamp'], name='idx_at_company_timestamp'),
            models.Index(fields=['user_id', 'event_timestamp'], name='idx_at_user_timestamp'),
            models.Index(fields=['event_type'], name='idx_at_event_type'),
            models.Index(fields=['event_category'], name='idx_at_event_category'),
            models.Index(fields=['module_name'], name='idx_at_module'),
            models.Index(fields=['object_type', 'object_id'], name='idx_at_object'),
            models.Index(fields=['is_sensitive'], name='idx_at_sensitive'),
            models.Index(fields=['is_compliance_related'], name='idx_at_compliance'),
            models.Index(fields=['ip_address'], name='idx_at_ip'),
            models.Index(fields=['archival_date'], name='idx_at_archival'),
        ]
        ordering = ['-event_timestamp']

class AuditTrailConfiguration(models.Model):
    """
    Configuration for audit trail settings and policies
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    
    # Configuration Settings
    is_audit_enabled = models.BooleanField(default=True)
    log_level = models.CharField(
        max_length=20,
        choices=[
            ('DEBUG', 'Debug'),
            ('INFO', 'Info'),
            ('WARNING', 'Warning'),
            ('ERROR', 'Error'),
            ('CRITICAL', 'Critical'),
        ],
        default='INFO'
    )
    
    # Data Retention
    default_retention_days = models.IntegerField(default=2555)  # 7 years
    sensitive_data_retention_days = models.IntegerField(default=3650)  # 10 years
    compliance_data_retention_days = models.IntegerField(default=3650)  # 10 years
    
    # Event Filtering
    tracked_events = models.TextField()  # JSON array of event types to track
    excluded_modules = models.TextField(blank=True)  # JSON array of modules to exclude
    excluded_users = models.TextField(blank=True)  # JSON array of user IDs to exclude
    
    # Sensitive Data Handling
    mask_sensitive_data = models.BooleanField(default=True)
    sensitive_fields = models.TextField()  # JSON array of sensitive field names
    encryption_enabled = models.BooleanField(default=False)
    
    # Performance Settings
    async_logging = models.BooleanField(default=True)
    batch_size = models.IntegerField(default=100)
    flush_interval_seconds = models.IntegerField(default=60)
    
    # Alerting
    enable_real_time_alerts = models.BooleanField(default=False)
    alert_events = models.TextField(blank=True)  # JSON array of events that trigger alerts
    alert_recipients = models.TextField(blank=True)  # JSON array of email addresses
    
    # Archival Settings
    enable_archival = models.BooleanField(default=True)
    archival_storage_type = models.CharField(
        max_length=20,
        choices=[
            ('DATABASE', 'Database'),
            ('FILE_SYSTEM', 'File System'),
            ('CLOUD_STORAGE', 'Cloud Storage'),
        ],
        default='DATABASE'
    )
    archival_path = models.CharField(max_length=500, null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_audit_trail_config'
        verbose_name = 'Audit Trail Configuration'
        verbose_name_plural = 'Audit Trail Configurations'
        indexes = [
            models.Index(fields=['company_id', 'is_audit_enabled'], name='idx_atc_company_enabled'),
        ]

class AuditTrailReport(models.Model):
    """
    Generated audit trail reports and exports
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    generated_by_user_id = models.UUIDField()
    
    # Report Information
    report_name = models.CharField(max_length=200)
    report_type = models.CharField(
        max_length=50,
        choices=[
            ('USER_ACTIVITY', 'User Activity'),
            ('DATA_CHANGES', 'Data Changes'),
            ('SECURITY_EVENTS', 'Security Events'),
            ('COMPLIANCE_REPORT', 'Compliance Report'),
            ('CUSTOM', 'Custom'),
        ]
    )
    
    # Report Parameters
    start_date = models.DateTimeField()
    end_date = models.DateTimeField()
    filters = models.TextField(blank=True)  # JSON filter criteria
    
    # Report Details
    total_records = models.IntegerField(default=0)
    file_path = models.CharField(max_length=500, null=True, blank=True)
    file_size_bytes = models.BigIntegerField(null=True, blank=True)
    file_format = models.CharField(
        max_length=20,
        choices=[
            ('PDF', 'PDF'),
            ('EXCEL', 'Excel'),
            ('CSV', 'CSV'),
            ('JSON', 'JSON'),
        ],
        default='PDF'
    )
    
    # Status
    status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', 'Pending'),
            ('GENERATING', 'Generating'),
            ('COMPLETED', 'Completed'),
            ('FAILED', 'Failed'),
            ('EXPIRED', 'Expired'),
        ],
        default='PENDING'
    )
    
    # Expiration
    expires_at = models.DateTimeField(null=True, blank=True)
    download_count = models.IntegerField(default=0)
    max_downloads = models.IntegerField(default=5)
    
    created_at = models.DateTimeField(auto_now_add=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        db_table = 'fms_audit_trail_reports'
        verbose_name = 'Audit Trail Report'
        verbose_name_plural = 'Audit Trail Reports'
        indexes = [
            models.Index(fields=['company_id', 'generated_by_user_id'], name='idx_atr_company_user'),
            models.Index(fields=['report_type', 'status'], name='idx_atr_type_status'),
            models.Index(fields=['expires_at'], name='idx_atr_expires'),
        ]
```

--- END OF SECTION 3 ---

## **4. BUSINESS RULES & VALIDATIONS**

### **4.1 Data Integrity Rules**
- All audit trail records must be immutable once created
- Audit trail entries cannot be modified or deleted by regular users
- Sensitive data must be masked or encrypted based on configuration
- All financial transactions must have corresponding audit trail entries
- User actions must be logged with complete session information

### **4.2 Validation Logic**

```python
def validate_audit_record_integrity(self, audit_record):
    """
    Validate audit record integrity and completeness
    """
    required_fields = ['event_type', 'event_category', 'action_description', 'module_name']
    
    for field in required_fields:
        if not getattr(audit_record, field):
            raise ValidationError(f"Required audit field '{field}' is missing")
    
    # Validate timestamp is within acceptable range
    if audit_record.event_timestamp > timezone.now():
        raise ValidationError("Audit timestamp cannot be in the future")
    
    # Validate IP address format if provided
    if audit_record.ip_address and not is_valid_ip(audit_record.ip_address):
        raise ValidationError("Invalid IP address format")

def mask_sensitive_data(self, audit_record):
    """
    Apply sensitive data masking based on configuration
    """
    config = AuditTrailConfiguration.objects.get(company_id=audit_record.company_id)
    
    if not config.mask_sensitive_data:
        return audit_record
    
    sensitive_fields = json.loads(config.sensitive_fields)
    
    for field in sensitive_fields:
        if hasattr(audit_record, field):
            value = getattr(audit_record, field)
            if value:
                masked_value = self.mask_value(value)
                setattr(audit_record, field, masked_value)
    
    return audit_record

def mask_value(self, value):
    """
    Mask sensitive value while preserving format
    """
    if isinstance(value, str):
        if len(value) <= 4:
            return '*' * len(value)
        return value[:2] + '*' * (len(value) - 4) + value[-2:]
    return '***MASKED***'

def validate_retention_period(self, audit_record):
    """
    Validate and set appropriate retention period
    """
    config = AuditTrailConfiguration.objects.get(company_id=audit_record.company_id)
    
    if audit_record.is_sensitive:
        retention_days = config.sensitive_data_retention_days
    elif audit_record.is_compliance_related:
        retention_days = config.compliance_data_retention_days
    else:
        retention_days = config.default_retention_days
    
    audit_record.retention_period_days = retention_days
    audit_record.archival_date = audit_record.event_timestamp + timedelta(days=retention_days)

def check_event_filtering(self, event_type, module_name, user_id):
    """
    Check if event should be logged based on configuration
    """
    config = AuditTrailConfiguration.objects.get(company_id=get_current_company_id())
    
    if not config.is_audit_enabled:
        return False
    
    # Check if event type is tracked
    tracked_events = json.loads(config.tracked_events)
    if event_type not in tracked_events:
        return False
    
    # Check if module is excluded
    excluded_modules = json.loads(config.excluded_modules)
    if module_name in excluded_modules:
        return False
    
    # Check if user is excluded
    excluded_users = json.loads(config.excluded_users)
    if user_id in excluded_users:
        return False
    
    return True

def validate_report_access(self, report_id, user_id):
    """
    Validate user access to audit trail reports
    """
    report = AuditTrailReport.objects.get(id=report_id)
    
    # Check if user generated the report
    if report.generated_by_user_id == user_id:
        return True
    
    # Check if user has audit admin permissions
    if has_audit_admin_permission(user_id, report.company_id):
        return True
    
    # Check if report is expired
    if report.expires_at and report.expires_at < timezone.now():
        raise ValidationError("Report has expired")
    
    # Check download limit
    if report.download_count >= report.max_downloads:
        raise ValidationError("Download limit exceeded for this report")
    
    raise ValidationError("User does not have permission to access this report")
```

### **4.3 Business Constraints**
- Audit trail records must be preserved for minimum regulatory retention periods
- Sensitive audit data requires additional security controls and access restrictions
- Real-time audit logging must not impact system performance significantly
- Audit trail reports must expire after defined periods to prevent data leakage
- Archival of old audit records must maintain data integrity and accessibility

--- END OF SECTION 4 ---

## **5. UI/UX SPECIFICATIONS**

### **5.1 User Interface Requirements**
- **Layout:** Comprehensive dashboard with audit search, filtering, and reporting capabilities
- **Navigation:** Tabbed interface with audit log viewer, configuration, reports, and analytics
- **Responsiveness:** Full desktop experience with tablet support for mobile audit review

### **5.2 User Experience Design**
- **User Flow:** Search audit logs → Apply filters → Review details → Generate reports → Export data
- **Error Handling:** Real-time validation with clear error messages for access restrictions
- **Loading States:** Progress indicators for large audit data searches and report generation

### **5.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility for all audit management controls
- **Screen Reader Support:** Comprehensive ARIA labels for complex audit data displays

### **5.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **5.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **5.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **5.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **5.8 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **5.9 Filter System Standards**
- **Filter Layout:** Sidebar filter panel with advanced search options
- **Filter Components:** Date range picker, event type filter, user filter, module filter, IP address filter
- **Filter Actions:** Apply, Clear, Reset, Save Filter buttons

### **5.10 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical
- **Audit Log Display:** Expandable rows with detailed change information
- **Timeline View:** Chronological display of audit events with visual indicators

--- END OF SECTION 5 ---

## **6. SECTIONS 8-16: NOT APPLICABLE**

### **6.1 Simplified Technical Sections**
For Configuration modules, sections 8-16 are marked as not applicable as this is a configuration-focused module with emphasis on audit logging, business rules, and user experience rather than complex technical implementations.

### **6.2 Not Applicable Sections**
- **Section 8 - Integration Points:** Handled by underlying system integration framework
- **Section 9 - API Specifications:** Standard audit logging APIs are sufficient
- **Section 10 - Security Requirements:** Standard FMS security applies with additional audit controls
- **Section 11 - Performance Considerations:** Standard audit logging performance optimization
- **Section 12 - Testing Requirements:** Standard configuration testing procedures
- **Section 13 - Deployment Specifications:** Standard FMS deployment with audit logging enabled
- **Section 14 - Maintenance & Support:** Standard FMS maintenance with audit data management
- **Section 15 - Version Control:** Standard FMS version control with audit trail preservation
- **Section 16 - Compliance & Audit:** This module provides compliance functionality rather than being subject to it

--- END OF SECTION 6 ---

**END OF AUDIT TRAIL BBP**
