# FMS BBP - Configuration

## **1. MODULE IDENTIFICATION**

**Module Name:** Configuration
**Module Number:** 6.6
**Module Type:** Configuration
**Target File:** FMS/06.Finance Closing & Compliance/6.6 Configuration.md
**Created Date:** December 31, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Configuration module provides centralized management of all financial system settings, parameters, and business rules, enabling organizations to customize the FMS according to their specific requirements, regulatory compliance needs, and operational preferences. It ensures system flexibility, maintainability, and governance through structured configuration management, version control, and change tracking capabilities.

### **2.2 Business Scope**
**In Scope:**
- Global system parameters and financial settings configuration
- Company-specific business rules and validation parameters
- Workflow approval hierarchies and authorization matrices
- Integration endpoints and external system connections
- Compliance settings and regulatory requirement configurations
- User interface customization and display preferences
- Notification and alert management settings
- Security and access control parameters
- Multi-language and localization settings
- Configuration versioning and change management

**Out of Scope:**
- User role and permission management (handled by security modules)
- Database schema management (handled by migration modules)
- System deployment and infrastructure configuration (handled by DevOps)
- Real-time system monitoring (handled by monitoring modules)

### **2.3 Key Stakeholders**
- **System Administrators:** Global system configuration and maintenance
- **Finance Controllers:** Business rules and financial parameter configuration
- **Compliance Officers:** Regulatory compliance settings and validation rules
- **IT Managers:** Integration configuration and technical parameters
- **Department Heads:** Workflow approval and notification preferences
- **External Consultants:** System customization and parameter tuning

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: SystemConfiguration**

```python
class SystemConfiguration(models.Model):
    """
    Master system configuration parameters and settings
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    updated_by_user_id = models.UUIDField(null=True, blank=True)
    
    # Configuration Information
    config_key = models.CharField(max_length=200)
    config_name = models.CharField(max_length=200)
    config_description = models.TextField(blank=True)
    config_category = models.CharField(
        max_length=50,
        choices=[
            ('FINANCIAL', 'Financial Settings'),
            ('WORKFLOW', 'Workflow Configuration'),
            ('INTEGRATION', 'Integration Settings'),
            ('COMPLIANCE', 'Compliance Settings'),
            ('UI_PREFERENCES', 'UI Preferences'),
            ('NOTIFICATIONS', 'Notification Settings'),
            ('SECURITY', 'Security Settings'),
            ('LOCALIZATION', 'Localization Settings'),
            ('SYSTEM', 'System Settings'),
        ]
    )
    
    # Configuration Value
    config_value = models.TextField()
    config_type = models.CharField(
        max_length=20,
        choices=[
            ('STRING', 'String'),
            ('INTEGER', 'Integer'),
            ('DECIMAL', 'Decimal'),
            ('BOOLEAN', 'Boolean'),
            ('JSON', 'JSON Object'),
            ('DATE', 'Date'),
            ('TIME', 'Time'),
            ('DATETIME', 'DateTime'),
            ('EMAIL', 'Email'),
            ('URL', 'URL'),
            ('FILE', 'File Upload'),
        ]
    )
    default_value = models.TextField(blank=True)
    
    # Validation Rules
    is_required = models.BooleanField(default=False)
    min_value = models.DecimalField(max_digits=20, decimal_places=8, null=True, blank=True)
    max_value = models.DecimalField(max_digits=20, decimal_places=8, null=True, blank=True)
    validation_pattern = models.CharField(max_length=500, blank=True)  # Regex pattern
    allowed_values = models.TextField(blank=True)  # JSON array of allowed values
    
    # Access Control
    is_encrypted = models.BooleanField(default=False)
    is_readonly = models.BooleanField(default=False)
    requires_approval = models.BooleanField(default=False)
    access_level = models.CharField(
        max_length=20,
        choices=[
            ('PUBLIC', 'Public'),
            ('INTERNAL', 'Internal'),
            ('CONFIDENTIAL', 'Confidential'),
            ('RESTRICTED', 'Restricted'),
        ],
        default='INTERNAL'
    )
    
    # Status and Versioning
    is_active = models.BooleanField(default=True)
    version = models.IntegerField(default=1)
    effective_date = models.DateTimeField(null=True, blank=True)
    expiry_date = models.DateTimeField(null=True, blank=True)
    
    # Environment Specific
    environment = models.CharField(
        max_length=20,
        choices=[
            ('ALL', 'All Environments'),
            ('DEVELOPMENT', 'Development'),
            ('TEST', 'Test'),
            ('STAGING', 'Staging'),
            ('PRODUCTION', 'Production'),
        ],
        default='ALL'
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_system_configuration'
        verbose_name = 'System Configuration'
        verbose_name_plural = 'System Configurations'
        indexes = [
            models.Index(fields=['company_id', 'config_key'], name='idx_sc_company_key'),
            models.Index(fields=['config_category', 'is_active'], name='idx_sc_category_active'),
            models.Index(fields=['environment', 'is_active'], name='idx_sc_env_active'),
            models.Index(fields=['access_level'], name='idx_sc_access_level'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'config_key', 'environment'], name='uk_sc_company_key_env'),
        ]

class ConfigurationHistory(models.Model):
    """
    Configuration change history and audit trail
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    system_configuration_id = models.UUIDField()
    
    # Change Information
    change_type = models.CharField(
        max_length=20,
        choices=[
            ('CREATE', 'Create'),
            ('UPDATE', 'Update'),
            ('DELETE', 'Delete'),
            ('ACTIVATE', 'Activate'),
            ('DEACTIVATE', 'Deactivate'),
        ]
    )
    
    # Change Details
    old_value = models.TextField(blank=True)
    new_value = models.TextField(blank=True)
    change_reason = models.TextField(blank=True)
    
    # User Information
    changed_by_user_id = models.UUIDField()
    user_name = models.CharField(max_length=255, null=True, blank=True)
    user_email = models.CharField(max_length=255, null=True, blank=True)
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    
    # Approval Information
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    approval_notes = models.TextField(blank=True)
    approved_at = models.DateTimeField(null=True, blank=True)
    
    # System Information
    change_timestamp = models.DateTimeField(auto_now_add=True)
    module_name = models.CharField(max_length=100, null=True, blank=True)
    action_type = models.CharField(max_length=50, null=True, blank=True)
    
    class Meta:
        db_table = 'fms_configuration_history'
        verbose_name = 'Configuration History'
        verbose_name_plural = 'Configuration Histories'
        indexes = [
            models.Index(fields=['company_id', 'system_configuration_id'], name='idx_ch_company_config'),
            models.Index(fields=['change_timestamp'], name='idx_ch_timestamp'),
            models.Index(fields=['changed_by_user_id'], name='idx_ch_user'),
            models.Index(fields=['change_type'], name='idx_ch_type'),
        ]
        ordering = ['-change_timestamp']

class ConfigurationTemplate(models.Model):
    """
    Configuration templates for quick setup and standardization
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    
    # Template Information
    template_name = models.CharField(max_length=200)
    template_description = models.TextField(blank=True)
    template_category = models.CharField(
        max_length=50,
        choices=[
            ('INDUSTRY', 'Industry Specific'),
            ('COMPANY_SIZE', 'Company Size'),
            ('REGULATORY', 'Regulatory Compliance'),
            ('BEST_PRACTICE', 'Best Practice'),
            ('CUSTOM', 'Custom'),
        ],
        default='CUSTOM'
    )
    
    # Template Content
    template_configurations = models.TextField()  # JSON array of configuration objects
    template_variables = models.TextField(blank=True)  # JSON template variables
    
    # Template Properties
    is_active = models.BooleanField(default=True)
    is_public = models.BooleanField(default=False)
    version = models.CharField(max_length=20, default='1.0')
    compatibility_version = models.CharField(max_length=20, default='1.0')
    
    # Usage Tracking
    usage_count = models.IntegerField(default=0)
    last_used_date = models.DateTimeField(null=True, blank=True)
    
    # Metadata
    created_by_user_id = models.UUIDField()
    tags = models.TextField(blank=True)  # JSON array of tags
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_configuration_template'
        verbose_name = 'Configuration Template'
        verbose_name_plural = 'Configuration Templates'
        indexes = [
            models.Index(fields=['company_id', 'template_category'], name='idx_ct_company_category'),
            models.Index(fields=['is_active', 'is_public'], name='idx_ct_active_public'),
            models.Index(fields=['template_name'], name='idx_ct_name'),
        ]

class ConfigurationApproval(models.Model):
    """
    Configuration change approval workflow
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    
    # Request Information
    request_title = models.CharField(max_length=200)
    request_description = models.TextField()
    requested_by_user_id = models.UUIDField()
    
    # Configuration Changes
    configuration_changes = models.TextField()  # JSON array of proposed changes
    impact_assessment = models.TextField(blank=True)
    
    # Approval Workflow
    approval_status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', 'Pending'),
            ('UNDER_REVIEW', 'Under Review'),
            ('APPROVED', 'Approved'),
            ('REJECTED', 'Rejected'),
            ('CANCELLED', 'Cancelled'),
        ],
        default='PENDING'
    )
    
    # Approval Levels
    current_approval_level = models.IntegerField(default=1)
    total_approval_levels = models.IntegerField(default=1)
    required_approvers = models.TextField()  # JSON array of required approvers
    
    # Schedule
    requested_effective_date = models.DateTimeField(null=True, blank=True)
    approved_effective_date = models.DateTimeField(null=True, blank=True)
    
    # Decision
    decision_notes = models.TextField(blank=True)
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    decision_date = models.DateTimeField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_configuration_approval'
        verbose_name = 'Configuration Approval'
        verbose_name_plural = 'Configuration Approvals'
        indexes = [
            models.Index(fields=['company_id', 'approval_status'], name='idx_ca_company_status'),
            models.Index(fields=['requested_by_user_id'], name='idx_ca_requester'),
            models.Index(fields=['current_approval_level'], name='idx_ca_level'),
            models.Index(fields=['requested_effective_date'], name='idx_ca_effective_date'),
        ]
```

--- END OF SECTION 3 ---

## **4. BUSINESS RULES & VALIDATIONS**

### **4.1 Data Integrity Rules**
- Configuration keys must be unique within company and environment
- Encrypted configurations must have proper key management
- Required configurations must have valid values before system activation
- Configuration changes must follow approval workflows for critical settings
- Historical configuration changes must be preserved for audit purposes

### **4.2 Validation Logic**

```python
def validate_configuration_value(self, config):
    """
    Validate configuration value based on type and rules
    """
    # Type-specific validation
    if config.config_type == 'INTEGER':
        try:
            value = int(config.config_value)
            if config.min_value and value < config.min_value:
                raise ValidationError(f"Value must be >= {config.min_value}")
            if config.max_value and value > config.max_value:
                raise ValidationError(f"Value must be <= {config.max_value}")
        except ValueError:
            raise ValidationError("Invalid integer value")
    
    elif config.config_type == 'DECIMAL':
        try:
            value = Decimal(config.config_value)
            if config.min_value and value < config.min_value:
                raise ValidationError(f"Value must be >= {config.min_value}")
            if config.max_value and value > config.max_value:
                raise ValidationError(f"Value must be <= {config.max_value}")
        except (ValueError, InvalidOperation):
            raise ValidationError("Invalid decimal value")
    
    elif config.config_type == 'BOOLEAN':
        if config.config_value.lower() not in ['true', 'false', '1', '0']:
            raise ValidationError("Invalid boolean value")
    
    elif config.config_type == 'EMAIL':
        try:
            validate_email(config.config_value)
        except ValidationError:
            raise ValidationError("Invalid email address")
    
    elif config.config_type == 'URL':
        if not config.config_value.startswith(('http://', 'https://')):
            raise ValidationError("Invalid URL format")
    
    # Pattern validation
    if config.validation_pattern:
        import re
        if not re.match(config.validation_pattern, config.config_value):
            raise ValidationError("Value does not match required pattern")
    
    # Allowed values validation
    if config.allowed_values:
        allowed_values = json.loads(config.allowed_values)
        if config.config_value not in allowed_values:
            raise ValidationError(f"Value must be one of: {', '.join(allowed_values)}")

def validate_configuration_access(self, user_id, config):
    """
    Validate user access to configuration based on access level
    """
    user_role = get_user_role(user_id)
    user_access_level = get_role_access_level(user_role)
    
    access_hierarchy = {
        'PUBLIC': 0,
        'INTERNAL': 1,
        'CONFIDENTIAL': 2,
        'RESTRICTED': 3,
    }
    
    if access_hierarchy.get(user_access_level, 0) < access_hierarchy.get(config.access_level, 1):
        raise ValidationError("User does not have sufficient access level for this configuration")

def validate_configuration_change(self, config_change_request):
    """
    Validate configuration change request and business rules
    """
    # Check if configuration requires approval
    if config_change_request.requires_approval:
        if not has_pending_approval(config_change_request.id):
            raise ValidationError("Configuration change requires approval before modification")
    
    # Validate effective date
    if config_change_request.effective_date:
        if config_change_request.effective_date < timezone.now():
            raise ValidationError("Effective date cannot be in the past")
    
    # Check for conflicting changes
        if has_conflicting_changes(config_change_request):
            raise ValidationError("Conflicting configuration changes detected")

def validate_template_application(self, template, variables):
    """
    Validate configuration template and variable substitution
    """
    template_configs = json.loads(template.template_configurations)
    template_vars = json.loads(template.template_variables or '{}')
    
    # Check if all required variables are provided
    for config in template_configs:
        if '{{' in config['config_value'] and '}}' in config['config_value']:
            # Extract variables from template
            import re
            required_vars = re.findall(r'\{\{(\w+)\}\}', config['config_value'])
            
            for var in required_vars:
                if var not in variables and var not in template_vars:
                    raise ValidationError(f"Required template variable '{var}' not provided")
    
    # Validate variable values
    for var_name, var_value in variables.items():
        if var_name in template_vars:
            var_config = template_vars[var_name]
            if not validate_variable_type(var_value, var_config.get('type', 'STRING')):
                raise ValidationError(f"Invalid type for variable '{var_name}'")

def validate_configuration_dependencies(self, config):
    """
    Validate configuration dependencies and constraints
    """
    # Check for dependent configurations
    dependencies = get_configuration_dependencies(config.config_key)
    
    for dep_config_key in dependencies:
        dep_config = SystemConfiguration.objects.filter(
            company_id=config.company_id,
            config_key=dep_config_key,
            is_active=True
        ).first()
        
        if not dep_config:
            raise ValidationError(f"Required dependency configuration '{dep_config_key}' is not active")
        
        # Validate dependency constraints
        if not validate_dependency_constraint(config, dep_config):
            raise ValidationError(f"Configuration value violates dependency constraint with '{dep_config_key}'")

def validate_environment_compatibility(self, config):
    """
    Validate configuration compatibility with target environment
    """
    if config.environment == 'ALL':
        return
    
    # Check environment-specific rules
    env_rules = get_environment_rules(config.environment)
    
    for rule in env_rules:
        if not validate_environment_rule(config, rule):
            raise ValidationError(f"Configuration violates environment rule: {rule['description']}")
    
    # Validate integration compatibility
    integrations = get_active_integrations(config.company_id, config.environment)
    for integration in integrations:
        if not validate_integration_compatibility(config, integration):
            raise ValidationError(f"Configuration incompatible with integration '{integration['name']}'")
```

### **4.3 Business Constraints**
- Critical system configurations cannot be changed without proper approval
- Production environment configurations require additional validation steps
- Configuration templates must be compatible with current system version
- Encrypted configurations cannot be viewed by users without decryption permissions
- Historical configuration data must be retained for minimum regulatory periods

--- END OF SECTION 4 ---

## **5. UI/UX SPECIFICATIONS**

### **5.1 User Interface Requirements**
- **Layout:** Comprehensive dashboard with configuration categories, search, and management tools
- **Navigation:** Tabbed interface with configuration sections, templates, approvals, and history
- **Responsiveness:** Full desktop experience with tablet support for mobile configuration management

### **5.2 User Experience Design**
- **User Flow:** Browse configuration → Edit values → Validate → Submit for approval → Deploy
- **Error Handling:** Real-time validation with clear error messages for configuration issues
- **Loading States:** Progress indicators for configuration validation and deployment processes

### **5.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility for all configuration management controls
- **Screen Reader Support:** Comprehensive ARIA labels for complex configuration forms

### **5.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **5.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **5.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **5.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **5.8 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **5.9 Filter System Standards**
- **Filter Layout:** Sidebar filter panel with advanced search options
- **Filter Components:** Category filter, environment filter, access level filter, status filter
- **Filter Actions:** Apply, Clear, Reset, Save Filter buttons

### **5.10 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical
- **Configuration Forms:** Organized sections with clear grouping and validation indicators
- **Approval Workflow:** Visual workflow representation with status tracking

--- END OF SECTION 5 ---

## **6. SECTIONS 8-16: NOT APPLICABLE**

### **6.1 Simplified Technical Sections**
For Configuration modules, sections 8-16 are marked as not applicable as this is a configuration-focused module with emphasis on configuration management, business rules, and user experience rather than complex technical implementations.

### **6.2 Not Applicable Sections**
- **Section 8 - Integration Points:** Handled by underlying system integration framework
- **Section 9 - API Specifications:** Standard configuration management APIs are sufficient
- **Section 10 - Security Requirements:** Standard FMS security applies with additional configuration controls
- **Section 11 - Performance Considerations:** Standard configuration performance optimization
- **Section 12 - Testing Requirements:** Standard configuration testing procedures
- **Section 13 - Deployment Specifications:** Standard FMS deployment with configuration services
- **Section 14 - Maintenance & Support:** Standard FMS maintenance with configuration system management
- **Section 15 - Version Control:** Standard FMS version control with configuration preservation
- **Section 16 - Compliance & Audit:** This module provides compliance functionality rather than being subject to it

--- END OF SECTION 6 ---

**END OF CONFIGURATION BBP**
