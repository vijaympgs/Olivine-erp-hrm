# FMS BBP - Month-End Closing

## **1. MODULE IDENTIFICATION**

**Module Name:** Month-End Closing
**Module Number:** 6.1
**Module Type:** Workflow
**Target File:** FMS/06.Finance Closing & Compliance/6.1 Month-End Closing.md
**Created Date:** December 30, 2025
**Version:** 1.0.0
**Author:** BBP System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Month-End Closing module provides comprehensive workflow management for monthly financial closing processes, enabling systematic execution of closing tasks, automated validation of financial data, approval workflows for closing entries, and generation of month-end financial statements to ensure accurate and timely financial reporting across the organization.

### **2.2 Business Scope**
**In Scope:**
- Month-end closing checklist management and task automation
- Automated closing procedures and validation workflows
- Journal entry processing and approval workflows
- Account reconciliation and balance verification
- Financial statement generation and review processes
- Closing status tracking and progress monitoring
- Multi-level approval hierarchies for closing entries
- Integration with all financial modules for data consolidation

**Out of Scope:**
- Year-end closing procedures (handled by Year-End Closing module)
- Audit trail management (handled by Audit Trail module)
- Data backup and restore operations (handled by separate modules)
- Multi-entity consolidation (handled by Consolidation module)
- Regulatory compliance reporting (handled by Compliance modules)

### **2.3 Key Stakeholders**
- **Finance Controllers:** Month-end closing oversight and approval management
- **Accountants:** Closing task execution and journal entry preparation
- **Financial Analysts:** Financial statement preparation and variance analysis
- **Department Heads:** Departmental closing approvals and validations
- **External Auditors:** Month-end closing documentation and audit verification

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: MonthEndClosing**

```python
class MonthEndClosing(models.Model):
    """
    Master month-end closing workflow configuration and tracking
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    financial_year_id = models.UUIDField()
    period_id = models.UUIDField()
    initiated_by_user_id = models.UUIDField()
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    
    # Core Fields
    closing_number = models.CharField(max_length=50, unique=True)
    closing_name = models.CharField(max_length=200)
    financial_year = models.IntegerField()
    closing_period = models.CharField(max_length=20)  # Jan-2024, Feb-2024, etc.
    
    # Closing Schedule
    start_date = models.DateField()
    end_date = models.DateField()
    target_completion_date = models.DateField()
    actual_completion_date = models.DateField(null=True, blank=True)
    
    # Closing Status
    status = models.CharField(
        max_length=20,
        choices=[
            ('DRAFT', 'Draft'),
            ('IN_PROGRESS', 'In Progress'),
            ('UNDER_REVIEW', 'Under Review'),
            ('PENDING_APPROVAL', 'Pending Approval'),
            ('COMPLETED', 'Completed'),
            ('CANCELLED', 'Cancelled'),
            ('FAILED', 'Failed'),
        ],
        default='DRAFT'
    )
    
    # Progress Tracking
    total_tasks = models.IntegerField(default=0)
    completed_tasks = models.IntegerField(default=0)
    failed_tasks = models.IntegerField(default=0)
    progress_percentage = models.DecimalField(max_digits=5, decimal_places=2, default=0)
    
    # Configuration
    auto_post_entries = models.BooleanField(default=False)
    require_dual_approval = models.BooleanField(default=True)
    allow_reopening = models.BooleanField(default=False)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        db_table = 'fms_month_end_closing'
        verbose_name = 'Month-End Closing'
        verbose_name_plural = 'Month-End Closing Records'
        indexes = [
            models.Index(fields=['company_id', 'closing_number'], name='idx_mec_company_number'),
            models.Index(fields=['financial_year', 'closing_period'], name='idx_mec_year_period'),
            models.Index(fields=['status'], name='idx_mec_status'),
            models.Index(fields=['target_completion_date'], name='idx_mec_target_date'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'financial_year', 'closing_period'], name='uk_mec_company_period'),
        ]

class ClosingTask(models.Model):
    """
    Individual closing tasks within month-end closing workflow
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    month_end_closing_id = models.UUIDField()
    
    # Task Information
    task_code = models.CharField(max_length=50)
    task_name = models.CharField(max_length=200)
    task_description = models.TextField(blank=True)
    task_group = models.CharField(max_length=100)  # Revenue, Expenses, Assets, etc.
    
    # Task Configuration
    task_type = models.CharField(
        max_length=30,
        choices=[
            ('AUTOMATED', 'Automated'),
            ('MANUAL', 'Manual'),
            ('VALIDATION', 'Validation'),
            ('APPROVAL', 'Approval'),
            ('REPORTING', 'Reporting'),
        ]
    )
    execution_order = models.IntegerField()
    is_mandatory = models.BooleanField(default=True)
    depends_on_tasks = models.TextField(blank=True)  # JSON array of task IDs
    
    # Assignment and Scheduling
    assigned_to_user_id = models.UUIDField(null=True, blank=True)
    assigned_to_role_id = models.UUIDField(null=True, blank=True)
    estimated_duration_hours = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    
    # Task Status
    status = models.CharField(
        max_length=20,
        choices=[
            ('PENDING', 'Pending'),
            ('IN_PROGRESS', 'In Progress'),
            ('COMPLETED', 'Completed'),
            ('FAILED', 'Failed'),
            ('SKIPPED', 'Skipped'),
            ('ON_HOLD', 'On Hold'),
        ],
        default='PENDING'
    )
    
    # Execution Details
    start_time = models.DateTimeField(null=True, blank=True)
    end_time = models.DateTimeField(null=True, blank=True)
    actual_duration_hours = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    
    # Results and Output
    result_data = models.TextField(blank=True)  # JSON result data
    error_message = models.TextField(blank=True)
    output_files = models.TextField(blank=True)  # JSON array of generated files
    
    # Approval
    requires_approval = models.BooleanField(default=False)
    approved_by_user_id = models.UUIDField(null=True, blank=True)
    approval_notes = models.TextField(blank=True)
    approved_at = models.DateTimeField(null=True, blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_closing_tasks'
        verbose_name = 'Closing Task'
        verbose_name_plural = 'Closing Tasks'
        indexes = [
            models.Index(fields=['company_id', 'month_end_closing_id'], name='idx_ct_company_closing'),
            models.Index(fields=['task_group', 'execution_order'], name='idx_ct_group_order'),
            models.Index(fields=['status'], name='idx_ct_status'),
            models.Index(fields=['assigned_to_user_id'], name='idx_ct_assigned_user'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['month_end_closing_id', 'task_code'], name='uk_ct_closing_task'),
        ]

class ClosingChecklist(models.Model):
    """
    Month-end closing checklist templates and configurations
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    
    # Checklist Information
    checklist_name = models.CharField(max_length=200)
    checklist_description = models.TextField(blank=True)
    checklist_type = models.CharField(
        max_length=30,
        choices=[
            ('STANDARD', 'Standard'),
            ('DETAILED', 'Detailed'),
            ('SIMPLIFIED', 'Simplified'),
            ('REGULATED', 'Regulated'),
            ('CUSTOM', 'Custom'),
        ],
        default='STANDARD'
    )
    
    # Configuration
    is_active = models.BooleanField(default=True)
    is_default = models.BooleanField(default=False)
    applicable_entity_types = models.TextField(blank=True)  # JSON array of entity types
    
    # Task Templates
    task_templates = models.TextField()  # JSON array of task template configurations
    
    # Approval Configuration
    approval_levels = models.IntegerField(default=1)
    approval_roles = models.TextField(blank=True)  # JSON array of role IDs
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'fms_closing_checklists'
        verbose_name = 'Closing Checklist'
        verbose_name_plural = 'Closing Checklists'
        indexes = [
            models.Index(fields=['company_id', 'checklist_type'], name='idx_ccl_company_type'),
            models.Index(fields=['is_active', 'is_default'], name='idx_ccl_active_default'),
        ]
```

--- END OF SECTION 3 ---

## **4. BUSINESS RULES & VALIDATIONS**

### **4.1 Data Integrity Rules**
- Closing numbers must be unique within each company
- Only one closing can be active per financial period
- Closing periods must be sequential without gaps
- Mandatory tasks must be completed before closing approval
- Closing cannot be completed if any tasks have failed status

### **4.2 Validation Logic**

```python
def clean_closing_period(self):
    """
    Validate closing period and prevent duplicates
    """
    # Check if closing already exists for this period
    if MonthEndClosing.objects.filter(
        company_id=self.company_id,
        financial_year=self.financial_year,
        closing_period=self.closing_period,
        status__in=['DRAFT', 'IN_PROGRESS', 'UNDER_REVIEW', 'PENDING_APPROVAL']
    ).exclude(id=self.id).exists():
        raise ValidationError("Closing already exists for this period")

def validate_task_dependencies(self, task_id):
    """
    Validate that task dependencies are satisfied
    """
    task = ClosingTask.objects.get(id=task_id)
    if task.depends_on_tasks:
        dependencies = json.loads(task.depends_on_tasks)
        for dep_task_id in dependencies:
            dep_task = ClosingTask.objects.get(id=dep_task_id)
            if dep_task.status != 'COMPLETED':
                raise ValidationError(f"Task dependency '{dep_task.task_name}' is not completed")

def validate_closing_completion(self, closing_id):
    """
    Validate that all requirements are met for closing completion
    """
    closing = MonthEndClosing.objects.get(id=closing_id)
    
    # Check all mandatory tasks are completed
    mandatory_tasks = ClosingTask.objects.filter(
        month_end_closing_id=closing_id,
        is_mandatory=True
    )
    
    for task in mandatory_tasks:
        if task.status != 'COMPLETED':
            raise ValidationError(f"Mandatory task '{task.task_name}' is not completed")
    
    # Check no tasks have failed
    failed_tasks = ClosingTask.objects.filter(
        month_end_closing_id=closing_id,
        status='FAILED'
    )
    
    if failed_tasks.exists():
        raise ValidationError("Some tasks have failed. Please resolve failed tasks before completing closing")

def validate_approval_hierarchy(self, closing_id, user_id):
    """
    Validate user approval authority based on hierarchy
    """
    closing = MonthEndClosing.objects.get(id=closing_id)
    user_role = get_user_role(user_id)
    
    # Check if user has approval authority
    if not has_approval_permission(user_role, closing.company_id):
        raise ValidationError("User does not have approval authority for this closing")
```

### **4.3 Business Constraints**
- Cannot reopen completed closing without special authorization
- Cannot modify closing entries after approval
- Closing tasks must be executed in defined order
- Approval workflows must follow company hierarchy
- Financial statements must balance before closing approval

--- END OF SECTION 4 ---

## **5. UI/UX SPECIFICATIONS**

### **5.1 User Interface Requirements**
- **Layout:** Dashboard with closing progress, task queue, and approval workflows
- **Navigation:** Tabbed interface with closing setup, task management, and reporting
- **Responsiveness:** Full desktop experience with tablet support for mobile approvals

### **5.2 User Experience Design**
- **User Flow:** Create closing → Load checklist → Execute tasks → Review results → Approve closing
- **Error Handling:** Real-time validation with clear error messages for task failures
- **Loading States:** Progress indicators for long-running closing tasks and validations

### **5.3 Accessibility Standards**
- **WCAG Compliance:** WCAG 2.1 AA compliance
- **Keyboard Navigation:** Full keyboard accessibility for all closing management controls
- **Screen Reader Support:** Comprehensive ARIA labels for complex closing workflows

### **5.4 Visual Design System**
- **Design System:** Material Design 3.0
- **Component Library:** Material-UI (MUI) v5
- **Design Tokens:** Custom design token system

### **5.5 Typography Standards**
- **Primary Font Family:** 'Inter', 'Roboto', sans-serif
- **Secondary Font Family:** 'JetBrains Mono', monospace
- **Font Sizes:**
  - **H1:** 32px / 700 / 40px
  - **H2:** 24px / 600 / 32px
  - **H3:** 20px / 600 / 28px
  - **H4:** 18px / 600 / 24px
  - **H5:** 16px / 600 / 24px
  - **H6:** 14px / 600 / 20px
  - **Body Large:** 16px / 400 / 24px
  - **Body Medium:** 14px / 400 / 20px
  - **Body Small:** 12px / 400 / 16px
  - **Caption:** 11px / 400 / 16px

### **5.6 Color Palette**
- **Primary Colors:**
  - **Primary 50:** #e3f2fd
  - **Primary 100:** #bbdefb
  - **Primary 200:** #90caf9
  - **Primary 300:** #64b5f6
  - **Primary 400:** #42a5f5
  - **Primary 500:** #2196f3
  - **Primary 600:** #1e88e5
  - **Primary 700:** #1976d2
  - **Primary 800:** #1565c0
  - **Primary 900:** #0d47a1
- **Semantic Colors:**
  - **Success:** #4caf50
  - **Warning:** #ff9800
  - **Error:** #f44336
  - **Info:** #2196f3

### **5.7 Spacing System**
- **Base Unit:** 4px
- **Spacing Scale:**
  - **XS:** 4px
  - **SM:** 8px
  - **MD:** 16px
  - **LG:** 24px
  - **XL:** 32px
  - **2XL:** 48px
  - **3XL:** 64px

### **5.8 Component Standards**
- **Buttons:**
  - **Primary Button:** Height 40px, Padding 0 24px, Border-radius 8px
  - **Secondary Button:** Height 40px, Padding 0 16px, Border-radius 8px
- **Form Controls:**
  - **Text Input:** Height 56px, Padding 16px, Border-radius 8px
  - **Select Dropdown:** Height 56px, Padding 16px, Border-radius 8px

### **5.9 Filter System Standards**
- **Filter Layout:** Sidebar filter panel
- **Filter Components:** Search, status filter, period filter, assigned user filter
- **Filter Actions:** Apply, Clear, Reset buttons

### **5.10 Data Display Standards**
- **Tables:**
  - **Header Row:** Height 56px, background #f8f9fa
  - **Data Row:** Height 48px, hover background #f5f5f5
  - **Cell Padding:** 16px horizontal, 12px vertical

--- END OF SECTION 5 ---

**END OF MONTH-END CLOSING BBP**
