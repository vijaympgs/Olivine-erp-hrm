# 1. MODULE IDENTIFICATION

**Module Name:** Tax Calculations
**Module Number:** 04.2
**Module Type:** Transaction
**Target File:** HR/04.Compensation & Payroll/04.2 Tax Calculations.md
**Created Date:** December 29, 2025
**Version:** 1.0
**Author:** HR System Architect

--- END OF SECTION 1 ---

## 2. PURPOSE

### 2.1 Business Purpose
The Tax Calculations module provides a comprehensive system for computing, managing, and processing all tax-related calculations for payroll. It ensures accurate tax withholding, compliance with federal, state, and local tax regulations, and proper reporting while supporting complex tax scenarios across multiple jurisdictions and employee types.

### 2.2 Business Scope
**In Scope:**
- Federal income tax calculations and withholding
- State and local income tax processing
- Social Security and Medicare (FICA) calculations
- Federal and state unemployment taxes (FUTA/SUTA)
- Disability insurance and other mandatory deductions
- Tax exemption and allowance management
- Supplemental wage tax calculations
- Year-end tax form generation (W-2, 1099)
- Tax jurisdiction management and updates
- Employee tax profile and withholding configuration
- Tax compliance reporting and filing
- Multi-state tax calculations for mobile workforce
- International tax calculations for expatriates
- Tax credit and deduction processing

**Out of Scope:**
- Payroll processing and disbursement (handled in Payroll Run module)
- Salary structure management (handled in Salary Structures module)
- Benefits administration (handled in separate Benefits modules)
- Time and attendance tracking (handled in Time & Attendance modules)

### 2.3 Key Stakeholders
- **Payroll Department:** Tax calculation processing and compliance
- **HR Department:** Employee tax profile management
- **Finance Department:** Tax liability management and reporting
- **Compliance Officers:** Regulatory compliance and audit support
- **Employees:** Tax withholding preferences and forms management
- **External Tax Agencies:** Tax filing and reporting
- **Tax Consultants:** Complex tax scenario advisory

--- END OF SECTION 2 ---

## 3. CORE MODELS (DJANGO)

### 3.1 Primary Model: TaxCalculation

```python
class TaxCalculation(models.Model):
    """
    Main tax calculation model for payroll tax processing
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    employee_id = models.UUIDField()
    payroll_run_id = models.UUIDField()
    tax_year = models.IntegerField()
    
    # Calculation Details
    calculation_date = models.DateTimeField(auto_now_add=True)
    pay_period_start = models.DateField()
    pay_period_end = models.DateField()
    pay_frequency = models.CharField(max_length=20, choices=[
        ('weekly', 'Weekly'),
        ('bi_weekly', 'Bi-Weekly'),
        ('semi_monthly', 'Semi-Monthly'),
        ('monthly', 'Monthly'),
        ('quarterly', 'Quarterly'),
        ('annual', 'Annual'),
    ])
    
    # Gross Compensation
    gross_wages = models.DecimalField(max_digits=12, decimal_places=2)
    supplemental_wages = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    taxable_wages = models.DecimalField(max_digits=12, decimal_places=2)
    year_to_date_gross = models.DecimalField(max_digits=12, decimal_places=2)
    
    # Federal Taxes
    federal_income_tax = models.DecimalField(max_digits=12, decimal_places=2)
    social_security_tax = models.DecimalField(max_digits=12, decimal_places=2)
    medicare_tax = models.DecimalField(max_digits=12, decimal_places=2)
    additional_medicare_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    futa_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    
    # State Taxes
    state_income_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    state_disability_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    state_unemployment_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    other_state_taxes = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    
    # Local Taxes
    local_income_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    local_school_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    local_city_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    other_local_taxes = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    
    # Totals
    total_tax_withholding = models.DecimalField(max_digits=12, decimal_places=2)
    total_employer_tax = models.DecimalField(max_digits=12, decimal_places=2)
    
    # Status and Validation
    calculation_status = models.CharField(max_length=20, choices=[
        ('pending', 'Pending'),
        ('calculated', 'Calculated'),
        ('verified', 'Verified'),
        ('error', 'Error'),
        ('adjusted', 'Adjusted'),
    ], default='pending')
    
    validation_status = models.CharField(max_length=20, choices=[
        ('not_validated', 'Not Validated'),
        ('validated', 'Validated'),
        ('validation_failed', 'Validation Failed'),
    ], default='not_validated')
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    calculated_by_user_id = models.UUIDField()
    
    class Meta:
        db_table = 'hr_tax_calculations'
        verbose_name = 'Tax Calculation'
        verbose_name_plural = 'Tax Calculations'
        indexes = [
            models.Index(fields=['company_id', 'employee_id'], name='idx_tax_employee'),
            models.Index(fields=['company_id', 'payroll_run_id'], name='idx_tax_payroll'),
            models.Index(fields=['company_id', 'tax_year'], name='idx_tax_year'),
            models.Index(fields=['company_id', 'calculation_status'], name='idx_tax_status'),
        ]
```

### 3.2 Supporting Model: TaxWithholding

```python
class TaxWithholding(models.Model):
    """
    Employee tax withholding preferences and allowances
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    employee_id = models.UUIDField()
    
    # Federal Withholding
    federal_filing_status = models.CharField(max_length=20, choices=[
        ('single', 'Single'),
        ('married_filing_jointly', 'Married Filing Jointly'),
        ('married_filing_separately', 'Married Filing Separately'),
        ('head_of_household', 'Head of Household'),
        ('qualifying_widow', 'Qualifying Widow(er)'),
    ])
    
    federal_allowances = models.IntegerField(default=0)
    additional_federal_withholding = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    federal_exempt = models.BooleanField(default=False)
    
    # State Withholding
    state_filing_status = models.CharField(max_length=50, blank=True)
    state_allowances = models.IntegerField(default=0)
    additional_state_withholding = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    state_exempt = models.BooleanField(default=False)
    
    # Local Withholding
    local_filing_status = models.CharField(max_length=50, blank=True)
    local_allowances = models.IntegerField(default=0)
    additional_local_withholding = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    local_exempt = models.BooleanField(default=False)
    
    # Special Tax Situations
    nonresident_alien = models.BooleanField(default=False)
    dual_status_alien = models.BooleanField(default=False)
    exemption_from_withholding = models.BooleanField(default=False)
    
    # Tax Treaty Information
    tax_treaty_country = models.CharField(max_length=100, blank=True)
    tax_treaty_article = models.CharField(max_length=100, blank=True)
    tax_treaty_exemption_amount = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    
    # Additional Withholding
    additional_withholding_401k = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    additional_withholding_health = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    additional_withholding_other = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    
    # Effective Dates
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    
    # Status
    status = models.CharField(max_length=20, choices=[
        ('active', 'Active'),
        ('inactive', 'Inactive'),
        ('pending', 'Pending'),
    ], default='active')
    
    # Documentation
    w4_form_date = models.DateField(null=True, blank=True)
    w4_form_url = models.URLField(blank=True)
    state_w4_form_date = models.DateField(null=True, blank=True)
    state_w4_form_url = models.URLField(blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'hr_tax_withholding'
        verbose_name = 'Tax Withholding'
        verbose_name_plural = 'Tax Withholding'
        indexes = [
            models.Index(fields=['company_id', 'employee_id'], name='idx_withholding_employee'),
            models.Index(fields=['company_id', 'status'], name='idx_withholding_status'),
        ]
```

### 3.3 Supporting Model: TaxJurisdiction

```python
class TaxJurisdiction(models.Model):
    """
    Tax jurisdictions and their configuration
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    
    # Jurisdiction Details
    jurisdiction_type = models.CharField(max_length=20, choices=[
        ('federal', 'Federal'),
        ('state', 'State'),
        ('local', 'Local'),
        ('school_district', 'School District'),
        ('city', 'City'),
        ('county', 'County'),
    ])
    
    jurisdiction_name = models.CharField(max_length=200)
    jurisdiction_code = models.CharField(max_length=50)
    state_code = models.CharField(max_length=10, blank=True)
    country_code = models.CharField(max_length=10, default='US')
    
    # Tax Configuration
    tax_type = models.CharField(max_length=50, choices=[
        ('income_tax', 'Income Tax'),
        ('unemployment_tax', 'Unemployment Tax'),
        ('disability_tax', 'Disability Tax'),
        ('transit_tax', 'Transit Tax'),
        ('school_tax', 'School Tax'),
        ('other', 'Other'),
    ])
    
    # Tax Rates and Thresholds
    tax_rate_type = models.CharField(max_length=20, choices=[
        ('flat', 'Flat Rate'),
        ('progressive', 'Progressive'),
        ('tiered', 'Tiered'),
    ])
    
    tax_rates = models.JSONField(default=list)  # Array of rate brackets
    wage_base_limit = models.DecimalField(max_digits=12, decimal_places=2, null=True, blank=True)
    minimum_wage_threshold = models.DecimalField(max_digits=12, decimal_places=2, null=True, blank=True)
    
    # Employer vs Employee Responsibility
    employee_responsible = models.BooleanField(default=True)
    employer_responsible = models.BooleanField(default=False)
    
    # Status and Dates
    status = models.CharField(max_length=20, choices=[
        ('active', 'Active'),
        ('inactive', 'Inactive'),
        ('pending', 'Pending'),
        ('deprecated', 'Deprecated'),
    ], default='active')
    
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    
    # Filing Information
    filing_frequency = models.CharField(max_length=20, choices=[
        ('monthly', 'Monthly'),
        ('quarterly', 'Quarterly'),
        ('annual', 'Annual'),
        ('semi_annual', 'Semi-Annual'),
    ])
    
    filing_agency = models.CharField(max_length=200, blank=True)
    filing_form = models.CharField(max_length=100, blank=True)
    
    # Additional Configuration
    special_rules = models.JSONField(default=dict, blank=True)
    notes = models.TextField(blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'hr_tax_jurisdictions'
        verbose_name = 'Tax Jurisdiction'
        verbose_name_plural = 'Tax Jurisdictions'
        indexes = [
            models.Index(fields=['company_id', 'jurisdiction_type'], name='idx_jurisdiction_type'),
            models.Index(fields=['company_id', 'state_code'], name='idx_jurisdiction_state'),
            models.Index(fields=['company_id', 'status'], name='idx_jurisdiction_status'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'jurisdiction_code'], name='uk_jurisdiction_code'),
        ]
```

--- END OF SECTION 3 ---

## 4. REFERENCE MODELS (DJANGO)

### 4.1 TaxRate

```python
class TaxRate(models.Model):
    """
    Tax rate brackets and configurations
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    tax_jurisdiction_id = models.UUIDField()
    
    bracket_number = models.IntegerField()
    minimum_wage = models.DecimalField(max_digits=12, decimal_places=2)
    maximum_wage = models.DecimalField(max_digits=12, decimal_places=2, null=True, blank=True)
    tax_rate = models.DecimalField(max_digits=8, decimal_places=6)
    base_tax = models.DecimalField(max_digits=12, decimal_places=2, default=0)
    
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    
    class Meta:
        db_table = 'hr_tax_rates'
        verbose_name = 'Tax Rate'
        verbose_name_plural = 'Tax Rates'
```

### 4.2 TaxExemption

```python
class TaxExemption(models.Model):
    """
    Tax exemptions and deductions
    """
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    company_id = models.UUIDField()
    employee_id = models.UUIDField()
    
    exemption_type = models.CharField(max_length=50)
    exemption_amount = models.DecimalField(max_digits=12, decimal_places=2)
    tax_jurisdiction_id = models.UUIDField()
    
    effective_date = models.DateField()
    expiry_date = models.DateField(null=True, blank=True)
    
    class Meta:
        db_table = 'hr_tax_exemptions'
        verbose_name = 'Tax Exemption'
        verbose_name_plural = 'Tax Exemptions'
```

--- END OF SECTION 4 ---

## 5. FOREIGN KEY RELATIONSHIPS

### 5.1 Primary Relationships
- **TaxCalculation** → **Employee**: Employee tax calculation
- **TaxCalculation** → **PayrollRun**: Associated payroll run
- **TaxWithholding** → **Employee**: Employee withholding preferences
- **TaxJurisdiction** → **Company**: Company-specific jurisdictions

### 5.2 Many-to-Many Relationships
- **TaxCalculation** ↔ **TaxJurisdiction**: Many-to-many through calculation details
- **TaxRate** → **TaxJurisdiction**: Multiple rates per jurisdiction

--- END OF SECTION 5 ---

## 6. BUSINESS RULES & VALIDATIONS

### 6.1 Data Integrity Rules
- Tax calculations must balance (withholding = calculated amounts)
- Withholding allowances must be within legal limits
- Tax rates must be current and valid for calculation period
- Jurisdiction configurations must be accurate and up-to-date
- Year-to-date totals must be cumulative and accurate

### 6.2 Validation Logic
```python
def clean_tax_calculation(self):
    """
    Validate tax calculation accuracy
    """
    total_withholding = (
        self.federal_income_tax + self.social_security_tax + 
        self.medicare_tax + self.state_income_tax + self.local_income_tax
    )
    
    if abs(total_withholding - self.total_tax_withholding) > 0.01:
        raise ValidationError("Total tax withholding calculation is incorrect")

def clean_wage_base_limit(self):
    """
    Validate wage base limits are reasonable
    """
    if self.wage_base_limit and self.wage_base_limit < 0:
        raise ValidationError("Wage base limit cannot be negative")

def clean_tax_rates(self):
    """
    Validate tax rate configuration
    """
    if not self.tax_rates or len(self.tax_rates) == 0:
        raise ValidationError("Tax rates must be configured")
```

### 6.3 Business Constraints
- Maximum federal allowances: 10 (without special circumstances)
- Maximum state allowances: Varies by state
- Social Security wage base: Updated annually by SSA
- Medicare wage base: No limit (additional 0.9% over $200k)
- FUTA wage base: $7,000 per year

--- END OF SECTION 6 ---

## 7. UI/UX SPECIFICATIONS

### 7.1 User Interface Requirements
- **Layout:** Dashboard with tax calculation overview and detailed views
- **Navigation:** Tabbed interface for different tax types
- **Responsiveness:** Mobile-optimized for tax management
- **Views:** Payroll view, HR view, Employee view

### 7.2 User Experience Design
- **User Flow:** Select employee → Configure withholding → Calculate taxes → Review → Approve
- **Error Handling:** Clear validation messages and error recovery
- **Loading States:** Progress indicators for complex tax calculations
- **Bulk Actions:** Mass tax calculations for payroll runs

### 7.3 Accessibility Standards
- **WCAG Compliance:** WCAG 2.1 AA
- **Keyboard Navigation:** Full keyboard accessibility
- **Screen Reader Support:** Proper ARIA labels and semantic HTML

### 7.4 Visual Design System
- **Color Scheme:** Professional colors with status indicators
- **Typography:** Clear, readable fonts for financial data
- **Iconography:** Intuitive icons for tax actions and statuses

--- END OF SECTION 7 ---

## 8. INTEGRATION POINTS

### 8.1 External Systems
- **IRS APIs:** Federal tax rate updates and validations
- **State Tax Agencies:** State tax rate feeds and filing
- **Tax Software Providers:** Integration with tax calculation services
- **Financial Institutions:** Direct deposit and tax payment processing
- **Compliance Services:** Tax compliance monitoring and reporting

### 8.2 Internal APIs
- **Payroll Run API:** Gross wage data for tax calculations
- **Employee Management API:** Employee profile and withholding data
- **Salary Structures API:** Compensation data for tax calculations
- **Reporting API:** Tax reporting and analytics
- **Benefits API:** Pre-tax deductions and exemptions

--- END OF SECTION 8 ---

## 9. API SPECIFICATIONS

### 9.1 REST Endpoints

#### **GET /api/tax-calculations/**
- **Purpose:** Retrieve tax calculations list
- **Authentication:** JWT token required
- **Parameters:** 
  - `employee_id` (UUID): Filter by employee
  - `payroll_run_id` (UUID): Filter by payroll run
  - `tax_year` (integer): Filter by tax year
- **Response:** Paginated list of tax calculations

#### **POST /api/tax-calculations/**
- **Purpose:** Calculate taxes for payroll
- **Authentication:** JWT token required
- **Request Body:** Tax calculation parameters
- **Response:** Created tax calculation object

#### **GET /api/tax-calculations/{calculation_id}/**
- **Purpose:** Retrieve specific tax calculation details
- **Authentication:** JWT token required
- **Parameters:** `calculation_id` (UUID)
- **Response:** Complete tax calculation with breakdown

#### **PUT /api/tax-calculations/{calculation_id}/**
- **Purpose:** Update tax calculation
- **Authentication:** JWT token with appropriate permissions
- **Request Body:** Updated tax calculation data
- **Response:** Updated tax calculation object

#### **POST /api/tax-calculations/batch/**
- **Purpose:** Calculate taxes for multiple employees
- **Authentication:** JWT token required
- **Request Body:** Batch calculation parameters
- **Response:** List of tax calculation results

#### **GET /api/tax-withholding/{employee_id}/**
- **Purpose:** Retrieve employee tax withholding preferences
- **Authentication:** JWT token required
- **Parameters:** `employee_id` (UUID)
- **Response:** Employee tax withholding configuration

#### **PUT /api/tax-withholding/{employee_id}/**
- **Purpose:** Update employee tax withholding preferences
- **Authentication:** JWT token required
- **Request Body:** Updated withholding preferences
- **Response:** Updated withholding configuration

#### **GET /api/tax-jurisdictions/**
- **Purpose:** Retrieve tax jurisdictions
- **Authentication:** JWT token required
- **Parameters**: 
  - `jurisdiction_type` (string): Filter by type
  - `state_code` (string): Filter by state
- **Response:** List of tax jurisdictions

### 9.2 Data Formats
- **Request Format:** JSON
- **Response Format:** JSON
- **Error Format:** Standardized error response with validation details

--- END OF SECTION 9 ---

## 10. SECURITY REQUIREMENTS

### 10.1 Authentication
- **Method:** JWT-based authentication with role-based access
- **Authorization:** Tax access based on user role and permissions
- **Session Management:** Secure session handling with timeout

### 10.2 Data Protection
- **Encryption:** Encrypted storage for sensitive tax data
- **Privacy Controls:** Tax information confidentiality and access restrictions
- **Data Masking:** SSN and financial data masking for unauthorized viewers

### 10.3 Access Control
- **Permissions:**
  - **Payroll Admin:** Full access to all tax calculations and configurations
  - **HR Admin:** Access to employee withholding preferences
  - **Employee:** Access to own tax withholding information only
  - **Finance:** Read-only access to tax liability reports
- **Audit Trail:** Complete audit logging for all tax changes

--- END OF SECTION 10 ---

## 11. PERFORMANCE CONSIDERATIONS

### 11.1 Database Optimization
- **Indexing Strategy:** Optimized indexes on employee IDs and calculation dates
- **Query Optimization:** Efficient tax data retrieval with proper joins
- **Connection Pooling:** Database connection management for high-volume calculations

### 11.2 Caching Strategy
- **Cache Layers:** Redis for frequently accessed tax rates and jurisdictions
- **Cache Invalidation:** Smart cache invalidation on tax rate updates
- **Performance Metrics:** Sub-200ms response time for tax calculations

--- END OF SECTION 11 ---

## 12. TESTING REQUIREMENTS

### 12.1 Unit Tests
- **Coverage Target:** 90%
- **Test Framework:** pytest with Django test extensions
- **Test Data:** Factory Boy for comprehensive test data generation

### 12.2 Integration Tests
- **API Testing:** Complete API endpoint testing
- **Tax Calculation Testing:** Accuracy validation against IRS formulas
- **External System Testing:** Integration with tax agency APIs

### 12.3 User Acceptance Tests
- **UAT Scenarios:** Complete tax calculation workflows
- **Cross-browser Testing:** Compatibility across major browsers
- **Mobile Testing:** Responsive design validation

--- END OF SECTION 12 ---

## 13. DEPLOYMENT SPECIFICATIONS

### 13.1 Environment Requirements
- **Development:** Local development with mock tax rates
- **Staging:** Full integration testing with tax agency APIs
- **Production:** Scalable cloud infrastructure with secure integrations

### 13.2 Configuration Management
- **Settings:** Environment-specific configuration
- **API Keys:** Secure management of tax agency API credentials
- **Security Settings:** Production security hardening

--- END OF SECTION 13 ---

## 14. MAINTENANCE & SUPPORT

### 14.1 Regular Maintenance
- **Tax Rate Updates:** Regular updates for federal, state, and local tax rates
- **Compliance Monitoring:** Ongoing tax compliance monitoring and updates
- **Performance Monitoring:** Tax calculation performance tracking

### 14.2 Support Procedures
- **User Support:** Help desk integration for tax calculation issues
- **Documentation:** Comprehensive user guides and API documentation
- **Training:** Regular training sessions for payroll and HR staff

--- END OF SECTION 14 ---

## 15. VERSION CONTROL

### 15.1 Version History
- **v1.0.0:** Initial release with basic tax calculations
- **v1.1.0:** Enhanced multi-state tax support
- **v1.2.0:** Advanced compliance reporting and analytics

### 15.2 Change Management
- **Release Process:** Structured release with rollback capability
- **Migration Scripts:** Database migration handling
- **Feature Flags:** Gradual feature rollout capability

--- END OF SECTION 15 ---

## 16. COMPLIANCE & AUDIT

### 16.1 Regulatory Compliance
- **IRS Compliance:** Federal tax withholding and reporting requirements
- **State Compliance:** State-specific tax regulations and requirements
- **Local Compliance:** Local tax jurisdiction compliance
- **Data Retention:** Tax record retention requirements (typically 4-7 years)

### 16.2 Audit Requirements
- **Audit Trail:** Complete change history logging for all tax calculations
- **Tax Reporting:** Automated generation of tax forms and reports
- **Access Logging:** Comprehensive access audit logging
- **Compliance Reports:** Automated compliance reporting and validation

--- END OF SECTION 16 ---

**END OF BBP TEMPLATE**
