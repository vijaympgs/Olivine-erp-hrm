# CRM Opportunity Pipeline - Business Blueprint

## **1. MODULE IDENTIFICATION**

**Module Name:** Opportunity Pipeline
**Module Number:** 3.2
**Module Type:** Transaction
**Complexity:** Medium (TXN-M)
**Template Type:** Complete (16 sections)
**Target File:** CRM/03.Account & Opportunity Management/3.2Opportunity Pipeline (Transaction).md
**Created Date:** December 31, 2025
**Version:** 1.0
**Author:** CRM System

--- END OF SECTION 1 ---

## **2. PURPOSE**

### **2.1 Business Purpose**
The Opportunity Pipeline module serves as the central transaction engine for managing sales opportunities throughout their entire lifecycle from initial qualification to closed-won or closed-lost status. It provides comprehensive opportunity tracking, stage progression management, revenue forecasting, and sales workflow automation. The module enables sales teams to systematically manage deal progression, track sales activities, monitor pipeline health, and make data-driven decisions for revenue optimization and sales performance improvement.

### **2.2 Business Scope**

**In Scope:**
- Complete opportunity lifecycle management from creation to closure with automated stage progression
- Sales stage workflow management with customizable stage definitions and transition rules
- Revenue forecasting and pipeline analytics with probability-based calculations
- Opportunity scoring and qualification with automated lead-to-opportunity conversion
- Sales activity tracking and task management linked to opportunity progression
- Competitive analysis and win/loss tracking with detailed reason codes
- Product and service catalog integration with pricing and quote generation
- Approval workflows for discounts, exceptions, and high-value opportunities
- Sales team collaboration with opportunity assignment and performance tracking
- Integration with account management, contact management, and activity tracking modules
- Mobile-optimized opportunity management for field sales representatives

**Out of Scope:**
- Account and contact data management (handled by Account Management and Contact Directory modules)
- Quote generation and pricing management (handled by Sales & Quote Management modules)
- Marketing campaign management and lead generation (handled by Marketing & Campaign modules)
- Advanced financial accounting and billing (handled by external ERP systems)
- Customer service and support case management (handled by Customer Service & Support modules)
- Comprehensive reporting and analytics dashboards (handled by Reports & Administration modules)

### **2.3 Key Stakeholders**
- **Sales Representatives:** Primary users for creating, managing, and progressing opportunities through the sales pipeline
- **Sales Managers:** Monitor pipeline health, team performance, and provide coaching on opportunity management
- **Sales Directors:** Oversee regional pipeline performance, revenue forecasting, and strategic sales planning
- **Sales Operations:** Manage pipeline configuration, approval workflows, and sales process optimization
- **Finance Teams:** Review revenue forecasts, deal economics, and financial impact of opportunities
- **Marketing Teams:** Analyze lead-to-opportunity conversion rates and campaign effectiveness
- **Executives:** Review overall pipeline health, revenue projections, and sales performance metrics

--- END OF SECTION 2 ---

## **3. CORE MODELS (DJANGO)**

### **3.1 Primary Model: Opportunity**

```python
class Opportunity(models.Model):
    """
    Primary model representing sales opportunities and their comprehensive information
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    account_id = models.UUIDField()
    primary_contact_id = models.UUIDField(null=True, blank=True)
    opportunity_owner_id = models.UUIDField()
    created_by_user_id = models.UUIDField()
    updated_by_user_id = models.UUIDField(null=True, blank=True)
    
    # Basic Opportunity Information
    opportunity_name = models.CharField(max_length=200)
    opportunity_number = models.CharField(max_length=50, unique=True)
    description = models.TextField(null=True, blank=True)
    
    # Sales Stage and Status
    sales_stage_id = models.UUIDField()
    probability = models.IntegerField(default=0)  # 0-100 percentage
    opportunity_status = models.CharField(max_length=20, choices=OPPORTUNITY_STATUS_CHOICES, default='open')
    
    # Financial Information
    amount = models.DecimalField(max_digits=15, decimal_places=2)
    currency = models.CharField(max_length=3, default='USD')
    expected_close_date = models.DateField()
    actual_close_date = models.DateField(null=True, blank=True)
    
    # Lead Source and Campaign
    lead_source = models.CharField(max_length=50, choices=LEAD_SOURCE_CHOICES, null=True, blank=True)
    campaign_id = models.UUIDField(null=True, blank=True)
    
    # Competitive Information
    competitor_analysis = models.JSONField(default=list, null=True, blank=True)
    primary_competitor = models.CharField(max_length=200, null=True, blank=True)
    competitive_position = models.CharField(max_length=50, choices=COMPETITIVE_POSITION_CHOICES, null=True, blank=True)
    
    # Product and Service Information
    products = models.JSONField(default=list)
    services = models.JSONField(default=list)
    
    # Decision Making Process
    decision_timeline = models.JSONField(default=null, blank=True)
    key_stakeholders = models.JSONField(default=list)
    buying_process = models.TextField(null=True, blank=True)
    
    # Next Steps and Activities
    next_steps = models.TextField(null=True, blank=True)
    last_activity_date = models.DateTimeField(null=True, blank=True)
    next_activity_date = models.DateTimeField(null=True, blank=True)
    
    # Scoring and Qualification
    opportunity_score = models.IntegerField(default=0)
    qualification_score = models.IntegerField(default=0)
    fit_score = models.IntegerField(default=0)
    
    # Approval and Exception Management
    requires_approval = models.BooleanField(default=False)
    approval_status = models.CharField(max_length=20, choices=APPROVAL_STATUS_CHOICES, null=True, blank=True)
    discount_approval = models.JSONField(default=null, blank=True)
    
    # Win/Loss Information
    win_loss_reason = models.CharField(max_length=100, null=True, blank=True)
    win_loss_details = models.TextField(null=True, blank=True)
    competitor_won = models.CharField(max_length=200, null=True, blank=True)
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    is_deleted = models.BooleanField(default=False)
    deleted_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        db_table = 'crm_opportunities'
        verbose_name = 'Opportunity'
        verbose_name_plural = 'Opportunities'
        indexes = [
            models.Index(fields=['company_id', 'opportunity_status'], name='idx_company_status'),
            models.Index(fields=['opportunity_owner_id', 'sales_stage_id'], name='idx_owner_stage'),
            models.Index(fields=['account_id', 'opportunity_status'], name='idx_account_status'),
            models.Index(fields=['expected_close_date'], name='idx_close_date'),
            models.Index(fields=['amount'], name='idx_amount'),
            models.Index(fields=['probability'], name='idx_probability'),
            models.Index(fields=['created_at'], name='idx_created_date'),
        ]
        constraints = [
            models.UniqueConstraint(fields=['company_id', 'opportunity_number'], name='uk_company_opportunity_number'),
        ]
```

### **3.2 Supporting Model: OpportunityStage**

```python
class OpportunityStage(models.Model):
    """
    Model defining sales stages and their configuration for opportunity progression
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Stage Information
    stage_name = models.CharField(max_length=100)
    stage_code = models.CharField(max_length=20, unique=True)
    description = models.TextField(null=True, blank=True)
    
    # Stage Configuration
    stage_order = models.IntegerField()
    default_probability = models.IntegerField(default=0)
    is_active = models.BooleanField(default=True)
    is_closed_won = models.BooleanField(default=False)
    is_closed_lost = models.BooleanField(default=False)
    
    # Stage Rules
    required_fields = models.JSONField(default=list)
    validation_rules = models.JSONField(default=list)
    transition_rules = models.JSONField(default=list)
    
    # Time and Duration
    average_duration_days = models.IntegerField(null=True, blank=True)
    max_duration_days = models.IntegerField(null=True, blank=True)
    
    # Metadata
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'crm_opportunity_stages'
        verbose_name = 'Opportunity Stage'
        verbose_name_plural = 'Opportunity Stages'
        indexes = [
            models.Index(fields=['stage_code'], name='idx_stage_code'),
            models.Index(fields=['stage_order'], name='idx_stage_order'),
        ]
```

### **3.3 Supporting Model: OpportunityActivity**

```python
class OpportunityActivity(models.Model):
    """
    Model tracking activities and interactions associated with opportunities
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Foreign Keys
    company_id = models.UUIDField()
    opportunity_id = models.UUIDField()
    user_id = models.UUIDField()
    contact_id = models.UUIDField(null=True, blank=True)
    
    # Activity Information
    activity_type = models.CharField(max_length=50, choices=ACTIVITY_TYPE_CHOICES)
    activity_subject = models.CharField(max_length=200)
    activity_description = models.TextField(null=True, blank=True)
    
    # Activity Details
    activity_date = models.DateTimeField()
    duration_minutes = models.IntegerField(null=True, blank=True)
    location = models.CharField(max_length=200, null=True, blank=True)
    
    # Activity Outcome
    outcome = models.CharField(max_length=100, null=True, blank=True)
    next_steps = models.TextField(null=True, blank=True)
    
    # Activity Status
    status = models.CharField(max_length=20, choices=ACTIVITY_STATUS_CHOICES, default='completed')
    
    # Audit Fields
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'crm_opportunity_activities'
        verbose_name = 'Opportunity Activity'
        verbose_name_plural = 'Opportunity Activities'
        indexes = [
            models.Index(fields=['company_id', 'opportunity_id'], name='idx_company_opportunity'),
            models.Index(fields=['user_id', 'activity_date'], name='idx_user_date'),
            models.Index(fields=['activity_type', 'status'], name='idx_type_status'),
        ]
```

--- END OF SECTION 3 ---

## **4. REFERENCE MODELS (DJANGO)**

### **4.1 LeadSource**

```python
class LeadSource(models.Model):
    """
    Reference model for lead source tracking and campaign attribution
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Source Information
    source_name = models.CharField(max_length=100)
    source_code = models.CharField(max_length=20, unique=True)
    description = models.TextField(null=True, blank=True)
    
    # Source Classification
    source_type = models.CharField(max_length=50, choices=SOURCE_TYPE_CHOICES)
    source_category = models.CharField(max_length=50, choices=SOURCE_CATEGORY_CHOICES)
    
    # Status and Configuration
    is_active = models.BooleanField(default=True)
    is_paid = models.BooleanField(default=False)
    cost_per_lead = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    
    # Metadata
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'crm_lead_sources'
        verbose_name = 'Lead Source'
        verbose_name_plural = 'Lead Sources'
        indexes = [
            models.Index(fields=['source_code'], name='idx_source_code'),
            models.Index(fields=['source_type'], name='idx_source_type'),
        ]
```

### **4.2 OpportunityType**

```python
class OpportunityType(models.Model):
    """
    Reference model for opportunity type classification and categorization
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Type Information
    type_name = models.CharField(max_length=100)
    type_code = models.CharField(max_length=20, unique=True)
    description = models.TextField(null=True, blank=True)
    
    # Type Configuration
    default_sales_stage_id = models.UUIDField(null=True, blank=True)
    default_probability = models.IntegerField(default=0)
    requires_approval = models.BooleanField(default=False)
    
    # Status
    is_active = models.BooleanField(default=True)
    sort_order = models.IntegerField(default=0)
    
    # Metadata
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'crm_opportunity_types'
        verbose_name = 'Opportunity Type'
        verbose_name_plural = 'Opportunity Types'
        indexes = [
            models.Index(fields=['type_code'], name='idx_type_code'),
        ]
```

### **4.3 WinLossReason**

```python
class WinLossReason(models.Model):
    """
    Reference model for win/loss reason categorization and analysis
    """
    
    # Primary Key
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Reason Information
    reason_name = models.CharField(max_length=100)
    reason_code = models.CharField(max_length=20, unique=True)
    description = models.TextField(null=True, blank=True)
    
    # Reason Classification
    reason_type = models.CharField(max_length=20, choices=REASON_TYPE_CHOICES)  # win/loss
    reason_category = models.CharField(max_length=50, choices=REASON_CATEGORY_CHOICES)
    
    # Status and Configuration
    is_active = models.BooleanField(default=True)
    sort_order = models.IntegerField(default=0)
    
    # Metadata
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'crm_win_loss_reasons'
        verbose_name = 'Win/Loss Reason'
        verbose_name_plural = 'Win/Loss Reasons'
        indexes = [
            models.Index(fields=['reason_code'], name='idx_reason_code'),
            models.Index(fields=['reason_type'], name='idx_reason_type'),
        ]
```

--- END OF SECTION 4 ---

## **5. FOREIGN KEY RELATIONSHIPS**

### **5.1 Primary Relationships**

- **Opportunity** → **Account (account_id):** Many-to-One relationship linking opportunities to customer accounts for revenue attribution and account-based selling.
- **Opportunity** → **User (opportunity_owner_id):** Many-to-One relationship linking opportunities to primary sales owners responsible for deal progression and revenue generation.
- **Opportunity** → **User (created_by_user_id):** Many-to-One relationship tracking which user created the opportunity for audit and accountability purposes.
- **Opportunity** → **User (updated_by_user_id):** Many-to-One relationship tracking the last user who modified the opportunity record.
- **Opportunity** → **Contact (primary_contact_id):** Many-to-One relationship linking opportunities to primary contact persons for communication and decision-making.
- **Opportunity** → **OpportunityStage (sales_stage_id):** Many-to-One relationship linking opportunities to their current sales stage for pipeline progression tracking.

- **OpportunityActivity** → **Opportunity (opportunity_id):** Many-to-One relationship linking activities to specific opportunities for comprehensive interaction tracking.
- **OpportunityActivity** → **User (user_id):** Many-to-One relationship linking activities to users who performed them for performance tracking.
- **OpportunityActivity** → **Contact (contact_id):** Many-to-One relationship linking activities to contacts for communication history.

### **5.2 Many-to-Many Relationships**

- **Opportunity** ↔ **Product:** Many-to-Many relationship through opportunity_product associations for tracking products and services in each opportunity.
- **Opportunity** ↔ **Campaign:** Many-to-Many relationship through opportunity_campaign associations for marketing attribution and campaign effectiveness.
- **Opportunity** ↔ **Competitor:** Many-to-Many relationship through opportunity_competitor associations for competitive analysis and win/loss tracking.

### **5.3 Relationship Integrity Rules**

- **Cascade Delete:** When an opportunity is deleted, all associated activities are soft-deleted but history is preserved for audit purposes.
- **Protect Delete:** Account and user records referenced in opportunities are protected from deletion to maintain data integrity.
- **Restrict Delete:** Sales stage records referenced in active opportunities are restricted from deletion to maintain pipeline consistency.
- **Set Null:** Contact references are set to null when contacts are deleted while preserving the opportunity record.

### **5.4 Pipeline Progression Constraints**

- **Stage Transition Validation:** Opportunities can only progress to valid next stages based on defined transition rules and stage order.
- **Probability Consistency:** Opportunity probabilities must align with stage default probabilities unless manually overridden with proper authorization.
- **Closure Validation:** Opportunities can only be marked as closed-won or closed-lost when all required fields are completed and approvals are obtained.
- **Date Validation:** Expected close dates must be in the future and actual close dates must align with opportunity status changes.

--- END OF SECTION 5 ---

## **6. BUSINESS RULES & VALIDATIONS**

### **6.1 Data Integrity Rules**

- **Unique Opportunity Number:** Each opportunity must have a unique opportunity number within the company to prevent duplicates and ensure proper identification.
- **Required Fields:** Opportunity name, account, opportunity owner, sales stage, amount, and expected close date are mandatory fields.
- **Valid Probability Range:** Probability must be between 0 and 100 and align with stage default probabilities unless manually overridden.
- **Currency Validation:** Currency codes must be valid ISO 4217 currency codes for proper financial calculations.
- **Date Validation:** Expected close date must be in the future; actual close date must be provided when opportunity is closed.

### **6.2 Validation Logic**

```python
def clean_opportunity_number(self):
    """
    Validate opportunity number format and uniqueness
    """
    if not self.opportunity_number:
        raise ValidationError("Opportunity number is required")
    
    # Check for valid format (alphanumeric with optional hyphens)
    if not re.match(r'^[A-Za-z0-9\-]+$', self.opportunity_number):
        raise ValidationError("Opportunity number can only contain letters, numbers, and hyphens")
    
    # Check uniqueness within company
    if Opportunity.objects.filter(
        company_id=self.company_id,
        opportunity_number=self.opportunity_number,
        is_deleted=False
    ).exclude(id=self.id).exists():
        raise ValidationError("Opportunity number must be unique within the company")

def clean_amount(self):
    """
    Validate opportunity amount is positive and within reasonable bounds
    """
    if self.amount is not None:
        if self.amount <= 0:
            raise ValidationError("Opportunity amount must be greater than zero")
        if self.amount > 999999999999.99:  # 1 trillion
            raise ValidationError("Opportunity amount exceeds maximum allowed value")

def clean_expected_close_date(self):
    """
    Validate expected close date is in the future
    """
    if self.expected_close_date:
        if self.expected_close_date < timezone.now().date():
            raise ValidationError("Expected close date cannot be in the past")
        
        # Check if expected close date is too far in future
        max_future_date = timezone.now().date() + timedelta(days=730)  # 2 years
        if self.expected_close_date > max_future_date:
            raise ValidationError("Expected close date cannot be more than 2 years in the future")

def clean_probability(self):
    """
    Validate probability range and stage alignment
    """
    if self.probability is not None:
        if not (0 <= self.probability <= 100):
            raise ValidationError("Probability must be between 0 and 100")
        
        # Check alignment with stage default probability
        if self.sales_stage_id:
            try:
                stage = OpportunityStage.objects.get(id=self.sales_stage_id)
                if self.probability < stage.default_probability and not self.problicity_override_approved:
                    raise ValidationError("Probability cannot be lower than stage default without approval")
            except OpportunityStage.DoesNotExist:
                pass

def clean_stage_transition(self):
    """
    Validate stage transition rules and requirements
    """
    if self.sales_stage_id:
        # Check if transition is allowed based on current stage
        if self.pk:  # Only for existing opportunities
            old_opportunity = Opportunity.objects.get(pk=self.pk)
            if old_opportunity.sales_stage_id != self.sales_stage_id:
                # Validate transition rules
                if not self.is_valid_stage_transition(old_opportunity.sales_stage_id, self.sales_stage_id):
                    raise ValidationError("Invalid stage transition")
                
                # Check required fields for new stage
                required_fields = self.get_required_fields_for_stage(self.sales_stage_id)
                for field in required_fields:
                    if not getattr(self, field, None):
                        raise ValidationError(f"{field.replace('_', ' ').title()} is required for this stage")
```

### **6.3 Business Constraints**

- **Opportunity Ownership Limits:** Users can own maximum 100 active opportunities to ensure effective pipeline management.
- **Stage Duration Limits:** Opportunities cannot remain in the same stage beyond maximum duration days without manager approval.
- **Amount Thresholds:** Opportunities above certain amounts require additional approval levels and documentation.
- **Probability Overrides:** Manual probability overrides require manager approval and justification documentation.
- **Closure Requirements:** Opportunities can only be closed when all required activities are completed and documentation is provided.

### **6.4 Automated Business Rules**

- **Stage Progression:** Automatic stage progression based on activity completion and predefined criteria.
- **Probability Updates:** Automatic probability adjustments based on stage changes and activity patterns.
- **Opportunity Scoring:** Real-time opportunity scoring based on engagement, activity frequency, and deal characteristics.
- **Pipeline Health Monitoring:** Automated identification of stalled opportunities and pipeline health indicators.
- **Forecast Updates:** Automatic revenue forecast updates based on pipeline changes and probability adjustments.
- **Activity Reminders:** Automated reminders for required activities and follow-up tasks based on stage requirements.

--- END OF SECTION 6 ---

## **7. UI/UX SPECIFICATIONS**

### **7.1 User Interface Requirements**

- **Layout:** Responsive pipeline dashboard with kanban-style board view, list view, and detailed opportunity cards. Three-panel design: pipeline stages (left), opportunity details (center), and activity timeline (right).
- **Navigation:** Tab-based navigation for pipeline views, opportunity management, analytics, and configuration. Quick action toolbar for common opportunity operations.
- **Responsiveness:** Mobile-optimized interface for field sales representatives with touch-optimized interactions and offline capability.

### **7.2 User Experience Design**

- **User Flow:** Login → Pipeline Dashboard → Create/Select Opportunity → Manage Details → Track Progress → Close Deal. Streamlined workflow for efficient opportunity management.
- **Pipeline Visualization:** Interactive kanban board with drag-and-drop stage progression, visual indicators for opportunity health, and real-time updates.
- **Bulk Operations:** Efficient bulk update capabilities for stage changes, owner assignments, and status updates with progress tracking.
- **Real-time Updates:** Live collaboration indicators for opportunity changes and real-time synchronization of pipeline data.

### **7.3 Accessibility Standards**

- **WCAG Compliance:** WCAG 2.1 AA level compliance with keyboard navigation for all opportunity operations and screen reader support for pipeline information.
- **Keyboard Navigation:** Full keyboard accessibility for opportunity creation, editing, stage progression, and activity management with logical tab order.
- **Screen Reader Support:** Comprehensive ARIA labels for opportunity status indicators, stage information, and pipeline analytics.

### **7.4 Visual Design System**

- **Color Scheme:** 
  - Primary Colors: Professional blue palette (#0078d4, #106ebe, #005a9e) for primary actions and navigation
  - Success Colors: Green palette (#28a745, #20c997, #198754) for won opportunities and successful actions
  - Warning Colors: Amber palette (#ffc107, #fd7e14, #ff9800) for at-risk opportunities and warnings
  - Error Colors: Red palette (#dc3545, #c82333, #bd2130) for lost opportunities and validation errors
  - Stage Colors: Progressive color gradient from blue (early stages) to green (closed won) and red (closed lost)

- **Typography:** 
  - Primary Font: Inter, system-ui, -apple-system, sans-serif
  - Font Sizes: 12px-48px with responsive scaling
  - Font Weights: 300 (Light), 400 (Regular), 600 (Semibold), 700 (Bold)
  - Line Heights: 1.2-1.6 for optimal readability

- **Iconography:** Fluent UI icon set with consistent 24px size for opportunity actions and status indicators.

### **7.5 Component Standards**

- **Opportunity Cards:** Rich cards displaying opportunity summary, key metrics, stage indicators, and quick action buttons with progress tracking.
- **Pipeline Board:** Interactive kanban board with drag-and-drop functionality, stage columns, and opportunity cards with visual indicators.
- **Stage Management Panel:** Comprehensive stage configuration interface with transition rules and validation requirements.
- **Activity Timeline:** Chronological activity display with interaction tracking and outcome recording.

--- END OF SECTION 7 ---

## **8. INTEGRATION POINTS**

### **8.1 External Systems**

- **ERP Systems:** SAP, Oracle, NetSuite integration for financial data synchronization, billing information, and revenue recognition.
- **Marketing Automation:** Marketo, HubSpot, Pardot integration for lead source tracking, campaign attribution, and lead-to-opportunity conversion.
- **Communication Platforms:** Salesforce, Microsoft Dynamics 365 integration for email synchronization, calendar integration, and activity tracking.
- **Product Catalog:** Integration with product management systems for pricing, inventory, and product information synchronization.
- **Competitive Intelligence:** Integration with competitive analysis tools for market intelligence and competitor tracking.

### **8.2 Internal APIs**

- **Account Management Module:** API endpoints for account data synchronization, account-opportunity associations, and account health metrics.
- **Contact Directory Module:** API endpoints for contact data, primary contact management, and contact-opportunity relationships.
- **Activity Timeline Module:** API endpoints for activity logging, communication tracking, and opportunity engagement metrics.
- **Sales & Quote Management Module:** API endpoints for quote generation, pricing information, and product catalog integration.
- **User Management Module:** API endpoints for user profile data, permission management, and opportunity assignment validation.
- **Notification System:** Real-time notification delivery for opportunity updates, stage changes, and important pipeline events.

--- END OF SECTION 8 ---

## **9. API SPECIFICATIONS**

### **9.1 REST Endpoints**

#### **GET /api/opportunities/**
- **Purpose:** Retrieve paginated list of opportunities with filtering and search capabilities
- **Authentication:** JWT token required with company_id validation
- **Parameters:** page, page_size, status, sales_stage, opportunity_owner_id, account_id, date_range, amount_range
- **Response:** Paginated opportunity list with total count and filtering metadata

#### **POST /api/opportunities/**
- **Purpose:** Create new opportunity with validation and automatic scoring
- **Authentication:** JWT token with create_opportunity permission
- **Request Body:** Opportunity data with required fields validation
- **Response:** Created opportunity object with validation warnings and calculated scores

#### **GET /api/opportunities/{id}/**
- **Purpose:** Retrieve detailed opportunity information including activities and relationships
- **Authentication:** JWT token with read_opportunity permission
- **Parameters:** opportunity_id (UUID), include_activities, include_products
- **Response:** Complete opportunity object with related data and associations

#### **PUT /api/opportunities/{id}/**
- **Purpose:** Update existing opportunity information with change tracking
- **Authentication:** JWT token with update_opportunity permission
- **Request Body:** Updated opportunity fields with validation
- **Response:** Updated opportunity object with change summary

#### **DELETE /api/opportunities/{id}/**
- **Purpose:** Soft delete opportunity with audit trail preservation
- **Authentication:** JWT token with delete_opportunity permission
- **Parameters:** opportunity_id (UUID), reason (optional)
- **Response:** Deletion confirmation with archived data information

#### **POST /api/opportunities/{id}/stage-transition/**
- **Purpose:** Transition opportunity to new sales stage with validation
- **Authentication:** JWT token with manage_opportunity permission
- **Request Body:** Stage transition data with validation and approval requirements
- **Response:** Updated opportunity with new stage and transition details

#### **GET /api/opportunities/{id}/activities/**
- **Purpose:** Retrieve opportunity activities with filtering and pagination
- **Authentication:** JWT token with read_activities permission
- **Parameters:** opportunity_id (UUID), activity_type, date_range, status
- **Response:** Paginated activity list with filtering metadata

#### **POST /api/opportunities/{id}/activities/**
- **Purpose:** Log activity against opportunity with outcome tracking
- **Authentication:** JWT token with create_activity permission
- **Request Body:** Activity data with type, description, and outcome
- **Response:** Created activity object with validation results

#### **GET /api/sales-stages/**
- **Purpose:** Retrieve list of sales stages with configuration details
- **Authentication:** JWT token with read_reference_data permission
- **Parameters:** is_active, include_transitions
- **Response:** Sales stage list with configuration and transition rules

#### **GET /api/pipeline/forecast/**
- **Purpose:** Generate revenue forecast based on pipeline data and probabilities
- **Authentication:** JWT token with forecast_permission
- **Parameters:** date_range, opportunity_owner_id, sales_stage
- **Response:** Forecast data with confidence intervals and trend analysis

#### **GET /api/pipeline/health/**
- **Purpose:** Analyze pipeline health and identify at-risk opportunities
- **Authentication:** JWT token with pipeline_analytics permission
- **Parameters:** date_range, include_recommendations
- **Response:** Pipeline health metrics with risk indicators and recommendations

### **9.2 Data Formats**

- **Request Format:** JSON for all endpoints except file uploads (multipart/form-data)
- **Response Format:** JSON with consistent error structure and pagination metadata
- **Error Format:** Standardized error response with error_code, message, and details fields
- **Date Format:** ISO 8601 (YYYY-MM-DDTHH:mm:ssZ) for all datetime fields
- **File Format:** CSV for bulk imports with UTF-8 encoding and standardized headers

### **9.3 WebSocket Events**

#### **opportunity.created**
- **Purpose:** Real-time notification when new opportunity is created
- **Data:** Opportunity object with assigned owner and initial scoring
- **Channels:** WebSocket connection to authenticated users and managers

#### **opportunity.stage_changed**
- **Purpose:** Real-time notification when opportunity stage changes
- **Data:** Opportunity object with old stage, new stage, and transition details
- **Channels:** WebSocket connection to opportunity owner and team members

#### **opportunity.closed**
- **Purpose:** Real-time notification when opportunity is marked as won or lost
- **Data:** Opportunity object with closure details and win/loss information
- **Channels:** WebSocket connection to relevant users and stakeholders

#### **pipeline.updated**
- **Purpose:** Real-time notification of significant pipeline changes
- **Data:** Pipeline metrics and health indicators
- **Channels:** WebSocket connection to managers and executives

--- END OF SECTION 9 ---

## **10. SECURITY REQUIREMENTS**

### **10.1 Authentication**

- **Method:** JWT-based authentication with refresh token rotation and secure token storage
- **Authorization:** Role-based access control (RBAC) with granular permissions for opportunity operations
- **Session Management:** Configurable session timeout with automatic logout and re-authentication requirements
- **Multi-Factor Authentication:** Optional MFA for high-value opportunity management and sensitive data access

### **10.2 Data Protection**

- **Encryption:** AES-256 encryption for sensitive opportunity data (financial information, competitive analysis) at rest
- **Masking:** Data masking for sensitive fields (competitor information, win/loss details) in non-privileged views
- **Backup:** Encrypted daily backups with 30-day retention and point-in-time recovery capabilities
- **Audit Logging:** Comprehensive audit trail for all opportunity operations with user attribution and timestamp

### **10.3 Access Control**

- **Permissions:** Granular permission matrix for opportunity operations (create, read, update, delete, manage, forecast)
- **Data Segregation:** Company-based data isolation with role-based access to opportunity information
- **Field-Level Security:** Sensitive field protection (financial data, competitive information) based on user roles
- **API Rate Limiting:** Configurable rate limits to prevent abuse and ensure system stability

--- END OF SECTION 10 ---

## **11. PERFORMANCE CONSIDERATIONS**

### **11.1 Database Optimization**

- **Indexing Strategy:** Comprehensive indexing on frequently queried fields (company_id, opportunity_owner_id, sales_stage_id, status)
- **Query Optimization:** Optimized queries for pipeline views, forecasting calculations, and activity tracking
- **Partitioning:** Table partitioning by company_id and creation_date for improved query performance
- **Connection Pooling:** Database connection pooling with configurable pool sizes and timeout settings

### **11.2 Caching Strategy**

- **Redis Caching:** Pipeline data caching with 15-minute TTL for frequently accessed opportunity information
- **Application Caching:** In-memory caching for reference data (sales stages, opportunity types, lead sources)
- **CDN Integration:** Static asset caching through CDN for improved UI performance
- **Cache Invalidation:** Intelligent cache invalidation on opportunity updates and stage changes

### **11.3 Scalability Planning**

- **Horizontal Scaling:** Support for horizontal scaling of application servers behind load balancers
- **Database Scaling:** Read replica configuration for reporting and analytics workloads
- **Async Processing:** Background job processing for opportunity scoring, forecasting calculations, and notifications
- **Resource Monitoring:** Real-time monitoring of system resources and performance metrics

--- END OF SECTION 11 ---

## **12. TESTING REQUIREMENTS**

### **12.1 Unit Tests**

- **Model Validation Tests:** Opportunity model validation, field constraints, and business rule enforcement
- **Business Logic Tests:** Opportunity scoring algorithms, stage transition validation, and probability calculations
- **Service Layer Tests:** Opportunity creation, updates, stage progression, and activity logging
- **API Endpoint Tests:** CRUD operations, filtering, pagination, and error handling
- **Integration Tests:** Database operations, caching mechanisms, and external API integrations

### **12.2 Integration Tests**

- **Pipeline Workflow Tests:** End-to-end opportunity lifecycle from creation to closure
- **Stage Transition Tests:** Automated stage progression and validation rule enforcement
- **Activity Tracking Tests:** Activity logging, outcome recording, and timeline updates
- **Forecast Calculation Tests:** Revenue forecasting accuracy and probability-based calculations
- **Notification Tests:** Real-time notifications, email alerts, and WebSocket event delivery

### **12.3 Performance Tests**

- **Load Testing:** Pipeline dashboard performance under concurrent user load (target: 1000 concurrent users)
- **Stress Testing:** System behavior under peak load scenarios (target: 5000 concurrent users)
- **Database Performance:** Query optimization and indexing effectiveness validation
- **API Performance:** Response time benchmarks for all endpoints (target: <200ms for 95% of requests)

### **12.4 User Acceptance Testing**

- **Sales Representative Workflow:** Opportunity creation, management, and stage progression
- **Sales Manager Dashboard:** Pipeline monitoring, team performance tracking, and forecasting
- **Mobile Responsiveness:** Field sales representative mobile experience and offline functionality
- **Bulk Operations:** Mass updates, stage changes, and data import/export functionality

--- END OF SECTION 12 ---

## **13. DEPLOYMENT SPECIFICATIONS**

### **13.1 Environment Requirements**

- **Development Environment:** Docker containerized development with PostgreSQL 14+, Redis 6+, and Python 3.11+
- **Testing Environment:** Automated testing infrastructure with parallel test execution and coverage reporting
- **Staging Environment:** Production-like environment for UAT and performance testing with full data set
- **Production Environment:** High-availability deployment with load balancers, auto-scaling, and disaster recovery

### **13.2 Infrastructure Requirements**

- **Application Servers:** Minimum 4 application servers with 8GB RAM each behind load balancer
- **Database Servers:** PostgreSQL 14+ with read replicas, connection pooling, and automated failover
- **Cache Servers:** Redis cluster with persistence and automatic failover for session and data caching
- **File Storage:** AWS S3 or equivalent for file uploads and static asset storage with CDN integration

### **13.3 Monitoring and Logging**

- **Application Monitoring:** Real-time performance monitoring with APM tools (New Relic, DataDog)
- **Error Tracking:** Comprehensive error logging and alerting with stack trace capture
- **Business Metrics:** Custom dashboards for pipeline health, conversion rates, and revenue forecasting
- **System Health:** Infrastructure monitoring with automated alerts for system failures

--- END OF SECTION 13 ---

## **14. MAINTENANCE & SUPPORT**

### **14.1 Regular Maintenance**

- **Daily Tasks:** Automated data backups, system health checks, and performance monitoring
- **Weekly Tasks:** Database optimization, cache cleanup, and security patch updates
- **Monthly Tasks:** Performance analysis, user feedback review, and system capacity planning
- **Quarterly Tasks:** Comprehensive system audits, disaster recovery testing, and feature updates

### **14.2 Support Procedures**

- **Issue Triage:** Automated ticket routing based on severity and impact on pipeline operations
- **Escalation Matrix:** Defined escalation paths for critical pipeline issues and system outages
- **Response Times:** SLA-based response times (Critical: 1 hour, High: 4 hours, Medium: 24 hours, Low: 72 hours)
- **Knowledge Base:** Comprehensive documentation for common issues and troubleshooting procedures

### **14.3 System Updates**

- **Patch Management:** Scheduled maintenance windows for security patches and bug fixes
- **Feature Releases:** Quarterly feature releases with backward compatibility and migration support
- **Data Migration:** Automated data migration tools for schema changes and data format updates
- **Rollback Procedures:** Automated rollback capabilities for failed deployments and system issues

--- END OF SECTION 14 ---

## **15. VERSION CONTROL**

### **15.1 Version History**

- **Version 1.0 (December 31, 2025):** Initial release with complete opportunity pipeline functionality
  - Core opportunity management with stage progression
  - Activity tracking and timeline management
  - Revenue forecasting and pipeline analytics
  - Integration with account and contact management
  - Mobile-responsive interface and real-time updates

### **15.2 Change Management**

- **Feature Requests:** Formal process for submitting and evaluating new feature requests
- **Bug Fixes:** Priority-based bug fixing with automated testing and validation
- **Security Updates:** Immediate patching for security vulnerabilities with coordinated disclosure
- **Performance Improvements:** Continuous optimization based on usage metrics and feedback

### **15.3 Release Process**

- **Development Branch:** Feature development in isolated branches with code review requirements
- **Testing Branch:** Integration testing and quality assurance in dedicated testing environment
- **Staging Branch:** User acceptance testing and performance validation in production-like environment
- **Production Release:** Coordinated releases with rollback capabilities and post-deployment monitoring

--- END OF SECTION 15 ---

## **16. COMPLIANCE & AUDIT**

### **16.1 Regulatory Compliance**

- **GDPR Compliance:** Full compliance with EU General Data Protection Regulation for personal data processing and consent management
- **CCPA Compliance:** California Consumer Privacy Act compliance for California residents' data rights and privacy
- **SOX Compliance:** Sarbanes-Oxley Act compliance for financial data integrity and internal controls
- **Data Residency:** Configurable data residency options for regional compliance requirements

### **16.2 Audit Requirements**

- **Audit Trail:** Comprehensive audit logging for all opportunity operations with immutable records
- **Data Retention:** Configurable data retention policies compliant with legal and regulatory requirements
- **Access Audits:** Regular access audits and permission reviews for data security compliance
- **Change Management:** Documented change management process with approval workflows and rollback procedures

### **16.3 Data Governance**

- **Data Classification:** Automated data classification based on sensitivity and regulatory requirements
- **Privacy Controls:** Granular privacy controls for personal data processing and consent management
- **Data Quality:** Automated data quality checks and validation rules for opportunity data integrity
- **Reporting:** Compliance reporting dashboards with real-time monitoring and alerting capabilities

--- END OF SECTION 16 ---
