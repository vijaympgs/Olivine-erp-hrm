# Invoice Matching (3-Way Matching) — Test Script Prompt
File to be created by Agent:
**Invoice_Matching_test_script.py**

---

## OBJECTIVE

Validate **end-to-end Invoice Matching (3-Way Matching)** behavior covering:
- PO-GRN-Invoice reconciliation
- 2-way matching (PO-Invoice)
- 3-way matching (PO-GRN-Invoice)
- Variance detection and tolerance
- Approval workflows for mismatches
- Payment authorization
- Data integrity & Persistence
- Permission enforcement

This test suite must execute critical scenarios using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company
   - Location
   - Item
   - Item Variant
   - Unit of Measure
   - Supplier
   - Purchase Order
   - Goods Receipt Note
   - Users / Roles
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated
8. ✅ Follow BBP 4.7 rules strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: Invoice_Matching_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from decimal import Decimal
from django.utils import timezone

# TODO: Import Invoice Matching specific models and serializers
from procurement.models import (
    VendorInvoice,
    VendorInvoiceLine,
    PurchaseOrder,
    PurchaseOrderLine,
    GoodsReceiptNote,
    GoodsReceiptLine,
    InvoiceMatchingRecord
)

from finance.models import (
    AccountsPayable,
    PaymentSchedule
)

from master.models import (
    Company, Location, Item, ItemVariant, UnitOfMeasure, Supplier
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class InvoiceMatchingTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company, is_active=True).first()
        cls.supplier = Supplier.objects.filter(is_active=True).first()
        cls.items = Item.objects.filter(is_active=True)[:5]
        cls.uom = UnitOfMeasure.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # Require approved PO and confirmed GRN for testing
        cls.po = PurchaseOrder.objects.filter(
            company=cls.company,
            po_status='APPROVED'
        ).first()
        
        cls.grn = GoodsReceiptNote.objects.filter(
            purchase_order=cls.po,
            grn_status='CONFIRMED'
        ).first()
        
        assert cls.company, "Missing active Company master"
        assert cls.location, "Missing active Location master"
        assert cls.supplier, "Missing active Supplier master"
        assert cls.items.count() >= 5, "At least 5 active Items required"
        assert cls.uom, "Missing Unit of Measure"
        assert cls.user, "Missing active User"
        assert cls.po, "Missing approved Purchase Order for Invoice Matching"
        assert cls.grn, "Missing confirmed GRN for 3-way matching"
```

---

## TEST CASES

> **Agent Instruction**:
> Based on the BBP 4.7 and Functional Requirements for **Invoice Matching**:
> 
> **Core Test Cases to Implement:**
> 
> ### INV-TS-01: Perfect 3-Way Match
> - Create vendor invoice referencing PO and GRN
> - Verify quantities match: Invoice = GRN = PO
> - Verify prices match: Invoice = PO
> - Verify automatic approval (no variance)
> - Verify status = MATCHED
> 
> ### INV-TS-02: 2-Way Match (PO-Invoice Only)
> - Create invoice referencing PO (no GRN reference)
> - Verify quantities match: Invoice = PO
> - Verify prices match: Invoice = PO
> - Verify 2-way matching logic applied
> - Verify approval workflow (if required)
> 
> ### INV-TS-03: Quantity Variance Detection
> - Create invoice with quantity > GRN received quantity
> - Verify variance detected and calculated
> - Verify variance percentage computed
> - Verify tolerance check applied
> - Verify approval required if outside tolerance
> 
> ### INV-TS-04: Price Variance Detection
> - Create invoice with price ≠ PO price
> - Verify price variance detected
> - Verify variance amount and percentage calculated
> - Verify tolerance check (e.g., ±5%)
> - Verify approval workflow triggered
> 
> ### INV-TS-05: Within Tolerance Auto-Approval
> - Create invoice with minor variance (within tolerance)
> - Verify variance detected but within limits
> - Verify automatic approval
> - Verify variance logged for audit
> 
> ### INV-TS-06: Outside Tolerance - Approval Required
> - Create invoice with variance > tolerance
> - Verify status = PENDING_APPROVAL
> - Verify approval workflow initiated
> - Verify approver notification
> - Verify blocking of payment until approved
> 
> ### INV-TS-07: Partial Invoice Against Full GRN
> - Create invoice for subset of GRN lines
> - Verify partial matching logic
> - Verify remaining GRN lines available for future invoices
> - Verify cumulative invoice tracking
> 
> ### INV-TS-08: Multiple Invoices Against Single PO/GRN
> - Create first invoice for partial items
> - Create second invoice for remaining items
> - Verify cumulative matching
> - Verify PO/GRN fully invoiced status
> 
> ### INV-TS-09: Tax Reconciliation
> - Create invoice with tax amounts
> - Verify tax calculation matches PO/GRN
> - Verify GST/VAT line items
> - Verify total amount = line total + tax
> 
> ### INV-TS-10: Freight and Additional Charges
> - Create invoice with freight/handling charges
> - Verify additional charges handling
> - Verify allocation to line items (if applicable)
> - Verify total invoice amount calculation
> 
> ### INV-TS-11: Invoice Rejection
> - Create invoice with unacceptable variance
> - Reject invoice
> - Verify status = REJECTED
> - Verify PO/GRN availability restored
> - Verify rejection reason logged
> 
> ### INV-TS-12: Invoice Approval After Review
> - Create invoice with variance
> - Approve invoice manually
> - Verify status = APPROVED
> - Verify payment authorization created
> - Verify AP entry generated
> 
> ### INV-TS-13: Duplicate Invoice Detection
> - Create invoice with same invoice number
> - Verify duplicate detection
> - Verify error/warning raised
> - Verify blocking of duplicate entry
> 
> ### INV-TS-14: Invoice Without PO (Non-PO Invoice)
> - Create invoice without PO reference
> - Verify direct entry allowed (if configured)
> - Verify approval workflow
> - Verify AP entry creation
> 
> ### INV-TS-15: Company/Supplier Context Validation
> - Verify invoice linked to correct supplier
> - Verify invoice created for correct company
> - Verify multi-tenancy isolation
> - Verify supplier payment terms applied
> 
> ### INV-TS-16: Permission Checks
> - Test unauthorized user access
> - Test approval permissions
> - Verify role-based restrictions
> - Test AP clerk vs approver permissions
> 
> ### INV-TS-17: Invalid Data Validation
> - Zero/negative amounts
> - Invoice against non-approved PO
> - Invoice for non-received items (no GRN)
> - Missing required fields (invoice number, date)
> 
> ### INV-TS-18: Audit Trail Verification
> - Verify created_at, updated_at timestamps
> - Verify created_by, updated_by user tracking
> - Verify matching status history
> - Verify variance approval trail
> - Verify payment authorization audit

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** Invoice Matching (3-Way Matching) — Test Automation

- Create `Invoice_Matching_test_script.py` in `backend/domain/procurement/invoice/tests/`
- Implement INV-TS-01 through INV-TS-18 exactly as defined
- Enforce real master dependency
- Do not simplify or shortcut validations
- Follow BBP 4.7 strictly
- Ensure tests cover: 2-way matching, 3-way matching, Variance detection, Tolerance logic, Approval workflows, Tax reconciliation

**Acceptance Criteria:**
- All 18 test cases pass
- No mock data used
- Real master data validated before execution
- Variance calculations verified mathematically
- Tolerance logic tested with edge cases
- Approval workflows validated
- AP integration verified
- Proper error handling for missing data
- Transaction isolation maintained

**Critical Integration Points:**
- PO → Invoice linkage
- GRN → Invoice linkage
- Invoice → AP entry creation
- Invoice → Payment authorization
- Variance → Approval workflow

**Matching Logic to Validate:**
- Quantity: Invoice Qty ≤ GRN Received Qty ≤ PO Ordered Qty
- Price: Invoice Price vs PO Price (with tolerance)
- Total: (Qty × Price) + Tax + Freight = Invoice Total

Failure to meet any rule = test suite rejection.
