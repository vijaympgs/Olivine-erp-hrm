# Goods Receipts (GRN) — Test Script Prompt
File to be created by Agent:
**Goods_Receipts_test_script.py**

---

## OBJECTIVE

Validate **end-to-end Goods Receipt Note (GRN)** behavior covering:
- GRN creation against PO
- Partial and full receipts
- Over-receipt handling
- Quality inspection integration
- Inventory update verification
- Data integrity & Persistence
- Permission enforcement

This test suite must execute critical scenarios using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company
   - Location
   - Item
   - Item Variant
   - Unit of Measure
   - Supplier
   - Purchase Order
   - Users / Roles
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated
8. ✅ Follow BBP 4.6 rules strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: Goods_Receipts_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from decimal import Decimal
from django.utils import timezone

# TODO: Import GRN specific models and serializers
from procurement.models import (
    GoodsReceiptNote,
    GoodsReceiptLine,
    PurchaseOrder,
    PurchaseOrderLine,
    AdvanceShipmentNotice
)

from inventory.models import (
    Inventory,
    StockMovement
)

from master.models import (
    Company, Location, Item, ItemVariant, UnitOfMeasure, Supplier
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class GoodsReceiptsTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company, is_active=True).first()
        cls.supplier = Supplier.objects.filter(is_active=True).first()
        cls.items = Item.objects.filter(is_active=True)[:5]
        cls.uom = UnitOfMeasure.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # Create an approved PO for testing
        cls.po = PurchaseOrder.objects.filter(
            company=cls.company,
            po_status='APPROVED'
        ).first()
        
        assert cls.company, "Missing active Company master"
        assert cls.location, "Missing active Location master"
        assert cls.supplier, "Missing active Supplier master"
        assert cls.items.count() >= 5, "At least 5 active Items required"
        assert cls.uom, "Missing Unit of Measure"
        assert cls.user, "Missing active User"
        assert cls.po, "Missing approved Purchase Order for GRN testing"
```

---

## TEST CASES

> **Agent Instruction**:
> Based on the BBP 4.6 and Functional Requirements for **Goods Receipts (GRN)**:
> 
> **Core Test Cases to Implement:**
> 
> ### GRN-TS-01: Create GRN Against Approved PO
> - Reference approved PO
> - Select PO lines for receipt
> - Create GRN with received quantities
> - Verify status = DRAFT
> - Verify PO linkage maintained
> 
> ### GRN-TS-02: Full Receipt (100% of PO)
> - Receive all items from PO at ordered quantities
> - Verify GRN lines match PO lines
> - Verify received_qty = ordered_qty for all lines
> - Verify PO receipt status updated
> 
> ### GRN-TS-03: Partial Receipt
> - Receive subset of PO lines
> - Receive partial quantities (e.g., 50% of ordered)
> - Verify remaining quantities tracked
> - Verify PO remains open for remaining items
> 
> ### GRN-TS-04: Multiple GRNs Against Single PO
> - Create first GRN with partial receipt
> - Create second GRN for remaining items
> - Verify cumulative receipt tracking
> - Verify PO closes when fully received
> 
> ### GRN-TS-05: Over-Receipt Handling
> - Attempt to receive more than ordered quantity
> - Verify validation rules (allow/block based on config)
> - Verify tolerance limits (if applicable)
> - Verify approval workflow for over-receipt
> 
> ### GRN-TS-06: GRN with ASN Reference
> - Create GRN referencing existing ASN
> - Verify ASN quantities pre-populated
> - Verify ASN-GRN linkage
> - Verify variance tracking (ASN vs actual receipt)
> 
> ### GRN-TS-07: Inventory Update on GRN Confirmation
> - Confirm GRN (DRAFT → CONFIRMED)
> - Verify inventory levels increased
> - Verify stock movement record created
> - Verify location-specific stock updated
> 
> ### GRN-TS-08: Quality Inspection Hold
> - Create GRN with QC required flag
> - Verify stock moved to QC/Inspection location
> - Verify inventory not available for use
> - Verify QC approval workflow
> 
> ### GRN-TS-09: GRN Rejection/Return
> - Create GRN
> - Reject items (quality issues)
> - Verify rejected quantity tracking
> - Verify return to supplier initiated
> 
> ### GRN-TS-10: Company/Location Context
> - Verify GRN created for correct company
> - Verify receiving location set correctly
> - Verify multi-tenancy isolation
> - Verify inventory updated in correct location
> 
> ### GRN-TS-11: Permission Checks
> - Test unauthorized user access
> - Test confirmation permissions
> - Verify role-based restrictions
> - Test warehouse staff vs buyer permissions
> 
> ### GRN-TS-12: Invalid Data Validation
> - Zero/negative received quantities
> - GRN against non-approved PO
> - GRN for already fully received PO
> - Missing required fields (delivery note, date)
> 
> ### GRN-TS-13: Audit Trail Verification
> - Verify created_at, updated_at timestamps
> - Verify created_by, updated_by user tracking
> - Verify status change history
> - Verify inventory movement audit trail
> 
> ### GRN-TS-14: GRN Reversal/Cancellation
> - Create and confirm GRN
> - Reverse/cancel GRN
> - Verify inventory levels restored
> - Verify PO receipt status reverted
> - Verify reversal audit trail

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** Goods Receipts (GRN) — Test Automation

- Create `Goods_Receipts_test_script.py` in `backend/domain/procurement/grn/tests/`
- Implement GRN-TS-01 through GRN-TS-14 exactly as defined
- Enforce real master dependency
- Do not simplify or shortcut validations
- Follow BBP 4.6 strictly
- Ensure tests cover: Full receipt, Partial receipt, Over-receipt, ASN integration, Inventory updates, QC workflow

**Acceptance Criteria:**
- All 14 test cases pass
- No mock data used
- Real master data validated before execution
- Inventory updates verified in database
- Stock movement records validated
- Proper error handling for missing data
- Transaction isolation maintained

**Critical Integration Points:**
- PO → GRN linkage
- ASN → GRN linkage (if ASN exists)
- GRN → Inventory update
- GRN → Stock Movement creation

Failure to meet any rule = test suite rejection.
