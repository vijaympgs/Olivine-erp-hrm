# 5.5 Physical Inventory — Test Script Prompt
File to be created by Agent:
**5.5_Physical_Inventory_test_script.py**

---

## OBJECTIVE

Validate **Stock Take (Physical Inventory)** process:
- Stock Snapshot creation (Freeze system qty)
- Physical Count entry
- Variance Calculation
- Approval & Posting (Adjustment generation)
- Cycle Count specific logic

This test suite must execute **TAKE-TS-01 → TAKE-TS-05** using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ✅ USE ONLY existing reference masters
3. ✅ Use Django ORM models only
4. ✅ Follow BBP 5.5 strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: 5.5_Physical_Inventory_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from django.utils import timezone
from decimal import Decimal

from domain.inventory.models import (
    StockTake, StockTakeLine, StockLevel, StockMovement
)
from domain.company.models import Company, Location, ItemVariant
```

---

## BASE TEST SETUP

```python
class StockTakeTestCase(TestCase):
    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company).first()
        cls.variant = ItemVariant.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # Seed Stock: 100
        StockLevel.objects.update_or_create(
            company=cls.company, variant=cls.variant, location=cls.location,
            defaults={'on_hand_qty': 100}
        )
```

---

## TEST CASES

### TAKE-TS-01: Create & Freeze Snapshot
```python
def test_take_01_freeze_snapshot(self):
    """Verify starting Stock Take freezes System Qty"""
    st = StockTake.objects.create(
        company=self.company, location=self.location,
        stock_take_type='FULL', status='IN_PROGRESS',
        snapshot_datetime=timezone.now(),
        created_by=self.user, stock_take_number='ST-001'
    )
    
    # Simulate Snapshot Logic
    current_stock = StockLevel.objects.get(variant=self.variant, location=self.location).on_hand_qty
    
    line = StockTakeLine.objects.create(
        stock_take=st,
        variant=self.variant,
        system_qty=current_stock, # Frozen here as 100
        physical_qty=0 # Pending count
    )
    
    # Change actual stock (simulate operations during count)
    # The line.system_qty should remain 100 regardless
    self.assertEqual(line.system_qty, 100)
```

### TAKE-TS-02: Variance Calculation
```python
def test_take_02_variance_calc(self):
    """Verify Variance = Physical - System"""
    st = StockTake.objects.create(
        company=self.company, location=self.location,
        stock_take_type='FULL', status='IN_PROGRESS',
        snapshot_datetime=timezone.now(), created_by=self.user, stock_take_number='ST-002'
    )
    
    # System: 100, Physical: 95 -> Variance: -5 (Loss)
    line = StockTakeLine.objects.create(
        stock_take=st, variant=self.variant,
        system_qty=100, physical_qty=95
    )
    
    self.assertEqual(line.variance_qty, -5)
```

### TAKE-TS-03: Post Stock Take (Adjustment)
```python
def test_take_03_post_result(self):
    """Verify Posting creates adjustment movement for Variance"""
    st = StockTake.objects.create(
        company=self.company, location=self.location,
        stock_take_type='FULL', status='POSTED',
        snapshot_datetime=timezone.now(), created_by=self.user, stock_take_number='ST-003'
    )
    
    # Variance -5
    variance = -5
    
    # Create Adjustment Movement (Simulated logic)
    StockMovement.objects.create(
        company=self.company, item=self.variant.item, variant=self.variant,
        qty=variance, movement_type='ADJUSTMENT', reference_type='STOCK_TAKE',
        reference_id=st.stock_take_id, created_by=self.user
    )
    
    # Update Stock Level
    level = StockLevel.objects.get(company=self.company, variant=self.variant, location=self.location)
    level.on_hand_qty += variance
    level.save()
    
    # 100 + (-5) = 95
    self.assertEqual(level.on_hand_qty, 95)
```

### TAKE-TS-04: Blind Count (Zero Default)
```python
def test_take_04_blind_count(self):
    """Verify new lines default to 0 physical qty"""
    line = StockTakeLine(
        stock_take_id=uuid.uuid4(), variant=self.variant,
        system_qty=50
    )
    # Check default before save logic if applicable, or explicit
    self.assertEqual(line.physical_qty, 0)
```

### TAKE-TS-05: Complete Cycle Count
```python
def test_take_05_cycle_count(self):
    """Verify Cycle Count flag"""
    cc = StockTake.objects.create(
        company=self.company, location=self.location,
        stock_take_type='CYCLE', status='PLANNED',
        snapshot_datetime=timezone.now(), created_by=self.user, stock_take_number='CC-001'
    )
    self.assertEqual(cc.stock_take_type, 'CYCLE')
```

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** 5.5 Physical Inventory — Test Automation

- Create `5.5_Physical_Inventory_test_script.py`
- Implement TAKE-TS-01 → TAKE-TS-05
- Focus on Snapshot Freeze logic
- Verify Variance Math
- Follow BBP 5.5 strictly

Failure to meet any rule = test suite rejection.
