# 5.1 Inventory Dashboard — Test Script Prompt
File to be created by Agent:
**5.1_Inventory_Dashboard_test_script.py**

---

## OBJECTIVE

Validate **Inventory Dashboard data aggregation and reporting** behavior covering:
- Stock Overview (Quantities & Valuation)
- Location-wise Stock Breakdown
- Low Stock Alerts validation
- Movement Trend Analysis
- Data permission enforcement (Location scope)

This test suite must execute **DASH-TS-01 → DASH-TS-05** using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company
   - Location
   - Item Master / Variant
   - Unit of Measure
   - Stock Level (Materialized View)
   - Stock Movement (Ledger)
4. ❌ DO NOT auto-create master data inside tests (use setUpTestData to fetch or create specific transactional data if needed)
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated
8. ✅ Follow BBP 5.1 rules strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: 5.1_Inventory_Dashboard_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from django.utils import timezone
from decimal import Decimal

from domain.inventory.models import (
    StockLevel,
    StockMovement,
    ReorderPolicy
)

from domain.company.models import (
    Company,
    Location,
    ItemVariant,
    UnitOfMeasure
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class InventoryDashboardTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        # 1. Fetch Core Masters
        cls.company = Company.objects.filter(is_active=True).first()
        cls.locations = list(Location.objects.filter(company=cls.company, is_active=True)[:2])
        cls.variants = list(ItemVariant.objects.filter(is_active=True)[:5])
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # 2. Setup Pre-conditions (Seed Data for Dashboard)
        # Create Stock Levels
        for variant in cls.variants:
             # Location 1: 100 units
             StockLevel.objects.update_or_create(
                 company=cls.company,
                 location=cls.locations[0],
                 variant=variant,
                 defaults={
                     'on_hand_qty': 100,
                     'available_qty': 100,
                     'reserved_qty': 0
                 }
             )
             
        # Create Reorder Policy for Alert Testing
        ReorderPolicy.objects.create(
            company=cls.company,
            location=cls.locations[0],
            variant=cls.variants[0],
            min_qty=150, # Threshold > Current (100) -> Should Trigger Alert
            reorder_qty=500
        )

        assert cls.company, "Missing active Company"
        assert len(cls.locations) >= 2, "Need at least 2 Locations"
        assert len(cls.variants) >= 5, "Need at least 5 Item Variants"
```

---

## TEST CASES

### DASH-TS-01: Verify Stock Overview (Total Value/Qty)
```python
def test_dash_01_stock_overview(self):
    """Verify total stock quantity and valuation across all locations"""
    # Total Qty = 5 variants * 100 = 500
    total_qty = StockLevel.objects.filter(company=self.company).aggregate(
        total=models.Sum('on_hand_qty')
    )['total']
    
    self.assertEqual(total_qty, 500)
    # Add valuation check if cost price exists in Variant
```

---

### DASH-TS-02: Verify Stock by Location
```python
def test_dash_02_stock_by_location(self):
    """Verify stock segmentation by location"""
    loc1_stock = StockLevel.objects.filter(
        company=self.company, 
        location=self.locations[0]
    ).count()
    
    # We added 5 items to Loc 1
    self.assertEqual(loc1_stock, 5)
    
    # Loc 2 should be empty
    loc2_stock = StockLevel.objects.filter(
        company=self.company, 
        location=self.locations[1]
    ).count()
    self.assertEqual(loc2_stock, 0)
```

---

### DASH-TS-03: Validate Low Stock Alerts
```python
def test_dash_03_low_stock_alerts(self):
    """Verify variants below reorder point trigger alerts"""
    # Logic: Join StockLevel with ReorderPolicy
    # Variant[0] has Qty 100, Min 150 -> Alert
    
    low_stock_items = StockLevel.objects.filter(
        company=self.company,
        available_qty__lt=models.Subquery(
            ReorderPolicy.objects.filter(
                variant=models.OuterRef('variant'),
                location=models.OuterRef('location')
            ).values('min_qty')
        )
    )
    
    self.assertTrue(low_stock_items.exists())
    self.assertEqual(low_stock_items.first().variant, self.variants[0])
```

---

### DASH-TS-04: Movement History Trends
```python
def test_dash_04_movement_trends(self):
    """Verify recent movements appear in trend analysis"""
    # Create a movement
    StockMovement.objects.create(
        company=self.company,
        item=self.variants[0].item,
        variant=self.variants[0],
        qty=10,
        movement_type='GRN',
        reference_type='GRN',
        reference_id=uuid.uuid4(),
        created_by=self.user
    )
    
    # Fetch recent movements
    recent_moves = StockMovement.objects.filter(
        company=self.company
    ).order_by('-posted_at')
    
    self.assertEqual(recent_moves.count(), 1)
    self.assertEqual(recent_moves.first().movement_type, 'GRN')
```

---

### DASH-TS-05: Permission Scope (Multi-Company)
```python
def test_dash_05_company_isolation(self):
    """Verify no data leak from other companies"""
    # Create separate company data... (if possible, or just verify filter)
    # Basic check: Ensure all fetched data matches self.company
    
    levels = StockLevel.objects.filter(company=self.company)
    for lvl in levels:
        self.assertEqual(lvl.company, self.company)
```

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** 5.1 Inventory Dashboard — Test Automation

- Create `5.1_Inventory_Dashboard_test_script.py`
- Implement DASH-TS-01 → DASH-TS-05 exactly as defined
- Enforce real master dependency
- Prioritize Aggregation queries and Performance
- Follow BBP 5.1 strictly

Failure to meet any rule = test suite rejection.
