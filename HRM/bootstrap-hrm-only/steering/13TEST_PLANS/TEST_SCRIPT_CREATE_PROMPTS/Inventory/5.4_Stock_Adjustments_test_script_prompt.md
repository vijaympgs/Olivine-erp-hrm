# 5.4 Stock Adjustments — Test Script Prompt
File to be created by Agent:
**5.4_Stock_Adjustments_test_script.py**

---

## OBJECTIVE

Validate **Stock Adjustment Workflow** including:
- Draft → Approve → Post lifecycle
- Reason Code validation
- Approval Threshold enforcement (if applicable)
- Stock Level impact (+/- adjustments)
- Audit Trail (Who approved?)

This test suite must execute **ADJ-TS-01 → ADJ-TS-05** using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ✅ USE ONLY existing reference masters
3. ✅ FAIL FAST if required master data is missing
4. ✅ Use Django ORM models only
5. ✅ Each test must be transactional and isolated

---

## TEST SCRIPT STRUCTURE

```python
# file: 5.4_Stock_Adjustments_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from django.utils import timezone
from decimal import Decimal

from domain.inventory.models import (
    StockAdjustment, StockAdjustmentLine, AdjustmentReasonCode,
    StockLevel, InventoryApprovalLog
)
from domain.company.models import Company, Location, ItemVariant, UnitOfMeasure
```

---

## BASE TEST SETUP

```python
class StockAdjustmentTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company).first()
        cls.variant = ItemVariant.objects.filter(is_active=True).first()
        cls.uom = UnitOfMeasure.objects.first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # Ensure Reason Code exists
        cls.reason, _ = AdjustmentReasonCode.objects.get_or_create(
            company=cls.company,
            reason_code='DAMAGED',
            defaults={'description': 'Damaged Goods', 'is_negative': True}
        )
        
        # Pre-seed stock
        StockLevel.objects.update_or_create(
            company=cls.company, variant=cls.variant, location=cls.location,
            defaults={'on_hand_qty': 100}
        )

        assert cls.reason, "Missing Reason Code"
```

---

## TEST CASES

### ADJ-TS-01: Create Draft Adjustment
```python
def test_adj_01_create_draft(self):
    """Verify Draft creation does NOT affect stock"""
    adj = StockAdjustment.objects.create(
        company=self.company,
        location=self.location,
        status='DRAFT',
        created_by=self.user,
        adjustment_number='ADJ-001'
    )
    
    StockAdjustmentLine.objects.create(
        adjustment=adj,
        variant=self.variant,
        uom=self.uom,
        qty_adjusted=-5,
        reason_code=self.reason
    )
    
    # Stock should remain 100
    level = StockLevel.objects.get(company=self.company, variant=self.variant)
    self.assertEqual(level.on_hand_qty, 100)
    self.assertEqual(adj.status, 'DRAFT')
```

### ADJ-TS-02: Approval Workflow
```python
def test_adj_02_approval_flow(self):
    """Verify Submit -> Approve state transitions"""
    adj = StockAdjustment.objects.create(
        company=self.company, location=self.location, status='DRAFT',
        created_by=self.user, adjustment_number='ADJ-002'
    )
    
    # Submit
    adj.status = 'PENDING_APPROVAL'
    adj.save()
    InventoryApprovalLog.objects.create(adjustment=adj, actor=self.user, action='SUBMIT')
    
    # Approve
    adj.status = 'APPROVED'
    adj.approved_by = self.user
    adj.save()
    InventoryApprovalLog.objects.create(adjustment=adj, actor=self.user, action='APPROVE')
    
    self.assertEqual(adj.status, 'APPROVED')
    self.assertEqual(InventoryApprovalLog.objects.filter(adjustment=adj).count(), 2)
```

### ADJ-TS-03: Post Adjustment (Stock Impact)
```python
def test_adj_03_post_adjustment(self):
    """Verify Posted adjustment updates Stock Level"""
    # Setup Approved Adjustment
    adj = StockAdjustment.objects.create(
        company=self.company, location=self.location, status='APPROVED',
        created_by=self.user, adjustment_number='ADJ-003'
    )
    line = StockAdjustmentLine.objects.create(
        adjustment=adj, variant=self.variant, uom=self.uom, 
        qty_adjusted=-10, reason_code=self.reason
    )
    
    # Execute Post Logic (Simulated)
    adj.status = 'POSTED'
    adj.posted_at = timezone.now()
    adj.save()
    
    level = StockLevel.objects.get(company=self.company, variant=self.variant, location=self.location)
    level.on_hand_qty += line.qty_adjusted # -10
    level.save()
    
    self.assertEqual(level.on_hand_qty, 90) # 100 - 10
```

### ADJ-TS-04: Positive Adjustment (Found Stock)
```python
def test_adj_04_positive_adjustment(self):
    """Verify positive adjustment (Found items) adds to stock"""
    found_reason, _ = AdjustmentReasonCode.objects.get_or_create(
        company=self.company, reason_code='FOUND', defaults={'is_negative': False}
    )
    
    # Post +5
    level = StockLevel.objects.get(company=self.company, variant=self.variant)
    initial = level.on_hand_qty
    
    # Logic simulation
    level.on_hand_qty += 5
    level.save()
    
    self.assertEqual(level.on_hand_qty, initial + 5)
```

### ADJ-TS-05: Reason Code Validation
```python
def test_adj_05_mandatory_reason(self):
    """Verify Reason Code is mandatory for lines"""
    adj = StockAdjustment.objects.create(company=self.company, location=self.location, created_by=self.user)
    
    with self.assertRaises(Exception): # IntegrityError if DB enforced, or generic
        StockAdjustmentLine.objects.create(
            adjustment=adj, variant=self.variant, qty_adjusted=1, uom=self.uom,
            reason_code=None # Should fail
        )
```

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** 5.4 Stock Adjustments — Test Automation

- Create `5.4_Stock_Adjustments_test_script.py`
- Implement ADJ-TS-01 → ADJ-TS-05
- Verify Lifecycle States: DRAFT -> PENDING -> APPROVED -> POSTED
- Strictly check Stock Impact calculation
- Follow BBP 5.4 strictly

Failure to meet any rule = test suite rejection.
