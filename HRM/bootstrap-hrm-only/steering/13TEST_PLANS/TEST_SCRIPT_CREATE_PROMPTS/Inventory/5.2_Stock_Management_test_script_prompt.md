# 5.2 Stock Management — Test Script Prompt
File to be created by Agent:
**5.2_Stock_Management_test_script.py**

---

## OBJECTIVE

Validate **Stock Management** capabilities covering:
- Stock Inquiry (Drill-down by Location, Category)
- Batch & Serial Number traceability
- Reorder Policy Management (CRUD)
- Stock Aging logic
- Zero stock filtering

This test suite must execute **STOCK-TS-01 → STOCK-TS-05** using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company, Location, ItemVariant
   - StockLevel
   - Batch, SerialNumber (Operational Models)
   - ReorderPolicy
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated

---

## TEST SCRIPT STRUCTURE

```python
# file: 5.2_Stock_Management_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from decimal import Decimal
import uuid

from domain.inventory.models import (
    StockLevel,
    ReorderPolicy,
    Batch,
    SerialNumber
)
from domain.company.models import (
    Company, Location, ItemVariant
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class StockManagementTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company, is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # Find item that supports batch/serial if possible, or just standard
        cls.variant = ItemVariant.objects.filter(is_active=True).first()

        # Create a Batch for testing
        cls.batch = Batch.objects.create(
            company=cls.company,
            batch_number=f"BATCH-{uuid.uuid4().hex[:6]}",
            item=cls.variant.item,
            expiry_date=timezone.now().date() + timezone.timedelta(days=365)
        )
        
        # Create Stock with Batch
        StockLevel.objects.update_or_create(
            company=cls.company,
            location=cls.location,
            variant=cls.variant,
            batch=cls.batch,
            defaults={'on_hand_qty': 50}
        )

        assert cls.company, "Missing Company"
        assert cls.location, "Missing Location"
        assert cls.variant, "Missing Variant"
```

---

## TEST CASES

### STOCK-TS-01: Filter Stock by Batch
```python
def test_stock_01_filter_by_batch(self):
    """Verify system can retrieve stock on hand for a specific batch"""
    stock = StockLevel.objects.filter(
        company=self.company, 
        batch=self.batch
    ).first()
    
    self.assertIsNotNone(stock)
    self.assertEqual(stock.batch.batch_number, self.batch.batch_number)
    self.assertEqual(stock.on_hand_qty, 50)
```

---

### STOCK-TS-02: Create & Validate Reorder Policy
```python
def test_stock_02_reorder_policy_crud(self):
    """Verify creation and validation of reorder policies"""
    policy = ReorderPolicy.objects.create(
        company=self.company,
        location=self.location,
        variant=self.variant,
        min_qty=10,
        reorder_qty=100
    )
    
    self.assertIsNotNone(policy.policy_id)
    self.assertEqual(policy.min_qty, 10)
    
    # Ensure duplication is prevented (unique together)
    with self.assertRaises(Exception): # IntegrityError
        ReorderPolicy.objects.create(
            company=self.company,
            location=self.location,
            variant=self.variant,
            min_qty=5,
            reorder_qty=50
        )
```

---

### STOCK-TS-03: Zero Stock Logic
```python
def test_stock_03_zero_stock_filtering(self):
    """Verify stock levels with 0 qty are handled correctly (shown/hidden based on view)"""
    # Create 0 qty record
    StockLevel.objects.create(
        company=self.company,
        location=self.location,
        variant=self.variants[1], # Access another variant
        on_hand_qty=0
    )
    
    # Filter 1: Show all
    all_stock = StockLevel.objects.filter(company=self.company).count()
    # Filter 2: Show only positive
    pos_stock = StockLevel.objects.filter(company=self.company, on_hand_qty__gt=0).count()
    
    self.assertGreater(all_stock, pos_stock)
```

---

### STOCK-TS-04: Batch Expiry Validation
```python
def test_stock_04_batch_expiry(self):
    """Verify batch expiry date querying"""
    # Retrieve batches expiring in next 400 days
    cutoff = timezone.now().date() + timezone.timedelta(days=400)
    
    expiring_batches = Batch.objects.filter(
        company=self.company,
        expiry_date__lte=cutoff
    )
    
    self.assertTrue(expiring_batches.filter(batch_id=self.batch.batch_id).exists())
```

---

### STOCK-TS-05: Serial Number Check (Stub)
```python
def test_stock_05_serial_check(self):
    """Basic Serial Number fetch check"""
    # Create serial
    sn = SerialNumber.objects.create(
        company=self.company,
        item=self.variant.item,
        serial_number=f"SN-{uuid.uuid4().hex[:6]}",
        status='AVAILABLE'
    )
    
    self.assertEqual(sn.status, 'AVAILABLE')
```

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** 5.2 Stock Management — Test Automation

- Create `5.2_Stock_Management_test_script.py`
- Implement STOCK-TS-01 → STOCK-TS-05 exactly as defined
- Enforce real master dependency
- Strict Unique constraints checking for Policy
- Follow BBP 5.2 strictly

Failure to meet any rule = test suite rejection.
