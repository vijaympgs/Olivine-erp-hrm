# 6.3 Sales Invoice
Template Ref: _txn_02 (Medium Transaction)

## 6.3.1 Business Purpose

The **Sales Invoice** is the legal document issued to a customer for goods/services delivered, representing a receivable liability and triggering revenue recognition. It validates the invoice against what was ordered (Sales Order) and what was shipped/delivered before it becomes an accounts receivable in Finance/AR.

Goals:

- Convert confirmed sales orders into billable invoices for revenue recognition.
- Ensure that only valid, matched invoices are sent to customers and posted to AR.
- Support:
  - **Order-based invoicing**: Invoice ↔ Sales Order ↔ Shipment (standard)
  - **Delivery-based invoicing**: Invoice ↔ Delivery Confirmation
  - **Milestone-based invoicing**: For services/projects
  - **Recurring invoicing**: For subscriptions/contracts
- Capture and route exceptions:
  - Price variance
  - Quantity variance
  - Tax mismatch
  - Unmatched invoice (no order reference)
- Feed Customer Payment Tracking and Revenue Recognition.
- Support partial invoicing and multiple invoices per order.

Hybrid behavior (config-driven):

- Invoicing model can vary by:
  - Company
  - Location / Business Unit
  - Customer Type (B2B, B2C, Export)
  - Order Type (Standard, Rush, Subscription)
- Tolerances can be configured by:
  - Amount (% or absolute)
  - Tax variance
  - Price vs order/quote

---

## 6.3.2 Data Model

### A) Sales Invoice Header (`sales_invoice`)

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| customer_id          | FK (Customer)| Yes      | Customer being invoiced |
| invoice_number       | String(30)   | Yes      | Human-readable Invoice No (auto-generated, e.g., INV-00000001) |
| invoice_status       | Enum         | Yes      | `DRAFT`, `VALIDATED`, `APPROVED`, `SENT_TO_CUSTOMER`, `PARTIALLY_PAID`, `FULLY_PAID`, `OVERDUE`, `WRITTEN_OFF`, `CANCELLED` |
| invoice_type         | Enum         | Yes      | `STANDARD`, `PROFORMA`, `CREDIT_NOTE`, `DEBIT_NOTE`, `RECURRING` |
| invoice_date         | Date         | Yes      | Invoice issue date |
| due_date             | Date         | Yes      | Payment due date |
| posting_date         | Date         | No       | AR posting date (finance integration) |
| currency_code        | String(3)    | Yes      | Invoice currency |
| sales_order_id       | FK (SalesOrder)| No     | Primary order this invoice belongs to (optional if multi-order) |
| shipment_id          | FK (Shipment)| No       | Optional shipment reference |
| billing_period_start | Date         | No       | For recurring/subscription invoices |
| billing_period_end   | Date         | No       | For recurring/subscription invoices |
| payment_terms        | String(100)  | No       | Payment terms (e.g., "Net 30", "Due on Receipt") |
| payment_method       | Enum         | No       | `CASH`, `CREDIT_CARD`, `BANK_TRANSFER`, `CHECK`, `UPI`, `WALLET` |
| subtotal             | Decimal      | Yes      | Sum of line totals before tax |
| discount_percent     | Decimal      | No       | Header-level discount % |
| discount_amount      | Decimal      | No       | Header-level discount amount |
| shipping_charges     | Decimal      | No       | Shipping/freight charges |
| adjustment_amount    | Decimal      | No       | Manual adjustment (positive or negative) |
| tax_amount           | Decimal      | Yes      | Total tax amount |
| grand_total          | Decimal      | Yes      | Final invoice amount |
| amount_paid          | Decimal      | Yes      | Default 0; updated from payments |
| amount_due           | Decimal      | Yes      | grand_total - amount_paid |
| tax_inclusive        | Boolean      | Yes      | True if prices stored are tax-inclusive |
| billing_address      | Text         | No       | Customer billing address |
| shipping_address     | Text         | No       | Delivery address (for reference) |
| customer_po_number   | String(50)   | No       | Customer's PO reference |
| customer_contact_name| String(100)  | No       | Contact person at customer |
| customer_contact_email| String(200) | No       | Email for invoice delivery |
| sales_person_id      | FK (User)    | No       | Sales representative |
| location_id          | FK (Location)| Yes      | Invoicing location/branch |
| source_capture_method| Enum         | Yes      | `MANUAL_ENTRY`, `AUTO_FROM_ORDER`, `AUTO_FROM_SHIPMENT`, `RECURRING_SCHEDULE`, `API` |
| match_type           | Enum         | Yes      | `ORDER_BASED`, `DELIVERY_BASED`, `MILESTONE_BASED`, `TIME_BASED` |
| match_status         | Enum         | Yes      | `UNMATCHED`, `PARTIALLY_MATCHED`, `FULLY_MATCHED`, `MATCH_WITH_VARIANCE` |
| match_variance_amount| Decimal      | Yes      | Total variance amount vs matched reference(s) |
| match_variance_reason| Text         | No       | Summary of main variance reasons |
| duplicate_check_signature| String(200)| No     | Hash derived from customer+invoice# etc. |
| duplicate_flag       | Boolean      | Yes      | System-detected potential duplicate |
| approval_required    | Boolean      | Yes      | Based on value/variance/rules |
| approved_by_user_id  | FK (User)    | No       | Who approved this invoice for posting/sending |
| approved_at          | DateTime     | No       | Approval timestamp |
| rejected_by_user_id  | FK (User)    | No       | If invoice was rejected |
| rejected_at          | DateTime     | No       | Rejection timestamp |
| rejection_reason     | Text         | No       | Reason for rejection |
| sent_to_customer_at  | DateTime     | No       | When invoice was sent to customer |
| first_payment_date   | Date         | No       | Date of first payment received |
| last_payment_date    | Date         | No       | Date of last payment received |
| fully_paid_at        | DateTime     | No       | When invoice was fully paid |
| overdue_days         | Integer      | Yes      | Calculated: days past due_date (if unpaid) |
| dunning_level        | Integer      | Yes      | Default 0; escalation level for overdue invoices |
| last_dunning_date    | Date         | No       | Last reminder sent date |
| write_off_amount     | Decimal      | No       | Amount written off (if any) |
| write_off_reason     | Text         | No       | Reason for write-off |
| write_off_date       | Date         | No       | Write-off date |
| remarks_internal     | Text         | No       | Notes for AR/sales only |
| remarks_to_customer  | Text         | No       | Notes visible on invoice |
| created_by_user_id   | FK (User)    | Yes      | Invoice created by |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |
| deleted_at           | DateTime     | No       | Soft delete timestamp |

**[NEW] Revision & Versioning:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| parent_invoice_id    | FK (sales_invoice)| No   | [NEW] Reference to original invoice if this is a revision |
| revision_number      | Integer       | Yes      | [NEW] Version number (default: 1, increments on revision) |
| is_latest_revision   | Boolean       | Yes      | [NEW] True only for current active revision (default: true) |
| revision_reason      | Text          | No       | [NEW] Reason for creating revision (required if revision_number > 1) |

**[NEW] Margin & Cost Tracking:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| cost_price_total     | Decimal       | No       | [NEW] Sum of line-level cost prices (read-only/computed) |
| gross_margin_pct     | Decimal       | No       | [NEW] ((grand_total - cost_price_total) / grand_total) × 100 |

**[NEW] Revenue Recognition:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| revenue_recognized_amount| Decimal   | No       | [NEW] Amount recognized as revenue (for accrual accounting) |
| revenue_recognition_date| Date       | No       | [NEW] Date when revenue was recognized |
| revenue_recognition_status| Enum     | No       | [NEW] `PENDING`, `RECOGNIZED`, `DEFERRED` |

**[NEW] Approval & Audit:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| approval_rule_snapshot| JSON         | No       | [NEW] Captures discount %, credit limit, approver role, rule version at approval time |

**[NEW] Document & Communication:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| invoice_pdf_url      | String(500)   | No       | [NEW] URL/path to generated PDF |
| last_sent_to_email   | String(255)   | No       | [NEW] Email address where invoice was last sent |
| sent_channel         | Enum          | No       | [NEW] `EMAIL`, `PORTAL`, `WHATSAPP`, `PRINT`, `POST` |

> Note: Multi-order and multi-shipment linking can be handled via detail/match table below.

---

### B) Sales Invoice Line (`sales_invoice_line`)

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| sales_invoice_id      | FK (Invoice Header)| Yes     | Invoice header |
| line_number           | Integer           | Yes      | Sequential line number |
| item_id               | FK (Item)         | No       | May be null for non-catalog items/services |
| item_variant_id       | FK (Item Variant) | No       | SKU reference |
| description           | String(255)       | Yes      | Line description on invoice |
| uom_id                | FK (UOM)          | No       | UOM if structured |
| quantity_invoiced     | Decimal           | Yes      | Quantity as per invoice |
| unit_price_invoiced   | Decimal           | Yes      | Price per unit as per invoice |
| discount_percent      | Decimal           | No       | Line-level discount % |
| discount_amount       | Decimal           | No       | Line-level discount amount |
| line_subtotal         | Decimal           | Yes      | = quantity_invoiced × unit_price_invoiced (before tax) |
| tax_percent_invoiced  | Decimal           | No       | Tax rate applied (if line-wise) |
| tax_amount_invoiced   | Decimal           | No       | Line tax amount |
| line_total            | Decimal           | Yes      | Subtotal - discount + tax |
| gl_account_code       | String(50)        | No       | For revenue posting / non-order lines |
| line_remarks_internal | Text              | No       | Any internal notes |
| line_remarks_to_customer| Text            | No       | Customer-visible notes |
| created_at            | DateTime          | Auto     |  |
| updated_at            | DateTime          | Auto     |  |

**[NEW] Price Source & Override Traceability:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| price_source         | Enum          | Yes      | [NEW] `ORDER`, `QUOTE`, `PRICE_LIST`, `MANUAL_OVERRIDE` (default: ORDER) |
| override_reason      | Text          | No       | [NEW] Required if price_source = MANUAL_OVERRIDE |
| cost_price           | Decimal       | No       | [NEW] Unit cost price (for margin calculation, read-only) |
| gross_margin_pct     | Decimal       | No       | [NEW] ((unit_price_invoiced - cost_price) / unit_price_invoiced) × 100 |

---

### C) Invoice Match Detail (`sales_invoice_match_detail`)

Connects invoice lines to Sales Order/Shipment, enabling order-based and delivery-based matching.

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| sales_invoice_line_id | FK (Invoice Line) | Yes      | Invoice line |
| sales_order_line_id   | FK (Order Line)   | No       | For order-based match |
| shipment_line_id      | FK (Shipment Line)| No       | For delivery-based match |
| matched_qty           | Decimal           | Yes      | Qty considered for matching |
| matched_unit_price    | Decimal           | Yes      | Reference unit price (from Order/Quote) |
| matched_tax_percent   | Decimal           | No       | Tax rate from order or master |
| qty_variance          | Decimal           | Yes      | quantity_invoiced - matched_qty |
| price_variance        | Decimal           | Yes      | unit_price_invoiced - matched_unit_price |
| tax_variance          | Decimal           | Yes      | tax_invoiced - matched_tax |
| variance_amount_total | Decimal           | Yes      | Monetary impact of variances |
| variance_status       | Enum              | Yes      | `WITHIN_TOLERANCE`, `EXCEEDS_TOLERANCE` |
| variance_reason_code  | String(50)        | No       | Under/over billing, extra charges, tax diff |
| manual_override_flag  | Boolean           | Yes      | True if user forced override |
| override_justification| Text              | No       | Reason for override (if any) |
| created_at            | DateTime          | Auto     |  |

---

### D) Config / Control (Conceptual)

Sample controls:

**[EXISTING]**
- `invoice_matching_model` per customer type/location:
  - `ORDER_BASED`, `DELIVERY_BASED`, `MILESTONE_BASED`, `TIME_BASED`
- Tolerances:
  - `qty_tolerance_percent`
  - `price_tolerance_percent`
  - `tax_tolerance_percent`
  - `amount_tolerance_absolute`
- `auto_match_if_within_tolerance` (Yes/No)
- `block_posting_if_duplicate_flag = true` (or require override)
- `auto_send_invoice_on_approval` (Boolean, default: false)
- `auto_generate_invoice_on_shipment` (Boolean, default: false)
- `allow_partial_invoicing` (Boolean, default: true)
- `require_approval_for_credit_note` (Boolean, default: true)

**[NEW] Revenue Recognition:**
- `revenue_recognition_method` (Enum: `ON_INVOICE`, `ON_PAYMENT`, `ON_DELIVERY`, `MILESTONE_BASED`)
- `auto_recognize_revenue` (Boolean, default: false)

**[NEW] Dunning & Collections:**
- `dunning_enabled` (Boolean, default: true)
- `dunning_schedule` (JSON: days and escalation levels)
- `auto_write_off_threshold` (Decimal, amount below which auto write-off allowed)

**[NEW] Margin Protection:**
- `enforce_margin_check` (Boolean, default: false)
- `minimum_margin_threshold` (Decimal, percentage)
- `margin_action` (Enum: `REQUIRE_APPROVAL`, `BLOCK`)

---

## 6.3.3 UI / UX Requirements

**Screen Name:** Sales Invoice  
**Path:** Sales → Invoices

### A) Invoice List

Columns:

- Invoice Number
- Invoice Date
- Customer Name
- Order Number (if any)
- Status
- Grand Total
- Amount Paid
- Amount Due
- Due Date
- Overdue Days
- Payment Status
- Created By / Approved By
- Source (Manual/Auto/Recurring)
- Actions

Filters:

- Date range (Invoice Date, Due Date, Posting Date)
- Customer
- Status (DRAFT, APPROVED, SENT, PAID, OVERDUE, etc.)
- Payment Status (Unpaid / Partially Paid / Fully Paid)
- Invoice Type (Standard, Proforma, Credit Note, etc.)
- Has Variance? (Yes/No)
- Duplicate Flag (Yes/No)
- Overdue (Yes/No)
- Sales Person
- Location

Actions:

- Create Invoice
- Generate from Order (select orders)
- Generate from Shipment (select shipments)
- View/Edit (DRAFT/VALIDATED only)
- Run Auto-Match
- Send for Approval
- Approve / Reject
- Send to Customer (email/PDF)
- Record Payment
- Generate Credit Note
- Write Off
- Print/Download PDF

---

### B) Invoice Capture Form (Header)

Sections:

**Invoice Details**
- Invoice Number (auto-generated, read-only)
- Invoice Type (Standard, Proforma, Credit Note, etc.)
- Invoice Date (default: today)
- Due Date (calculated from payment terms)
- Customer (lookup)
- Customer Contact Name / Email
- Sales Person
- Location
- Currency
- Customer PO Number

**Reference**
- Link to Sales Order(s)
- Link to Shipment(s) (optional)
- Billing Period (for recurring)
- Match Type (auto-suggested by config)

**Pricing & Terms**
- Payment Terms
- Payment Method
- Tax Inclusive? (Yes/No)
- Header Discount % / Amount
- Shipping Charges
- Adjustment Amount

**Addresses**
- Billing Address (default from customer, editable)
- Shipping Address (for reference)

**Totals** (calculated, read-only)
- Subtotal
- Discount
- Shipping Charges
- Adjustment
- Tax
- Grand Total
- Amount Paid
- Amount Due
- **[NEW]** Cost Total (if visible to user role)
- **[NEW]** Gross Margin %

**System Info** (read-only)
- Invoice Status
- Match Status
- Duplicate Flag
- Approval Required? (Yes/No)
- Approved By / At
- Sent to Customer At
- Payment Status
- Overdue Days
- Dunning Level
- **[NEW]** Revenue Recognition Status

**Notes**
- Internal Notes (not printed)
- Remarks to Customer (printed on invoice)

---

### C) Invoice Lines View

Columns:

- Line No
- Description
- Item Code / SKU (if identified)
- UOM
- Qty Invoiced
- Unit Price
- Discount %
- Line Subtotal
- Tax %
- Tax Amount
- Line Total
- **[NEW]** Cost Price (if visible)
- **[NEW]** Margin %
- Matched Order/Shipment reference indicator
- Actions (Edit, Delete, Copy)

Features:

**Auto-suggestion of Order/Shipment mapping based on:**
- Customer, item, quantity, amount, period

**Manual line-to-Order/Shipment linking when auto-match not possible**

**Add line via:**
- From Item Master search
- From Order line selection: "Add from Order"
- From Shipment line selection: "Add from Shipment"
- Manual entry (for services/adjustments)

**Inline validation:**
- Required fields for description, qty, price
- Non-zero quantity
- Match validation against order/shipment

---

### D) Matching View (Core UX)

Dedicated pane/tab:

Show for each invoice line:

**Invoice line values:**
- Qty, price, tax

**Order line reference:**
- Ordered Qty
- Order Unit Price
- Invoiced Qty (cumulative)

**Shipment line reference:**
- Shipped Qty
- Delivered Qty

**Show variance:**
- Qty variance
- Price variance
- Tax variance
- Within/Outside tolerance highlight

**Actions per line:**
- Accept (within tolerance)
- Flag as Exception (outside tolerance)
- Override (if role allows; requires justification)

---

### E) Payment Recording

**Payment Entry:**
- Payment Date
- Payment Amount
- Payment Method
- Payment Reference (transaction ID, check number)
- Bank Account (if applicable)
- Notes

**Payment Allocation:**
- Allocate payment to invoice lines (if partial payment)
- Auto-allocate to oldest invoices first (configurable)

**Payment Status Update:**
- Update `amount_paid`, `amount_due`
- Update status to `PARTIALLY_PAID` or `FULLY_PAID`
- Set `first_payment_date`, `last_payment_date`, `fully_paid_at`

---

### F) Customer-Facing View (Print / PDF / Email)

Invoice document includes:

- Company details and logo
- Invoice number and date
- Customer details
- Billing and shipping addresses
- Line items with quantities & prices
- Taxes & totals
- Payment terms and due date
- Payment instructions (bank details, QR code)
- Notes to customer
- Company signature block

System must support generating:
- PDF
- Email with attached PDF
- Customer portal view
- Print-friendly format

---

## 6.3.4 Validation Rules

**Header-level:**

- `customer_id` + `invoice_number` combination must be unique (or flagged duplicate)
- `invoice_date` must be <= `posting_date` (if posting date used)
- `due_date` must be >= `invoice_date`
- Total of invoice lines must reconcile with `subtotal`, `tax_amount`, and `grand_total` (allow small rounding difference config)
- If matching model requires Order:
  - At least one order is linked or resolvable
- If matching model requires Shipment:
  - At least one shipment is linked or resolvable
- If `invoice_type = CREDIT_NOTE`:
  - Must reference original invoice
  - Amount must be <= original invoice amount

**Line-level:**

- `quantity_invoiced > 0`
- If mapped to order line:
  - `quantity_invoiced + already_invoiced_qty <= shipped_qty * (1 + qty_tolerance_percent)`
- If mapped to shipment line:
  - Cannot invoice beyond delivered quantity
- Price variance vs Order:
  - If beyond tolerance, line flagged as exception; invoice cannot move to MATCHED until resolved

**Matching/Status-level:**

- Invoice cannot be set to `MATCHED` unless:
  - All lines are either:
    - Matched within tolerance, or
    - Exception is flagged and routed for approval
- Cannot SEND to Customer unless:
  - Status is `APPROVED`
- Cannot POST to Finance unless:
  - Status is `APPROVED`
- Cannot record payment unless:
  - Status is `SENT_TO_CUSTOMER` or `APPROVED`

**[NEW] Revision & Versioning:**

- If creating a revision (parent_invoice_id is set):
  - `revision_number` = parent's revision_number + 1
  - `revision_reason` is required
  - Parent invoice's `is_latest_revision` must be set to false
  - Only invoices with `is_latest_revision = true` can be sent to customer

**[NEW] Margin Protection:**

- If `enforce_margin_check = true` (config):
  - If `gross_margin_pct < minimum_margin_threshold` (from config):
    - If `margin_action = REQUIRE_APPROVAL`: Require approval
    - If `margin_action = BLOCK`: Block submission

**[NEW] Revenue Recognition:**

- If `revenue_recognition_method = ON_PAYMENT`:
  - Revenue recognized only when payment received
- If `revenue_recognition_method = ON_DELIVERY`:
  - Revenue recognized when shipment delivered
- If `revenue_recognition_method = ON_INVOICE`:
  - Revenue recognized when invoice approved

**Config behavior:**

- If `auto_send_invoice_on_approval = true`:
  - Invoice automatically sent to customer after approval
- If `auto_generate_invoice_on_shipment = true`:
  - Invoice automatically created when shipment is completed
- If `allow_partial_invoicing = false`:
  - Must invoice entire order at once

---

## 6.3.5 Workflow

**Default:**

- `DRAFT`  
  → **Validate** (auto-match attempt) → `VALIDATED`  
  → If fully matched within tolerance → `APPROVED`  
  → **Send to Customer** → `SENT_TO_CUSTOMER`  
  → **Record Payment (Partial)** → `PARTIALLY_PAID`  
  → **Record Payment (Full)** → `FULLY_PAID`  
  → **Overdue Check** (batch job) → `OVERDUE` (if unpaid past due date)  
  → **Write Off** → `WRITTEN_OFF`  
  → **Cancel** → `CANCELLED`

**Exception path:**

- `VALIDATED` → match variance outside tolerance → `EXCEPTION`  
  → Send to approver → `APPROVAL_PENDING` → `APPROVED` or `REJECTED`  
  → If approved, can still be SENT with variances documented

**Rejection path:**

- `EXCEPTION` / `APPROVAL_PENDING` → `REJECTED` (if invoice is disputed with customer)

**Cancellation:**

- `DRAFT` / `VALIDATED` → `CANCELLED` (if captured incorrectly or voided)

**Detailed Transitions:**

1. **DRAFT → VALIDATED**:
   - Trigger: User clicks "Validate" or auto-validation on save
   - Validations: All required fields filled, lines present
   - Actions: Run auto-match against orders/shipments, calculate variances

2. **VALIDATED → APPROVED**:
   - Trigger: Auto (if no variances) or Approver clicks "Approve"
   - Validations: Match status acceptable, within tolerances
   - Actions: Set approved_by, approved_at, capture approval_rule_snapshot

3. **APPROVED → SENT_TO_CUSTOMER**:
   - Trigger: User clicks "Send to Customer" (or auto if config)
   - Validations: Invoice approved, customer email exists
   - Actions: Generate PDF, send email, set sent_to_customer_at, sent_channel

4. **SENT_TO_CUSTOMER → PARTIALLY_PAID**:
   - Trigger: Payment recorded (partial amount)
   - Validations: Payment amount > 0, payment amount < grand_total
   - Actions: Update amount_paid, amount_due, set first_payment_date

5. **PARTIALLY_PAID → FULLY_PAID**:
   - Trigger: Final payment recorded
   - Validations: amount_paid >= grand_total
   - Actions: Update status, set fully_paid_at, trigger revenue recognition

6. **SENT_TO_CUSTOMER → OVERDUE**:
   - Trigger: Automated batch job (daily check)
   - Validations: due_date < today, amount_due > 0
   - Actions: Update overdue_days, increment dunning_level, send reminder

7. **OVERDUE → WRITTEN_OFF**:
   - Trigger: User clicks "Write Off" (or auto for small amounts)
   - Validations: Approval required (if amount > threshold)
   - Actions: Set write_off_amount, write_off_reason, write_off_date, update AR

**Config variations:**

- If `auto_send_invoice_on_approval = true`:
  - `APPROVED → SENT_TO_CUSTOMER` automatically
- If `auto_generate_invoice_on_shipment = true`:
  - Invoice created in `DRAFT` when shipment completed
- If `auto_recognize_revenue = true`:
  - Revenue recognized automatically based on `revenue_recognition_method`

**[NEW] Revision Workflow:**

New transition:
- **SENT_TO_CUSTOMER → DRAFT (Revision)**:
  - Trigger: User clicks "Create Revision" (for corrections)
  - Validations: `invoice_revision_enabled = true` (config), no payments yet
  - Actions:
    - Set current invoice's `is_latest_revision = false`
    - Create new invoice with:
      - `parent_invoice_id` = current invoice ID
      - `revision_number` = parent's revision_number + 1
      - `invoice_status = DRAFT`
      - `is_latest_revision = true`
      - Copy all lines from parent
    - Notify customer of revision

**[NEW] Credit Note Workflow:**

- **FULLY_PAID → DRAFT (Credit Note)**:
  - Trigger: User clicks "Generate Credit Note"
  - Validations: Original invoice exists, reason provided
  - Actions:
    - Create new invoice with:
      - `invoice_type = CREDIT_NOTE`
      - `parent_invoice_id` = original invoice ID
      - Negative amounts
      - Copy relevant lines
    - Update original invoice AR balance

**[NEW] Dunning Process:**

- **OVERDUE → OVERDUE (Escalation)**:
  - Trigger: Automated dunning schedule (e.g., 7, 14, 30 days overdue)
  - Actions:
    - Increment `dunning_level`
    - Send escalated reminder
    - Set `last_dunning_date`
    - Notify sales person and management (at higher levels)

---

## 6.3.6 Module Metadata & Build Steps

### Module Metadata

```yaml
module_type: transaction
complexity: medium

template_ref: _txn_02

extension_allowed: true

depends_on:
  - Company
  - Locations
  - Customer Master
  - Item Master
  - Item Variants
  - Units of Measure
  - Tax Configuration
  - Users / Roles
  - Sales Order (6.2)
  - Shipment Management
  - Payment Gateway

used_by:
  - Payment & Settlement
  - Revenue Recognition
  - Accounts Receivable (AR)
  - Customer Credit Management
  - Sales Analytics / Reporting
  - Tax & Compliance Reporting

integrates_with:
  - Email Service (for invoice delivery)
  - PDF Generation Service
  - Customer Portal
  - Payment Gateway (for online payments)
  - Accounting System (GL posting)
  - Dunning & Collections System

notes: >
  Sales Invoice is the revenue recognition document that validates
  invoices against orders and shipments before posting to AR.
  It supports approval workflows, partial invoicing, payment tracking,
  dunning, and serves as the anchor for customer payments and
  revenue recognition. It is hybrid-configurable, allowing
  organizations to invoice based on orders, shipments, milestones,
  or time periods.

You are building a Medium Complexity Transaction module for a Retail ERP.

Module: Sales Invoice
Template: _txn_02

Requirements:

1) Backend (Django + DRF):
   - Models:
     - sales_invoice (header)
     - sales_invoice_line (lines)
     - sales_invoice_match_detail (matching details)
   - Serializers:
     - Invoice header with nested lines
     - Matching detail serializer
   - Viewsets & Endpoints:
     - Capture invoice (CRUD while in DRAFT)
     - Auto-match endpoint:
       - Tries to match lines to Order/Shipment using configured rules
     - Manual match endpoint:
       - For user-driven mapping
     - Workflow:
       - validate_invoice
       - approve_invoice
       - reject_invoice
       - send_to_customer
       - record_payment
       - generate_credit_note
       - write_off_invoice
       - post_invoice (integration handoff to Finance/AR)
   - Business Rules:
     - Enforce uniqueness and tolerance rules
     - Keep aggregated match_variance_amount up to date
     - Respect configuration for match type and tolerance per customer type
     - Auto-generate invoices from orders/shipments (if configured)
     - Auto-send invoices on approval (if configured)
     - Dunning process automation

2) Frontend (React + Vite + Tailwind):
   - Screens:
     - Invoice List (filters, status indicators, payment status)
     - Invoice Capture/Edit:
       - Header + lines + basic references
     - Matching View:
       - Side-by-side comparison of invoice vs Order vs Shipment
     - Payment Recording:
       - Payment entry and allocation
     - Credit Note Generation
   - Behavior:
     - Display clear variance warnings
     - Block approval/posting when rules are violated
     - Support inline justification capture for overrides
     - Show payment status and aging
     - Dunning alerts for overdue invoices

3) Integration:
   - Upstream:
     - Fetch Orders and Shipments for customer and date window
   - Downstream:
     - Expose approved invoices to Payment module
     - Provide revenue data to Finance/AR
     - Feed customer credit management
   - External:
     - Email service for invoice delivery
     - PDF generation for invoice documents
     - Payment gateway for online payments

4) Security & Roles:
   - Roles:
     - Invoice Creator
     - Invoice Approver
     - Payment Recorder
     - AR Manager
     - Finance Poster

Ensure full fidelity with the data, workflow, and validation rules
defined in the Sales Invoice specification.


MODULE: Sales Invoice
TYPE: Transaction (Medium, _txn_02)

DATA MODEL:
- Header: company, invoice_number, customer, status, dates (invoice_date, due_date),
  pricing (subtotal, discount, shipping, tax, grand_total), payment tracking
  (amount_paid, amount_due), match status, approval flags, dunning tracking,
  revenue recognition, revision tracking, margin tracking, audit fields
- Lines: item_variant, UOM, quantity_invoiced, unit_price_invoiced, discount, tax,
  line_total, price_source, cost_price, margin
- Match Detail: Links to order/shipment lines with variance tracking

WORKFLOW:
- DRAFT → VALIDATED → APPROVED → SENT_TO_CUSTOMER → PARTIALLY_PAID /
  FULLY_PAID / OVERDUE → WRITTEN_OFF / CANCELLED
- Exception path for variances outside tolerance
- Revision workflow for invoice corrections
- Credit note generation for returns/adjustments
- Automated dunning for overdue invoices

UI:
- List + Edit screens with clear separation of header, lines, matching, payments
- Matching view (invoice vs order vs shipment)
- Payment recording and allocation
- Dunning and collections tracking
- Credit note generation
- Customer-facing invoice documents (PDF, email)

Use template _txn_02 and generate:

- Django models, serializers, viewsets, URLs for Invoice header + lines +
  match detail
- React pages for:
  - Invoice list
  - Invoice edit (header + lines + matching + approval info)
  - Payment recording
  - Credit note generation
  - Invoice PDF preview
- Axios API service for all operations (CRUD + workflow + matching + payments)

Enforce all validation and workflow rules described in the
Sales Invoice specification.
