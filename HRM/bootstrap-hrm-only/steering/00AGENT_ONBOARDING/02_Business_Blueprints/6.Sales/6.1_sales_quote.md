# 6.1 Sales Quotation (Quote)
Template Ref: _txn_02 (Medium Transaction)

## 6.1.1 Business Purpose

The **Sales Quotation (Quote)** is a **formal offer** to sell goods/services to a customer at specified prices and terms, valid for a defined period. It serves as a pre-sales document that can be converted into a Sales Order upon customer acceptance.

Goals:

- Capture *customer demand* (what, how much, at what price, valid until when) before committing to a sale.
- Enable **approval workflows** for pricing, discounts, and special terms (optional, configurable).
- Support both:
  - Organizations that use **Quote → Sales Order**
  - Organizations that create **Sales Order directly** (Quote disabled)
- Provide an audit trail of *who created*, *who approved*, *pricing offered*, and *when it converted to Sales Order*.
- Track quote win/loss for sales analytics and forecasting.

Hybrid behavior (config-driven):

- Quote can be **enabled/disabled** per:
  - Company
  - Location
  - Sales Channel
  - Customer Type
- When enabled, Sales Order may:
  - Require a Quote reference (hard rule), or
  - Allow direct Sales Order (soft rule).
- Pricing approval thresholds can be configured based on:
  - Discount percentage
  - Total quote value
  - Customer credit limit

---

## 6.1.2 Data Model

### A) Quote Header (`sales_quote`)

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| quote_number         | String(30)   | Yes      | Human-readable Quote No (auto-generated, e.g., QT-00000001) |
| quote_status         | Enum         | Yes      | `DRAFT`, `SUBMITTED`, `APPROVED`, `SENT_TO_CUSTOMER`, `ACCEPTED`, `REJECTED`, `EXPIRED`, `PARTIALLY_CONVERTED`, `FULLY_CONVERTED`, `CANCELLED` |
| customer_id          | FK (Customer)| Yes      | Customer reference |
| quote_date           | Date         | Yes      | Date of quote creation |
| valid_until_date     | Date         | Yes      | Quote expiry date |
| sales_person_id      | FK (User)    | No       | Sales representative |
| location_id          | FK (Location)| Yes      | Selling location/branch |
| payment_terms        | String(100)  | No       | Payment terms (e.g., "Net 30", "50% advance") |
| delivery_terms       | String(100)  | No       | Delivery terms (e.g., "FOB", "CIF") |
| shipping_address     | Text         | No       | Delivery address (can differ from customer default) |
| billing_address      | Text         | No       | Billing address |
| currency_code        | String(3)    | Yes      | Currency (e.g., USD, INR) |
| subtotal             | Decimal      | Yes      | Sum of line totals before tax |
| discount_percent     | Decimal      | No       | Header-level discount % |
| discount_amount      | Decimal      | No       | Header-level discount amount |
| tax_amount           | Decimal      | Yes      | Total tax amount |
| grand_total          | Decimal      | Yes      | Final quote amount |
| remarks              | Text         | No       | Internal notes |
| customer_notes       | Text         | No       | Notes visible to customer |
| approval_required    | Boolean      | Yes      | Flag (from config): whether approval is needed |
| approved_by_user_id  | FK (User)    | No       | Set when approved |
| approved_at          | DateTime     | No       | Timestamp of approval |
| rejected_by_user_id  | FK (User)    | No       | Rejection user (if any) |
| rejected_at          | DateTime     | No       | Rejected timestamp |
| rejection_reason     | Text         | No       | Reason for rejection |
| sent_to_customer_at  | DateTime     | No       | When quote was sent to customer |
| customer_response_date | Date       | No       | When customer accepted/rejected |
| converted_to_order   | Boolean      | Yes      | True if Sales Order created from this Quote |
| sales_order_id       | FK (SalesOrder) | No    | Reference to created Sales Order |
| win_loss_reason      | Text         | No       | Reason for win/loss (for analytics) |
| created_by_user_id   | FK (User)    | Yes      | Who created the quote |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |
| deleted_at           | DateTime     | No       | Soft delete timestamp |
| parent_quote_id      | FK (sales_quote) | No    | [NEW] Reference to original quote if this is a revision |
| revision_number      | Integer       | Yes      | [NEW] Version number (default: 1, increments on revision) |
| is_latest_revision   | Boolean       | Yes      | [NEW] True only for current active revision (default: true) |
| revision_reason      | Text          | No       | [NEW] Reason for creating revision (required if revision_number > 1) |
| cost_price_total     | Decimal       | No       | [NEW] Sum of line-level cost prices (read-only/computed) |
| gross_margin_pct     | Decimal       | No       | [NEW] ((grand_total - cost_price_total) / grand_total) × 100 |
| customer_response_mode | Enum        | No       | [NEW] `PORTAL`, `EMAIL_CONFIRMATION`, `MANUAL_ENTRY` |
| approval_rule_snapshot | JSON        | No       | [NEW] Captures discount %, threshold, approver role, rule version at approval time |
| quote_pdf_url        | String(500)   | No       | [NEW] URL/path to generated PDF |
| last_sent_to_email   | String(255)   | No       | [NEW] Email address where quote was last sent |
| sent_channel         | Enum          | No       | [NEW] `EMAIL`, `PORTAL`, `WHATSAPP`, `PRINT` |

> Note: Pricing can be based on customer-specific price lists, promotional pricing, or negotiated rates.
> [NEW] Revision tracking enables quote versioning after customer communication.
> [NEW] Margin visibility supports pricing approval workflows.

---

### B) Quote Line (`sales_quote_line`)

Each line = quoted item/variant + quantity + pricing.

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| sales_quote_id        | FK (Quote Header) | Yes      | Header link |
| line_number           | Integer           | Yes      | Line sequence number |
| item_id               | FK (Item)         | Yes      | Parent item |
| item_variant_id       | FK (Item Variant) | Yes      | SKU reference |
| uom_id                | FK (UOM)          | Yes      | Unit of measure |
| quantity              | Decimal           | Yes      | Quoted quantity |
| unit_price            | Decimal           | Yes      | Price per unit |
| discount_percent      | Decimal           | No       | Line-level discount % |
| discount_amount       | Decimal           | No       | Line-level discount amount |
| tax_percent           | Decimal           | No       | Tax percentage |
| tax_amount            | Decimal           | Yes      | Calculated tax amount |
| line_total            | Decimal           | Yes      | (quantity × unit_price) - discount + tax |
| delivery_date         | Date              | No       | Promised delivery date |
| line_remarks          | Text              | No       | Line-specific notes |
| line_status           | Enum              | Yes      | `ACTIVE`, `CANCELLED` |
| price_source         | Enum          | Yes      | [NEW] `PRICE_LIST`, `PROMOTION`, `MANUAL_OVERRIDE` (default: PRICE_LIST) |
| price_list_id        | FK (PriceList)| No       | [NEW] Reference to price list used (if price_source = PRICE_LIST) |
| override_reason      | Text          | No       | [NEW] Required if price_source = MANUAL_OVERRIDE |
| cost_price           | Decimal       | No       | [NEW] Unit cost price (for margin calculation, read-only) |
| gross_margin_pct     | Decimal       | No       | [NEW] ((unit_price - cost_price) / unit_price) × 100 |
| created_at            | DateTime          | Auto     |  |
| updated_at            | DateTime          | Auto     |  |

---

### C) Quote–Order Link (`sales_quote_order_link`)

Tracks which Sales Order lines were created from a Quote.

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| quote_line_id         | FK (Quote Line)   | Yes      | Quote line |
| sales_order_id        | FK (Sales Order)  | Yes      | Sales Order header |
| order_line_id         | FK (Order Line)   | Yes      | Sales Order line |
| ordered_qty_from_quote| Decimal           | Yes      | Quantity ordered against this quote line |
| created_at            | DateTime          | Auto     |  |

This table will be fully used in **6.2 Sales Order** spec.

> [NEW] **Partial Conversion Support**: `remaining_qty` = `quote_line.quantity` − SUM(`ordered_qty_from_quote`) for all links to this quote_line (computed/derived field)

---

### D) Config / Control (Conceptual)

This may live in a generic config table or YAML, but logically:

**[EXISTING]**
- `quote_enabled` (Company, Location, Sales Channel)
- `quote_required_for_order` (Company, Location)
- `quote_approval_required` (Company, Role, Discount Threshold, Value Threshold)
- `quote_validity_days` (Company, default: 30 days)
- `auto_expire_quotes` (Boolean, default: true)

**[NEW] Revision & Conversion Control:**
- `quote_revision_enabled` (Boolean, default: true)
- `max_revisions` (Integer, default: 5)
- `allow_partial_conversion` (Boolean, default: true)
- `require_customer_acceptance` (Boolean, default: false)

**[NEW] Margin Protection:**
- `enforce_margin_check` (Boolean, default: false)
- `minimum_margin_threshold` (Decimal, percentage, e.g., 15.0)
- `margin_action` (Enum: `REQUIRE_APPROVAL`, `BLOCK`)

**[NEW] Expiry Control:**
- `expiry_action` (Enum: `BLOCK`, `ALLOW_WITH_WARNING`, default: ALLOW_WITH_WARNING)

---

## 6.1.3 UI / UX Requirements

**Screen Name:** Sales Quotation  
**Path:** Sales → Quotations

### A) Quote List

Columns:

- Quote Number
- Quote Date
- Customer Name
- Sales Person
- Valid Until
- Status
- Grand Total
- Converted to Order? (Yes/No)
- Actions

Filters:

- Date range (quote_date)
- Customer
- Status
- Sales Person
- Location
- Expiry status (Active / Expired)
- Conversion status (Converted / Not Converted)

Actions:

- Create Quote
- View / Edit (based on status & role)
- Submit for approval
- Approve / Reject (for approvers)
- Send to Customer (email/PDF)
- Convert to Sales Order
- Mark as Won / Lost
- Cancel (with reason)
- Duplicate Quote

---

### B) Quote Header Form

Sections:

- **General Information**
  - Quote Number (auto-generated, read-only)
  - Quote Date (default: today)
  - Valid Until Date (default: today + 30 days)
  - Customer (lookup with search)
  - Sales Person (default: current user, editable)
  - Location (default: user's location)

- **Pricing & Terms**
  - Currency
  - Payment Terms
  - Delivery Terms
  - Header Discount % / Amount

- **Addresses**
  - Shipping Address (default from customer, editable)
  - Billing Address (default from customer, editable)

- **Notes**
  - Internal Remarks (not visible to customer)
  - Customer Notes (visible on quote document)

- **Totals** (calculated, read-only)
  - Subtotal
  - Discount
  - Tax
  - Grand Total

- **System Info** (read-only)
  - Status
  - Approval Required? (Yes/No)
  - Approved By / At
  - Rejected By / At
  - Sent to Customer At
  - Converted to Order? (Sales Order link)

---

### C) Quote Line Entry

Grid:

- Line #
- Item Code / Name (search with autocomplete)
- SKU / Variant (if applicable)
- UOM (default to sales UOM)
- Quantity
- Unit Price (from price list or manual entry)
- Discount % / Amount
- Tax %
- Line Total (calculated)
- Delivery Date
- Line Remarks
- Actions (Edit, Delete, Copy)

Features:

- Add line via:
  - Item search
  - Barcode scan (optional)
  - Quick add from favorites
- Copy line
- Delete line (only in Draft / Submitted but not yet sent to customer)
- Inline validation:
  - Non-zero quantity
  - Valid pricing (not below cost, if configured)
  - UOM consistency
- Bulk pricing update
- Apply price list
- Calculate totals automatically

---

### D) Approver View

Approvers get:

- List of **Quotes in SUBMITTED** state filtered by:
  - Location(s) they manage
  - Approval threshold (discount % or total value)

From detail view:

- Approve (with optional comment)
- Reject (reason required)
- Request pricing revision
- Partial edit allowed? (**config option**; default: can adjust pricing within limits)

---

### E) Customer-Facing Actions

- **Send to Customer**:
  - Generate PDF quote document
  - Email to customer with tracking
  - Mark status as `SENT_TO_CUSTOMER`

- **Customer Response**:
  - Mark as Accepted (with date)
  - Mark as Rejected (with reason)
  - Record win/loss reason for analytics

---

## 6.1.4 Validation Rules

Header-level:

- `quote_number` unique per company.
- `customer_id` required and must be active.
- `valid_until_date` must be >= `quote_date`.
- `grand_total` must equal calculated sum of line totals.
- If `approval_required = true`, then:
  - Only users with **approval role** can move `SUBMITTED → APPROVED / REJECTED`.
- Cannot send to customer if status < `APPROVED` (if approval required).

Line-level:

- Each Quote must have at least **one line**.
- `quantity > 0`.
- `unit_price >= 0` (can be zero for promotional items).
- `item_variant_id` + `uom_id` must be valid from Item + UOM configuration.
- Cannot modify lines once status >= `SENT_TO_CUSTOMER` except:
  - Allowed fields (e.g., internal remark), depending on config.
- Discount validation:
  - If `discount_percent > threshold`, approval required.
  - Cannot exceed maximum discount % (from config).

Status/Workflow integrity:

- Cannot Submit a Quote with **no lines**.
- Cannot Approve a Quote with status not equal to `SUBMITTED`.
- Cannot Send to Customer if status not equal to `APPROVED` (or `DRAFT` if approval not required).
- Cannot Convert to Order if:
  - Status not in [`APPROVED`, `SENT_TO_CUSTOMER`, `ACCEPTED`]
  - Quote is expired (valid_until_date < today)
- Auto-expire quotes:
  - Batch job to move `SENT_TO_CUSTOMER` → `EXPIRED` if `valid_until_date` < today.

Pricing validation:

- Unit price cannot be below cost (if `enforce_minimum_margin = true`).
- Total discount cannot exceed customer credit limit (if configured).
- Currency must match customer's default currency (or allow multi-currency with conversion).

Config behavior:

- If `quote_enabled = false` for a company/location:
  - Quote screen is hidden or blocked.
- If `quote_required_for_order = true`:
  - Sales Order must reference a Quote (will be enforced in 6.2).

**[NEW] Revision & Versioning:**
- If creating a revision (parent_quote_id is set):
  - `revision_number` = parent's revision_number + 1
  - `revision_reason` is required
  - Parent quote's `is_latest_revision` must be set to false
  - Only quotes with `is_latest_revision = true` can be converted to Sales Order

**[NEW] Price Override:**
- If `price_source = MANUAL_OVERRIDE`:
  - `override_reason` is required (min 10 characters)
  - May trigger approval based on config threshold

**[NEW] Margin Protection:**
- If `enforce_margin_check = true` (config):
  - If `gross_margin_pct < minimum_margin_threshold` (from config):
    - If `margin_action = REQUIRE_APPROVAL`: Require approval
    - If `margin_action = BLOCK`: Block submission

**[NEW] Expiry with Soft/Hard Control:**
- On conversion attempt after `valid_until_date`:
  - If `expiry_action = BLOCK` (config): Hard stop, cannot convert
  - If `expiry_action = ALLOW_WITH_WARNING` (config): Allow with justification required

**[NEW] Customer Response Mode:**
- If `require_customer_acceptance = true` (config):
  - Cannot convert to order unless `customer_response_mode` is set and status = `ACCEPTED`

**[NEW] Approval Snapshot:**
- When quote moves to `APPROVED`:
  - Capture `approval_rule_snapshot` as JSON with discount %, threshold, approver role, rule version, timestamp

---

## 6.1.5 Workflow

**Hybrid, config-driven workflow:**

Default state machine:

- `DRAFT`  
  → **Submit** → `SUBMITTED`  
  → **Approve** → `APPROVED`  
  → **Reject** → `REJECTED`  
  → **Send to Customer** → `SENT_TO_CUSTOMER`  
  → **Customer Accepts** → `ACCEPTED`  
  → **Customer Rejects** → `REJECTED`  
  → **Convert to Order** → `CONVERTED`  
  → **Cancel** → `CANCELLED` (from DRAFT/SUBMITTED/APPROVED if allowed)  
  → **Auto-Expire** → `EXPIRED` (if valid_until_date passed)

**Detailed Transitions:**

1. **DRAFT → SUBMITTED**:
   - Trigger: User clicks "Submit for Approval"
   - Validations: Must have lines, all required fields filled
   - Actions: Set submitted timestamp, notify approvers

2. **SUBMITTED → APPROVED**:
   - Trigger: Approver clicks "Approve"
   - Validations: User has approval role, within approval limits
   - Actions: Set approved_by, approved_at, notify sales person

3. **SUBMITTED → REJECTED**:
   - Trigger: Approver clicks "Reject"
   - Validations: Rejection reason required
   - Actions: Set rejected_by, rejected_at, rejection_reason, notify sales person

4. **APPROVED → SENT_TO_CUSTOMER**:
   - Trigger: User clicks "Send to Customer"
   - Validations: Customer email exists, quote is approved
   - Actions: Generate PDF, send email, set sent_to_customer_at

5. **SENT_TO_CUSTOMER → ACCEPTED**:
   - Trigger: Customer accepts (via portal or manual entry)
   - Validations: Quote not expired
   - Actions: Set customer_response_date, enable "Convert to Order"

6. **SENT_TO_CUSTOMER → EXPIRED**:
   - Trigger: Automated batch job (daily)
   - Validations: valid_until_date < today
   - Actions: Update status, notify sales person

7. **ACCEPTED → CONVERTED**:
   - Trigger: User clicks "Convert to Sales Order"
   - Validations: Quote accepted, not expired
   - Actions: Create Sales Order, link via quote_order_link, set converted_to_order = true, sales_order_id

**Config variations:**

- If `quote_approval_required = false`:
  - `DRAFT → APPROVED` directly when user submits.
- If `auto_expire_quotes = false`:
  - Quotes remain in `SENT_TO_CUSTOMER` indefinitely.
- In very simple setups:
  - Only `DRAFT → APPROVED → SENT_TO_CUSTOMER → CONVERTED` + `CANCELLED`.

**Win/Loss Tracking:**

- When quote is `CONVERTED` or `FULLY_CONVERTED`: Mark as "Won" with reason (optional).
- When quote is `REJECTED` or `EXPIRED`: Mark as "Lost" with reason (required for analytics).

**[NEW] Revision Workflow:**

New transition:
- **SENT_TO_CUSTOMER → DRAFT (Revision)**:
  - Trigger: User clicks "Create Revision"
  - Validations: `quote_revision_enabled = true` (config)
  - Actions:
    - Set current quote's `is_latest_revision = false`
    - Create new quote with:
      - `parent_quote_id` = current quote ID
      - `revision_number` = parent's revision_number + 1
      - `quote_status = DRAFT`
      - `is_latest_revision = true`
      - Copy all lines from parent
    - Notify sales person

**[NEW] Partial Conversion:**

Modified transitions:
- **ACCEPTED → PARTIALLY_CONVERTED**:
  - Trigger: Sales Order created from Quote (partial lines)
  - Validations: `allow_partial_conversion = true` (config)
  - Actions:
    - Update `remaining_qty` for each quote line
    - If any line has `remaining_qty > 0`: status = `PARTIALLY_CONVERTED`
    - If all lines have `remaining_qty = 0`: status = `FULLY_CONVERTED`
    - Create entries in `sales_quote_order_link`

- **PARTIALLY_CONVERTED → FULLY_CONVERTED**:
  - Trigger: Additional Sales Order(s) consume remaining quote lines
  - Validations: All lines have `remaining_qty = 0`
  - Actions: Update status, mark `converted_to_order = true`

**[NEW] Enhanced Expiry Handling:**

Modified auto-expiry:
- **SENT_TO_CUSTOMER → EXPIRED**:
  - Trigger: Automated batch job (daily) OR manual check on conversion attempt
  - Validations: `valid_until_date < today`
  - Actions:
    - If `expiry_action = BLOCK`: Update status to `EXPIRED`, prevent conversion
    - If `expiry_action = ALLOW_WITH_WARNING`: Flag as expired but allow conversion with justification

---

## 6.1.6 Module Metadata & Build Steps

### Module Metadata

```yaml
module_type: transaction
complexity: medium

template_ref: _txn_02

extension_allowed: true

depends_on:
  - Company
  - Locations
  - Customer Master
  - Item Master
  - Item Variants
  - Units of Measure
  - Price Lists
  - Tax Configuration
  - Users / Roles

used_by:
  - Sales Order (6.2)
  - Sales Analytics / Reporting
  - CRM (Customer Relationship Management)
  - Approvals & Workflow Engine

integrates_with:
  - Email Service (for sending quotes)
  - PDF Generation Service
  - Customer Portal (for quote acceptance)
  - Pricing Engine
  - Inventory (for stock availability check)

notes: >
  Sales Quotation is a pre-sales document that captures customer demand
  with pricing and terms. It supports approval workflows for pricing
  validation and serves as a feeder document to Sales Orders.
  It is hybrid-configurable, allowing organizations to either strictly
  enforce Quote→Order or bypass Quote entirely.

You are building a Medium Complexity Transaction module for a Retail ERP.

Module: Sales Quotation (Quote)
Template: _txn_02

Requirements:

1) Backend (Django + DRF):
   - Models:
     - sales_quote (header)
     - sales_quote_line (lines)
     - sales_quote_order_link (link to Sales Order, to be used by 6.2)
   - Serializers for header + lines (nested or separate)
   - Viewsets with:
     - Filter by company, location, customer, status, sales_person, date range
     - Actions/endpoints for:
       - submit_quote
       - approve_quote
       - reject_quote
       - send_to_customer
       - mark_accepted
       - mark_rejected
       - convert_to_order
       - cancel_quote
       - duplicate_quote
   - Business rules for:
     - Status transitions
     - Pricing and discount validation
     - Quote expiry automation
     - Hybrid configuration flags (quote_enabled, approval_required)

2) Frontend (React + Vite + Tailwind):
   - Quote List Page:
     - Filters (date, status, customer, sales person, location)
     - Basic search (quote number, customer name)
     - Quick actions (view, edit, send, convert)
   - Quote Edit Page:
     - Header form (customer, dates, terms, addresses)
     - Lines grid with add/edit/delete
     - Pricing calculations (subtotal, discount, tax, total)
     - Buttons:
       - Save as Draft
       - Submit for Approval
       - Approve / Reject (for approvers)
       - Send to Customer
       - Convert to Sales Order
       - Mark as Won / Lost
       - Cancel (with confirmation)
   - Quote PDF Preview/Print
   - Show read-only sections for approvals and order linkage

3) Integration:
   - Axios service for all Quote CRUD & workflow endpoints
   - PDF generation service integration
   - Email service integration
   - Design response structures so that Sales Order (6.2) can:
     - Search for ACCEPTED/APPROVED Quotes
     - Consume Quote lines and create Order lines
     - Update quote status to CONVERTED


MODULE: Sales Quotation
TYPE: Transaction (Medium, _txn_02)

DATA MODEL:
- Header: company, quote_number, customer, status, dates (quote_date, valid_until),
  sales_person, location, pricing (subtotal, discount, tax, grand_total),
  addresses, terms, approval flags, conversion tracking, audit fields
- Lines: item_variant, UOM, quantity, unit_price, discount, tax, line_total,
  delivery_date, status

WORKFLOW:
- DRAFT → SUBMITTED → APPROVED / REJECTED → SENT_TO_CUSTOMER →
  ACCEPTED / REJECTED / EXPIRED → CONVERTED → CANCELLED
- Config flags can simplify: no approval, or mandatory Quote for Order
- Auto-expiry for quotes past valid_until_date

UI:
- List + Edit screens with clear separation of header, lines, pricing, approvals
- Customer-facing actions (send, track response)
- Win/loss tracking for sales analytics

Use template _txn_02 and generate:

- Django models, serializers, viewsets, URLs for Quote header + lines +
  Quote–Order link
- React pages for:
  - Quote list
  - Quote edit (header + lines + pricing + approval info)
  - Quote PDF preview
- Axios API service for all operations (CRUD + workflow)

Enforce all validation and workflow rules described in the
Sales Quotation specification.
