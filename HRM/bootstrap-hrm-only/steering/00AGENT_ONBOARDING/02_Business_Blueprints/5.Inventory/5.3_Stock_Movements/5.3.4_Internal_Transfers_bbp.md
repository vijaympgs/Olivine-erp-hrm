# 5.3.4 Internal Transfers
Template Ref: _txn_02 (Medium Transaction)

## 5.3.4.1 Business Purpose

The **Internal Transfer** module manages the controlled movement of inventory between different locations within the same legal entity (Company). It ensures that stock is physically issued from one location and received at another with a complete audit trail.

**Goals**:
-   **Visibility**: Track goods in transit between locations.
-   **Accountability**: Identify who requested, who shipped, and who received the goods.
-   **Balance Accuracy**: Ensure atomic stock movements (Decrease Source → Increase Destination).
-   **Security**: Prevent unauthorized stock shifting between warehouses/stores.

---

## 5.3.4.2 Data Model

### A) Transfer Header (`inventory_transfer`)

| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | Yes | Primary Key |
| `company_id` | FK (Company) | Yes | Multi-tenant scope |
| `transfer_number` | String(30) | Yes | Auto-generated ID (e.g., TR-2025-001) |
| `status` | Enum | Yes | `DRAFT`, `SUBMITTED`, `APPROVED`, `SHIPPED`, `RECEIVED`, `CANCELLED` |
| `from_location_id` | FK (Location) | Yes | Source warehouse/store |
| `to_location_id` | FK (Location) | Yes | Destination warehouse/store |
| `transfer_date` | Date | Yes | Planned/Actual date of transfer |
| `remarks` | Text | No | General comments |
| `created_by_id` | FK (User) | Yes | Requestor |
| `approved_by_id` | FK (User) | No | Approver |
| `shipped_at` | DateTime | No | Timestamp of issue |
| `received_at` | DateTime | No | Timestamp of receipt |

### B) Transfer Line (`inventory_transfer_line`)

| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | Yes | Primary Key |
| `transfer_id` | FK (Header) | Yes | Parent link |
| `item_variant_id` | FK (ItemVariant) | Yes | SKU being moved |
| `uom_id` | FK (UOM) | Yes | Unit of measure |
| `qty_requested` | Decimal | Yes | Quantity planned |
| `qty_shipped` | Decimal | No | Quantity actually issued |
| `qty_received` | Decimal | No | Quantity actually received |
| `batch_number` | String | No | If batch-tracked |
| `serial_number` | String | No | If serial-tracked (Line per unit) |

---

## 5.3.4.3 UI / UX Requirements

**Screen Name:** Internal Transfers  
**Path:** Inventory → Operation → Internal Transfers

### A) List View
-   **Columns**: Transfer No, Date, From Location, To Location, Status, Total Items.
-   **Filters**: Status, Source Location, Destination, Date Range.

### B) Form View
-   **Header Section**: From/To Location selectors (Source ≠ Destination validation).
-   **Lines Section**:
    -   Item search with "Stock at Source" indicator.
    -   Qty input.
    -   Batch/Serial entry modal if required.
-   **Workflow Buttons**:
    -   "Submit" (Triggers Approval if config enabled).
    -   "Ship" (Decrements Source Stock).
    -   "Receive" (Increments Destination Stock).

---

## 5.3.4.4 Validation Rules

-   **Uniqueness**: `transfer_number` must be unique per company.
-   **Locations**: `from_location_id` cannot be equal to `to_location_id`.
-   **Stock Check**: Cannot ship more than `qty_shipped` if stock is unavailable (based on `allow_negative_stock` config).
-   **Locks**: Cannot edit lines once status ≥ `SHIPPED`.
-   **Batch/Serial**: Force entry if item masters require it.

---

## 5.3.4.5 Workflow

1.  **DRAFT**: Request is created.
2.  **SUBMITTED**: Sent for approval (if configured).
3.  **APPROVED**: Ready for fulfillment.
4.  **SHIPPED**: 
    -   Reduces stock at `from_location`.
    -   Creates `StockMovement` (Type: TRANSFER_OUT).
5.  **RECEIVED**:
    -   Increases stock at `to_location`.
    -   Creates `StockMovement` (Type: TRANSFER_IN).
    -   Matches `qty_received` vs `qty_shipped` (Difference noted in variance report).

---

## 5.3.4.6 Module Metadata & Build Steps

```yaml
module_type: transaction
complexity: medium
template_ref: _txn_02

depends_on:
  - Inventory (Core)
  - Location Master
  - Item Variants
  - Approval Workflow (Generic)

used_by:
  - Stock Views (5.2)
  - Movement History (5.3.1)
```

**Build Instructions**:
1.  **Backend**: Use atomic transactions for the `ship` and `receive` operations.
2.  **Frontend**: Implement a "Receive" button that auto-fills `qty_received` with `qty_shipped` for convenience.
