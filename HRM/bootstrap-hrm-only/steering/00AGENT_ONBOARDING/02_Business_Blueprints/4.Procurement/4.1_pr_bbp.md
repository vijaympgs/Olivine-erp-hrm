
# 4.1 Purchase Requisition (PR)
Template Ref: _txn_02 (Medium Transaction)

## 4.1.1 Business Purpose

The **Purchase Requisition (PR)** is an **internal request** to procure goods/services, raised by a store, warehouse, or department and optionally approved before becoming a Purchase Order.

Goals:

- Capture *demand* (what, how much, by when) before committing to a supplier.
- Enable **approval workflows** (optional, configurable).
- Support both:
  - Organizations that use **PR → PO**
  - Organizations that create **PO directly** (PR disabled)
- Provide an audit trail of *who requested*, *who approved*, and *when it converted to PO*.

Hybrid behavior (config-driven):

- PR can be **enabled/disabled** per:
  - Company
  - Location
  - Role
- When enabled, PO may:
  - Require a PR reference (hard rule), or
  - Allow direct PO (soft rule).

---

## 4.1.2 Data Model

### A) PR Header (`purchase_requisition`)

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| pr_number            | String(30)   | Yes      | Human-readable PR No (per sequence) |
| pr_status            | Enum         | Yes      | `DRAFT`, `SUBMITTED`, `APPROVED`, `PARTIALLY_ORDERED`, `FULLY_ORDERED`, `REJECTED`, `CANCELLED`, `CLOSED` |
| requested_by_user_id | FK (User)    | Yes      | Who raised the PR |
| requesting_location_id | FK (Location) | Yes   | Store/warehouse that needs stock |
| required_by_date     | Date         | No       | Preferred requirement date |
| priority             | Enum         | No       | `LOW`, `NORMAL`, `HIGH`, `URGENT` |
| supplier_hint_id     | FK (Supplier) | No      | Optional preferred supplier |
| remarks              | Text         | No       | Free text comments |
| approval_required    | Boolean      | Yes      | Flag (from config): whether approval is needed |
| approved_by_user_id  | FK (User)    | No       | Set when approved |
| approved_at          | DateTime     | No       | Timestamp of approval |
| rejected_by_user_id  | FK (User)    | No       | Rejection user (if any) |
| rejected_at          | DateTime     | No       | Rejected timestamp |
| converted_to_po      | Boolean      | Yes      | True if any PO created from this PR |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

> Note: Supplier is **hint/optional** here. Final supplier is selected at PO stage.

---

### B) PR Line (`purchase_requisition_line`)

Each line = requested item/variant + quantity.

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| purchase_requisition_id | FK (PR Header) | Yes      | Header link |
| item_id               | FK (Item)         | Yes      | Parent item |
| item_variant_id       | FK (Item Variant) | Yes      | SKU reference |
| uom_id                | FK (UOM)          | Yes      | UOM requested (usually stock UOM) |
| requested_qty         | Decimal           | Yes      | Quantity requested |
| already_ordered_qty   | Decimal           | Yes      | Default 0; updated as POs reference this line |
| required_by_date      | Date              | No       | Line-level override |
| line_remarks          | Text              | No       | Optional notes |
| line_status           | Enum              | Yes      | `OPEN`, `PARTIALLY_ORDERED`, `FULLY_ORDERED`, `CANCELLED` |

---

### C) PR–PO Link (`purchase_requisition_po_link`)

Optional helper to track which PO lines fulfilled a PR.

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| pr_line_id            | FK (PR Line)      | Yes      | PR line |
| po_id                 | FK (Purchase Order) | Yes    | PO header |
| po_line_id            | FK (PO Line)      | Yes      | PO line |
| ordered_qty_from_pr   | Decimal           | Yes      | Quantity ordered against this PR line |

This table will be fully used in **4.2 Purchase Order** spec.

---

### D) Config / Control (Conceptual)

This may live in a generic config table or YAML, but logically:

- `pr_enabled` (Company, Location)
- `pr_required_for_po` (Company, Location)
- `pr_approval_required` (Company, Role, Threshold)

---

## 4.1.3 UI / UX Requirements

**Screen Name:** Purchase Requisition  
**Path:** Procurement → Purchase Requisition

### A) PR List

Columns:

- PR Number
- Date (created_at)
- Requesting Location
- Requested By
- Status
- Supplier Hint (if any)
- Required By (min or header)
- Converted to PO? (Yes/No or %)

Filters:

- Date range
- Location
- Status
- Requesting user
- Approval status (Approved / Pending / Rejected)

Actions:

- Create PR
- View / Edit (based on status & role)
- Submit for approval
- Approve / Reject (for approvers)
- Cancel (with reason)

---

### B) PR Header Form

Sections:

- **General**
  - PR Number (auto)
  - Requesting Location
  - Requested By (auto from user, editable only by admin)
  - Priority
  - Required By Date
  - Supplier Hint (optional)
  - Remarks

- **System Info** (read-only)
  - Status
  - Approval Required? (Yes/No)
  - Approved By / At
  - Rejected By / At

---

### C) PR Line Entry

Grid:

- Item Code / Name search
- SKU / Variant (if applicable)
- UOM (default to stock or purchase UOM)
- Requested Qty
- Required By (line-level)
- Line remarks
- Already Ordered Qty (read-only)
- Line Status (read-only)

Features:

- Add line via:
  - Item search
  - Scan barcode (optional future)
- Copy line
- Delete line (only in Draft / Submitted but not yet approved/ordered)
- Inline validation:
  - Non-zero quantity
  - UOM consistency

---

### D) Approver View

Approvers get:

- List of **PRs in SUBMITTED** state filtered by:
  - Location(s) they manage
  - Approval threshold (optional future)

From detail view:

- Approve (with optional comment)
- Reject (reason required)
- Partial edit allowed? (**config option**; default: can’t change quantities, only approve/reject)

---

## 4.1.4 Validation Rules

Header-level:

- `pr_number` unique per company.
- `requesting_location_id` required.
- `requested_by_user_id` required.
- If `approval_required = true`, then:
  - Only users with **approval role** can move `SUBMITTED → APPROVED / REJECTED`.

Line-level:

- Each PR must have at least **one line**.
- `requested_qty > 0`.
- `item_variant_id` + `uom_id` must be valid from Item + UOM configuration.
- Cannot modify lines once status ≥ `APPROVED` except:
  - Allowed fields (e.g., internal remark), depending on config.

Status/Workflow integrity:

- Cannot Submit a PR with **no lines**.
- Cannot Approve a PR with status not equal to `SUBMITTED`.
- Cannot Cancel a PR if:
  - Any line is `FULLY_ORDERED` (must be Closed instead).
- `already_ordered_qty` must not exceed `requested_qty`.

Config behavior:

- If `pr_enabled = false` for a company/location:
  - PR screen is hidden or blocked.
- If `pr_required_for_po = true`:
  - PO must reference at least one PR line for certain item/location types (will be enforced in 4.2).

---

## 4.1.5 Workflow

**Hybrid, config-driven workflow:**

Default state machine:

- `DRAFT`  
  → **Submit** → `SUBMITTED`  
  → **Approve** → `APPROVED`  
  → **Reject** → `REJECTED`  
  → **Cancel** → `CANCELLED` (from DRAFT/SUBMITTED/APPROVED if allowed)  

Once **PO(s)** are created:

- As PO(s) consume `requested_qty` via PR–PO links:
  - Line status transitions:
    - `OPEN` → `PARTIALLY_ORDERED` → `FULLY_ORDERED`
  - Header status transitions:
    - `APPROVED` → `PARTIALLY_ORDERED` (some lines ordered)
    - `PARTIALLY_ORDERED` → `FULLY_ORDERED` (all lines fully ordered)
- When all lines are **FULLY_ORDERED** or explicitly closed:
  - Header can move to `CLOSED`.

**Config variations:**

- If `pr_approval_required = false`:
  - `DRAFT → SUBMITTED` may directly be treated as `APPROVED`, or
  - Status jumps `DRAFT → APPROVED` when user submits, depending on config.
- In very simple setups:
  - Only `DRAFT → APPROVED → CLOSED` + `CANCELLED`.

---

## 4.1.6 Module Metadata & Build Steps

### Module Metadata

```yaml
module_type: transaction
complexity: medium

template_ref: _txn_02

extension_allowed: true

depends_on:
  - Company
  - Locations
  - Item Master
  - Item Variants
  - Units of Measure
  - Suppliers (hint only)
  - Users / Roles

used_by:
  - Purchase Order (4.2)
  - Inventory Planning (future)
  - Approvals & Workflow Engine (future)
  - Reporting (open PRs, aging, demand vs. supply)

notes: >
  Purchase Requisition is an internal demand capture mechanism with
  optional approval, and acts as a feeder document to Purchase Orders.
  It is hybrid-configurable, allowing organizations to either strictly
  enforce PR→PO or bypass PR entirely.

You are building a Medium Complexity Transaction module for a Retail ERP.

Module: Purchase Requisition (PR)
Template: _txn_02

Requirements:

1) Backend (Django + DRF):
   - Models:
     - purchase_requisition (header)
     - purchase_requisition_line (lines)
     - purchase_requisition_po_link (link to PO, to be used by 4.2)
   - Serializers for header + lines (nested or separate)
   - Viewsets with:
     - Filter by company, location, status, requested_by, date range
     - Actions/endpoints for:
       - submit_pr
       - approve_pr
       - reject_pr
       - cancel_pr
   - Business rules for:
     - Status transitions
     - Quantity and data validation
     - Hybrid configuration flags (pr_enabled, approval_required).

2) Frontend (React + Vite + Tailwind):
   - PR List Page:
     - Filters (date, status, location)
     - Basic search (PR number, requested by)
   - PR Edit Page:
     - Header form (location, requested_by, required_by, priority, supplier hint)
     - Lines grid with add/edit/delete
     - Buttons:
       - Save as Draft
       - Submit
       - Approve / Reject (for approvers)
       - Cancel (with confirmation)
   - Show read-only sections for approvals and PO linkage.

3) Integration:
   - Axios service for all PR CRUD & workflow endpoints.
   - Design response structures so that Purchase Order (4.2) can:
     - Search for APPROVED PRs
     - Consume PR lines and update already_ordered_qty.


MODULE: Purchase Requisition
TYPE: Transaction (Medium, _txn_02)

DATA MODEL:
- Header: company, pr_number, status, requesting_location, requested_by,
  required_by, supplier_hint, approval flags, audit fields.
- Lines: item_variant, UOM, requested_qty, required_by, status, linkage
  fields for ordered quantities.

WORKFLOW:
- DRAFT → SUBMITTED → APPROVED / REJECTED → PARTIALLY_ORDERED /
  FULLY_ORDERED → CLOSED / CANCELLED
- Config flags can simplify: no approval, or mandatory PR for PO.

UI:
- List + Edit screens with clear separation of header, lines, approvals.

Use template _txn_02 and generate:

- Django models, serializers, viewsets, URLs for PR header + lines +
  PR–PO link.
- React pages for:
  - PR list
  - PR edit (header + lines + approval info)
- Axios API service for all operations (CRUD + workflow).

Enforce all validation and workflow rules described in the
Purchase Requisition specification.



