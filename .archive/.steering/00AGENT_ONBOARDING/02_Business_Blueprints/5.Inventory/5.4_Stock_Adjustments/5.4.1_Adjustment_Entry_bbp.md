# 5.4.1 Stock Adjustment Entry
Template Ref: _txn_02 (Medium Transaction)

## 5.4.1.1 Business Purpose

The **Stock Adjustment Entry** module serves as the primary mechanism for manually correcting inventory discrepancies to ensure system records match physical reality. It is a critical control point for maintaining financial and operational integrity.

**Goals**:
-   **Correction**: Adjust stock for shrinkage (theft/loss), damage, expiry, or found items.
-   **Auditability**: Enforce mandatory reason codes for every adjustment to track *why* stock is changing.
-   **Control**: Prevent unauthorized changes via approval workflows (threshold-based).
-   **Financial Accuracy**: Ensure stock value changes are captured for period-end reporting.

**Hybrid behavior (Config-driven)**:
-   **Negative Stock**: Can be enabled/disabled per company.
-   **Approval**: Can be mandatory for all, or only for values > X amount (defined in Approval Rules).

---

## 5.4.1.2 Data Model

### A) Adjustment Header (`stock_adjustment`)

| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | Yes | Primary Key |
| `company_id` | FK (Company) | Yes | Multi-tenant scope |
| `adjustment_number` | String(30) | Yes | Auto-generated ID (e.g., ADJ-2025-001) |
| `location_id` | FK (Location) | Yes | Warehouse/Store where adjustment occurs |
| `adjustment_date` | Date | Yes | Business date of adjustment |
| `status` | Enum | Yes | `DRAFT`, `PENDING_APPROVAL`, `APPROVED`, `REJECTED`, `POSTED` |
| `reference_doc` | String(100) | No | External ref (e.g., police report no.) |
| `remarks` | Text | No | General comments |
| `created_by_id` | FK (User) | Yes | Creator |
| `approved_by_id` | FK (User) | No | Approver |
| `posted_at` | DateTime | No | When stock was actually updated |

### B) Adjustment Line (`stock_adjustment_line`)

Each line represents an item variance.

| Field | Type | Required | Description |
| :--- | :--- | :--- | :--- |
| `id` | UUID | Yes | Primary Key |
| `adjustment_id` | FK (Header) | Yes | Parent link |
| `item_variant_id` | FK (ItemVariant) | Yes | SKU being adjusted |
| `uom_id` | FK (UOM) | Yes | Unit of measure |
| `batch_number` | String | No | If item is batch-tracked |
| `serial_number` | String | No | If item is serial-tracked |
| `qty_adjusted` | Decimal | Yes | Signed quantity (+/-). +5 = Found, -5 = Lost |
| `reason_code_id` | FK (Reason) | Yes | Mandatory classification (Damage, etc.) |
| `unit_cost` | Decimal | Yes | Cost at time of adjustment (snapshot) |
| `line_remarks` | Text | No | Line-specific notes |

---

## 5.4.1.3 UI / UX Requirements

**Screen Name:** Stock Adjustments  
**Path:** Inventory → Operation → Stock Adjustments

### A) Adjustment List (Inquiry)
**Columns**:
- Adjustment No
- Date
- Location
- Status (Color-coded)
- Total Items (Line count)
- Total Value (if perms allow)
- Created By

**Filters**:
- Date Range
- Location (Multi-select)
- Status
- Reason Code (filter by line content)
- Created By

**Actions**:
- Create New
- View / Edit (if Draft)
- Submit for Approval
- Approve / Reject (Manager)
- Post (Finalize)

### B) Adjustment Consoles (Entry)
**Header Section**:
- Location Selector (Locks once lines added)
- Date Picker (Default today)
- Reference / Remarks

**Lines Grid**:
- **Item Search**: Typeahead (SKU/Name/Barcode).
- **Current Stock**: Read-only display of *System Qty* for selected Item+Location.
- **Adjust (+/-)**: Input field.
- **New Qty**: Calculated (System + Adjust).
- **Reason Code**: Dropdown (Mandatory).
- **Batch/Serial**: Popup/Input if item requires it.

**Validation Feedback**:
- Warning if resulting stock < 0 (unless allowed).
- Error if Reason missing.

---

## 5.4.1.4 Validation Rules

**Header Level**:
- `adjustment_date` cannot be in a closed fiscal period.
- `location_id` cannot be changed if lines exist.

**Line Level**:
- `qty_adjusted` cannot be zero.
- `reason_code` is mandatory for every line.
- `batch_number` mandatory if Item is Batch-tracked.
- If `InventoryParameter.allow_negative_stock = False`, then `Current Stock + qty_adjusted` must be >= 0.

**Workflow Integrity**:
- Cannot POST if status != `APPROVED` (or `DRAFT` if no approval needed).
- Cannot Edit if status is `PENDING_APPROVAL`, `APPROVED`, or `POSTED`.
- Cannot Delete if `POSTED`.

---

## 5.4.1.5 Workflow State Machine

**Default Flow**:
1.  `DRAFT`: User creates and saves. Stock not affected.
2.  **Submit**:
    - Checks `ApprovalRule`.
    - If Value/Qty < Threshold -> Auto-transition to `APPROVED`.
    - If Value/Qty > Threshold -> Transition to `PENDING_APPROVAL`.
3.  `PENDING_APPROVAL`: Locked. Manager reviews.
    - **Approve** -> `APPROVED`.
    - **Reject** -> `REJECTED` (Editable to fix).
4.  `APPROVED`: Ready to impact stock.
    - **Post** -> `POSTED`.
5.  `POSTED`:
    - Creates `StockMovement` records (immutable).
    - Updates `Inventory` table.
    - Locks Adjustment record.

---

## 5.4.1.6 Module Metadata & Build Steps

```yaml
module_type: transaction
complexity: medium
template_ref: _txn_02
extension_allowed: true

depends_on:
  - Inventory (Core)
  - Location Master
  - Item Master
  - Reason Codes (5.4.3)
  - Approval Rules (5.10.5)

used_by:
  - Inventory Reports (5.9)
  - Finance (GL Integration - Phase 2)
  - Physical Inventory (5.5 - generates adjustments)

notes: >
  Stock Adjustment is the authoritative way to manually change inventory.
  It must always be accompanied by a Reason Code.
  Posting is the distinct event that updates the stock ledger.
```

**Build Instructions**:

1.  **Backend (Django)**:
    -   Create `StockAdjustment` and `StockAdjustmentLine` models in `domain.inventory`.
    -   Implement `submit`, `approve`, `reject`, `post` actions in ViewSet.
    -   **Critical**: The `post` action must transactional-wrap the creation of `StockMovement` and update of `Inventory`.
    -   Use `inventoryConfigService` to check `allow_negative_stock` logic.

2.  **Frontend (React)**:
    -   List View: Standard `DataTable` with filters.
    -   Detail View: `MasterDetail` pattern.
    -   Use `LocationSelector` to scope item search.
    -   Show "Live Stock" in the grid for reference.
    -   Implement Workflow buttons (Submit, Approve, Post) based on permissions and status.

3.  **Integration**:
    -   Service must handle the compound payload (Header + Lines).
    -   On `POST` success, refresh the Inventory levels view.
