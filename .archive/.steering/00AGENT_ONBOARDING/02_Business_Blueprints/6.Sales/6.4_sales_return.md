# 6.4 Sales Return (RMA – Return Merchandise Authorization)
Template Ref: _txn_02 (Medium Transaction)

## 6.4.1 Business Purpose

The **Sales Return (RMA)** handles returning goods back from customers after they have been delivered, due to:

- Quality failures / Defects
- Damages during shipping
- Wrong items / over-delivery
- Customer dissatisfaction / Change of mind
- Warranty claims
- Near-expiry or regulatory non-compliance

Goals:

- Adjust inventory back into stock or quarantine for inspection.
- Provide a formal Return Merchandise Authorization (RMA) and basis for:
  - Financial credit (Credit Note)
  - Replacement shipments
  - Refund processing
  - Exchange processing
- Feed back into:
  - Customer satisfaction tracking
  - Product quality metrics
  - Warranty claim processing
  - Inventory valuation adjustments
- Support return-to-stock, return-for-repair, and return-for-disposal workflows.

Hybrid behavior (config-driven):

- Returns can be:
  - Immediate at delivery (during delivery confirmation) or
  - Post-delivery (identified later by customer)
- May require:
  - RMA approval before accepting return
  - Quality inspection before refund/credit
  - Restocking fee calculation
  - Return shipping label generation
- Return policies can vary by:
  - Customer type (B2B, B2C, VIP)
  - Product category (electronics, perishables, apparel)
  - Time window (7 days, 30 days, warranty period)

---

## 6.4.2 Data Model

### A) Sales Return Header (`sales_return_note`)

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| rma_number           | String(30)   | Yes      | Human-readable RMA/Return reference (auto-generated, e.g., RMA-00000001) |
| return_status        | Enum         | Yes      | `DRAFT`, `PENDING_APPROVAL`, `APPROVED`, `RECEIVED`, `INSPECTING`, `ACCEPTED`, `REJECTED`, `REFUNDED`, `EXCHANGED`, `CLOSED`, `CANCELLED` |
| customer_id          | FK (Customer)| Yes      | Customer returning goods |
| customer_contact_name| String(100)  | No       | Contact person at customer |
| customer_contact_email| String(200) | No       | Email for return communication |
| customer_contact_phone| String(20)  | No       | Phone for return coordination |
| receiving_location_id| FK (Location)| Yes      | Store/Warehouse receiving returned goods |
| linked_order_id      | FK (SalesOrder)| No     | Original sales order (if known) |
| linked_invoice_id    | FK (SalesInvoice)| No   | Original invoice (usually required for refund) |
| linked_shipment_id   | FK (Shipment)| No       | Original shipment reference |
| return_reason_category| Enum        | Yes      | `DEFECTIVE`, `DAMAGED`, `WRONG_ITEM`, `NOT_AS_DESCRIBED`, `CUSTOMER_REMORSE`, `WARRANTY_CLAIM`, `EXPIRED`, `OTHER` |
| return_reason_detail | Text         | No       | Detailed reason from customer |
| return_type          | Enum         | Yes      | `REFUND`, `EXCHANGE`, `REPAIR`, `CREDIT_NOTE` |
| return_policy_applied| String(50)   | No       | Return policy reference (e.g., "30-Day Return", "Warranty") |
| return_window_days   | Integer      | No       | Allowed return window (from config or policy) |
| days_since_purchase  | Integer      | Yes      | Calculated: days from order/invoice date |
| is_within_policy     | Boolean      | Yes      | True if return is within allowed window |
| restocking_fee_percent| Decimal     | No       | Restocking fee % (if applicable) |
| restocking_fee_amount| Decimal      | No       | Calculated restocking fee |
| return_shipping_cost | Decimal      | No       | Cost of return shipping (who bears it) |
| shipping_paid_by     | Enum         | No       | `CUSTOMER`, `COMPANY`, `SHARED` |
| return_shipping_label| String(200)  | No       | Tracking/label reference |
| carrier_name         | String(100)  | No       | Return carrier name |
| tracking_number      | String(100)  | No       | Return shipment tracking |
| expected_receipt_date| Date         | No       | Expected date of return receipt |
| actual_receipt_date  | Date         | No       | Actual date goods received |
| inspection_required  | Boolean      | Yes      | True if QC inspection needed |
| inspection_status    | Enum         | No       | `PENDING`, `IN_PROGRESS`, `PASSED`, `FAILED`, `PARTIAL` |
| inspected_by_user_id | FK (User)    | No       | Who performed inspection |
| inspected_at         | DateTime     | No       | Inspection completion timestamp |
| inspection_notes     | Text         | No       | Inspection findings |
| refund_method        | Enum         | No       | `ORIGINAL_PAYMENT`, `STORE_CREDIT`, `BANK_TRANSFER`, `CHECK` |
| refund_amount        | Decimal      | No       | Total refund amount (after fees) |
| refund_processed_at  | DateTime     | No       | When refund was processed |
| refund_reference     | String(100)  | No       | Payment gateway reference |
| credit_note_number   | String(30)   | No       | Generated credit note reference |
| credit_note_amount   | Decimal      | No       | Credit note amount |
| exchange_order_id    | FK (SalesOrder)| No     | New order created for exchange |
| remarks_internal     | Text         | No       | Internal notes (not sent to customer) |
| remarks_to_customer  | Text         | No       | Message sent to customer |
| approval_required    | Boolean      | Yes      | Controlled by config (value/reason) |
| approved_by_user_id  | FK (User)    | No       | Approver for return |
| approved_at          | DateTime     | No       | Approval timestamp |
| rejected_by_user_id  | FK (User)    | No       | Who rejected return |
| rejected_at          | DateTime     | No       | Rejection timestamp |
| rejection_reason     | Text         | No       | Reason for rejection |
| created_by_user_id   | FK (User)    | Yes      | Who created return |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |
| deleted_at           | DateTime     | No       | Soft delete timestamp |

**[NEW] Revision & Versioning:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| parent_return_id     | FK (sales_return_note)| No | [NEW] Reference to original return if this is a revision |
| revision_number      | Integer       | Yes      | [NEW] Version number (default: 1, increments on revision) |
| is_latest_revision   | Boolean       | Yes      | [NEW] True only for current active revision (default: true) |
| revision_reason      | Text          | No       | [NEW] Reason for creating revision (required if revision_number > 1) |

**[NEW] Customer Satisfaction:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| customer_satisfaction_rating| Integer | No      | [NEW] Customer rating (1-5) for return experience |
| customer_feedback    | Text          | No       | [NEW] Customer feedback on return process |

**[NEW] Approval & Audit:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| approval_rule_snapshot| JSON         | No       | [NEW] Captures return value, reason, approver role, rule version at approval time |

---

### B) Sales Return Line (`sales_return_note_line`)

Each line represents quantity being returned against specific Order/Invoice/Shipment line.

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| sales_return_note_id  | FK (Return Header)| Yes      | Header ref |
| sales_order_line_id   | FK (Order Line)   | No       | From which order line (if known) |
| sales_invoice_line_id | FK (Invoice Line) | No       | From which invoice line |
| shipment_line_id      | FK (Shipment Line)| No       | From which shipment line |
| item_id               | FK (Item)         | Yes      | Item master |
| item_variant_id       | FK (Item Variant) | Yes      | SKU |
| uom_id                | FK (UOM)          | Yes      | UOM |
| ordered_qty           | Decimal           | No       | Qty originally ordered (for reference) |
| shipped_qty           | Decimal           | No       | Qty originally shipped (for reference) |
| already_returned_qty  | Decimal           | Yes      | Qty previously returned from this order/invoice line |
| return_qty_requested  | Decimal           | Yes      | Qty customer wants to return |
| return_qty_received   | Decimal           | Yes      | Default 0; updated when goods received |
| return_qty_accepted   | Decimal           | Yes      | Default 0; updated after inspection |
| return_qty_rejected   | Decimal           | Yes      | Default 0; qty rejected after inspection |
| batch_number          | String(50)        | No       | Batch/lot (if applicable) |
| serial_numbers_blob   | Text              | No       | JSON/comma-separated serial numbers |
| expiry_date           | Date              | No       | Product expiry date |
| reason_code           | String(50)        | Yes      | Detailed reason (e.g., DEFECTIVE_SCREEN, WRONG_SIZE, DAMAGED_PACKAGING) |
| line_remarks          | Text              | No       | Additional info |
| line_status           | Enum              | Yes      | `PENDING`, `RECEIVED`, `INSPECTING`, `ACCEPTED`, `REJECTED`, `REFUNDED`, `EXCHANGED`, `CLOSED` |
| original_unit_price   | Decimal           | No       | Original selling price (for refund calculation) |
| refund_unit_price     | Decimal           | No       | Actual refund price per unit (may differ due to fees) |
| restocking_fee_per_unit| Decimal          | No       | Restocking fee per unit |
| line_refund_amount    | Decimal           | No       | Total refund for this line (qty × refund_unit_price - fees) |
| line_credit_amount    | Decimal           | No       | Credit note amount for this line |
| return_to_stock       | Boolean           | Yes      | True if item can be returned to sellable stock |
| return_disposition    | Enum              | No       | `RETURN_TO_STOCK`, `QUARANTINE`, `SCRAP`, `REPAIR`, `VENDOR_RETURN` |
| warehouse_location_id | FK (Location)     | No       | Warehouse location for returned stock |
| created_at            | DateTime          | Auto     |  |
| updated_at            | DateTime          | Auto     |  |

**[NEW] Cost Tracking:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| cost_price           | Decimal       | No       | [NEW] Unit cost price (for inventory valuation) |
| total_cost_impact    | Decimal       | No       | [NEW] Total cost impact of return (qty × cost_price) |

---

### C) Return–Order/Invoice Link (Reuse existing tables)

Links are maintained through:
- `sales_order_line_id` on return line
- `sales_invoice_line_id` on return line
- Updates to order/invoice line `returned_qty` fields

---

### D) Config / Control (Conceptual)

**[EXISTING]**
- `return_requires_order_or_invoice` (true/false; usually true)
- `return_approval_threshold_amount`
- `return_allowed_time_window_days` per category (e.g., 7, 30, 90 days)
- `auto_generate_credit_note` (Yes/No; integration with Finance)
- `require_inspection_for_refund` (Boolean, default: true)
- `allow_return_without_receipt` (Boolean, default: false)
- `restocking_fee_enabled` (Boolean, default: false)
- `restocking_fee_percent_by_category` (JSON config)
- `return_shipping_paid_by_default` (Enum: CUSTOMER, COMPANY)

**[NEW] Return Policy:**
- `return_policy_by_category` (JSON: category → policy rules)
- `auto_approve_within_policy` (Boolean, default: false)
- `require_photos_for_damage_claims` (Boolean, default: true)
- `allow_partial_returns` (Boolean, default: true)

**[NEW] Disposition Rules:**
- `auto_return_to_stock_if_passed` (Boolean, default: true)
- `quarantine_days_for_inspection` (Integer, default: 3)

---

## 6.4.3 UI / UX Requirements

**Screen Name:** Sales Returns (RMA)  
**Path:** Sales → Returns

### A) Sales Return List

Columns:

- RMA Number
- Return Date
- Customer Name
- Order Number
- Invoice Number
- Return Reason
- Return Type (Refund/Exchange/Repair)
- Status
- Refund Amount
- Days Since Purchase
- Within Policy?
- Created By / Approved By
- Actions

Filters:

- Date range (Created, Receipt, Refund)
- Customer
- Status
- Return Reason Category
- Return Type
- Within Policy (Yes/No)
- Inspection Status
- Location

Actions:

- Create Return
- Create from Order (select orders)
- Create from Invoice (select invoices)
- View/Edit (DRAFT / PENDING_APPROVAL)
- Approve / Reject
- Mark as Received
- Perform Inspection
- Process Refund
- Generate Credit Note
- Create Exchange Order
- Close
- Cancel (with reason)
- Print RMA Label

---

### B) Sales Return Header Form

Sections:

**General**
- RMA Number (auto-generated, read-only)
- Return Date (default: today)
- Customer (lookup)
- Customer Contact Name / Email / Phone
- Receiving Location
- Return Reason Category
- Return Reason Detail (from customer)
- Return Type (Refund/Exchange/Repair/Credit Note)

**Reference**
- Linked Sales Order
- Linked Invoice
- Linked Shipment
- Return Policy Applied
- Days Since Purchase (calculated)
- Within Policy? (Yes/No indicator)

**Return Logistics**
- Expected Receipt Date
- Actual Receipt Date
- Return Shipping Cost
- Shipping Paid By (Customer/Company/Shared)
- Carrier Name
- Tracking Number
- Return Shipping Label (generate/upload)

**Inspection**
- Inspection Required? (Yes/No)
- Inspection Status
- Inspected By / At
- Inspection Notes

**Financial**
- Restocking Fee % / Amount
- Refund Method
- Refund Amount (calculated)
- Refund Processed At
- Refund Reference
- Credit Note Number / Amount
- Exchange Order (if applicable)

**System Info** (read-only)
- Return Status
- Approval Required? (Yes/No)
- Approved By / At
- Rejected By / At / Reason

**Notes**
- Internal Remarks (not sent to customer)
- Remarks to Customer (sent in communication)

---

### C) Sales Return Lines Grid

Columns:

- Item Code / Name
- SKU
- UOM
- Order/Invoice/Shipment Line Reference
- Ordered Qty / Shipped Qty
- Already Returned Qty
- Return Qty Requested (input)
- Return Qty Received (updated on receipt)
- Return Qty Accepted (updated after inspection)
- Return Qty Rejected (updated after inspection)
- Batch / Serial / Expiry
- Reason Code
- Original Unit Price
- Refund Unit Price
- Restocking Fee
- Line Refund Amount
- Return Disposition (Stock/Quarantine/Scrap/Repair)
- Line Status
- Actions (Edit, Delete, Copy)

Features:

**Add lines by:**
- Selecting from Order lines (filter by customer/order/date)
- Selecting from Invoice lines
- Selecting from Shipment lines
- Manual entry (if allowed without receipt)

**Show warning when:**
- `already_returned_qty + return_qty_requested > shipped_qty`
- Return is outside policy window
- Restocking fee applies

**For batch/serial items:**
- Allow selection of specific serials or batch segments
- Validate serial numbers against shipped serials

**Inline calculations:**
- Refund amount = (return_qty_accepted × refund_unit_price) - restocking_fee
- Auto-calculate based on inspection results

---

### D) Inspection View

**Inspection Interface:**

For each return line:
- Item details and return reason
- Qty Requested vs Qty Received
- Inspection checklist (configurable per category)
- Photo upload for damage claims
- Accept/Reject decision per line
- Qty Accepted / Qty Rejected (input)
- Disposition selection (Return to Stock, Quarantine, Scrap, Repair, Vendor Return)
- Inspection notes

**Actions:**
- Accept All (within tolerance)
- Reject All (with reason)
- Partial Accept (specify qty)
- Complete Inspection

**Automatic triggers:**
- If all lines accepted → Status = ACCEPTED
- If all lines rejected → Status = REJECTED
- If partial → Status = ACCEPTED (with partial refund)

---

### E) Refund Processing

**Refund Entry:**
- Refund Method selection
- Refund Amount (calculated, editable with approval)
- Refund Date
- Refund Reference (transaction ID)
- Bank Account / Payment Gateway details

**Refund Calculation:**
- Sum of line refund amounts
- Minus restocking fees
- Minus return shipping (if customer pays)
- Plus any adjustments

**Refund Status Update:**
- Update `refund_amount`, `refund_processed_at`, `refund_reference`
- Update status to `REFUNDED`
- Trigger payment gateway refund (if online payment)
- Send refund confirmation to customer

---

### F) Customer-Facing View (RMA Portal / Email)

RMA document includes:

- Company details
- RMA number and date
- Customer details
- Return instructions
- Return shipping label (if provided)
- Line items being returned
- Expected refund amount
- Return policy terms
- Contact information for support

System must support:
- PDF generation
- Email with RMA details and shipping label
- Customer portal view (track return status)
- Print-friendly RMA label

---

## 6.4.4 Validation Rules

**Header-level:**

- `rma_number` unique per company
- `customer_id` must match customer of linked order/invoice
- `receiving_location_id` required
- If `return_requires_order_or_invoice = true`:
  - At least one `linked_order_id` or `linked_invoice_id` required
- If `return_allowed_time_window_days` specified:
  - Check order/invoice date vs current date
  - Set `is_within_policy` flag
  - If outside window and `auto_approve_within_policy = true`: require approval

**Line-level:**

- `return_qty_requested > 0`
- `already_returned_qty + return_qty_requested <= shipped_qty`
- For batch-managed items:
  - `batch_number` required
- For serial-managed items:
  - Serial numbers must match originally shipped serials
- If `require_inspection_for_refund = true`:
  - Cannot process refund until inspection complete

**Approval:**

- If `refund_amount > return_approval_threshold_amount`:
  - Set `approval_required = true`
- If return is outside policy window:
  - Set `approval_required = true`
- Cannot receive goods until approved (if approval required)

**Status/Workflow:**

- Cannot mark return `RECEIVED`:
  - If any line has invalid quantity
  - If `approval_required` and not approved
- Cannot process refund:
  - Until goods received
  - Until inspection complete (if required)
  - Until approved (if required)
- Cannot close return:
  - Until financial side processed (refund or credit note)

**[NEW] Revision & Versioning:**

- If creating a revision (parent_return_id is set):
  - `revision_number` = parent's revision_number + 1
  - `revision_reason` is required
  - Parent return's `is_latest_revision` must be set to false
  - Only returns with `is_latest_revision = true` can be processed

**Config behavior:**

- If `auto_approve_within_policy = true`:
  - Returns within policy window auto-approved
- If `auto_return_to_stock_if_passed = true`:
  - Accepted items automatically returned to stock
- If `restocking_fee_enabled = true`:
  - Calculate and apply restocking fee based on category

---

## 6.4.5 Workflow

**Standard:**

- `DRAFT`  
  → **Submit** → `PENDING_APPROVAL` (if approval_required)  
  → **Approve** → `APPROVED`  
  → **Receive Goods** → `RECEIVED`  
  → **Inspect** → `INSPECTING`  
  → **Complete Inspection** → `ACCEPTED` / `REJECTED` / `PARTIAL`  
  → **Process Refund** → `REFUNDED`  
  → **Generate Credit Note** → `CLOSED` (if credit note)  
  → **Create Exchange Order** → `EXCHANGED` → `CLOSED`  
  → **Cancel** → `CANCELLED`

**Alternative:**

- If no approval required:
  - `DRAFT → APPROVED` directly on submit
- If no inspection required:
  - `RECEIVED → ACCEPTED` directly

**Detailed Transitions:**

1. **DRAFT → PENDING_APPROVAL**:
   - Trigger: User clicks "Submit for Approval"
   - Validations: Must have lines, all required fields filled, within allowed window (or flagged)
   - Actions: Set submitted timestamp, notify approvers

2. **PENDING_APPROVAL → APPROVED**:
   - Trigger: Approver clicks "Approve"
   - Validations: User has approval role
   - Actions: Set approved_by, approved_at, capture approval_rule_snapshot, send RMA to customer

3. **APPROVED → RECEIVED**:
   - Trigger: Warehouse receives goods
   - Validations: Goods physically received
   - Actions: Update return_qty_received for each line, set actual_receipt_date, trigger inspection (if required)

4. **RECEIVED → INSPECTING**:
   - Trigger: Inspection started
   - Validations: Inspection required
   - Actions: Set inspection_status = IN_PROGRESS

5. **INSPECTING → ACCEPTED**:
   - Trigger: Inspection complete, all items accepted
   - Validations: All lines inspected
   - Actions: Update return_qty_accepted, set inspected_by, inspected_at, inspection_notes, trigger refund/credit note

6. **ACCEPTED → REFUNDED**:
   - Trigger: Refund processed
   - Validations: Refund method selected, amount calculated
   - Actions: Process payment gateway refund, update refund_amount, refund_processed_at, refund_reference, send confirmation to customer

7. **ACCEPTED → CLOSED (Credit Note)**:
   - Trigger: Credit note generated
   - Validations: Credit note amount calculated
   - Actions: Generate credit note, update credit_note_number, credit_note_amount, link to customer account

8. **ACCEPTED → EXCHANGED**:
   - Trigger: Exchange order created
   - Validations: Customer selected exchange items
   - Actions: Create new sales order, link via exchange_order_id, process as new order

**Inventory integration:**

- On `RECEIVED`:
  - Inventory movement event to add stock at receiving location (quarantine)
- On `ACCEPTED`:
  - If `return_disposition = RETURN_TO_STOCK`: Move to sellable stock
  - If `return_disposition = QUARANTINE`: Keep in quarantine
  - If `return_disposition = SCRAP`: Write off inventory
  - If `return_disposition = REPAIR`: Move to repair location
  - If `return_disposition = VENDOR_RETURN`: Prepare for supplier return

**Finance integration:**

- On `REFUNDED`:
  - Update AR (reduce receivable)
  - Record refund transaction
- On `CLOSED` (Credit Note):
  - Generate credit note against original invoice
  - Update customer account balance

**Customer satisfaction:**

- After `CLOSED`:
  - Send satisfaction survey
  - Record `customer_satisfaction_rating` and `customer_feedback`

**[NEW] Revision Workflow:**

- **APPROVED → DRAFT (Revision)**:
  - Trigger: User clicks "Create Revision" (for corrections before receipt)
  - Validations: No goods received yet
  - Actions: Create new return with parent reference, copy lines

**[NEW] Exchange Workflow:**

- **ACCEPTED → EXCHANGED**:
  - Trigger: User clicks "Create Exchange Order"
  - Validations: Customer selected exchange items, inventory available
  - Actions:
    - Create new sales order with exchange items
    - Link original return to new order
    - Process new order through normal sales flow
    - Close return when exchange shipped

---

## 6.4.6 Module Metadata & Build Steps

### Module Metadata

```yaml
module_type: transaction
complexity: medium

template_ref: _txn_02

extension_allowed: true

depends_on:
  - Company
  - Locations
  - Customer Master
  - Item Master
  - Item Variants
  - Units of Measure
  - Sales Order (6.2)
  - Sales Invoice (6.3)
  - Shipment Management
  - Inventory Movement Engine
  - Users / Roles
  - Return Policy Configuration

used_by:
  - Customer Satisfaction Tracking
  - Product Quality Metrics
  - Warranty Claim Processing
  - Inventory Valuation & Stock Adjustments
  - Accounts Receivable (AR)
  - Sales Analytics / Reporting

integrates_with:
  - Email Service (for RMA communication)
  - PDF Generation Service (for RMA labels)
  - Customer Portal
  - Payment Gateway (for refund processing)
  - Accounting System (credit note posting)
  - Shipping Carriers (return label generation)

notes: >
  Sales Return (RMA) handles customer returns with approval workflows,
  quality inspection, refund/exchange processing, and inventory
  disposition. It supports return-to-stock, quarantine, scrap, repair,
  and vendor-return workflows. It is hybrid-configurable, allowing
  organizations to enforce return policies, restocking fees, and
  inspection requirements based on customer type and product category.

You are building a Medium Complexity Transaction module for a Retail ERP.

Module: Sales Return (RMA)
Template: _txn_02

Requirements:

1) Backend (Django + DRF):
   - Models:
     - sales_return_note (header)
     - sales_return_note_line (lines)
   - Serializers:
     - Header with nested lines
     - List serializer for returns
   - Viewsets & Endpoints:
     - CRUD while in DRAFT
     - Workflow actions:
       - submit_return
       - approve_return
       - reject_return
       - receive_return
       - start_inspection
       - complete_inspection
       - process_refund
       - generate_credit_note
       - create_exchange_order
       - close_return
       - cancel_return
   - Business Rules:
     - Enforce quantity validations against order/invoice/shipment lines
     - Enforce approval and time-window rules
     - Trigger inventory movement events at receipt and after inspection
     - Calculate refund amounts with restocking fees
     - Auto-generate credit notes (if configured)

2) Frontend (React + Vite + Tailwind):
   - Screens:
     - Return List view with filters and status
     - Return Edit:
       - Header (customer, reason, type, logistics)
       - Lines grid (select from order/invoice/shipment lines)
       - Inspection interface
       - Refund processing
     - Approval View with summary of return amounts
     - Exchange Order Creation
   - Behavior:
     - Block receipt if not approved where required
     - Show warnings for over-return or outside policy window
     - Display inspection checklist
     - Calculate refund amounts dynamically

3) Integration:
   - Upstream:
     - Order, Invoice, and Shipment lines as source for return
   - Downstream:
     - Provide return info to Finance for credit note creation
     - Feed into Customer Satisfaction tracking
     - Feed into Product Quality metrics
     - Adjust inventory via stock movement
   - External:
     - Payment gateway for refund processing
     - Shipping carriers for return label generation

4) Security & Roles:
   - Return Creator
   - Return Approver
   - Return Receiver
   - Quality Inspector
   - Refund Processor
   - Return Viewer

Ensure conformance with the data model, workflow, and validation
rules defined in the Sales Return specification.


MODULE: Sales Return (RMA)
TYPE: Transaction (Medium, _txn_02)

DATA MODEL:
- Header: company, rma_number, customer, status, return_reason, return_type,
  logistics (shipping, tracking), inspection tracking, refund tracking,
  credit note linkage, exchange order linkage, approval flags, policy compliance,
  revision tracking, customer satisfaction, audit fields
- Lines: item_variant, UOM, return quantities (requested, received, accepted, rejected),
  reason codes, refund amounts, restocking fees, disposition, cost tracking

WORKFLOW:
- DRAFT → PENDING_APPROVAL → APPROVED → RECEIVED → INSPECTING →
  ACCEPTED / REJECTED → REFUNDED / EXCHANGED / CLOSED / CANCELLED
- Inspection workflow for quality validation
- Refund processing with payment gateway integration
- Exchange order creation for replacements
- Inventory disposition (return-to-stock, quarantine, scrap, repair)

UI:
- List + Edit screens with clear separation of header, lines, inspection, refund
- Inspection interface with photo upload and disposition selection
- Refund processing and payment gateway integration
- Exchange order creation
- Customer-facing RMA portal and labels

Use template _txn_02 and generate:

- Django models, serializers, viewsets, URLs for Return header + lines
- React pages for:
  - Return list
  - Return edit (header + lines + inspection + refund info)
  - Inspection interface
  - Refund processing
  - Exchange order creation
  - RMA label/document generation
- Axios API service for all operations (CRUD + workflow + inspection + refund)

Enforce all validation and workflow rules described in the
Sales Return specification.
