# 6.5 Sales Configuration & Master Data Governance
Template Ref: _cfg_01 (Configuration Module)

## What is 6.5?

Think of **6.5 Sales Configuration & Master Data Governance** as:

**"The control panel and rules layer that tells all the transaction modules in Section 6 how to behave."**

It does not introduce new core entities like Customer or Item, but instead defines:

- Which sales steps are enabled/disabled
- What is mandatory vs optional
- Tolerances, thresholds, and rules used by:
  - 6.1 Sales Quotation
  - 6.2 Sales Order
  - 6.3 Sales Invoice
  - 6.4 Sales Return

In other words:

- **Your Masters** (Customer, Item, Location, etc.) = **Who/What we sell to**
- **6.5 Config & Governance** = **How we run sales** (process, rules, flows)

So it centralizes all the config flags we've been referencing:

- `quote_enabled`, `quote_required_for_order`
- `order_requires_quote`, `credit_check_required`
- `allow_partial_invoicing`, `auto_send_invoice_on_approval`
- `invoice_matching_model`, `revenue_recognition_method`
- `return_allowed_time_window_days`, `restocking_fee_enabled`
- `quote_approval_required`, `margin_check_enabled`
- etc.

Rather than scattering them in multiple specs, 6.5:

- **Documents them in one place**
- **Gives them a proper data model** (config tables)
- **Ensures your ERP can behave as "simple retail" or "enterprise-grade"** just by flipping config

---

## 6.5.1 Business Purpose

The **Sales Configuration & Master Data Governance** module defines how all sales transactions (6.1–6.4) behave, without changing core masters (Customer, Item, Location, etc.).

Goals:

- **Centralize process behavior and tolerance rules:**
  - Which steps are active (Quote, Order, Invoice, Return)
  - Which steps are mandatory or optional
  - Pricing, credit, and approval rules
  - Revenue recognition and payment policies

- **Allow the same product to serve:**
  - Small retailers (direct order, minimal controls)
  - Mid/Large enterprises (full Quote→Order→Invoice→Payment chain)
  - B2B, B2C, and Export scenarios

- **Provide governance over:**
  - Who can change configuration
  - Audit of when rules changed (and by whom)
  - Customer-specific pricing and credit policies

This module does not introduce new core entity masters; it references and controls how existing masters and transactions are used.

---

## 6.5.2 Data Model (Conceptual Configuration Tables)

These are logical config entities; physical implementation can be SQL tables, JSON config, or a mix.

### A) Sales Process Settings (`sales_process_setting`)

Controls step enablement and mandatory rules.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| location_id          | FK (Location)| No       | Optional override per location |
| customer_type        | Enum         | No       | Optional override per customer type (B2B, B2C, EXPORT) |
| category_code        | String(50)   | No       | Optional override per product category |
| quote_enabled        | Boolean      | Yes      | Show/hide Quote (6.1) |
| quote_required_for_order | Boolean  | Yes      | Hard rule: Order must reference Quote? |
| quote_approval_required | Boolean   | Yes      | Approval workflow required for Quote? |
| quote_validity_days  | Integer      | No       | Default quote validity period (e.g., 30 days) |
| auto_expire_quotes   | Boolean      | Yes      | Auto-expire quotes past validity date? |
| order_requires_quote | Boolean      | Yes      | Order must link Quote in this context? |
| credit_check_required | Boolean     | Yes      | Credit limit check required for orders? |
| credit_hold_on_exceed | Boolean     | Yes      | Put order on hold if credit exceeded? |
| allow_backorders     | Boolean      | Yes      | Allow orders when stock insufficient? |
| auto_allocate_inventory | Boolean   | Yes      | Auto-allocate stock on order confirmation? |
| auto_confirm_on_approval | Boolean  | Yes      | Auto-confirm order after approval? |
| allow_partial_shipment | Boolean    | Yes      | Allow multiple shipments per order? |
| allow_partial_invoicing | Boolean   | Yes      | Allow multiple invoices per order? |
| auto_generate_invoice_on_shipment | Boolean | Yes | Auto-create invoice when shipment completed? |
| auto_send_invoice_on_approval | Boolean | Yes | Auto-send invoice to customer after approval? |
| require_delivery_confirmation | Boolean | Yes | Require delivery confirmation before closing order? |
| return_enabled       | Boolean      | Yes      | Allow customer returns (6.4)? |
| return_requires_rma  | Boolean      | Yes      | Require RMA approval before accepting return? |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### B) Tolerance Settings (`sales_tolerance_setting`)

Numeric thresholds for pricing, credit, and matching.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| customer_type        | Enum         | No       | Optional per customer type |
| category_code        | String(50)   | No       | Optional per category |
| over_ship_tolerance_percent | Decimal | No    | Max shipment over order qty (e.g., 5%) |
| qty_tolerance_percent_invoice | Decimal | No  | Max qty over shipment accepted for invoicing |
| price_tolerance_percent | Decimal   | No       | Max price delta vs order/quote |
| tax_tolerance_percent | Decimal     | No       | Max tax variance vs expected |
| amount_tolerance_absolute | Decimal | No       | Absolute currency amount tolerance |
| credit_limit_tolerance_percent | Decimal | No | % over credit limit allowed with approval |
| discount_tolerance_percent | Decimal | No     | Max discount % before requiring approval |
| return_allowed_time_window_days | Integer | No | Max days post-delivery to initiate return |
| minimum_margin_threshold | Decimal  | No       | Minimum gross margin % required |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### C) Pricing & Revenue Configuration (`sales_pricing_revenue_setting`)

Controls pricing rules and revenue recognition.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| customer_type        | Enum         | No       | Optional per customer type |
| category_code        | String(50)   | No       | Optional per category |
| enforce_margin_check | Boolean      | Yes      | Enforce minimum margin validation? |
| margin_action        | Enum         | Yes      | `REQUIRE_APPROVAL`, `BLOCK` |
| allow_price_override | Boolean      | Yes      | Allow manual price override? |
| require_override_reason | Boolean   | Yes      | Require justification for price override? |
| invoice_matching_model | Enum       | Yes      | `ORDER_BASED`, `DELIVERY_BASED`, `MILESTONE_BASED`, `TIME_BASED` |
| revenue_recognition_method | Enum   | Yes      | `ON_INVOICE`, `ON_PAYMENT`, `ON_DELIVERY`, `MILESTONE_BASED` |
| auto_recognize_revenue | Boolean    | Yes      | Auto-recognize revenue based on method? |
| restocking_fee_enabled | Boolean    | Yes      | Apply restocking fee on returns? |
| restocking_fee_percent_by_category | JSON | No | Category-specific restocking fee % |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### D) Return Policy Configuration (`sales_return_policy_setting`)

Controls return acceptance and processing rules.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| customer_type        | Enum         | No       | Optional per customer type |
| category_code        | String(50)   | No       | Optional per category |
| return_window_days   | Integer      | Yes      | Allowed return window (e.g., 7, 30, 90 days) |
| auto_approve_within_policy | Boolean | Yes   | Auto-approve returns within policy window? |
| require_inspection_for_refund | Boolean | Yes | Require QC inspection before refund? |
| allow_return_without_receipt | Boolean | Yes | Allow returns without order/invoice reference? |
| require_photos_for_damage_claims | Boolean | Yes | Require photo evidence for damage claims? |
| return_shipping_paid_by_default | Enum | Yes | `CUSTOMER`, `COMPANY`, `SHARED` |
| auto_return_to_stock_if_passed | Boolean | Yes | Auto-return inspected items to stock? |
| quarantine_days_for_inspection | Integer | No | Days to hold in quarantine for inspection |
| allow_exchange       | Boolean      | Yes      | Allow exchange instead of refund? |
| allow_store_credit   | Boolean      | Yes      | Allow store credit instead of refund? |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### E) Approval Matrix (`sales_approval_matrix`)

Defines who approves which transaction at what threshold.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| module_code          | Enum         | Yes      | `QUOTE`, `ORDER`, `INVOICE`, `CREDIT_NOTE`, `RETURN`, `PRICE_OVERRIDE`, `CREDIT_OVERRIDE` |
| customer_type        | Enum         | No       | Optional per customer type |
| category_code        | String(50)   | No       | Optional per category |
| min_amount           | Decimal      | Yes      | Lower bound inclusive |
| max_amount           | Decimal      | Yes      | Upper bound inclusive |
| min_discount_percent | Decimal      | No       | Min discount % to trigger approval |
| max_discount_percent | Decimal      | No       | Max discount % to trigger approval |
| approver_role_code   | String(50)   | Yes      | Role (Sales Manager, Finance Head, etc.) |
| approval_level       | Integer      | Yes      | 1, 2, 3… for multi-level approval |
| sequential_approval_required | Boolean | Yes  | Sequential vs parallel approvals |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### F) Payment & Dunning Configuration (`sales_payment_dunning_setting`)

Controls payment terms and collections.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| customer_type        | Enum         | No       | Optional per customer type |
| default_payment_terms | String(100) | Yes      | Default payment terms (e.g., "Net 30") |
| dunning_enabled      | Boolean      | Yes      | Enable dunning/reminder process? |
| dunning_schedule     | JSON         | No       | Days and escalation levels (e.g., [7, 14, 30]) |
| auto_write_off_threshold | Decimal  | No       | Amount below which auto write-off allowed |
| require_approval_for_write_off | Boolean | Yes | Require approval for write-off? |
| allow_partial_payments | Boolean    | Yes      | Allow partial invoice payments? |
| auto_allocate_payments | Boolean    | Yes      | Auto-allocate payments to oldest invoices? |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### G) Customer & Item Governance (Pointers Only)

You already have Customer, Item, Item Variant, UOM, etc. in your system.

6.5 can store sales-specific governance attributes without redefining those cores. These can be extensions or views:

**Examples:**

**Customer-level:**
- Credit limit
- Payment terms
- Price list assignment
- Allowed payment methods
- Sales channel preference
- VIP status / tier
- Blocked for new orders (bool)

**Item-level:**
- Default sales price
- Minimum selling price
- Margin % target
- Returnable flag
- Warranty period
- Restocking fee %
- Approved for specific sales channels

These can be implemented as:
- Extensions to your existing customer/item masters, or
- Separate mapping tables like `customer_sales_profile`, `item_sales_profile`

---

## 6.5.3 UI / UX Requirements

**Screen Name:** Sales Configuration  
**Path:** Admin / Configuration → Sales

### A) Process Configuration Screen

**Sections:**

Grid by:
- Company
- Location
- Customer Type (B2B, B2C, Export)
- Category

**Columns:**
- Quote Enabled?
- Quote Required for Order?
- Quote Approval Required?
- Credit Check Required?
- Allow Backorders?
- Auto-Allocate Inventory?
- Allow Partial Shipment?
- Allow Partial Invoicing?
- Return Enabled?
- RMA Required?

**Actions:**
- Add new rule row
- Override rule for specific location/customer type/category
- View effective rule (resolved by priority: location > customer type > category > company)

---

### B) Tolerances & Pricing

Screen to define:
- Over-shipment tolerance
- Price/Tax tolerance
- Credit limit tolerance
- Discount tolerance
- Return time window
- Minimum margin threshold

**UI:**
- Filter by customer type and category
- Inline edit fields
- Show where-used indicator (modules impacted)

---

### C) Approval Matrix Maintenance

Screen for managing approval rules:

**Filters:**
- Module (Quote/Order/Invoice/Return/etc.)
- Customer Type
- Category
- Role

**Grid:**
- Module
- Customer Type
- Category
- Min Amount
- Max Amount
- Min/Max Discount %
- Approver Role
- Level
- Sequential? (Yes/No)

**Approval view integration:**
- Approvers can see why they're being asked to approve (which rule triggered)

---

### D) Return Policy Configuration

Screen to define return policies:

**Filters:**
- Customer Type
- Category

**Fields:**
- Return Window Days
- Auto-Approve Within Policy?
- Require Inspection?
- Allow Return Without Receipt?
- Require Photos for Damage?
- Return Shipping Paid By
- Auto-Return to Stock?
- Quarantine Days
- Allow Exchange?
- Allow Store Credit?

---

### E) Revenue Recognition & Payment

Screen to configure:

**Revenue Recognition:**
- Method (On Invoice, On Payment, On Delivery, Milestone)
- Auto-Recognize Revenue?

**Payment & Dunning:**
- Default Payment Terms
- Dunning Enabled?
- Dunning Schedule (days: 7, 14, 30)
- Auto Write-Off Threshold
- Allow Partial Payments?
- Auto-Allocate Payments?

---

## 6.5.4 Governance & Validation Rules

**Changes to sales configuration must:**

- Be restricted to config/admin roles
- Have full audit trail (who, what, when)

**Rule resolution algorithm (conceptual):**

For each transaction (Quote/Order/Invoice/Return), system determines:
- Company
- Location
- Customer Type
- Category

Then finds the most specific applicable config:
1. Location + Customer Type + Category
2. Location + Customer Type
3. Location + Category
4. Customer Type + Category
5. Location
6. Customer Type
7. Category
8. Company-level default

**Prevent contradictory configs:**
- E.g., `quote_enabled = false` and `quote_required_for_order = true` for same scope

**Validate that:**
- Approval matrix covers required ranges (no gaps where approvals would be ambiguous)
- Tolerance percentages are within reasonable bounds (e.g., 0-100%)
- Return window days are positive
- Dunning schedule days are in ascending order

---

## 6.5.5 Module Metadata & Build Steps

### Module Metadata

```yaml
module_type: configuration
complexity: medium

template_ref: _cfg_01

extension_allowed: true

depends_on:
  - Company
  - Locations
  - Customer Master
  - Categories
  - Items / Variants
  - Users / Roles

used_by:
  - Sales Quotation (6.1)
  - Sales Order (6.2)
  - Sales Invoice (6.3)
  - Sales Return (6.4)
  - Customer Credit Management
  - Sales Analytics / Reporting

integrates_with:
  - Pricing Engine
  - Credit Management
  - Revenue Recognition
  - Dunning & Collections

notes: >
  Sales Configuration & Governance centralizes all sales process
  behavior, tolerances, approval rules, pricing policies, revenue
  recognition methods, and return policies. It enables the same
  ERP to serve simple retail or complex enterprise scenarios
  through configuration rather than code changes.

You are building a Configuration module for a Retail ERP.

Module: Sales Configuration & Governance
Template: _cfg_01

Requirements:

1) Backend (Django + DRF):

   Models:
   - sales_process_setting
   - sales_tolerance_setting
   - sales_pricing_revenue_setting
   - sales_return_policy_setting
   - sales_approval_matrix
   - sales_payment_dunning_setting

   Services:
   - Rule resolution service:
     - Given (company, location, customer_type, category, module),
       compute effective config and approval rules
   - Audit logging for config changes

   APIs:
   - CRUD for configuration models (restricted to admin roles)
   - Read-only "get effective settings" API consumed by transactional
     modules (Quote, Order, Invoice, Return)

2) Frontend (React + Vite + Tailwind):

   Screens:
   - Process configuration maintenance
   - Tolerance and pricing settings
   - Approval matrix
   - Return policy configuration
   - Revenue recognition & payment settings

   Behavior:
   - Prevent conflicting rule combinations
   - Provide preview of "effective" rules for a sample scenario
     (company/location/customer_type/category)
   - Show impact analysis when changing config (which transactions affected)

3) Security & Roles:

   - Restrict write access to configuration to:
     - System Admin
     - Sales Admin
   - Transactional modules should only **read** from these settings

Ensure no duplication of core masters (customer/item), and treat
this module as the centralized control layer for Section 6
sales behavior.


MODULE: Sales Configuration & Governance
TYPE: Configuration (_cfg_01)

DATA MODEL:
- Process Settings: Quote, Order, Invoice, Return enablement and mandatory rules
- Tolerance Settings: Pricing, credit, discount, margin, return window tolerances
- Pricing & Revenue: Margin enforcement, price override, revenue recognition
- Return Policy: Return window, inspection, shipping, disposition rules
- Approval Matrix: Multi-level approval rules by module, amount, discount, customer type
- Payment & Dunning: Payment terms, dunning schedule, write-off rules

RULE RESOLUTION:
- Hierarchical resolution: Location > Customer Type > Category > Company
- Effective settings computed at runtime for each transaction
- Audit trail for all config changes

UI:
- Process configuration grid with override capability
- Tolerance and pricing settings by customer type and category
- Approval matrix maintenance with gap detection
- Return policy configuration by customer type and category
- Revenue recognition and payment settings
- Preview and impact analysis tools

Use template _cfg_01 and generate:

- Django models, serializers, viewsets, URLs for all config tables
- Rule resolution service for effective settings computation
- React pages for:
  - Process configuration
  - Tolerance settings
  - Approval matrix
  - Return policy
  - Revenue & payment settings
  - Preview and impact analysis
- Axios API service for config CRUD and effective settings retrieval

Ensure centralized control of all sales transaction behavior
through configuration rather than code changes.
