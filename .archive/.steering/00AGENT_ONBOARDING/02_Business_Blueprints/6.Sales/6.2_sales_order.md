# 6.2 Sales Order (SO)
Template Ref: _txn_02 (Medium Transaction)

## 6.2.1 Business Purpose

The **Sales Order (SO)** is the legally binding commercial document issued to a customer, confirming agreed quantities, prices, taxes, delivery terms, and payment terms. It serves as the anchor document for order fulfillment, shipping, invoicing, and revenue recognition.

Goals:

- Convert approved customer demand (Quote) and/or direct customer orders into a formal sales commitment.
- Serve as the anchor document for subsequent processes:
  - Inventory Allocation & Reservation
  - Picking & Packing
  - Shipping & Delivery
  - Sales Invoice Generation
  - Sales Returns
  - Payment & Settlement
- Enforce sales and financial controls:
  - Credit limit validation
  - Approval workflows (value/role/customer-based)
  - Pricing, tax, and contract compliance
  - Inventory availability checks
- Support both:
  - Organizations using **Quote → Sales Order**
  - Organizations using **Sales Order directly** (Quote disabled)
- Track order fulfillment status and enable partial shipments/invoicing.

Hybrid behavior (config-driven):

- Sales Order may be:
  - Created directly (no Quote) for simple sales.
  - Created from Quote (single or multiple Quotes).
  - Created from customer portal/eCommerce integration.
- Config rules can enforce:
  - `order_requires_quote` for certain customer types/categories.
  - `credit_check_required` for customer credit limit validation.
  - Separate approval tiers for B2B vs B2C vs Export orders.

---

## 6.2.2 Data Model

### A) Sales Order Header (`sales_order`)

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| order_number         | String(30)   | Yes      | Human-readable Order No (auto-generated, e.g., SO-00000001) |
| order_status         | Enum         | Yes      | `DRAFT`, `PENDING_APPROVAL`, `APPROVED`, `CONFIRMED`, `PROCESSING`, `PARTIALLY_SHIPPED`, `FULLY_SHIPPED`, `PARTIALLY_INVOICED`, `FULLY_INVOICED`, `DELIVERED`, `CLOSED`, `CANCELLED` |
| customer_id          | FK (Customer)| Yes      | Customer to whom order is issued |
| customer_contact_name| String(100)  | No       | Contact person at customer |
| customer_contact_email| String(200) | No       | Email for order confirmation |
| customer_contact_phone| String(20)  | No       | Phone for delivery coordination |
| sales_person_id      | FK (User)    | No       | Sales representative |
| sales_channel        | Enum         | No       | `DIRECT_SALES`, `ECOMMERCE`, `PHONE`, `PORTAL`, `MOBILE_APP` |
| ordering_location_id | FK (Location)| Yes      | Location/branch processing the order |
| shipping_location_id | FK (Location)| No       | Warehouse/location for fulfillment |
| currency_code        | String(3)    | Yes      | Currency (e.g., USD, INR) |
| order_date           | Date         | Yes      | Order creation date |
| required_delivery_date| Date        | No       | Customer requested delivery date |
| promised_delivery_date| Date        | No       | Committed delivery date |
| actual_delivery_date | Date         | No       | Actual delivery completion date |
| payment_terms        | String(100)  | No       | Payment terms (e.g., "Net 30", "50% advance") |
| delivery_terms       | String(100)  | No       | Delivery terms (e.g., "FOB", "CIF") |
| shipping_method      | String(50)   | No       | Shipping carrier/method |
| shipping_address     | Text         | No       | Delivery address (can differ from customer default) |
| billing_address      | Text         | No       | Billing address |
| tax_inclusive        | Boolean      | Yes      | True if prices stored are tax-inclusive |
| subtotal             | Decimal      | Yes      | Sum of line totals before tax |
| discount_percent     | Decimal      | No       | Header-level discount % |
| discount_amount      | Decimal      | No       | Header-level discount amount |
| shipping_charges     | Decimal      | No       | Shipping/freight charges |
| tax_amount           | Decimal      | Yes      | Total tax amount |
| grand_total          | Decimal      | Yes      | Final order amount |
| linked_quote_id      | FK (Quote)   | No       | If order created from Quote |
| created_from_quote_flag| Boolean    | Yes      | True if order created from Quote |
| customer_po_number   | String(50)   | No       | Customer's PO reference number |
| remarks_internal     | Text         | No       | Internal notes (not sent to customer) |
| remarks_to_customer  | Text         | No       | Free text to appear on order confirmation |
| special_instructions | Text         | No       | Packing/delivery special instructions |
| approval_required    | Boolean      | Yes      | Derived from config based on value/customer |
| approved_by_user_id  | FK (User)    | No       | User who approved order |
| approved_at          | DateTime     | No       | Approval timestamp |
| cancelled_by_user_id | FK (User)    | No       | Who cancelled order |
| cancelled_at         | DateTime     | No       | Cancelled timestamp |
| cancellation_reason  | Text         | No       | Reason for cancellation |
| confirmed_at         | DateTime     | No       | When order was confirmed to customer |
| sent_to_customer_at  | DateTime     | No       | When order confirmation was sent |
| order_version_no     | Integer      | Yes      | Version number for amendments (start at 1) |
| is_amendment_of_order_id| FK (SalesOrder)| No   | Reference to original order for amendments |
| priority             | Enum         | No       | `LOW`, `NORMAL`, `HIGH`, `URGENT` |
| order_type           | Enum         | No       | `STANDARD`, `RUSH`, `BACKORDER`, `DROPSHIP` |
| credit_hold          | Boolean      | Yes      | True if order on credit hold |
| credit_hold_reason   | Text         | No       | Reason for credit hold |
| credit_approved_by   | FK (User)    | No       | Who approved credit override |
| created_by_user_id   | FK (User)    | Yes      | Creator |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |
| deleted_at           | DateTime     | No       | Soft delete timestamp |

**[NEW] Revision & Versioning:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| parent_order_id      | FK (sales_order)| No     | [NEW] Reference to original order if this is a revision |
| revision_number      | Integer       | Yes      | [NEW] Version number (default: 1, increments on revision) |
| is_latest_revision   | Boolean       | Yes      | [NEW] True only for current active revision (default: true) |
| revision_reason      | Text          | No       | [NEW] Reason for creating revision (required if revision_number > 1) |

**[NEW] Margin & Cost Tracking:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| cost_price_total     | Decimal       | No       | [NEW] Sum of line-level cost prices (read-only/computed) |
| gross_margin_pct     | Decimal       | No       | [NEW] ((grand_total - cost_price_total) / grand_total) × 100 |

**[NEW] Fulfillment Tracking:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| allocated_at         | DateTime      | No       | [NEW] When inventory was allocated |
| picked_at            | DateTime      | No       | [NEW] When picking was completed |
| packed_at            | DateTime      | No       | [NEW] When packing was completed |
| shipped_at           | DateTime      | No       | [NEW] When shipment was dispatched |
| tracking_number      | String(100)   | No       | [NEW] Shipment tracking number |
| carrier_name         | String(100)   | No       | [NEW] Shipping carrier name |

**[NEW] Approval & Audit:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| approval_rule_snapshot| JSON         | No       | [NEW] Captures discount %, credit limit, approver role, rule version at approval time |

> Note: `order_version_no` and `is_amendment_of_order_id` allow for controlled order amendments; how amendments are managed is further enforced in workflow and validation.

---

### B) Sales Order Line (`sales_order_line`)

Each line = one item/variant row on the order.

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| sales_order_id        | FK (Order Header) | Yes      | Link to order header |
| line_number           | Integer           | Yes      | Sequential line number on order |
| item_id               | FK (Item)         | Yes      | Parent item |
| item_variant_id       | FK (Item Variant) | Yes      | SKU reference |
| description_override  | String(255)       | No       | Line description override |
| uom_id                | FK (UOM)          | Yes      | UOM ordered |
| ordered_qty           | Decimal           | Yes      | Quantity ordered |
| allocated_qty         | Decimal           | Yes      | Default 0; updated from inventory allocation |
| picked_qty            | Decimal           | Yes      | Default 0; updated from picking |
| shipped_qty           | Decimal           | Yes      | Default 0; updated from shipment |
| delivered_qty         | Decimal           | Yes      | Default 0; updated from delivery confirmation |
| invoiced_qty          | Decimal           | Yes      | Default 0; updated from invoice |
| cancelled_qty         | Decimal           | Yes      | Default 0; qty cancelled |
| returned_qty          | Decimal           | Yes      | Default 0; qty returned |
| unit_price            | Decimal           | Yes      | Unit price (pre-tax or tax-inclusive based on flag) |
| discount_percent      | Decimal           | No       | Line-level discount % |
| discount_amount       | Decimal           | No       | Line-level discount value |
| tax_percent           | Decimal           | No       | Standard tax rate applied |
| tax_amount            | Decimal           | No       | Tax amount computed for line |
| line_subtotal         | Decimal           | Yes      | Qty × unit_price (before discounts/taxes) |
| line_total            | Decimal           | Yes      | Subtotal - discount + tax |
| warehouse_location_id | FK (Location)     | No       | Warehouse for fulfillment (if differs from header) |
| required_delivery_date| Date              | No       | Required delivery date for this line |
| promised_delivery_date| Date              | No       | Promised delivery date for this line |
| quote_line_id         | FK (Quote Line)   | No       | Quote line reference (if fulfilled from Quote) |
| line_status           | Enum              | Yes      | `OPEN`, `ALLOCATED`, `PICKED`, `PACKED`, `PARTIALLY_SHIPPED`, `FULLY_SHIPPED`, `PARTIALLY_INVOICED`, `FULLY_INVOICED`, `CANCELLED` |
| backorder_qty         | Decimal           | Yes      | Default 0; qty on backorder |
| backorder_reason      | Text              | No       | Reason for backorder |
| line_remarks_internal | Text              | No       | Buyer-only notes |
| line_remarks_to_customer| Text            | No       | Customer-visible notes (line-level) |
| created_at            | DateTime          | Auto     |  |
| updated_at            | DateTime          | Auto     |  |

**[NEW] Price Source & Override Traceability:**
| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| price_source         | Enum          | Yes      | [NEW] `PRICE_LIST`, `QUOTE`, `PROMOTION`, `MANUAL_OVERRIDE` (default: PRICE_LIST) |
| price_list_id        | FK (PriceList)| No       | [NEW] Reference to price list used (if price_source = PRICE_LIST) |
| override_reason      | Text          | No       | [NEW] Required if price_source = MANUAL_OVERRIDE |
| cost_price           | Decimal       | No       | [NEW] Unit cost price (for margin calculation, read-only) |
| gross_margin_pct     | Decimal       | No       | [NEW] ((unit_price - cost_price) / unit_price) × 100 |

---

### C) Quote–Order Link (`sales_quote_order_link`)

This was already introduced in 6.1 Quote; here we reuse it from the Order perspective.

Fields (same table, used bidirectionally):

| Field                 | Type              | Required | Description |
|-----------------------|-------------------|----------|-------------|
| id                    | UUID              | Yes      | Primary key |
| quote_line_id         | FK (Quote Line)   | Yes      | Quote line fulfilled |
| sales_order_id        | FK (Order Header) | Yes      | Order header |
| order_line_id         | FK (Order Line)   | Yes      | Order line created |
| ordered_qty_from_quote| Decimal           | Yes      | Quantity ordered from quote line |
| created_at            | DateTime          | Auto     |  |

From Order side:
- Whenever an order line is created from quote line, an entry is created/updated here.
- Ensures quote line `remaining_qty` is updated correctly.
- Updates quote status to `PARTIALLY_CONVERTED` or `FULLY_CONVERTED`.

---

### D) Config / Control (Conceptual)

Key controls (config / YAML / system params):

**[EXISTING]**
- `order_requires_quote` (Company, Location, Customer Type, Threshold)
- `allow_direct_order_for_categories` (list)
- `credit_check_required` (Boolean, default: true)
- `credit_hold_on_exceed` (Boolean, default: true)
- `allow_backorders` (Boolean, default: true)
- `over_ship_tolerance_percent` (e.g., allow shipping up to +5%)
- `price_change_tolerance_percent` (allowed % above quote price before requiring approval)
- `allow_order_amendments_after_shipment` (Yes/No, and for which fields)
- `order_approval_thresholds` (role-based matrix by value/customer type)
- `auto_allocate_inventory` (Boolean, default: false)
- `require_delivery_confirmation` (Boolean, default: false)

**[NEW] Revision & Conversion Control:**
- `order_revision_enabled` (Boolean, default: true)
- `max_revisions` (Integer, default: 5)
- `allow_partial_shipment` (Boolean, default: true)
- `allow_partial_invoicing` (Boolean, default: true)

**[NEW] Margin Protection:**
- `enforce_margin_check` (Boolean, default: false)
- `minimum_margin_threshold` (Decimal, percentage, e.g., 15.0)
- `margin_action` (Enum: `REQUIRE_APPROVAL`, `BLOCK`)

**[NEW] Fulfillment Control:**
- `auto_confirm_on_approval` (Boolean, default: false)
- `require_picking_confirmation` (Boolean, default: true)
- `require_packing_confirmation` (Boolean, default: true)

---

## 6.2.3 UI / UX Requirements

**Screen Name:** Sales Order  
**Path:** Sales → Orders

### A) Order List

Columns:

- Order Number
- Order Date
- Customer Name
- Sales Person
- Status
- Grand Total
- Required Delivery Date
- Linked Quote (Yes/No or Quote Number)
- Fulfillment Status (%)
- Invoice Status (%)
- Actions

Filters:

- Date range (Order Date)
- Status (DRAFT, APPROVED, CONFIRMED, PROCESSING, SHIPPED, etc.)
- Customer
- Sales Person
- Location
- Sales Channel
- Has Quote? (Yes/No)
- Fulfillment Status (Not Started / In Progress / Complete)
- Invoice Status (Not Invoiced / Partially Invoiced / Fully Invoiced)
- Credit Hold (Yes/No)

Actions:

- Create Order
- Open/Edit Order (depending on status/role)
- Submit for Approval
- Approve / Reject (for approvers)
- Confirm Order (send confirmation to customer)
- Allocate Inventory
- Process Picking
- Process Packing
- Create Shipment
- Generate Invoice
- Cancel Order (with reason)
- View Order History / Amendments
- Print/Email Order Confirmation

---

### B) Order Header Form

Sections:

**General**
- Order Number (auto)
- Order Date (default to today)
- Customer (lookup)
- Customer Contact Name / Email / Phone
- Sales Person (default: current user, editable)
- Sales Channel
- Ordering Location
- Shipping Location (warehouse)
- Customer PO Number
- Priority
- Order Type

**Delivery & Shipping**
- Required Delivery Date
- Promised Delivery Date
- Shipping Method
- Shipping Address (default from customer, editable)
- Billing Address (default from customer, editable)
- Special Instructions

**Commercial Terms**
- Currency
- Payment Terms
- Delivery Terms
- Tax Inclusive? (Yes/No)
- Header Discount % / Amount
- Shipping Charges

**References**
- Linked Quote (if any)
- Linked Quote Lines (view lines referenced)

**Notes**
- Internal Notes (not printed)
- Remarks to Customer (printed on order confirmation)

**Totals** (calculated, read-only)
- Subtotal
- Discount
- Shipping Charges
- Tax
- Grand Total
- **[NEW]** Cost Total (if visible to user role)
- **[NEW]** Gross Margin %

**System Info** (read-only)
- Order Status
- Approval Required? (Yes/No)
- Approved By / At
- Confirmed At
- Sent to Customer At
- Credit Hold? (Yes/No with reason)
- Version No
- Amendment Of (if this is a revised order)
- **[NEW]** Fulfillment Timeline:
  - Allocated At
  - Picked At
  - Packed At
  - Shipped At
  - Delivered At

---

### C) Order Line Entry

Grid behavior:

Columns:
- Line No
- Item Code / Name lookup
- SKU / Variant
- Description Override (editable)
- UOM
- Ordered Qty
- Allocated Qty (read-only)
- Shipped Qty (read-only)
- Invoiced Qty (read-only)
- Backorder Qty (read-only)
- Unit Price
- Discount %
- Line Subtotal
- Tax %
- Tax Amount
- Line Total
- **[NEW]** Cost Price (if visible)
- **[NEW]** Margin %
- Warehouse Location
- Required Delivery Date
- Quote Reference (if from Quote)
- Line Status
- Actions (Edit, Delete, Copy)

Features:

**Add line:**
- From Item Master search
- From Quote line selection: "Add from Quote" (filter by customer, status, item)
- From customer order history (quick reorder)
- Barcode scan (optional)

**Inline validation:**
- Required fields for item, qty, price, UOM
- Non-zero ordered quantity
- Stock availability check (warning if insufficient)
- Credit limit check (warning if exceeded)
- Read-only fields when derived from Quote:
  - Optionally lock price & terms if config prohibits price override

**Inventory Actions:**
- Check Availability (real-time stock check)
- Reserve Stock (allocate inventory)
- View Allocation Details

**Totals panel at bottom:**
- Sum of subtotal, discount, shipping, tax, total
- **[NEW]** Total margin and margin %

---

### D) Approver View

Approvers see:

**Summary header:**
- Customer, amount, sales person, location
- Credit status and limit utilization

**Risk flags:**
- Price above quote/price list?
- Customer credit limit exceeded?
- Customer payment history (overdue invoices?)
- Missing quote despite threshold?
- Margin below threshold?

**Key calculated data:**
- Order value vs approval limit
- Credit limit consumption
- Margin analysis

**Actions:**
- Approve (with optional comment)
- Reject (reason required)
- Approve with Credit Override (if credit exceeded)
- Request Clarification

---

### E) Customer-Facing View (Print / PDF / Email)

Order confirmation document includes:

- Customer details
- Order number and date
- Delivery details and promised date
- Line items with quantities & prices
- Taxes & totals
- Payment terms & delivery terms
- Tracking information (if shipped)
- Company branding and signature block

System must support generating:
- PDF
- Email with attached PDF
- Customer portal view (optional)

---

## 6.2.4 Validation Rules

**Header-level:**

- `order_number` unique per company
- `customer_id` required and must reference ACTIVE customer
- `ordering_location_id` required
- `order_date` cannot be in the future (configurable rule)
- If `order_requires_quote` is true for this customer type/category:
  - At least one line must reference a quote line
- If `credit_check_required = true`:
  - Validate customer credit limit
  - If exceeded and `credit_hold_on_exceed = true`: Set `credit_hold = true`, require credit approval
- `promised_delivery_date` must be >= `required_delivery_date` (if both set)

**Line-level:**

- At least one line item is required
- `ordered_qty > 0`
- `ordered_qty >= shipped_qty + cancelled_qty`
- `unit_price >= 0`
- When line is linked to Quote:
  - If `price_change_tolerance_percent` is configured:
    - Order line price deviation vs Quote price above tolerance → requires additional approval
- When line is linked to Quote:
  - `ordered_qty_from_quote` (sum from order lines) must not exceed `quote_line.quantity - quote_line.remaining_qty`
- Stock availability validation:
  - If `allow_backorders = false`: `ordered_qty` must not exceed available stock
  - If `allow_backorders = true`: Flag backorder qty and reason

**Status/Workflow integrity:**

- Cannot submit for approval when:
  - Required header fields are missing
  - Any line is incomplete
  - Credit hold is active (unless override approved)
- Cannot approve order with status not in `PENDING_APPROVAL`
- Cannot confirm order if status < `APPROVED`
- Cannot allocate inventory if status < `CONFIRMED`
- Cannot ship if status < `CONFIRMED` or inventory not allocated
- Cannot invoice if status < `CONFIRMED`
- Cannot cancel order if:
  - Any line is `FULLY_SHIPPED` (should go through return process instead)
  - Any line is `FULLY_INVOICED` (requires credit note)

**Pricing validation:**

- Unit price cannot be below cost (if `enforce_minimum_margin = true`)
- Total discount cannot exceed customer credit limit (if configured)
- Currency must match customer's default currency (or allow multi-currency with conversion)

**[NEW] Revision & Versioning:**

- If creating a revision (parent_order_id is set):
  - `revision_number` = parent's revision_number + 1
  - `revision_reason` is required
  - Parent order's `is_latest_revision` must be set to false
  - Only orders with `is_latest_revision = true` can be shipped/invoiced

**[NEW] Margin Protection:**

- If `enforce_margin_check = true` (config):
  - If `gross_margin_pct < minimum_margin_threshold` (from config):
    - If `margin_action = REQUIRE_APPROVAL`: Require approval
    - If `margin_action = BLOCK`: Block submission

**[NEW] Approval Snapshot:**

- When order moves to `APPROVED`:
  - Capture `approval_rule_snapshot` as JSON with discount %, credit limit, approver role, rule version, timestamp

**Config behavior:**

- If `order_requires_quote = false` for a company/location:
  - Direct order creation allowed
- If `auto_allocate_inventory = true`:
  - Inventory allocated automatically on order confirmation
- If `auto_confirm_on_approval = true`:
  - Order status moves to `CONFIRMED` automatically after approval

---

## 6.2.5 Workflow

**Hybrid, config-driven workflow:**

Default state machine:

- `DRAFT`  
  → **Submit** → `PENDING_APPROVAL`  
  → **Approve** → `APPROVED`  
  → **Reject** → `REJECTED`  
  → **Confirm** → `CONFIRMED`  
  → **Allocate Inventory** → `PROCESSING`  
  → **Pick** → `PROCESSING` (picked_at set)  
  → **Pack** → `PROCESSING` (packed_at set)  
  → **Ship (Partial)** → `PARTIALLY_SHIPPED`  
  → **Ship (Complete)** → `FULLY_SHIPPED`  
  → **Invoice (Partial)** → `PARTIALLY_INVOICED`  
  → **Invoice (Complete)** → `FULLY_INVOICED`  
  → **Deliver** → `DELIVERED`  
  → **Close** → `CLOSED`  
  → **Cancel** → `CANCELLED` (from DRAFT/PENDING_APPROVAL/APPROVED/CONFIRMED if allowed)

**Detailed Transitions:**

1. **DRAFT → PENDING_APPROVAL**:
   - Trigger: User clicks "Submit for Approval"
   - Validations: Must have lines, all required fields filled, credit check passed (or flagged)
   - Actions: Set submitted timestamp, notify approvers

2. **PENDING_APPROVAL → APPROVED**:
   - Trigger: Approver clicks "Approve"
   - Validations: User has approval role, within approval limits
   - Actions: Set approved_by, approved_at, capture approval_rule_snapshot, notify sales person

3. **PENDING_APPROVAL → REJECTED**:
   - Trigger: Approver clicks "Reject"
   - Validations: Rejection reason required
   - Actions: Set rejected_by, rejected_at, rejection_reason, notify sales person

4. **APPROVED → CONFIRMED**:
   - Trigger: User clicks "Confirm Order" (or auto if config)
   - Validations: Order approved, credit approved (if required)
   - Actions: Set confirmed_at, send order confirmation to customer, set sent_to_customer_at

5. **CONFIRMED → PROCESSING (Allocation)**:
   - Trigger: User clicks "Allocate Inventory" (or auto if config)
   - Validations: Sufficient stock available (or backorder allowed)
   - Actions: Reserve inventory, update allocated_qty for each line, set allocated_at

6. **PROCESSING → PROCESSING (Picking)**:
   - Trigger: Warehouse picks items
   - Validations: Inventory allocated
   - Actions: Update picked_qty for each line, set picked_at

7. **PROCESSING → PROCESSING (Packing)**:
   - Trigger: Warehouse packs items
   - Validations: Items picked
   - Actions: Update packed status, set packed_at

8. **PROCESSING → PARTIALLY_SHIPPED**:
   - Trigger: Create shipment for some lines
   - Validations: Items picked and packed
   - Actions: Update shipped_qty for shipped lines, set shipped_at, generate tracking number

9. **PARTIALLY_SHIPPED → FULLY_SHIPPED**:
   - Trigger: All lines shipped
   - Validations: All lines have shipped_qty = ordered_qty - cancelled_qty
   - Actions: Update status, notify customer with tracking

10. **FULLY_SHIPPED → PARTIALLY_INVOICED**:
    - Trigger: Create invoice for some lines
    - Validations: Lines shipped
    - Actions: Update invoiced_qty for invoiced lines

11. **PARTIALLY_INVOICED → FULLY_INVOICED**:
    - Trigger: All lines invoiced
    - Validations: All lines have invoiced_qty = shipped_qty
    - Actions: Update status, trigger revenue recognition

12. **FULLY_SHIPPED → DELIVERED**:
    - Trigger: Customer confirms delivery (or auto after X days)
    - Validations: All lines shipped
    - Actions: Set actual_delivery_date, update delivered_qty

13. **DELIVERED/FULLY_INVOICED → CLOSED**:
    - Trigger: Manual closure or auto after delivery + full invoice + payment
    - Validations: All fulfillment and invoicing complete
    - Actions: Archive order, update analytics

**Config variations:**

- If `order_approval_required = false`:
  - `DRAFT → APPROVED` directly when user submits
- If `auto_confirm_on_approval = true`:
  - `APPROVED → CONFIRMED` automatically
- If `auto_allocate_inventory = true`:
  - `CONFIRMED → PROCESSING` with allocation automatically
- In very simple setups:
  - Only `DRAFT → APPROVED → CONFIRMED → SHIPPED → INVOICED → CLOSED` + `CANCELLED`

**[NEW] Revision Workflow:**

New transition:
- **CONFIRMED → DRAFT (Revision)**:
  - Trigger: User clicks "Create Revision"
  - Validations: `order_revision_enabled = true` (config), no shipments yet
  - Actions:
    - Set current order's `is_latest_revision = false`
    - Create new order with:
      - `parent_order_id` = current order ID
      - `revision_number` = parent's revision_number + 1
      - `order_status = DRAFT`
      - `is_latest_revision = true`
      - Copy all lines from parent
      - Release allocated inventory from parent
    - Notify sales person and customer

**[NEW] Partial Shipment/Invoice:**

- Order can remain in `PARTIALLY_SHIPPED` or `PARTIALLY_INVOICED` for extended periods
- Multiple shipments/invoices can be created against one order
- Each shipment/invoice updates respective qty fields on order lines
- Order closes only when all lines are fully shipped and invoiced (or explicitly closed)

**[NEW] Backorder Handling:**

- If stock insufficient and `allow_backorders = true`:
  - Line status = `OPEN` with `backorder_qty` set
  - Order can be partially shipped (available items)
  - Backorder items ship when stock arrives
  - Customer notified of backorder status

---

## 6.2.6 Module Metadata & Build Steps

### Module Metadata

```yaml
module_type: transaction
complexity: medium

template_ref: _txn_02

extension_allowed: true

depends_on:
  - Company
  - Locations
  - Customer Master
  - Item Master
  - Item Variants
  - Units of Measure
  - Price Lists
  - Tax Configuration
  - Users / Roles
  - Sales Quotation (6.1)
  - Inventory Management

used_by:
  - Sales Invoice (6.3)
  - Sales Return (6.4)
  - Inventory Allocation
  - Shipping & Delivery
  - Revenue Recognition
  - Sales Analytics / Reporting

integrates_with:
  - Email Service (for order confirmations)
  - PDF Generation Service
  - Customer Portal
  - Pricing Engine
  - Inventory Management (allocation, reservation)
  - Shipping Carriers (tracking integration)
  - Payment Gateway (for prepayment orders)

notes: >
  Sales Order is the anchor document for order fulfillment and revenue
  recognition. It supports approval workflows for credit and pricing
  validation, inventory allocation, partial shipments/invoicing, and
  serves as a feeder document to Sales Invoices and Shipping.
  It is hybrid-configurable, allowing organizations to either strictly
  enforce Quote→Order or bypass Quote entirely.

You are building a Medium Complexity Transaction module for a Retail ERP.

Module: Sales Order (SO)
Template: _txn_02

Requirements:

1) Backend (Django + DRF):
   - Models:
     - sales_order (header)
     - sales_order_line (lines)
     - sales_quote_order_link (link to Quote, reuse from 6.1)
   - Serializers for header + lines (nested or separate)
   - Viewsets with:
     - Filter by company, location, customer, status, sales_person, date range
     - Actions/endpoints for:
       - submit_order
       - approve_order
       - reject_order
       - confirm_order
       - allocate_inventory
       - process_picking
       - process_packing
       - create_shipment
       - generate_invoice
       - cancel_order
       - create_revision
   - Business rules for:
     - Status transitions
     - Credit limit validation
     - Pricing and discount validation
     - Inventory allocation
     - Partial shipment/invoice tracking
     - Hybrid configuration flags (order_enabled, approval_required)

2) Frontend (React + Vite + Tailwind):
   - Order List Page:
     - Filters (date, status, customer, sales person, location, channel)
     - Basic search (order number, customer name, customer PO)
     - Quick actions (view, edit, confirm, allocate, ship, invoice)
   - Order Edit Page:
     - Header form (customer, dates, terms, addresses, shipping)
     - Lines grid with add/edit/delete
     - Inventory availability check
     - Pricing calculations (subtotal, discount, shipping, tax, total)
     - Margin visibility (if role permits)
     - Buttons:
       - Save as Draft
       - Submit for Approval
       - Approve / Reject (for approvers)
       - Confirm Order
       - Allocate Inventory
       - Process Picking/Packing
       - Create Shipment
       - Generate Invoice
       - Mark as Delivered
       - Cancel (with confirmation)
   - Order Fulfillment View:
     - Allocation status
     - Picking list
     - Packing list
     - Shipment tracking
   - Order PDF Preview/Print
   - Show read-only sections for approvals, fulfillment, and invoice linkage

3) Integration:
   - Axios service for all Order CRUD & workflow endpoints
   - PDF generation service integration
   - Email service integration
   - Inventory service integration (allocation, reservation)
   - Design response structures so that Sales Invoice (6.3) can:
     - Search for CONFIRMED/SHIPPED Orders
     - Consume Order lines and create Invoice lines
     - Update order status to PARTIALLY_INVOICED/FULLY_INVOICED


MODULE: Sales Order
TYPE: Transaction (Medium, _txn_02)

DATA MODEL:
- Header: company, order_number, customer, status, dates (order_date, delivery_dates),
  sales_person, location, pricing (subtotal, discount, shipping, tax, grand_total),
  addresses, terms, approval flags, fulfillment tracking, invoice tracking,
  revision tracking, margin tracking, audit fields
- Lines: item_variant, UOM, ordered_qty, allocated_qty, shipped_qty, invoiced_qty,
  unit_price, discount, tax, line_total, delivery_date, status, price_source,
  cost_price, margin

WORKFLOW:
- DRAFT → PENDING_APPROVAL → APPROVED / REJECTED → CONFIRMED → PROCESSING →
  PARTIALLY_SHIPPED / FULLY_SHIPPED → PARTIALLY_INVOICED / FULLY_INVOICED →
  DELIVERED → CLOSED / CANCELLED
- Config flags can simplify: no approval, auto-confirm, auto-allocate
- Support for partial shipments and partial invoicing
- Revision workflow for order amendments

UI:
- List + Edit screens with clear separation of header, lines, pricing, fulfillment, approvals
- Fulfillment tracking (allocation, picking, packing, shipping)
- Invoice generation and tracking
- Credit limit and margin visibility
- Customer-facing actions (confirm, track, deliver)

Use template _txn_02 and generate:

- Django models, serializers, viewsets, URLs for Order header + lines +
  Quote–Order link
- React pages for:
  - Order list
  - Order edit (header + lines + pricing + fulfillment + approval info)
  - Order fulfillment view
  - Order PDF preview
- Axios API service for all operations (CRUD + workflow + fulfillment)

Enforce all validation and workflow rules described in the
Sales Order specification.
