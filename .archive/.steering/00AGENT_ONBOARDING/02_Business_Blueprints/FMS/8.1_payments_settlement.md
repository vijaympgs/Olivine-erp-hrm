# 8.1 Payments & Settlement (Unified AP/AR)
Template Ref: _txn_03 (Medium/Complex Transaction)

## 8.1.1 Business Purpose

The **Payments & Settlement** module manages the complete payment lifecycle for both **Accounts Payable (AP)** and **Accounts Receivable (AR)**, including:

### Accounts Payable (AP) - Outbound Payments:
- Standard supplier invoice payments
- Part-payments and adjustments
- Early payment discounts
- Retentions and milestone payments
- Settlements against debit notes or credit notes

### Accounts Receivable (AR) - Inbound Payments:
- Customer payment receipts
- Invoice allocation and settlement
- Partial payments and overpayments
- Payment reconciliation
- Unapplied cash and advance payments

### Goals:

**For AP:**
- Ensure only approved, matched supplier invoices (from Procurement) are paid
- Optimize cash flow and working capital via:
  - Payment scheduling
  - Discount programs
  - Prioritization rules
- Maintain clear audit trail of supplier payments

**For AR:**
- Accurately record and allocate customer payments to invoices
- Manage cash application and reconciliation
- Track outstanding receivables and aging
- Support multiple payment methods and channels
- Enable dunning and collections workflows

**Common Goals:**
- Unified cash management and bank reconciliation
- Support different payment modes (Bank Transfer, Check, UPI, Credit Card, etc.)
- Maintain comprehensive audit trail (what, when, from/to which account)
- Enable both single-payment and batch-payment processing
- Support multi-currency payments with FX handling

### Hybrid behavior (config-driven):

Payments can be processed:
- **Per invoice** (single-payment mode)
- **Via Payment Runs/Batches** (group payments by date/supplier/customer/bank)

Settlement model can:
- Auto-apply credit notes and debit notes
- Support partial payments and multi-invoice settlement
- Handle advance payments and unapplied cash
- Support payment allocation across multiple invoices

---

## 8.1.2 Data Model

### A) Payment Batch Header (`payment_batch`)

Represents one logical "payment run" (e.g., weekly AP payment cycle or daily AR receipt batch).

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| batch_number         | String(30)   | Yes      | Payment batch ID (auto-generated) |
| batch_type           | Enum         | Yes      | `AP` (Accounts Payable), `AR` (Accounts Receivable) |
| batch_status         | Enum         | Yes      | `DRAFT`, `READY_FOR_REVIEW`, `APPROVAL_PENDING`, `APPROVED`, `EXECUTED`, `PARTIALLY_EXECUTED`, `RECONCILED`, `CANCELLED` |
| batch_date           | Date         | Yes      | Logical batch/run date |
| payment_date         | Date         | No       | Intended payment/receipt date |
| bank_account_id      | FK (BankAccount)| Yes   | Bank account used for this run |
| total_batch_amount   | Decimal      | Yes      | Sum of planned payments/receipts in batch |
| currency_code        | String(3)    | Yes      | Currency (usually company base) |
| payment_method       | Enum         | No       | `BANK_TRANSFER`, `CHECK`, `UPI`, `CREDIT_CARD`, `CASH`, `WALLET`, `OTHER` |
| created_by_user_id   | FK (User)    | Yes      | Creator |
| reviewed_by_user_id  | FK (User)    | No       | Optional reviewer before approval |
| approved_by_user_id  | FK (User)    | No       | Approver for payment run |
| approved_at          | DateTime     | No       | Approval timestamp |
| executed_by_user_id  | FK (User)    | No       | Who triggered actual payment file/API |
| executed_at          | DateTime     | No       | Execution timestamp |
| reconciled_by_user_id| FK (User)    | No       | Who reconciled batch with bank statement |
| reconciled_at        | DateTime     | No       | Reconciliation timestamp |
| remarks_internal     | Text         | No       | Internal notes for AP/AR/Finance |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### B) Supplier Payment (`supplier_payment`)

Represents one supplier-level payment instruction, possibly covering multiple invoices.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| payment_batch_id     | FK (PaymentBatch)| No   | Optional; may also support ad-hoc payment (no batch) |
| company_id           | FK           | Yes      | Company scope |
| supplier_id          | FK (Supplier)| Yes      | Supplier being paid |
| payment_reference_number| String(50)| Yes      | Internal payment ref (can store bank UTR later) |
| payment_status       | Enum         | Yes      | `PLANNED`, `PENDING_EXECUTION`, `EXECUTED`, `FAILED`, `RECONCILED`, `CANCELLED` |
| payment_mode         | Enum         | Yes      | `BANK_TRANSFER`, `CHECK`, `MANUAL_SETTLEMENT`, `UPI`, `OTHER` |
| bank_account_id      | FK (BankAccount)| Yes   | From which account money goes out |
| supplier_bank_account| String(100)  | No       | Supplier's bank account details |
| payment_currency_code| String(3)    | Yes      | Currency used |
| payment_amount       | Decimal      | Yes      | Total amount paid to supplier |
| early_payment_discount_taken| Decimal| Yes    | Total discount benefit taken (if any) |
| fx_rate_applied      | Decimal      | No       | For foreign currency payments |
| payment_execution_ref| String(100)  | No       | UTR/transaction ID from bank |
| payment_value_date   | Date         | No       | Actual settlement date at bank |
| check_number         | String(50)   | No       | Check number (if payment_mode = CHECK) |
| check_date           | Date         | No       | Check date |
| remarks_internal     | Text         | No       | Internal notes on payment |
| remarks_to_supplier  | Text         | No       | Notes for payment advice |
| created_by_user_id   | FK (User)    | Yes      | Creator |
| executed_by_user_id  | FK (User)    | No       | Execution user |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### C) Customer Payment Receipt (`customer_payment_receipt`)

Represents one customer payment receipt, possibly covering multiple invoices.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| payment_batch_id     | FK (PaymentBatch)| No   | Optional; may also support ad-hoc receipt (no batch) |
| company_id           | FK           | Yes      | Company scope |
| customer_id          | FK (Customer)| Yes      | Customer making payment |
| receipt_number       | String(30)   | Yes      | Receipt reference number (auto-generated) |
| receipt_status       | Enum         | Yes      | `DRAFT`, `RECEIVED`, `ALLOCATED`, `PARTIALLY_ALLOCATED`, `UNAPPLIED`, `RECONCILED`, `CANCELLED` |
| receipt_mode         | Enum         | Yes      | `BANK_TRANSFER`, `CHECK`, `CASH`, `CREDIT_CARD`, `UPI`, `WALLET`, `OTHER` |
| bank_account_id      | FK (BankAccount)| Yes   | To which account money comes in |
| receipt_date         | Date         | Yes      | Date payment received |
| receipt_currency_code| String(3)    | Yes      | Currency received |
| receipt_amount       | Decimal      | Yes      | Total amount received from customer |
| allocated_amount     | Decimal      | Yes      | Amount allocated to invoices (default: 0) |
| unapplied_amount     | Decimal      | Yes      | Amount not yet allocated (receipt_amount - allocated_amount) |
| fx_rate_applied      | Decimal      | No       | For foreign currency receipts |
| payment_reference    | String(100)  | No       | Customer's payment reference/transaction ID |
| check_number         | String(50)   | No       | Check number (if receipt_mode = CHECK) |
| check_date           | Date         | No       | Check date |
| credit_card_last4    | String(4)    | No       | Last 4 digits of credit card |
| payment_gateway_ref  | String(100)  | No       | Payment gateway transaction ID |
| remarks_internal     | Text         | No       | Internal notes on receipt |
| remarks_from_customer| Text         | No       | Notes from customer |
| created_by_user_id   | FK (User)    | Yes      | Creator |
| reconciled_by_user_id| FK (User)    | No       | Who reconciled receipt |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### D) Payment–Invoice Link (`payment_invoice_link`)

Connects payments to invoices and credit/debit notes (works for both AP and AR).

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| link_type            | Enum         | Yes      | `AP` (supplier payment), `AR` (customer receipt) |
| supplier_payment_id  | FK (SupplierPayment)| No | For AP: Payment header |
| customer_receipt_id  | FK (CustomerReceipt)| No | For AR: Receipt header |
| supplier_invoice_id  | FK (SupplierInvoice)| No | For AP: Invoice settled |
| sales_invoice_id     | FK (SalesInvoice)| No    | For AR: Invoice settled |
| gross_invoice_amount | Decimal      | Yes      | Original invoice value |
| credit_notes_adjusted_amount| Decimal| Yes    | Total credit applied against this invoice |
| discount_taken_amount| Decimal      | Yes      | Early payment or other discount |
| net_payable_amount   | Decimal      | Yes      | Net payable/receivable after above adjustments |
| amount_paid_received | Decimal      | Yes      | Actual paid/received amount (can be partial) |
| remaining_balance_after_payment| Decimal| Yes  | Outstanding after this payment/receipt |
| settlement_type      | Enum         | Yes      | `FULL`, `PARTIAL`, `ADVANCE`, `FINAL`, `UNAPPLIED` |
| allocation_date      | Date         | No       | Date when payment was allocated to invoice |
| allocated_by_user_id | FK (User)    | No       | Who allocated payment |
| created_at           | DateTime     | Auto     |  |

> Note: Credit/debit notes may be modeled as special invoice entries or separate financial documents; this link handles netting logic conceptually.

---

### E) Bank Account (`bank_account`)

Represents company bank accounts for payment processing.

| Field                | Type          | Required | Description |
|----------------------|--------------|----------|-------------|
| id                   | UUID         | Yes      | Primary key |
| company_id           | FK           | Yes      | Company scope |
| account_name         | String(100)  | Yes      | Account name/description |
| account_number       | String(50)   | Yes      | Bank account number |
| bank_name            | String(100)  | Yes      | Bank name |
| bank_branch          | String(100)  | No       | Branch name |
| ifsc_code            | String(20)   | No       | IFSC/SWIFT/Routing code |
| currency_code        | String(3)    | Yes      | Account currency |
| account_type         | Enum         | Yes      | `CURRENT`, `SAVINGS`, `ESCROW`, `VIRTUAL` |
| is_active            | Boolean      | Yes      | Active status |
| is_default_ap        | Boolean      | Yes      | Default for AP payments |
| is_default_ar        | Boolean      | Yes      | Default for AR receipts |
| opening_balance      | Decimal      | No       | Opening balance |
| current_balance      | Decimal      | No       | Current balance (updated from transactions) |
| created_at           | DateTime     | Auto     |  |
| updated_at           | DateTime     | Auto     |  |

---

### F) Config / Control (Conceptual)

**AP Configuration:**
- `auto_select_invoices_due_within_days` (e.g., 7 days)
- `payment_run_requires_approval` (Yes/No; possibly threshold-based)
- `min_discount_percent_to_take_early_payment` (e.g., >1% only)
- `max_invoices_per_payment` (for UI constraints)
- `block_payment_if_invoice_status != APPROVED` (true/false)
- `partial_payment_allowed` (Yes/No; and when)

**AR Configuration:**
- `auto_allocate_receipts_to_oldest_invoice` (Yes/No)
- `allow_unapplied_cash` (Yes/No)
- `allow_overpayment` (Yes/No; and action: refund or credit)
- `require_receipt_approval` (Yes/No; threshold-based)
- `auto_send_receipt_confirmation` (Yes/No)
- `allow_partial_allocation` (Yes/No)

---

## 8.1.3 UI / UX Requirements

### A) Payment Batch List (Unified)

**Screen Name:** Payment Batches  
**Path:** Finance → Payments & Settlement → Payment Batches

**Columns:**
- Batch Number
- Batch Type (AP/AR)
- Batch Date
- Payment/Receipt Date
- Bank Account
- Total Amount
- Status
- Created By / Approved By / Executed By
- Actions

**Filters:**
- Date range
- Batch Type (AP/AR)
- Status
- Bank account
- Created By / Approved By

**Actions:**
- Create New AP Batch
- Create New AR Batch
- View/Edit Batch
- Submit for Approval
- Approve Batch
- Execute Batch (export bank file / trigger API)
- Reconcile Batch
- Cancel Batch (if not executed)

---

### B) AP Payment Batch Detail

**Sections:**

**Header:**
- Batch No, Date
- Bank Account
- Payment Date
- Status
- Remarks

**Invoice Selection Panel:**
- Filter invoices by:
  - Supplier
  - Due date range
  - Status = APPROVED
  - With/without discount eligibility
- Multi-select invoices

**Selected Payments Grid:**
- Supplier
- Invoice Number
- Invoice Date
- Invoice Amount
- Due Date
- Suggested Payment Amount
- Discount available? (Yes/No, discount amount)
- Discount taken (checkbox or amount)
- Net Payable
- Included in Batch? (flag)

**Totals section:**
- Sum of all net payable by supplier
- Sum of batch total

---

### C) AR Payment Receipt Detail

**Sections:**

**Header:**
- Receipt Number, Date
- Customer
- Bank Account
- Receipt Mode
- Receipt Amount
- Allocated Amount
- Unapplied Amount
- Status

**Invoice Allocation Panel:**
- Show customer's outstanding invoices:
  - Invoice Number
  - Invoice Date
  - Invoice Amount
  - Amount Paid (previous)
  - Amount Due
  - Allocate Amount (input)
- Auto-allocate button (oldest first)
- Manual allocation

**Allocation Summary:**
- Total Receipt Amount
- Total Allocated
- Remaining Unapplied

---

### D) Supplier Payment View

For each supplier_payment:

**Details:**
- Supplier details (name, ID, bank info)
- Payment amount and mode
- Payment reference/UTR
- Check details (if applicable)

**Linked invoices:**
- Invoice No, Amount, Paid Amount, Remaining Balance

**Actions:**
- Mark as Executed (if not using automatic bank integration)
- Edit remarks
- Generate Payment Advice
- Print/Email Payment Advice

---

### E) Customer Receipt View

For each customer_receipt:

**Details:**
- Customer details (name, ID)
- Receipt amount and mode
- Payment reference
- Check/Card details (if applicable)

**Allocated invoices:**
- Invoice No, Amount, Allocated Amount, Remaining Balance

**Actions:**
- Allocate to Invoices
- Mark as Reconciled
- Generate Receipt Document
- Print/Email Receipt

---

### F) Payment Advice / Receipt Documents

**AP - Payment Advice PDF/Email:**
- Paid invoices list
- Amounts
- Any deductions (discounts, returns, debit notes)
- Payment reference (UTR, check no, etc.)

**AR - Receipt Document PDF/Email:**
- Receipt number and date
- Amount received
- Allocated invoices
- Remaining balance (if any)
- Payment method details

---

## 8.1.4 Validation Rules

### AP Validation Rules:

**Header-level (Batch):**
- `batch_number` unique per company
- `bank_account_id` required
- `payment_date` cannot be in the past (or allowed with warning, per config)
- Batch cannot move to APPROVAL_PENDING or APPROVED:
  - If no supplier_payment entries exist
  - If any linked invoices are no longer in APPROVED status

**Supplier Payment-level:**
- `payment_amount > 0`
- `payment_currency_code` consistent with invoice or properly converted
- For each linked invoice:
  - `amount_paid_received <= net_payable_amount`
  - If `partial_payment_allowed = false`: `amount_paid_received` must equal `net_payable_amount`

**Posting/Execution:**
- Cannot EXECUTE payment:
  - If batch/individual payment not APPROVED (where approval_required = true)
  - Cannot mark payment as EXECUTED twice

---

### AR Validation Rules:

**Header-level (Batch):**
- `batch_number` unique per company
- `bank_account_id` required
- `receipt_date` cannot be in the future

**Customer Receipt-level:**
- `receipt_amount > 0`
- `allocated_amount <= receipt_amount`
- `unapplied_amount = receipt_amount - allocated_amount`
- For each linked invoice:
  - `amount_paid_received <= remaining_invoice_balance`
  - Cannot allocate to fully paid invoices

**Allocation:**
- Cannot allocate more than receipt amount
- If `allow_unapplied_cash = false`: Must allocate full receipt amount
- If `allow_overpayment = false`: Cannot allocate more than invoice due amount

---

## 8.1.5 Workflow

### AP Workflow:

**Batch-level:**
- `DRAFT`  
  → Review → `READY_FOR_REVIEW` (optional intermediate)  
  → Submit for Approval → `APPROVAL_PENDING`  
  → Approve → `APPROVED`  
  → Execute (bank file/API or manual) → `EXECUTED`  
  → Reconcile with bank statement → `RECONCILED`

**Alternative:**
- `DRAFT` → `CANCELLED`
- `APPROVAL_PENDING` → `REJECTED` (and optionally back to DRAFT)

**Supplier Payment-level:**
- `PLANNED` → `PENDING_EXECUTION` (once batch is approved)
- `PENDING_EXECUTION` → `EXECUTED` (on confirm/payment file success)
- `PENDING_EXECUTION` → `FAILED` (if bank rejects; can be retried or cancelled)
- `EXECUTED` → `RECONCILED` (when matched with bank statement)

**Integration with Supplier Invoice:**
- Once payment is executed:
  - Update invoice's `amount_paid` and `amount_due`
  - If fully paid: Invoice status may move to `FULLY_PAID`
  - Create payment_invoice_link entry

---

### AR Workflow:

**Batch-level:**
- `DRAFT`  
  → Review → `READY_FOR_REVIEW`  
  → Approve → `APPROVED` (if approval required)  
  → Execute → `EXECUTED`  
  → Reconcile with bank statement → `RECONCILED`

**Customer Receipt-level:**
- `DRAFT` → `RECEIVED` (when payment physically received)
- `RECEIVED` → `ALLOCATED` (when fully allocated to invoices)
- `RECEIVED` → `PARTIALLY_ALLOCATED` (when partially allocated)
- `RECEIVED` → `UNAPPLIED` (when not allocated, if allowed)
- `ALLOCATED` → `RECONCILED` (when matched with bank statement)

**Integration with Sales Invoice:**
- Once receipt is allocated:
  - Update invoice's `amount_paid` and `amount_due`
  - If fully paid: Invoice status may move to `FULLY_PAID`
  - Create payment_invoice_link entry
  - Update customer credit balance

---

## 8.1.6 Module Metadata & Build Steps

### Module Metadata

```yaml
module_type: transaction
complexity: medium_to_complex

template_ref: _txn_03

extension_allowed: true

depends_on:
  - Company
  - Suppliers
  - Customers
  - Supplier Invoice Matching (Procurement)
  - Sales Invoice (Sales)
  - Bank Accounts / Treasury
  - Users / Roles
  - Payment Configuration

used_by:
  - Vendor Performance (for payment behavior metrics)
  - Customer Credit Management
  - Cash Flow & Treasury Planning
  - Financial Ledger / GL
  - Bank Reconciliation

integrates_with:
  - Banking APIs (for payment execution)
  - Payment Gateways (for online payments)
  - Bank Statement Import
  - GL Posting
  - Tax Compliance

notes: >
  Unified Payments & Settlement module handles both Accounts Payable
  (supplier payments) and Accounts Receivable (customer receipts).
  It supports batch processing, payment allocation, reconciliation,
  and multiple payment methods. The module serves as the bridge
  between procurement/sales invoices and actual cash movements.

You are building a Medium-to-Complex Transaction module for a Retail ERP.

Module: Payments & Settlement (Unified AP/AR)
Template: _txn_03

Requirements:

1) Backend (Django + DRF):

   Models:
   - payment_batch (unified for AP/AR)
   - supplier_payment (AP)
   - customer_payment_receipt (AR)
   - payment_invoice_link (unified)
   - bank_account

   Serializers:
   - Batch with nested payments/receipts and rollup amounts
   - Payment with nested invoice links
   - Receipt with nested invoice allocations

   Viewsets & Endpoints:
   - CRUD for payment batches (up to APPROVAL_PENDING)
   - AP Actions:
     - submit_batch_for_approval
     - approve_batch
     - reject_batch
     - execute_batch
     - mark_payment_executed
     - mark_payment_failed
     - generate_payment_advice
   - AR Actions:
     - receive_payment
     - allocate_to_invoices
     - auto_allocate
     - mark_receipt_reconciled
     - generate_receipt_document
   - Common Actions:
     - reconcile_with_bank_statement
     - cancel_payment_receipt

   Integration:
   - Query supplier_invoice records with status APPROVED and not fully paid
   - Query sales_invoice records with outstanding balance
   - Update invoices' paid/outstanding amounts
   - Provide hooks to generate:
     - Bank files (CSV, XML, etc.)
     - Payment advice export
     - Receipt documents

2) Frontend (React + Vite + Tailwind):

   Screens:
   - Payment Batch List (unified, filterable by AP/AR)
   - AP Payment Batch Detail:
     - Header + invoice selection + payment summary
   - AR Receipt Batch Detail:
     - Header + receipt entry + allocation
   - Supplier Payment Detail:
     - View payment with linked invoices
   - Customer Receipt Detail:
     - View receipt with allocated invoices
   - Bank Reconciliation View

   Behavior:
   - Respect status-based edit locks
   - Clearly highlight discount-taking options and net payable amounts (AP)
   - Show allocation suggestions and unapplied amounts (AR)
   - Real-time balance updates

3) Security & Roles:

   - Roles:
     - Payment Batch Creator
     - Payment Approver
     - Payment Executor
     - Receipt Recorder
     - Receipt Allocator
     - Reconciliation Manager
     - Payment Viewer

Ensure all validation and workflows conform to the spec above.


MODULE: Payments & Settlement (Unified AP/AR)
TYPE: Transaction (Medium/Complex, _txn_03)

DATA MODEL:
- Payment Batch: Unified batch header for AP/AR with batch_type flag
- Supplier Payment: AP payment details with invoice links
- Customer Receipt: AR receipt details with allocation
- Payment-Invoice Link: Unified linking for both AP and AR
- Bank Account: Company bank accounts for payment processing

WORKFLOW:
AP: DRAFT → READY_FOR_REVIEW → APPROVAL_PENDING → APPROVED → EXECUTED → RECONCILED
AR: DRAFT → RECEIVED → ALLOCATED/PARTIALLY_ALLOCATED/UNAPPLIED → RECONCILED

UI:
- Unified payment batch list with AP/AR filter
- AP: Invoice selection, discount management, payment advice
- AR: Receipt recording, invoice allocation, receipt documents
- Bank reconciliation interface

Use template _txn_03 and generate:

- Django models, serializers, viewsets, URLs for all payment entities
- React pages for:
  - Payment batch list (unified)
  - AP payment batch detail
  - AR receipt batch detail
  - Supplier payment view
  - Customer receipt view
  - Bank reconciliation
- Axios API service for all operations (CRUD + workflow + allocation + reconciliation)

Enforce all validation and workflow rules described in the
Payments & Settlement specification.
