# 4.11 Intercompany Trade (ICT)
Template Ref: _txn_03 (Medium/Complex Transaction)

---

## 4.11.1 Business Purpose

Intercompany Trade (ICT) governs **commercial transactions between two legal entities (companies)** within the same enterprise group.  
These are **not stock transfers**; they are legally enforceable **sales and purchases** requiring statutory, tax, and accounting compliance.

Goals:
- Model **intercompany movement as Sale + Purchase**, not transfer.
- Ensure **legal-entity level financial integrity** (AR/AP, revenue, expense).
- Support **tax compliance** (GST/VAT, invoicing, reporting).
- Maintain **audit trail** and reconciliation between entities.
- Enable **automation between paired companies** while preserving control.

ICT must:
- Reuse existing transactional engines (PO, GRN, Invoice, Payments)
- Enforce **company boundary rules**
- Treat each legal entity as an independent accounting unit

Canonical Rule:
> If seller_company_id ≠ buyer_company_id →  
> The system must enforce **commercial documents**, not inventory transfer.

---

## 4.11.2 Scope & Position in Process Chain

ICT spans both Sales and Procurement flows.

End-to-end chain:

Seller Company (A):
- Intercompany Sales Order (IC-SO)
- Dispatch / Delivery
- Intercompany AR Invoice

Buyer Company (B):
- Intercompany Purchase Order (IC-PO)
- GRN (Receipt)
- Intercompany AP Invoice
- Payment

Conceptual chain:

PR → IC-PO (Buyer)  
IC-SO (Seller) → Delivery → AR Invoice  
IC-PO → GRN → AP Invoice → Payment  

This module ensures:
- Document mirroring
- Referential linkage
- Cross-entity traceability

---

## 4.11.3 Master Data Dependencies

### A) Company as Business Partner

Each company must be able to act as:
- A **Customer** in other companies
- A **Supplier** in other companies

This is achieved by extending existing masters.

---

### B) Supplier Master (Extension)

| Field | Type | Required | Description |
|------|------|----------|-------------|
| is_intercompany_supplier | Boolean | Yes | True if this supplier is a group company |
| linked_company_id | FK (Company) | Yes | Which company this supplier represents |
| auto_accept_ic_po | Boolean | No | Auto-approve incoming IC-PO |
| default_ic_price_list_id | FK | No | Transfer price reference |
| default_tax_profile_id | FK | No | Intercompany tax behavior |

---

### C) Customer Master (Extension)

| Field | Type | Required | Description |
|------|------|----------|-------------|
| is_intercompany_customer | Boolean | Yes | True if this customer is a group company |
| linked_company_id | FK (Company) | Yes | Which company this customer represents |
| auto_accept_ic_so | Boolean | No | Auto-confirm IC-SO |
| default_ic_price_list_id | FK | No | Transfer price reference |
| default_tax_profile_id | FK | No | Intercompany tax behavior |

---

## 4.11.4 Data Model

### A) Intercompany Sales Order (ic_sales_order)

Seller-side commercial document.

| Field | Type | Required | Description |
|------|------|----------|-------------|
| id | UUID | Yes | Primary key |
| seller_company_id | FK (Company) | Yes | Selling legal entity |
| buyer_company_id | FK (Company) | Yes | Buying legal entity |
| customer_id | FK (Customer) | Yes | Must be intercompany customer |
| so_number | String(30) | Yes | Sequence per seller company |
| so_status | Enum | Yes | DRAFT, CONFIRMED, DISPATCHED, INVOICED, CLOSED |
| currency_code | String(10) | Yes | Transaction currency |
| price_list_id | FK | No | Transfer price source |
| total_net_amount | Decimal | Yes | Commercial value |
| linked_ic_po_id | FK | No | Back-reference to buyer PO |
| created_by_user_id | FK | Yes | Creator |
| created_at | DateTime | Auto |  |

---

### B) Intercompany Purchase Order (ic_purchase_order)

Buyer-side commercial document.

| Field | Type | Required | Description |
|------|------|----------|-------------|
| id | UUID | Yes | Primary key |
| buyer_company_id | FK (Company) | Yes | Buying legal entity |
| seller_company_id | FK (Company) | Yes | Selling legal entity |
| supplier_id | FK (Supplier) | Yes | Must be intercompany supplier |
| po_number | String(30) | Yes | Sequence per buyer company |
| po_status | Enum | Yes | DRAFT, APPROVED, RECEIVED, INVOICED, CLOSED |
| currency_code | String(10) | Yes | Transaction currency |
| linked_ic_so_id | FK | No | Back-reference to seller SO |
| total_net_amount | Decimal | Yes | Commercial value |
| created_by_user_id | FK | Yes | Creator |
| created_at | DateTime | Auto |  |

---

### C) Intercompany Invoice Link (ic_invoice_link)

Ensures AR/AP invoices are paired.

| Field | Type | Required | Description |
|------|------|----------|-------------|
| id | UUID | Yes | Primary key |
| seller_invoice_id | FK (AR Invoice) | Yes | Seller-side invoice |
| buyer_invoice_id | FK (AP Invoice) | Yes | Buyer-side invoice |
| reconciliation_status | Enum | Yes | OPEN, MATCHED, DISPUTED |
| variance_amount | Decimal | No | Difference if any |

---

## 4.11.5 UI / UX Requirements

### Navigation

Sales:
- Sales → Intercompany → Sales Orders
- Sales → Intercompany → Deliveries
- Sales → Intercompany → AR Invoices

Procurement:
- Procurement → Intercompany → Purchase Orders
- Procurement → Intercompany → Receipts
- Procurement → Intercompany → AP Invoices

Finance:
- Finance → Intercompany → Reconciliation
- Finance → Intercompany → Balances

---

### A) Intercompany Sales Order List

Columns:
- SO Number
- Buyer Company
- Status
- Total Amount
- Linked PO
- Created At

Actions:
- Create SO
- View / Edit
- Confirm
- Dispatch
- Generate Invoice

---

### B) Intercompany Purchase Order List

Columns:
- PO Number
- Seller Company
- Status
- Total Amount
- Linked SO
- Created At

Actions:
- View
- Approve
- Receive
- Match Invoice

---

### C) Intercompany Reconciliation Screen

Shows:
- Seller invoice vs Buyer invoice
- Amount differences
- Status (Matched / Disputed)
- Drilldown to documents

---

## 4.11.6 Validation Rules

Header-level:
- seller_company_id ≠ buyer_company_id must be enforced.
- supplier/customer must be flagged intercompany.
- Currency must be compatible with intercompany rules.
- Tax profile must exist for both entities.

Document integrity:
- IC-PO cannot be confirmed unless linked IC-SO exists (if auto-sync enabled).
- Buyer AP invoice must reference Seller AR invoice.
- Mismatched amounts must raise reconciliation exception.

Governance:
- Intercompany documents cannot bypass:
  - Approval rules
  - Tax computation
  - Pricing rules (if configured)

---

## 4.11.7 Workflow

Sales side (Seller):
- DRAFT  
 → CONFIRMED  
 → DISPATCHED  
 → INVOICED  
 → CLOSED  

Procurement side (Buyer):
- DRAFT  
 → APPROVED  
 → RECEIVED  
 → INVOICED  
 → CLOSED  

Reconciliation:
- OPEN  
 → MATCHED  
 → DISPUTED  

---

## 4.11.8 Configuration / Control (Conceptual)

Key controls:

- auto_create_ic_po (Yes/No)
- auto_confirm_ic_so (Yes/No)
- enforce_transfer_price (Yes/No)
- allow_manual_price_override (Yes/No + justification)
- require_dual_approval (Yes/No)
- auto_create_ap_from_ar (Yes/No)
- block_posting_if_mismatch (Yes/No)

Scope:
- Company-pair specific
- Category specific (optional future)

---

## 4.11.9 Integration

Reuses existing modules:
- PO engine (4.3)
- GRN engine (4.5)
- Invoice engine (4.6)
- Payments (4.8)

Adds:
- Cross-company linking
- Validation layer enforcing legal-entity boundaries
- Reconciliation layer

---

## 4.11.10 Module Metadata & Build Steps

Module Metadata:
- module_type: transaction
- complexity: complex
- template_ref: _txn_03
- extension_allowed: true

depends_on:
- Company
- Supplier Master
- Customer Master
- Purchase Order (4.3)
- GRN (4.5)
- Invoice Matching (4.6)
- Payments (4.8)
- Users / Roles

used_by:
- Consolidation
- Statutory Reporting
- Tax Engine
- Financial Audit

---

## Build Steps (for AI / Implementation Engine)

Module: Intercompany Trade (ICT)  
Template: _txn_03  

Backend (Django + DRF):
- Models:
  - ic_sales_order
  - ic_purchase_order
  - ic_invoice_link
- Services:
  - Auto-create mirrored documents
  - Reconciliation validation
- APIs:
  - create_ic_so
  - confirm_ic_so
  - generate_ic_po
  - reconcile_ic_invoices

Frontend (React + Vite + Tailwind):
- Screens:
  - IC Sales Order List / Form
  - IC Purchase Order List / Form
  - Intercompany Reconciliation Dashboard

Security & Roles:
- Intercompany Sales User
- Intercompany Procurement User
- Intercompany Finance Reviewer
- Intercompany Admin

Ensure adherence to:
- Legal entity separation
- Validation rules
- Workflow integrity
- Auditability
