# Request for Quotation (RFQ) — Test Script Prompt
File to be created by Agent:
**Request_for_Quotation_test_script.py**

---

## OBJECTIVE

Validate **end-to-end Request for Quotation (RFQ)** behavior covering:
- Standalone RFQ creation
- RFQ from PR conversion
- Multi-supplier bidding
- Quote submission and comparison
- Supplier selection and PO conversion
- Data integrity & Persistence
- Permission enforcement

This test suite must execute critical scenarios using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company
   - Location
   - Item
   - Item Variant
   - Unit of Measure
   - Supplier
   - Purchase Requisition (if applicable)
   - Users / Roles
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated
8. ✅ Follow BBP 4.2 rules strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: Request_for_Quotation_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from decimal import Decimal
from django.utils import timezone
from datetime import timedelta

# TODO: Import RFQ specific models and serializers
from procurement.models import (
    RequestForQuotation,
    RequestForQuotationLine,
    RFQSupplier,
    SupplierQuote,
    SupplierQuoteLine,
    PurchaseRequisition,
    PurchaseOrder
)

from master.models import (
    Company, Location, Item, ItemVariant, UnitOfMeasure, Supplier
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class RequestForQuotationTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company, is_active=True).first()
        cls.suppliers = Supplier.objects.filter(is_active=True)[:3]
        cls.items = Item.objects.filter(is_active=True)[:5]
        cls.uom = UnitOfMeasure.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        assert cls.company, "Missing active Company master"
        assert cls.location, "Missing active Location master"
        assert cls.suppliers.count() >= 3, "At least 3 active Suppliers required for RFQ testing"
        assert cls.items.count() >= 5, "At least 5 active Items required"
        assert cls.uom, "Missing Unit of Measure"
        assert cls.user, "Missing active User"
```

---

## TEST CASES

> **Agent Instruction**:
> Based on the BBP 4.2 and Functional Requirements for **Request for Quotation (RFQ)**:
> 
> **Core Test Cases to Implement:**
> 
> ### RFQ-TS-01: Create Standalone RFQ
> - Create RFQ directly (not from PR)
> - Add multiple line items
> - Set deadline date
> - Verify status = DRAFT
> - Verify company/location context
> 
> ### RFQ-TS-02: Create RFQ from PR
> - Reference approved PR
> - Convert PR lines to RFQ lines
> - Verify PR linkage maintained
> - Verify quantities transferred
> - Verify suggested supplier pre-populated (if any)
> 
> ### RFQ-TS-03: Multi-Supplier Invitation
> - Create RFQ
> - Invite 3+ suppliers
> - Verify supplier list maintained
> - Verify invitation status tracking
> - Verify supplier notification triggered
> 
> ### RFQ-TS-04: RFQ Publication
> - Publish RFQ (DRAFT → PUBLISHED)
> - Verify deadline date locked
> - Verify line items locked
> - Verify suppliers can view RFQ
> - Verify RFQ open for bidding
> 
> ### RFQ-TS-05: Supplier Quote Submission
> - Supplier submits quote
> - Quote includes prices for all/some items
> - Verify quote linked to RFQ
> - Verify quote linked to supplier
> - Verify quote status = SUBMITTED
> 
> ### RFQ-TS-06: Multiple Quotes from Different Suppliers
> - Supplier A submits quote
> - Supplier B submits quote
> - Supplier C submits quote
> - Verify all quotes tracked independently
> - Verify quote comparison available
> 
> ### RFQ-TS-07: Quote Comparison and Analysis
> - Receive quotes from multiple suppliers
> - Compare prices across suppliers
> - Verify lowest price identification
> - Verify total cost calculation per supplier
> - Verify comparison report generation
> 
> ### RFQ-TS-08: Partial Quote Submission
> - Supplier submits quote for subset of items
> - Verify partial quote accepted
> - Verify non-quoted items marked
> - Verify supplier can still quote remaining items
> 
> ### RFQ-TS-09: Quote Amendment Before Deadline
> - Supplier submits initial quote
> - Supplier amends quote before deadline
> - Verify latest quote version tracked
> - Verify quote history maintained
> 
> ### RFQ-TS-10: Late Quote Rejection
> - Set RFQ deadline
> - Attempt quote submission after deadline
> - Verify late quote blocked (or flagged)
> - Verify deadline enforcement
> 
> ### RFQ-TS-11: Supplier Selection
> - Review submitted quotes
> - Select winning supplier
> - Verify selection recorded
> - Verify non-selected suppliers notified
> 
> ### RFQ-TS-12: PO Creation from RFQ
> - Select winning quote
> - Convert RFQ to PO
> - Verify PO created with selected supplier
> - Verify PO prices from winning quote
> - Verify RFQ-PO linkage maintained
> 
> ### RFQ-TS-13: Partial PO from RFQ
> - Select items from multiple suppliers
> - Create multiple POs from single RFQ
> - Verify split PO creation
> - Verify each PO linked to correct supplier/quote
> 
> ### RFQ-TS-14: RFQ Cancellation
> - Create and publish RFQ
> - Cancel RFQ before deadline
> - Verify status = CANCELLED
> - Verify supplier notification
> - Verify quotes invalidated
> 
> ### RFQ-TS-15: RFQ Amendment After Publication
> - Publish RFQ
> - Amend deadline date (extend)
> - Amend line items (add/remove)
> - Verify amendment tracking
> - Verify supplier re-notification
> 
> ### RFQ-TS-16: RFQ with Technical Specifications
> - Create RFQ with detailed specs
> - Attach documents/drawings
> - Verify specification capture
> - Verify supplier access to specs
> 
> ### RFQ-TS-17: Quote Evaluation Criteria
> - Define evaluation criteria (price, delivery, quality)
> - Score quotes based on criteria
> - Verify weighted scoring
> - Verify best value selection (not just lowest price)
> 
> ### RFQ-TS-18: Company/Location Context
> - Verify RFQ created for correct company
> - Verify delivery location set correctly
> - Verify multi-tenancy isolation
> - Verify supplier visibility restrictions
> 
> ### RFQ-TS-19: Permission Checks
> - Test unauthorized user access
> - Test supplier vs buyer permissions
> - Verify role-based restrictions
> - Test quote submission permissions
> 
> ### RFQ-TS-20: Invalid Data Validation
> - Zero/negative quantities
> - Past deadline date
> - Missing required fields (title, deadline)
> - RFQ without items
> - RFQ without invited suppliers
> 
> ### RFQ-TS-21: Audit Trail Verification
> - Verify created_at, updated_at timestamps
> - Verify created_by, updated_by user tracking
> - Verify status change history
> - Verify quote submission audit
> - Verify supplier selection audit

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** Request for Quotation (RFQ) — Test Automation

- Create `Request_for_Quotation_test_script.py` in `backend/domain/procurement/rfq/tests/`
- Implement RFQ-TS-01 through RFQ-TS-21 exactly as defined
- Enforce real master dependency
- Do not simplify or shortcut validations
- Follow BBP 4.2 strictly
- Ensure tests cover: Standalone RFQ, PR conversion, Multi-supplier bidding, Quote comparison, Supplier selection, PO conversion

**Acceptance Criteria:**
- All 21 test cases pass
- No mock data used
- Real master data validated before execution
- Multi-supplier quote comparison validated
- Deadline enforcement tested
- PO conversion verified
- Quote history tracking validated
- Proper error handling for missing data
- Transaction isolation maintained

**Critical Integration Points:**
- PR → RFQ conversion (optional)
- RFQ → Supplier invitation
- Supplier → Quote submission
- RFQ → PO conversion
- Quote comparison → Supplier selection

**Business Logic to Validate:**
- Quote Validity: Quote Submission Date ≤ RFQ Deadline Date
- Best Price: MIN(Supplier Quote Total) across all valid quotes
- PO Conversion: PO Price = Selected Quote Price

Failure to meet any rule = test suite rejection.
