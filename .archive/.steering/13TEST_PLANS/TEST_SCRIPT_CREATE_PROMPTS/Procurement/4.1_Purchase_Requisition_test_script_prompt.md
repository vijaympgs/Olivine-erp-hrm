# 4.1 Purchase Requisition (PR) — Test Script Prompt
File to be created by Agent:
**4.1_Purchase_Requisition_test_script.py**

---

## OBJECTIVE

Validate **end-to-end Purchase Requisition (PR)** behavior covering:
- Internal demand creation
- Approval workflows
- Data integrity
- Permission enforcement
- Auditability

This test suite must execute **PR-TS-01 → PR-TS-10** using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company
   - Location
   - Item
   - Item Variant
   - Unit of Measure
   - Supplier (if hinted)
   - Users / Roles
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated
8. ✅ Follow BBP 4.1 rules strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: 4.1_Purchase_Requisition_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model

from procurement.models import (
    PurchaseRequisition,
    PurchaseRequisitionLine
)

from master.models import (
    Company,
    Location,
    Item,
    ItemVariant,
    UnitOfMeasure,
    Supplier
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class PRBaseTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(
            company=cls.company,
            is_active=True
        ).first()
        cls.items = Item.objects.filter(is_active=True)[:10]
        cls.uom = UnitOfMeasure.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()

        assert cls.company, "Missing active Company master"
        assert cls.location, "Missing active Location master"
        assert cls.items.count() >= 10, "At least 10 active Items required"
        assert cls.uom, "Missing Unit of Measure"
        assert cls.user, "Missing active User"
```

---

## TEST CASES

### PR-TS-01: Create PR with ≥10 items
```python
def test_pr_ts_01_create_pr_with_10_items(self):
    pr = PurchaseRequisition.objects.create(
        company=self.company,
        requesting_location=self.location,
        requested_by=self.user,
        pr_status="DRAFT"
    )

    for item in self.items:
        PurchaseRequisitionLine.objects.create(
            purchase_requisition=pr,
            item=item,
            item_variant=item.variants.first(),
            uom=self.uom,
            requested_qty=10
        )

    self.assertEqual(pr.lines.count(), 10)
```

---

### PR-TS-02: Validate company & location context
```python
def test_pr_ts_02_validate_company_location_context(self):
    pr = PurchaseRequisition.objects.first()
    self.assertEqual(pr.company, self.company)
    self.assertEqual(pr.requesting_location.company, self.company)
```

---

### PR-TS-03: Submit PR for approval
```python
def test_pr_ts_03_submit_pr(self):
    pr = PurchaseRequisition.objects.first()
    pr.submit()
    self.assertEqual(pr.pr_status, "SUBMITTED")
```

---

### PR-TS-04: Approve PR (single / multi-level)
```python
def test_pr_ts_04_approve_pr(self):
    pr = PurchaseRequisition.objects.get(pr_status="SUBMITTED")
    pr.approve(by_user=self.user)
    self.assertEqual(pr.pr_status, "APPROVED")
```

---

### PR-TS-05: Reject & resubmit PR
```python
def test_pr_ts_05_reject_and_resubmit(self):
    pr = PurchaseRequisition.objects.first()
    pr.reject(by_user=self.user, reason="Test rejection")
    self.assertEqual(pr.pr_status, "REJECTED")

    pr.resubmit()
    self.assertEqual(pr.pr_status, "SUBMITTED")
```

---

### PR-TS-06: Amend PR before approval
```python
def test_pr_ts_06_amend_pr_before_approval(self):
    pr = PurchaseRequisition.objects.get(pr_status="DRAFT")
    line = pr.lines.first()
    line.requested_qty = 25
    line.save()

    self.assertEqual(line.requested_qty, 25)
```

---

### PR-TS-07: Lock PR after approval
```python
def test_pr_ts_07_lock_pr_after_approval(self):
    pr = PurchaseRequisition.objects.get(pr_status="APPROVED")
    with self.assertRaises(Exception):
        pr.lines.first().delete()
```

---

### PR-TS-08: Permission checks
```python
def test_pr_ts_08_permission_checks(self):
    other_user = get_user_model().objects.exclude(id=self.user.id).first()
    pr = PurchaseRequisition.objects.first()

    with self.assertRaises(PermissionError):
        pr.approve(by_user=other_user)
```

---

### PR-TS-09: Invalid quantity/date validation
```python
def test_pr_ts_09_invalid_quantity(self):
    pr = PurchaseRequisition.objects.first()
    with self.assertRaises(ValueError):
        PurchaseRequisitionLine.objects.create(
            purchase_requisition=pr,
            item=self.items.first(),
            item_variant=self.items.first().variants.first(),
            uom=self.uom,
            requested_qty=0
        )
```

---

### PR-TS-10: Audit trail verification
```python
def test_pr_ts_10_audit_trail(self):
    pr = PurchaseRequisition.objects.first()
    self.assertIsNotNone(pr.created_at)
    self.assertIsNotNone(pr.updated_at)
```

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** 4.1 Purchase Requisition — Test Automation

- Create `4.1_Purchase_Requisition_test_script.py`
- Implement PR-TS-01 → PR-TS-10 exactly as defined
- Enforce real master dependency
- Do not simplify or shortcut validations
- Follow BBP 4.1 strictly

Failure to meet any rule = test suite rejection.
