# Advance Shipment Notice (ASN) — Test Script Prompt
File to be created by Agent:
**Advance_Shipment_Notice_test_script.py**

---

## OBJECTIVE

Validate **end-to-end Advance Shipment Notice (ASN)** behavior covering:
- ASN creation against PO
- Shipment planning and tracking
- Expected delivery date management
- GRN pre-population from ASN
- Variance tracking (ASN vs actual receipt)
- Data integrity & Persistence
- Permission enforcement

This test suite must execute critical scenarios using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company
   - Location
   - Item
   - Item Variant
   - Unit of Measure
   - Supplier
   - Purchase Order
   - Users / Roles
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated
8. ✅ Follow BBP 4.5 rules strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: Advance_Shipment_Notice_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from decimal import Decimal
from django.utils import timezone
from datetime import timedelta

# TODO: Import ASN specific models and serializers
from procurement.models import (
    AdvanceShipmentNotice,
    AdvanceShipmentNoticeLine,
    PurchaseOrder,
    PurchaseOrderLine,
    GoodsReceiptNote
)

from master.models import (
    Company, Location, Item, ItemVariant, UnitOfMeasure, Supplier
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class AdvanceShipmentNoticeTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company, is_active=True).first()
        cls.supplier = Supplier.objects.filter(is_active=True).first()
        cls.items = Item.objects.filter(is_active=True)[:5]
        cls.uom = UnitOfMeasure.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # Require approved PO for ASN testing
        cls.po = PurchaseOrder.objects.filter(
            company=cls.company,
            po_status='APPROVED'
        ).first()
        
        assert cls.company, "Missing active Company master"
        assert cls.location, "Missing active Location master"
        assert cls.supplier, "Missing active Supplier master"
        assert cls.items.count() >= 5, "At least 5 active Items required"
        assert cls.uom, "Missing Unit of Measure"
        assert cls.user, "Missing active User"
        assert cls.po, "Missing approved Purchase Order for ASN testing"
```

---

## TEST CASES

> **Agent Instruction**:
> Based on the BBP 4.5 and Functional Requirements for **Advance Shipment Notice (ASN)**:
> 
> **Core Test Cases to Implement:**
> 
> ### ASN-TS-01: Create ASN Against Approved PO
> - Reference approved PO
> - Select PO lines for shipment
> - Create ASN with expected quantities
> - Set expected delivery date
> - Verify status = DRAFT
> - Verify PO linkage maintained
> 
> ### ASN-TS-02: Full Shipment ASN (100% of PO)
> - Create ASN for all PO lines
> - Verify ASN quantities = PO ordered quantities
> - Verify all items included
> - Verify shipment completeness flag
> 
> ### ASN-TS-03: Partial Shipment ASN
> - Create ASN for subset of PO lines
> - Create ASN with partial quantities
> - Verify remaining quantities tracked
> - Verify PO remains open for remaining shipments
> 
> ### ASN-TS-04: Multiple ASNs Against Single PO
> - Create first ASN with partial shipment
> - Create second ASN for remaining items
> - Verify cumulative shipment tracking
> - Verify no over-shipment allowed
> 
> ### ASN-TS-05: ASN Confirmation/Publication
> - Confirm ASN (DRAFT → CONFIRMED)
> - Verify expected delivery date locked
> - Verify warehouse notification triggered
> - Verify receiving team alerted
> 
> ### ASN-TS-06: ASN with Shipment Details
> - Add tracking number
> - Add carrier information
> - Add container/pallet details
> - Verify shipment metadata captured
> 
> ### ASN-TS-07: Expected Delivery Date Management
> - Set expected delivery date
> - Update delivery date (before confirmation)
> - Verify date change tracking
> - Verify warehouse re-notification
> 
> ### ASN-TS-08: GRN Pre-population from ASN
> - Create and confirm ASN
> - Create GRN referencing ASN
> - Verify GRN lines pre-populated from ASN
> - Verify expected quantities transferred
> 
> ### ASN-TS-09: ASN-GRN Variance Tracking
> - Create ASN with expected quantities
> - Create GRN with different actual quantities
> - Verify variance detected (ASN vs GRN)
> - Verify variance percentage calculated
> - Verify variance logged for analysis
> 
> ### ASN-TS-10: Over-Shipment Detection
> - Attempt to create ASN with qty > PO ordered qty
> - Verify validation error
> - Verify over-shipment blocked (or flagged)
> - Verify approval required for over-shipment
> 
> ### ASN-TS-11: ASN Cancellation Before Receipt
> - Create and confirm ASN
> - Cancel ASN before GRN created
> - Verify status = CANCELLED
> - Verify PO shipment status reverted
> - Verify warehouse notification of cancellation
> 
> ### ASN-TS-12: ASN Amendment Before Confirmation
> - Create ASN in DRAFT
> - Modify quantities/delivery date
> - Verify changes saved
> - Verify amendment tracking
> 
> ### ASN-TS-13: ASN Lock After Confirmation
> - Confirm ASN
> - Attempt to modify ASN
> - Verify modification blocked
> - Verify error handling
> 
> ### ASN-TS-14: Company/Location Context
> - Verify ASN created for correct company
> - Verify delivery location set correctly
> - Verify multi-tenancy isolation
> - Verify supplier linkage
> 
> ### ASN-TS-15: Permission Checks
> - Test unauthorized user access
> - Test confirmation permissions
> - Verify role-based restrictions
> - Test supplier vs buyer permissions
> 
> ### ASN-TS-16: Invalid Data Validation
> - Zero/negative shipment quantities
> - ASN against non-approved PO
> - Past expected delivery date
> - Missing required fields (tracking number, carrier)
> 
> ### ASN-TS-17: Audit Trail Verification
> - Verify created_at, updated_at timestamps
> - Verify created_by, updated_by user tracking
> - Verify status change history
> - Verify delivery date change log
> 
> ### ASN-TS-18: ASN Reporting and Analytics
> - Verify ASN accuracy metrics (ASN vs GRN variance)
> - Verify on-time delivery tracking
> - Verify supplier performance data
> - Verify shipment planning reports

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** Advance Shipment Notice (ASN) — Test Automation

- Create `Advance_Shipment_Notice_test_script.py` in `backend/domain/procurement/asn/tests/`
- Implement ASN-TS-01 through ASN-TS-18 exactly as defined
- Enforce real master dependency
- Do not simplify or shortcut validations
- Follow BBP 4.5 strictly
- Ensure tests cover: Full/Partial shipments, Multiple ASNs, GRN pre-population, Variance tracking, Delivery date management

**Acceptance Criteria:**
- All 18 test cases pass
- No mock data used
- Real master data validated before execution
- ASN-GRN variance calculations verified
- Delivery date tracking validated
- Warehouse notification logic tested
- Proper error handling for missing data
- Transaction isolation maintained

**Critical Integration Points:**
- PO → ASN linkage
- ASN → GRN pre-population
- ASN → Warehouse notification
- ASN variance → Supplier performance metrics

**Business Logic to Validate:**
- Shipment Qty: ASN Qty ≤ PO Ordered Qty - Previously Shipped Qty
- Variance: (GRN Actual Qty - ASN Expected Qty) / ASN Expected Qty × 100
- On-Time: Actual Receipt Date ≤ ASN Expected Delivery Date

Failure to meet any rule = test suite rejection.
