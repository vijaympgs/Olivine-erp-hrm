# Purchase Returns — Test Script Prompt
File to be created by Agent:
**Purchase_Returns_test_script.py**

---

## OBJECTIVE

Validate **end-to-end Purchase Returns** behavior covering:
- Return creation against GRN
- Return authorization workflow
- Quality-based returns
- Damaged/defective goods handling
- Inventory adjustment on return
- Supplier credit note generation
- Data integrity & Persistence
- Permission enforcement

This test suite must execute critical scenarios using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company
   - Location
   - Item
   - Item Variant
   - Unit of Measure
   - Supplier
   - Purchase Order
   - Goods Receipt Note
   - Users / Roles
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated
8. ✅ Follow BBP 4.8 rules strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: Purchase_Returns_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from decimal import Decimal
from django.utils import timezone

# TODO: Import Purchase Return specific models and serializers
from procurement.models import (
    PurchaseReturn,
    PurchaseReturnLine,
    PurchaseOrder,
    GoodsReceiptNote,
    GoodsReceiptLine,
    VendorInvoice
)

from inventory.models import (
    Inventory,
    StockMovement
)

from finance.models import (
    DebitNote,
    AccountsPayable
)

from master.models import (
    Company, Location, Item, ItemVariant, UnitOfMeasure, Supplier
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class PurchaseReturnsTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company, is_active=True).first()
        cls.supplier = Supplier.objects.filter(is_active=True).first()
        cls.items = Item.objects.filter(is_active=True)[:5]
        cls.uom = UnitOfMeasure.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # Require confirmed GRN for return testing
        cls.grn = GoodsReceiptNote.objects.filter(
            company=cls.company,
            grn_status='CONFIRMED'
        ).first()
        
        cls.po = cls.grn.purchase_order if cls.grn else None
        
        assert cls.company, "Missing active Company master"
        assert cls.location, "Missing active Location master"
        assert cls.supplier, "Missing active Supplier master"
        assert cls.items.count() >= 5, "At least 5 active Items required"
        assert cls.uom, "Missing Unit of Measure"
        assert cls.user, "Missing active User"
        assert cls.grn, "Missing confirmed GRN for Purchase Return testing"
        assert cls.po, "Missing PO linked to GRN"
```

---

## TEST CASES

> **Agent Instruction**:
> Based on the BBP 4.8 and Functional Requirements for **Purchase Returns**:
> 
> **Core Test Cases to Implement:**
> 
> ### PR-RET-TS-01: Create Return Against GRN
> - Reference confirmed GRN
> - Select items to return
> - Specify return quantities
> - Specify return reason (quality issue, wrong item, etc.)
> - Verify status = DRAFT
> - Verify GRN linkage maintained
> 
> ### PR-RET-TS-02: Full Return (100% of GRN)
> - Return all items from GRN
> - Verify return quantities = received quantities
> - Verify all GRN lines included
> - Verify GRN return status updated
> 
> ### PR-RET-TS-03: Partial Return
> - Return subset of GRN lines
> - Return partial quantities from specific lines
> - Verify remaining items not affected
> - Verify partial return tracking
> 
> ### PR-RET-TS-04: Return Reason Classification
> - Create returns with different reasons:
>   - Quality defect
>   - Damaged in transit
>   - Wrong item received
>   - Excess quantity
>   - Not as per specification
> - Verify reason code captured
> - Verify reason-based workflow routing
> 
> ### PR-RET-TS-05: Return Authorization Workflow
> - Submit return (DRAFT → PENDING_APPROVAL)
> - Approve return (PENDING_APPROVAL → APPROVED)
> - Verify approval required for high-value returns
> - Verify auto-approval for low-value returns (if configured)
> 
> ### PR-RET-TS-06: Inventory Adjustment on Return Confirmation
> - Confirm return (APPROVED → CONFIRMED)
> - Verify inventory levels decreased
> - Verify stock movement record created (negative)
> - Verify location-specific stock updated
> 
> ### PR-RET-TS-07: Return Shipment to Supplier
> - Confirm return
> - Create return shipment
> - Add tracking details
> - Verify shipment status tracking
> - Verify supplier notification
> 
> ### PR-RET-TS-08: Debit Note Generation
> - Confirm return
> - Generate debit note against supplier
> - Verify debit note amount = return value
> - Verify debit note linked to return
> - Verify AP adjustment
> 
> ### PR-RET-TS-09: Return Against Invoiced Items
> - Create return for items already invoiced
> - Verify invoice linkage
> - Verify debit note offsets invoice
> - Verify AP balance adjustment
> 
> ### PR-RET-TS-10: Return Before Invoice
> - Create return for items not yet invoiced
> - Verify GRN available quantity reduced
> - Verify future invoice reflects net quantity
> - Verify PO fulfillment status updated
> 
> ### PR-RET-TS-11: Quality Inspection Return
> - Create return for items in QC hold
> - Verify QC status checked
> - Verify return from QC location
> - Verify QC rejection reason linked
> 
> ### PR-RET-TS-12: Replacement vs Refund
> - Create return with replacement request
> - Verify replacement flag set
> - Verify new PO/requisition triggered (if configured)
> - Create return with refund request
> - Verify refund processing initiated
> 
> ### PR-RET-TS-13: Multiple Returns Against Single GRN
> - Create first return for partial items
> - Create second return for additional items
> - Verify cumulative return tracking
> - Verify cannot exceed received quantity
> 
> ### PR-RET-TS-14: Return Cancellation
> - Create and approve return
> - Cancel return before confirmation
> - Verify status = CANCELLED
> - Verify inventory not affected
> - Verify cancellation reason logged
> 
> ### PR-RET-TS-15: Return Reversal After Confirmation
> - Create and confirm return
> - Reverse return (goods re-received)
> - Verify inventory levels restored
> - Verify debit note reversed
> - Verify reversal audit trail
> 
> ### PR-RET-TS-16: Company/Supplier Context
> - Verify return created for correct company
> - Verify return linked to correct supplier
> - Verify multi-tenancy isolation
> - Verify supplier return policy applied
> 
> ### PR-RET-TS-17: Permission Checks
> - Test unauthorized user access
> - Test approval permissions
> - Verify role-based restrictions
> - Test warehouse vs purchasing permissions
> 
> ### PR-RET-TS-18: Invalid Data Validation
> - Zero/negative return quantities
> - Return qty > received qty
> - Return against non-confirmed GRN
> - Missing return reason
> - Missing required fields
> 
> ### PR-RET-TS-19: Audit Trail Verification
> - Verify created_at, updated_at timestamps
> - Verify created_by, updated_by user tracking
> - Verify status change history
> - Verify inventory movement audit
> - Verify debit note generation audit
> 
> ### PR-RET-TS-20: Return Analytics
> - Verify return rate by supplier
> - Verify return reason analysis
> - Verify return value tracking
> - Verify supplier performance impact

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** Purchase Returns — Test Automation

- Create `Purchase_Returns_test_script.py` in `backend/domain/procurement/returns/tests/`
- Implement PR-RET-TS-01 through PR-RET-TS-20 exactly as defined
- Enforce real master dependency
- Do not simplify or shortcut validations
- Follow BBP 4.8 strictly
- Ensure tests cover: Full/Partial returns, Return reasons, Approval workflow, Inventory adjustments, Debit note generation, Replacement vs Refund

**Acceptance Criteria:**
- All 20 test cases pass
- No mock data used
- Real master data validated before execution
- Inventory adjustments verified (negative movements)
- Debit note generation validated
- AP integration verified
- Return reason classification tested
- Proper error handling for missing data
- Transaction isolation maintained

**Critical Integration Points:**
- GRN → Return linkage
- Return → Inventory adjustment (negative)
- Return → Debit Note generation
- Return → AP adjustment
- Return → Supplier performance metrics

**Business Logic to Validate:**
- Return Qty: Return Qty ≤ GRN Received Qty - Previously Returned Qty
- Debit Note Amount: Sum(Return Line Qty × Unit Price) + Applicable Taxes
- Inventory Impact: Stock Level = Previous Level - Return Qty

Failure to meet any rule = test suite rejection.
