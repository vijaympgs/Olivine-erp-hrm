# Purchase Orders — Test Script Prompt
File to be created by Agent:
**Purchase_Orders_test_script.py**

---

## OBJECTIVE

Validate **end-to-end Purchase Order (PO)** behavior covering:
- Standalone PO creation
- PO from PR conversion
- PO from RFQ conversion
- Approval workflows
- Data integrity & Persistence
- Permission enforcement
- Supplier commitment tracking

This test suite must execute critical scenarios using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories, fixtures, or fake generators
3. ✅ USE ONLY existing reference masters from DB:
   - Company
   - Location
   - Item
   - Item Variant
   - Unit of Measure
   - Supplier
   - Users / Roles
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated
8. ✅ Follow BBP 4.3 rules strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: Purchase_Orders_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from decimal import Decimal

# TODO: Import Purchase Order specific models and serializers
from procurement.models import (
    PurchaseOrder,
    PurchaseOrderLine,
    PurchaseRequisition,
    RequestForQuotation
)

from master.models import (
    Company, Location, Item, ItemVariant, UnitOfMeasure, Supplier
)
```

---

## BASE TEST SETUP (SHARED CONTEXT)

```python
class PurchaseOrdersTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.filter(company=cls.company, is_active=True).first()
        cls.supplier = Supplier.objects.filter(is_active=True).first()
        cls.items = Item.objects.filter(is_active=True)[:5]
        cls.uom = UnitOfMeasure.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        assert cls.company, "Missing active Company master"
        assert cls.location, "Missing active Location master"
        assert cls.supplier, "Missing active Supplier master"
        assert cls.items.count() >= 5, "At least 5 active Items required"
        assert cls.uom, "Missing Unit of Measure"
        assert cls.user, "Missing active User"
```

---

## TEST CASES

> **Agent Instruction**:
> Based on the BBP 4.3 and Functional Requirements for **Purchase Orders**:
> 
> **Core Test Cases to Implement:**
> 
> ### PO-TS-01: Create Standalone PO
> - Create PO directly with supplier selection
> - Add multiple line items with prices
> - Verify grand total calculation
> - Verify status = DRAFT
> 
> ### PO-TS-02: Create PO from PR
> - Reference existing approved PR
> - Convert PR lines to PO lines
> - Verify PR linkage maintained
> - Verify quantities transferred correctly
> 
> ### PO-TS-03: Create PO from RFQ
> - Reference existing RFQ with quoted prices
> - Convert RFQ lines to PO lines
> - Verify pricing from RFQ
> - Verify RFQ linkage maintained
> 
> ### PO-TS-04: PO Approval Workflow
> - Submit PO (DRAFT → SUBMITTED)
> - Approve PO (SUBMITTED → APPROVED)
> - Verify fields locked after approval
> - Verify approval audit trail
> 
> ### PO-TS-05: PO Amendment Before Approval
> - Modify PO in DRAFT status
> - Update line quantities/prices
> - Verify changes saved
> - Verify totals recalculated
> 
> ### PO-TS-06: PO Lock After Approval
> - Attempt to modify approved PO
> - Verify modification blocked
> - Verify error handling
> 
> ### PO-TS-07: Multi-line PO with Different Items
> - Add 5+ different items
> - Verify line-level calculations
> - Verify header total aggregation
> - Verify item variant tracking
> 
> ### PO-TS-08: Supplier Context Validation
> - Verify PO linked to correct supplier
> - Verify supplier payment terms applied
> - Verify supplier-specific pricing (if applicable)
> 
> ### PO-TS-09: Company/Location Context
> - Verify PO created for correct company
> - Verify delivery location set correctly
> - Verify multi-tenancy isolation
> 
> ### PO-TS-10: Permission Checks
> - Test unauthorized user access
> - Test approval permissions
> - Verify role-based restrictions
> 
> ### PO-TS-11: Invalid Data Validation
> - Zero/negative quantities
> - Zero/negative prices
> - Missing required fields
> - Invalid supplier reference
> 
> ### PO-TS-12: Audit Trail Verification
> - Verify created_at, updated_at timestamps
> - Verify created_by, updated_by user tracking
> - Verify status change history

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** Purchase Orders — Test Automation

- Create `Purchase_Orders_test_script.py` in `backend/domain/procurement/po/tests/`
- Implement PO-TS-01 through PO-TS-12 exactly as defined
- Enforce real master dependency
- Do not simplify or shortcut validations
- Follow BBP 4.3 strictly
- Ensure tests cover: Standalone creation, PR conversion, RFQ conversion, Approval workflow, Validations

**Acceptance Criteria:**
- All 12 test cases pass
- No mock data used
- Real master data validated before execution
- Proper error handling for missing data
- Transaction isolation maintained

Failure to meet any rule = test suite rejection.
