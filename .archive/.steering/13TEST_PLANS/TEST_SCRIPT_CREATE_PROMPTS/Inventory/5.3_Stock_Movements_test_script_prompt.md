# 5.3 Stock Movements — Test Script Prompt
File to be created by Agent:
**5.3_Stock_Movements_test_script.py**

---

## OBJECTIVE

Validate **Stock Movement (Ledger)** logic and audit trail integrity covering:
- Immutable Ledger entries (StockMovement)
- Movement Types (GRN, Transfer, Adjustment, Sale)
- Stock Level updates (Materialized View sync)
- Permission & Scope validations
- Negative stock prevention (if configured)

This test suite must execute **MOVE-TS-01 → MOVE-TS-06** using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ❌ NO factories
3. ✅ USE ONLY existing reference masters
4. ❌ DO NOT auto-create master data inside tests
5. ✅ FAIL FAST if required master data is missing
6. ✅ Use Django ORM models only
7. ✅ Each test must be transactional and isolated

---

## TEST SCRIPT STRUCTURE

```python
# file: 5.3_Stock_Movements_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from django.db.utils import IntegrityError
from decimal import Decimal
import uuid

from domain.inventory.models import StockMovement, StockLevel, InventoryParameter
from domain.company.models import Company, Location, ItemVariant, UnitOfMeasure
```

---

## BASE TEST SETUP

```python
class StockMovementTestCase(TestCase):

    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.loc_source = Location.objects.filter(company=cls.company).first()
        cls.loc_dest = Location.objects.filter(company=cls.company).last()
        cls.variant = ItemVariant.objects.filter(is_active=True).first()
        cls.uom = UnitOfMeasure.objects.first()
        cls.user = get_user_model().objects.filter(is_active=True).first()
        
        # Ensure 'allow_negative_stock' is FALSE for testing
        InventoryParameter.objects.update_or_create(
            company=cls.company,
            defaults={'allow_negative_stock': False}
        )

        assert cls.company, "Missing Company"
        assert cls.loc_source, "Missing Location"
        assert cls.variant, "Missing Variant"
```

---

## TEST CASES

### MOVE-TS-01: GRN Movement (Inbound)
```python
def test_move_01_grn_inbound(self):
    """Verify GRN increases Stock Level and creates Movement Entry"""
    # Simulate GRN logic
    qty = Decimal('100.00')
    
    # 1. Create Movement
    Movement = StockMovement.objects.create(
        company=self.company,
        item=self.variant.item,
        variant=self.variant,
        qty=qty, # Positive for IN
        to_location=self.loc_source,
        movement_type='GRN',
        reference_type='GRN',
        reference_id=uuid.uuid4(),
        created_by=self.user,
        uom=self.uom
    )
    
    # 2. Update Stock Level (Simulate Service Logic)
    level, _ = StockLevel.objects.get_or_create(
        company=self.company, variant=self.variant, location=self.loc_source
    )
    level.on_hand_qty += qty
    level.save()
    
    self.assertIsNotNone(Movement.movement_id)
    self.assertEqual(level.on_hand_qty, 100)
```

### MOVE-TS-02: Transfer (Outbound)
```python
def test_move_02_transfer_outbound(self):
    """Verify Transfer OUT reduces stock"""
    # Pre-seed stock: 100
    StockLevel.objects.update_or_create(
         company=self.company, variant=self.variant, location=self.loc_source,
         defaults={'on_hand_qty': 100}
    )
    
    # Execute Transfer OUT (-20)
    qty = Decimal('-20.00')
    StockMovement.objects.create(
        company=self.company,
        variant=self.variant,
        qty=qty,
        from_location=self.loc_source,
        movement_type='TRANSFER_OUT',
        reference_type='TRANSFER',
        reference_id=uuid.uuid4(),
        created_by=self.user
    )
    
    level = StockLevel.objects.get(company=self.company, variant=self.variant, location=self.loc_source)
    level.on_hand_qty += qty
    level.save()
    
    self.assertEqual(level.on_hand_qty, 80)
```

### MOVE-TS-03: Immutable Audit Trail
```python
def test_move_03_immutable_audit(self):
    """Verify Ledger entries cannot be modified easily (Application-level check)"""
    # Note: Pure Django models don't enforce immutability without DB triggers or strict permissions.
    # This test verifies standard behavior implies persistence.
    
    mv = StockMovement.objects.create(
        company=self.company, variant=self.variant, qty=10,
        to_location=self.loc_source, movement_type='ADJUSTMENT',
        reference_type='ADJUSTMENT', reference_id=uuid.uuid4(),
        created_by=self.user
    )
    
    # Try to update ID (Should fail or be ignored in logic)
    # This is more of a smoke test for DB integrity
    self.assertTrue(StockMovement.objects.filter(movement_id=mv.movement_id).exists())
```

### MOVE-TS-04: Negative Stock Prevention
```python
def test_move_04_negative_stock_prevention(self):
    """Verify logic validation prevents negative stock if configured"""
    # Reset Stock to 10
    StockLevel.objects.update_or_create(
         company=self.company, variant=self.variant, location=self.loc_source,
         defaults={'on_hand_qty': 10}
    )
    
    # Attempt to consume 50 (Should fail business logic)
    # Note: Logic resides in Service, but here we test the check
    current_stock = 10
    requested_qty = 50
    allow_negative = InventoryParameter.objects.get(company=self.company).allow_negative_stock
    
    if not allow_negative and (current_stock - requested_qty) < 0:
        with self.assertRaises(ValueError): # Or your custom exception
            raise ValueError("Insufficient Stock")
```

### MOVE-TS-05: Double Entry Verification (Transfer)
```python
def test_move_05_double_entry(self):
    """Verify Transfer creates balanced entries (+ and -)"""
    # Logic: Transfer logic creates 2 Movement records
    ref_id = uuid.uuid4()
    
    # OUT
    StockMovement.objects.create(
        company=self.company, variant=self.variant, qty=-10,
        from_location=self.loc_source, movement_type='TRANSFER_OUT',
        reference_id=ref_id, created_by=self.user,
        reference_type='TRANSFER' # Added missing field
    )
    # IN
    StockMovement.objects.create(
        company=self.company, variant=self.variant, qty=10,
        to_location=self.loc_dest, movement_type='TRANSFER_IN',
        reference_id=ref_id, created_by=self.user,
        reference_type='TRANSFER' # Added missing field
    )
    
    movements = StockMovement.objects.filter(reference_id=ref_id)
    self.assertEqual(movements.count(), 2)
    net_qty = sum(m.qty for m in movements)
    self.assertEqual(net_qty, 0)
```

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** 5.3 Stock Movements — Test Automation

- Create `5.3_Stock_Movements_test_script.py`
- Implement MOVE-TS-01 → MOVE-TS-05
- Focus on Ledger Integrity
- Reference Types MUST match Enum (GRN, SALE, TRANSFER)
- Follow BBP 5.3 strictly

Failure to meet any rule = test suite rejection.
