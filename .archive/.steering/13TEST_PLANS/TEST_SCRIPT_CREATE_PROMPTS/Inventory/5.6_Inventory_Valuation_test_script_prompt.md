# 5.6 Inventory Valuation — Test Script Prompt
File to be created by Agent:
**5.6_Inventory_Valuation_test_script.py**

---

## OBJECTIVE

Validate **Inventory Valuation** logic:
- Valuation Method configuration (Company level)
- Stock Value Calculation (Qty * Cost)
- FIFO/LIFO/Weighted Average logic simulation (Cost Layering)
- Consistency with General Ledger (simulated)

This test suite must execute **VAL-TS-01 → VAL-TS-04** using **real reference master data only**.

---

## GLOBAL EXECUTION RULES (MANDATORY)

1. ❌ NO mock data
2. ✅ USE ONLY existing reference masters
3. ✅ Use Django ORM models only
4. ✅ Follow BBP 5.6 strictly

---

## TEST SCRIPT STRUCTURE

```python
# file: 5.6_Inventory_Valuation_test_script.py

from django.test import TestCase
from django.contrib.auth import get_user_model
from decimal import Decimal

from domain.inventory.models import ValuationMethod, StockLevel
from domain.company.models import Company, Location, ItemVariant, ItemMaster
```

---

## BASE TEST SETUP

```python
class ValuationTestCase(TestCase):
    @classmethod
    def setUpTestData(cls):
        cls.company = Company.objects.filter(is_active=True).first()
        cls.location = Location.objects.first()
        cls.variant = ItemVariant.objects.filter(is_active=True).first()
        cls.user = get_user_model().objects.first()
        
        # Ensure Item has Cost
        item = cls.variant.item
        item.cost_price = Decimal('10.00')
        item.save()
        
        # Seed Stock: 100
        StockLevel.objects.update_or_create(
            company=cls.company, variant=cls.variant, location=cls.location,
            defaults={'on_hand_qty': 100}
        )
```

---

## TEST CASES

### VAL-TS-01: Default Valuation Method
```python
def test_val_01_default_method(self):
    """Verify default method is FIFO"""
    # Create or Get Method
    method, created = ValuationMethod.objects.get_or_create(
         company=self.company, defaults={'method': 'FIFO', 'created_by': self.user}
    )
    self.assertEqual(method.method, 'FIFO')
```

### VAL-TS-02: Total Inventory Value (Standard Cost)
```python
def test_val_02_total_value(self):
    """Verify Value = Qty * Cost (Standard Cost Model)"""
    level = StockLevel.objects.get(company=self.company, variant=self.variant)
    cost = self.variant.item.cost_price
    
    value = level.on_hand_qty * cost
    self.assertEqual(value, 1000.00) # 100 * 10
```

### VAL-TS-03: Change Valuation Method
```python
def test_val_03_change_method(self):
    """Verify changing method is persisted"""
    method, _ = ValuationMethod.objects.get_or_create(
        company=self.company, defaults={'created_by': self.user}
    )
    
    method.method = 'WEIGHTED_AVG'
    method.save()
    
    self.assertEqual(ValuationMethod.objects.get(company=self.company).method, 'WEIGHTED_AVG')
```

### VAL-TS-04: Negative Stock Valuation Warning
```python
def test_val_04_negative_value_check(self):
    """Verify negative stock results in negative value (or flagged)"""
    # Force negative stock
    level = StockLevel.objects.get(company=self.company, variant=self.variant)
    level.on_hand_qty = -5
    level.save()
    
    cost = self.variant.item.cost_price
    value = level.on_hand_qty * cost
    self.assertTrue(value < 0)
```

---

## AGENT EXECUTION INSTRUCTION (LOCKED)

**Run Task:** 5.6 Inventory Valuation — Test Automation

- Create `5.6_Inventory_Valuation_test_script.py`
- Implement VAL-TS-01 → VAL-TS-04
- Verify Math Precision (Decimals)
- Follow BBP 5.6 strictly

Failure to meet any rule = test suite rejection.
